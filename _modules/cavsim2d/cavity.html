<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cavsim2d.cavity &mdash; cavsim2d 13.08.2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f5513fb5"></script>
        <script src="../../_static/doctools.js?v=9bcbadda"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            cavsim2d
              <img src="../../_static/cavsim2d_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#understanding-the-geometry-types">Understanding the geometry types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#advanced">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#parallelisation">Parallelisation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">cavsim2d</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">cavsim2d</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cavsim2d.cavity</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cavsim2d.cavity</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">operator</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">distutils</span> <span class="kn">import</span> <span class="n">dir_util</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display_html</span><span class="p">,</span> <span class="n">Math</span>
<span class="kn">from</span> <span class="nn">IPython.core.display_functions</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">Label</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cavsim2d.data_module.abci_data</span> <span class="kn">import</span> <span class="n">ABCIData</span>
<span class="kn">from</span> <span class="nn">cavsim2d.optimisation</span> <span class="kn">import</span> <span class="n">Optimisation</span>
<span class="kn">from</span> <span class="nn">cavsim2d.processes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cavsim2d.utils.shared_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cavsim2d.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">sci</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="c1"># Safe arithmetic evaluator for simple expressions</span>
<span class="n">_ops</span> <span class="o">=</span> <span class="p">{</span><span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Sub</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Mult</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">Div</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">truediv</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Pow</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">pow</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">USub</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">neg</span><span class="p">}</span>

<div class="viewcode-block" id="Cavities">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities">[docs]</a>
<span class="k">class</span> <span class="nc">Cavities</span><span class="p">(</span><span class="n">Optimisation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cavities object is an object containing several Cavity objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cavities_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs all the necessary attributes of the Cavity object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cavities_list: list, array like</span>
<span class="sd">            List containing Cavity objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span> <span class="o">=</span> <span class="n">cavities_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cavities_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cavities_list</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_cavity</span><span class="p">(</span><span class="n">cavities_list</span><span class="p">,</span> <span class="n">names_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;cavities&#39;</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter valid project name.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uq_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results_all_modes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_qois_uq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points_threshold</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># V/m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cavities_field</span><span class="p">()</span>

<div class="viewcode-block" id="Cavities.add_cavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.add_cavity">[docs]</a>
    <span class="k">def</span> <span class="nf">add_cavity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cavs</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds cavity to cavities</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_labels: list, str</span>
<span class="sd">            Plot labels</span>
<span class="sd">        cavs: Cavity, list</span>
<span class="sd">            Cavity object or list of cavity objects</span>
<span class="sd">        names: list, str</span>
<span class="sd">            Cavity name or list of cavity names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cavs</span><span class="p">,</span> <span class="n">Cavity</span><span class="p">):</span>
            <span class="n">cavs</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>

            <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cav_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_plot_label</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_plot_label</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">)</span>

            <span class="n">cavs</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cavs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">[</span><span class="n">cavs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cavs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="n">cavs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cavs</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span><span class="p">[</span><span class="n">cavs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cavs</span><span class="o">.</span><span class="n">shape_multicell</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cavs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="s2">&quot;Number of cavities does not correspond to number of names.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cav_</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))]</span>

            <span class="k">if</span> <span class="n">plot_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cavs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">),</span> <span class="s2">&quot;Number of cavities does not correspond to number of labels.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_labels</span> <span class="o">=</span> <span class="n">names</span>

            <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cavs</span><span class="p">):</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

                <span class="n">cav</span><span class="o">.</span><span class="n">set_plot_label</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cav</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">shape_multicell</span></div>


<div class="viewcode-block" id="Cavities.set_name">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.set_name">[docs]</a>
    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Cavities.save">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set folder to save cavity analysis results</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files_path: str</span>
<span class="sd">            Save project directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">project_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please specify a folder to write the simulation results to.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">project_folder</span>
                <span class="n">success</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_project</span><span class="p">(</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="n">project_folder</span><span class="si">}</span><span class="s2"> could not be created. Please check the folder and try again.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="n">project_folder</span><span class="si">}</span><span class="s2"> created successfully.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="n">project_folder</span><span class="si">}</span><span class="s2"> created already exists. </span><span class="se">\n\t</span><span class="s2">Set `overwrite=True` to overwrite.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">project_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span></div>


<div class="viewcode-block" id="Cavities.save_plot_as_json">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.save_plot_as_json">[docs]</a>
    <span class="k">def</span> <span class="nf">save_plot_as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">ax_children</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>

        <span class="n">ax_objects_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ax props&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;fig props&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># &#39;line1&#39;: line_properties,</span>
            <span class="p">},</span>
            <span class="s1">&#39;axvline&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;axhline&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;patches&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># get axis properties</span>
        <span class="n">axis_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis_properties</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_objects_dict</span><span class="p">[</span><span class="s1">&#39;ax props&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis_properties</span>

        <span class="c1"># get figure properties</span>
        <span class="n">fig_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_figure_properties</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">())</span>
        <span class="n">ax_objects_dict</span><span class="p">[</span><span class="s1">&#39;fig props&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig_props</span>

        <span class="c1"># List of known properties for Line2D</span>
        <span class="n">line_properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;xdata&#39;</span><span class="p">,</span> <span class="s1">&#39;ydata&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;animated&#39;</span><span class="p">,</span> <span class="s1">&#39;antialiased&#39;</span><span class="p">,</span> <span class="s1">&#39;clip_on&#39;</span><span class="p">,</span> <span class="s1">&#39;clip_path&#39;</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;dash_capstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;dash_joinstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;drawstyle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;markeredgecolor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;markeredgewidth&#39;</span><span class="p">,</span> <span class="s1">&#39;markerfacecolor&#39;</span><span class="p">,</span> <span class="s1">&#39;markersize&#39;</span><span class="p">,</span> <span class="s1">&#39;path_effects&#39;</span><span class="p">,</span> <span class="s1">&#39;rasterized&#39;</span><span class="p">,</span> <span class="s1">&#39;sketch_params&#39;</span><span class="p">,</span>
            <span class="s1">&#39;snap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solid_capstyle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solid_joinstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span> <span class="s1">&#39;zorder&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;transform&#39;,</span>
            <span class="c1"># &#39;clip_box&#39;,</span>
            <span class="c1"># &#39;figure&#39;, &#39;picker&#39;, &#39;pickradius&#39;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">mpl_obj</span> <span class="ow">in</span> <span class="n">ax_children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mpl_obj</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">):</span>
                <span class="c1"># Extract properties into a dictionary</span>
                <span class="n">line_properties_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mpl_obj</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)()</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">line_properties</span><span class="p">}</span>
                <span class="n">ax_objects_dict</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">mpl_obj</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_properties_data</span>

        <span class="k">return</span> <span class="n">ax_objects_dict</span></div>


<div class="viewcode-block" id="Cavities.load_plot_from_json">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.load_plot_from_json">[docs]</a>
    <span class="k">def</span> <span class="nf">load_plot_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">plot_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plot_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[])</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;patches&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="Cavities.plot_from_json">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_from_json">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_config</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plot_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line_keys</span><span class="p">,</span> <span class="n">line_values</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[])</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">line_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># ax[0].scatter(value[&#39;x&#39;], value[&#39;y&#39;], value[&#39;kwargs&#39;])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;patches&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># if value[&#39;type&#39;] == &#39;text&#39;:</span>
                <span class="c1">#     ax[0].add_text(value[&#39;x&#39;], value[&#39;y&#39;], value[&#39;kwargs&#39;])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fig props&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ax props&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

        <span class="c1"># plot legend wthout duplicates</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


    <span class="k">def</span> <span class="nf">_get_axis_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="c1"># List of common properties for an Axis</span>
        <span class="n">axis_properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;margin&#39;</span><span class="p">,</span> <span class="s1">&#39;bound&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect&#39;</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_axis_properties</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">axis_properties</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Use get_* methods dynamically if available</span>
                    <span class="n">getter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">getter</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
                            <span class="n">properties</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span><span class="p">()</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">properties</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Fallback to axis.get_property()</span>
                        <span class="n">properties</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">properties</span>

        <span class="n">axis_properties</span> <span class="o">=</span> <span class="n">get_axis_properties</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">axis_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_axis_properties</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">axis_properties</span>

    <span class="k">def</span> <span class="nf">_get_figure_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">):</span>
        <span class="c1"># List of properties to retrieve</span>
        <span class="n">figure_properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;figwidth&#39;</span><span class="p">,</span> <span class="s1">&#39;figheight&#39;</span><span class="p">,</span> <span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="s1">&#39;tight_layout&#39;</span><span class="p">,</span> <span class="s1">&#39;constrained_layout&#39;</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_figure_properties</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">figure_properties</span><span class="p">:</span>
                <span class="n">getter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">getter</span><span class="p">):</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
            <span class="k">return</span> <span class="n">properties</span>

        <span class="c1"># Get properties of the figure</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fig_properties</span> <span class="o">=</span> <span class="n">get_figure_properties</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig_properties</span>

    <span class="k">def</span> <span class="nf">_create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>

        <span class="k">if</span> <span class="n">project_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># check if folder already exist</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_path_exists</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">project_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># create project structure in folders</span>
                <span class="n">project_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;Cavities&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;OperatingPoints&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;PostData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;Plots&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">project_dir_structure</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;An exception occurred in created project: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># self.projectDir = os.path.join(project_dir, project_name)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Please enter a valid project name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_if_path_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">directory_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Cavities&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;PostData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                             <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">directory_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">It seems that the folder specified is not a cavity project folder. Please check folder&#39;</span>
                              <span class="s1">&#39;again to avoid deleting important files.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Cavities.sweep">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.sweep">[docs]</a>
    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sweep_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">sweep_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">sweep_results</span></div>


<div class="viewcode-block" id="Cavities.plot_dispersion">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_dispersion">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">plot_dispersion</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.check_uq_config">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.check_uq_config">[docs]</a>
    <span class="k">def</span> <span class="nf">check_uq_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
        <span class="n">uq_ok</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">check_uq_config</span><span class="p">(</span><span class="n">uq_config</span><span class="p">)</span>
            <span class="n">uq_ok</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">info</span><span class="p">(</span><span class="n">uq_ok</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.run_tune">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_tune">[docs]</a>
    <span class="k">def</span> <span class="nf">run_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tune_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tune_config: dict</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                tune_config = {</span>
<span class="sd">                            &#39;freqs&#39;: 801.58,</span>
<span class="sd">                            &#39;parameters&#39;: &#39;Req&#39;,</span>
<span class="sd">                            &#39;cell_types&#39;: &#39;mid-cell&#39;,</span>
<span class="sd">                            &#39;processes&#39;: 1,</span>
<span class="sd">                            &#39;rerun&#39;: True</span>
<span class="sd">                        }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tune_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># set default tune_config</span>
            <span class="n">tune_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Req&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span>
                <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">c0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">cav</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span>
                <span class="s1">&#39;cell_types&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mid_cell&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tune variable and frequency not entered, defaulting to </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tune_config</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;freqs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># set default tune_config</span>
            <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">cav</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Target frequency not entered, defaulting to </span><span class="si">{</span><span class="n">tune_config</span><span class="p">[</span><span class="s2">&quot;freqs&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># set default tune_config</span>
            <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Req&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;parameters&quot; not entered, defaulting to </span><span class="si">{</span><span class="n">tune_config</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;cell_types&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># set default tune_config</span>
            <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;cell_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mid_cell&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;cell_types&quot; not entered, defaulting to </span><span class="si">{</span><span class="n">tune_config</span><span class="p">[</span><span class="s2">&quot;cell_types&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;The number of deltas must &quot;</span>
                                                                                     <span class="s2">&quot;be equal to the number of &quot;</span>
                                                                                     <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;The number of epsilons must &quot;</span>
                    <span class="s2">&quot;be equal to the number of &quot;</span>
                    <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;eigenmode_config&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;eigenmode_config&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">uq_config_eig</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of deltas must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of epsilons must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="p">:</span>
            <span class="n">rerun</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rerun</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;rerun should be boolean.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rerun</span>

        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="n">run_tune_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span> <span class="o">=</span> <span class="n">tune_config</span>
        <span class="c1"># get tune results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_tune_res</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.get_tune_res">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_tune_res">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tune_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_ngsolve_tune_res</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tune_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">tune_results</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oops! Something went wrong. Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.run_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">run_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the eigenmode analysis with the given configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eigenmode_config : dict</span>
<span class="sd">            Configuration for running the eigenmode analysis. Example structure:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                eigenmode_config = {</span>
<span class="sd">                    &#39;processes&#39;: 3,</span>
<span class="sd">                    &#39;rerun&#39;: True,</span>
<span class="sd">                    &#39;boundary_conditions&#39;: &#39;mm&#39;,</span>
<span class="sd">                    &#39;uq_config&#39;: {</span>
<span class="sd">                        &#39;variables&#39;: [&#39;A&#39;, &#39;B&#39;, &#39;a&#39;, &#39;b&#39;],</span>
<span class="sd">                        # &#39;objectives&#39;: [&quot;freq [MHz]&quot;, &quot;R/Q [Ohm]&quot;, &quot;Epk/Eacc []&quot;, &quot;Bpk/Eacc [mT/MV/m]&quot;, &quot;G [Ohm]&quot;, &quot;kcc [%]&quot;, &quot;ff [%]&quot;],</span>
<span class="sd">                        &#39;objectives&#39;: [&quot;Epk/Eacc []&quot;, &quot;Bpk/Eacc [mT/MV/m]&quot;, &quot;R/Q [Ohm]&quot;, &quot;G [Ohm]&quot;],</span>
<span class="sd">                        # &#39;objectives&#39;: [&quot;ZL&quot;],</span>
<span class="sd">                        &#39;delta&#39;: [0.05, 0.05, 0.05, 0.05],</span>
<span class="sd">                        &#39;processes&#39;: 4,</span>
<span class="sd">                        &#39;distribution&#39;: &#39;gaussian&#39;,</span>
<span class="sd">                        # &#39;method&#39;: [&#39;QMC&#39;, &#39;LHS&#39;, 1000],</span>
<span class="sd">                        # &#39;method&#39;: [&#39;QMC&#39;, &#39;Sobol&#39;, 1000],</span>
<span class="sd">                        # &#39;method&#39;: [&#39;Qudrature&#39;, &#39;Gaussian&#39;, 1000],</span>
<span class="sd">                        &#39;method&#39;: [&#39;Quadrature&#39;, &#39;Stroud3&#39;],</span>
<span class="sd">                        # &#39;method&#39;: [&#39;Quadrature&#39;, &#39;Stroud5&#39;],</span>
<span class="sd">                        # &#39;gaussian&#39;: [&#39;Quadrature&#39;, &#39;Gaussian&#39;],</span>
<span class="sd">                        # &#39;from file&#39;: [&#39;&lt;file path&gt;&#39;, columns],</span>
<span class="sd">                        &#39;cell_type&#39;: &#39;mid-cell&#39;,</span>
<span class="sd">                        &#39;cell_complexity&#39;: &#39;simplecell&#39;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">eigenmode_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_eigenmode_s</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

        <span class="n">uq_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;The number of deltas must &quot;</span>
                                                                                         <span class="s2">&quot;be equal to the number of &quot;</span>
                                                                                         <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of epsilons must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="c1"># add save directory field to eigenmode_config</span>
            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NGSolveMEVP&#39;</span>
            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">run_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span> <span class="o">=</span> <span class="n">eigenmode_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">(</span><span class="n">uq_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.get_eigenmode_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_eigenmode_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenmode_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
        <span class="c1"># get results</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">eigenmode_qois</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span>
                <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">cav</span><span class="o">.</span><span class="n">get_uq_fm_results</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">uq_dir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_fm_results</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uq_nodes</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_nodes</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results_all_modes</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_fm_results_all_modes</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find eigenmode results. Please rerun eigenmode analysis:: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Cavities.run_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wakefield_config:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                op_points = {</span>
<span class="sd">                            &quot;Z&quot;: {</span>
<span class="sd">                                &quot;freq [MHz]&quot;: 400.79,  # Operating frequency</span>
<span class="sd">                                &quot;E [GeV]&quot;: 45.6,  # &lt;- Beam energy</span>
<span class="sd">                                &quot;I0 [mA]&quot;: 1280,  # &lt;- Beam current</span>
<span class="sd">                                &quot;V [GV]&quot;: 0.12,  # &lt;- Total voltage</span>
<span class="sd">                                &quot;Eacc [MV/m]&quot;: 5.72,  # &lt;- Accelerating field</span>
<span class="sd">                                &quot;nu_s []&quot;: 0.0370,  # &lt;- Synchrotron oscillation tune</span>
<span class="sd">                                &quot;alpha_p [1e-5]&quot;: 2.85,  # &lt;- Momentum compaction factor</span>
<span class="sd">                                &quot;tau_z [ms]&quot;: 354.91,  # &lt;- Longitudinal damping time</span>
<span class="sd">                                &quot;tau_xy [ms]&quot;: 709.82,  # &lt;- Transverse damping time</span>
<span class="sd">                                &quot;f_rev [kHz]&quot;: 3.07,  # &lt;- Revolution frequency</span>
<span class="sd">                                &quot;beta_xy [m]&quot;: 56,  # &lt;- Beta function</span>
<span class="sd">                                &quot;N_c []&quot;: 56,  # &lt;- Number of cavities</span>
<span class="sd">                                &quot;T [K]&quot;: 4.5,  # &lt;- Operating tempereature</span>
<span class="sd">                                &quot;sigma_SR [mm]&quot;: 4.32,  # &lt;- Bunch length</span>
<span class="sd">                                &quot;sigma_BS [mm]&quot;: 15.2,  # &lt;- Bunch length</span>
<span class="sd">                                &quot;Nb [1e11]&quot;: 2.76  # &lt;- Bunch population</span>
<span class="sd">                            }</span>
<span class="sd">                }</span>
<span class="sd">                wakefield_config = {</span>
<span class="sd">                    &#39;bunch_length&#39;: 25,</span>
<span class="sd">                    &#39;wakelength&#39;: 50,</span>
<span class="sd">                    &#39;processes&#39;: 2,</span>
<span class="sd">                    &#39;rerun&#39;: True,</span>
<span class="sd">                    &#39;operating_points&#39;: op_points,</span>
<span class="sd">                }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">wakefield_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wakefield_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_wakefield_s</span>

        <span class="n">wakefield_config_keys</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

        <span class="n">uq_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;The number of deltas must &quot;</span>
                                                                                     <span class="s2">&quot;be equal to the number of &quot;</span>
                                                                                     <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;The number of epsilons must &quot;</span>
                    <span class="s2">&quot;be equal to the number of &quot;</span>
                    <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="s1">&#39;objectives&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter objectives in uq_config.&#39;</span><span class="p">)</span>

            <span class="n">objectives_unprocessed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># adjust objectives to match signature with optimisation</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">objectives_unprocessed</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">objectives_unprocessed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="n">objectives</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">process_objectives</span><span class="p">(</span><span class="n">objectives_unprocessed</span><span class="p">)</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives_unprocessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objectives_unprocessed</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objectives</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uq_config</span>

        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="n">MROT</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">MT</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">NFS</span> <span class="o">=</span> <span class="mi">10000</span>
            <span class="n">wakelength</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">bunch_length</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="n">DDR_SIG</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">DDZ_SIG</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processes</span>

            <span class="k">if</span> <span class="s1">&#39;polarisation&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Polarisation should be 0 for longitudinal, &#39;</span>
                    <span class="s1">&#39;1 for transverse, 2 for both.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MROT</span>

            <span class="k">if</span> <span class="s1">&#39;MT&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;MT must be integer between 4 and 20, with 4 and 20 &#39;</span>
                    <span class="s1">&#39;included.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span>

            <span class="k">if</span> <span class="s1">&#39;NFS&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;NFS must be integer.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NFS</span>

            <span class="c1"># check input configs</span>

            <span class="c1"># beam config</span>
            <span class="n">wake_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">beam_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mesh_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;beam_config&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_config</span>
            <span class="k">if</span> <span class="s1">&#39;wake_config&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wake_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wake_config</span>
            <span class="k">if</span> <span class="s1">&#39;mesh_config&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;mesh_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_config</span>

            <span class="k">if</span> <span class="s1">&#39;bunch_length&#39;</span> <span class="ow">in</span> <span class="n">beam_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">][</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Bunch length must be of type integer or float.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beam_config</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bunch_length</span>

            <span class="c1"># wake config</span>
            <span class="k">if</span> <span class="s1">&#39;wakelength&#39;</span> <span class="ow">in</span> <span class="n">wake_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wake_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Wakelength must be of type integer or float.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wake_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wakelength</span>

            <span class="k">if</span> <span class="s1">&#39;DDR_SIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">mesh_config</span><span class="p">[</span><span class="s1">&#39;DDR_SIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDR_SIG</span>

            <span class="k">if</span> <span class="s1">&#39;DDZ_SIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">mesh_config</span><span class="p">[</span><span class="s1">&#39;DDZ_SIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDZ_SIG</span>

            <span class="n">run_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span> <span class="o">=</span> <span class="n">wakefield_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">(</span><span class="n">uq_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.get_wakefield_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_wakefield_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">wakefield_qois</span>
                <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">cav</span><span class="o">.</span><span class="n">get_uq_hom_results</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;uq.json&quot;</span><span class="p">))</span>
                    <span class="n">cav_uq_hom_results</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_hom_results</span>
                    <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="p">:</span>
                        <span class="c1"># separate into opearating points</span>
                        <span class="n">op_points</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span>
                        <span class="n">uq_hom_results_op</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">op_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">uq_hom_results_op</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                                    <span class="n">sig_id</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">ident</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sig_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">mm&#39;</span>
                                    <span class="n">uq_hom_results_op</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">sig_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">vv</span> <span class="k">for</span> <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="ow">in</span>
                                                                     <span class="n">cav_uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uq_hom_results_op</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_hom_results</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">uq_hom_results_op</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oops! Something went wrong. Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Length of scale_x must be same as number of Cavity objects.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale_x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zl&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zl&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Length of scale_x must be same as number of Cavity objects.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale_x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wpl&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Length of scale_x must be same as number of Cavity objects.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale_x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;wpl&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;wpl&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wpt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Length of scale_x must be same as number of Cavity objects.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale_x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;wpt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;wpt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;logy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;logy&#39;</span><span class="p">]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Cavities.config_sample">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.config_sample">[docs]</a>
    <span class="k">def</span> <span class="nf">config_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config_sample</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.set_cavities_field">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.set_cavities_field">[docs]</a>
    <span class="k">def</span> <span class="nf">set_cavities_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets cavities analysis field range.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">set_Eacc</span><span class="p">(</span><span class="n">Eacc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.compare_power">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.compare_power">[docs]</a>
    <span class="k">def</span> <span class="nf">compare_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E_acc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">E_acc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">=</span> <span class="n">E_acc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cavities_field</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_qois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="c1"># E_acc_Pin(cavity, op_field[i], ls[i], fig, ax, ax_right, ax_right2)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qois</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">cav</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">E_acc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span> <span class="o">=</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.qois_fm">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.qois_fm">[docs]</a>
    <span class="k">def</span> <span class="nf">qois_fm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing fundamental mode quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;kcc [%]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;G [Ohm]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;GR/Q [Ohm^2]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span>
            <span class="p">})</span>

        <span class="n">results_norm_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results_norm_units</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;$e_\mathrm</span><span class="si">{pk}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$b_\mathrm</span><span class="si">{pk}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$r/q$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$g$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$g\cdot r/q $&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.qois_hom">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.qois_hom">[docs]</a>
    <span class="k">def</span> <span class="nf">qois_hom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the higher-order modes quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing higher-order modes quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cavity</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;|k_loss| [V/pC]&quot;</span><span class="p">:</span> <span class="n">cavity</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;|k_kick| [V/pC/m]&quot;</span><span class="p">:</span> <span class="n">cavity</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;P_HOM [kW]&quot;</span><span class="p">:</span> <span class="n">cavity</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.qois_all">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.qois_all">[docs]</a>
    <span class="k">def</span> <span class="nf">qois_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing fundamental mode quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{pk}</span><span class="s2">/E_\mathrm</span><span class="si">{acc}</span><span class="s2"> ~[\cdot]$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$B_\mathrm</span><span class="si">{pk}</span><span class="s2">/E_\mathrm</span><span class="si">{acc}</span><span class="s2"> ~\mathrm{[mT/MV/m]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$R/Q~ \mathrm{[\Omega]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$G ~\mathrm{[\Omega]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~\mathrm{[10^4\Omega^2]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">*</span> <span class="mf">1e-4</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$|k_\parallel| ~\mathrm{[V/pC]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$|k_\perp| ~\mathrm{[V/pC/m]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">/cav~ \mathrm{[kW]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="n">results_norm_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results_norm_units</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;$e_\mathrm</span><span class="si">{pk}</span><span class="s2">/e_\mathrm</span><span class="si">{acc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$b_\mathrm</span><span class="si">{pk}</span><span class="s2">/e_\mathrm</span><span class="si">{acc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$r/q$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$g$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="c1"># r&quot;$g\cdot r/q $&quot;: cav.GR_Q,</span>
                <span class="c1"># r&quot;$|k_\mathrm{FM}|$&quot;: cav.k_fm,</span>
                <span class="sa">r</span><span class="s2">&quot;$|k_\parallel|$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\perp$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$p_\mathrm</span><span class="si">{HOM}</span><span class="s2">/cav$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.plot_uq_geometries">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_uq_geometries">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_uq_geometries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">,</span> <span class="n">axd</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="c1"># plot nominal</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">mid_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_Q&#39;</span>
            <span class="n">uq_geom_folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_folders_with_tag</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

            <span class="c1"># load uq geometries</span>
            <span class="k">for</span> <span class="n">uq_geom_folder</span> <span class="ow">in</span> <span class="n">uq_geom_folders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uq_geom_folder</span><span class="si">}</span><span class="s1">/monopole/geodata.n&#39;</span><span class="p">):</span>
                    <span class="c1"># read geometry</span>
                    <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uq_geom_folder</span><span class="si">}</span><span class="s1">/monopole/geodata.n&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">skipfooter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

                    <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Cavities.find_folders_with_tag">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.find_folders_with_tag">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_folders_with_tag</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="n">matching_folders</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Walk through the directory</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="c1"># Check if the folder name contains the tag</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">):</span>
                    <span class="n">matching_folders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">matching_folders</span></div>


<div class="viewcode-block" id="Cavities.plot_power_comparison">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_power_comparison">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_power_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Can be called using ``cavities.plot_power_comparison()``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fig: matplotlib figure</span>
<span class="sd">        ax_list: list of matplotlib axes object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span>
            <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create figure</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># def E_acc_Pin(self, cavity, E_acc, op_field, ls=&#39;-&#39;, ):</span>

        <span class="c1"># ax_right2._get_lines.prop_cycler = ax._get_lines.prop_cycler</span>
        <span class="c1"># ax_right2.spines[&quot;right&quot;].set_position((&quot;axes&quot;, 1.2))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">pstat</span> <span class="o">/</span> <span class="n">cavity</span><span class="o">.</span><span class="n">n_cav</span><span class="p">,</span>
                     <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{static/cav}$&quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">pdyn</span> <span class="o">/</span> <span class="n">cavity</span><span class="o">.</span><span class="n">n_cav</span><span class="p">,</span>
                     <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{dynamic/cav}$&quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># p1, = ax1.plot(cavity.E_acc * 1e-6, cavity.p_wp/cavity.n_cav,</span>
            <span class="c1">#                ls=self.ls[i], lw=2, c=&#39;k&#39;, label=r&quot;$P_\mathrm{wp/beam}$&quot; + fr&quot;{cavity.name}&quot;)</span>

            <span class="n">p2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">n_cav</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">p3</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">p_in</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:purple&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m]&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{stat, dyn}$/cav [W]&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m]&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$N_\mathrm{cav/beam}$&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m]&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{in/cav}$ [kW]&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-6</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-6</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-6</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                     <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

            <span class="c1"># ax.axvline(7.13, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax.axvline(10, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax.axvline(15, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax_right2.axhline(500, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax_right2.axhline(1000, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax.xaxis.set_major_locator(ticker.MultipleLocator(2))</span>
            <span class="c1"># ax.yaxis.set_major_locator(ticker.MultipleLocator(2))</span>
            <span class="c1"># ax_right.yaxis.set_major_locator(ticker.MultipleLocator(100))</span>
            <span class="c1"># ax_right2.yaxis.set_major_locator(ticker.MultipleLocator(200))</span>

            <span class="c1"># ax.yaxis.label.set_color(p1.get_color())</span>
            <span class="c1"># ax_right.yaxis.label.set_color(p2.get_color())</span>
            <span class="c1"># ax_right2.yaxis.label.set_color(p3.get_color())</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="c1"># # ax.set_ylim(0, 50)</span>
            <span class="c1"># ax_right.set_ylim(100, 400)f</span>
            <span class="c1"># ax_right2.set_ylim(0, 700)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

            <span class="c1"># tkw = dict(size=4, width=1.5)</span>
            <span class="c1"># ax.tick_params(axis=&#39;y&#39;, colors=p1.get_color(), **tkw)</span>
            <span class="c1"># ax_right.tick_params(axis=&#39;y&#39;, colors=p2.get_color(), **tkw)</span>
            <span class="c1"># ax_right2.tick_params(axis=&#39;y&#39;, colors=p3.get_color(), **tkw)</span>
            <span class="c1"># ax.tick_params(axis=&#39;x&#39;, **tkw)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
            <span class="c1"># ax.grid(True, which=&#39;both&#39;, axis=&#39;both&#39;)</span>

        <span class="c1"># dummy lines with NO entries, just to create the black style legend</span>
        <span class="n">dummy_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b_idx</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="n">dummy_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">b_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="n">legend1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span>
                             <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">legend2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">dummy_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))],</span>
                             <span class="p">[</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                             <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">legend1</span><span class="p">)</span>

        <span class="c1"># ax1.legend(ncol=len(cavities))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\mathbf{Z^*}$&quot;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\mathbf{W^*}$&quot;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_comparison.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots bar chart of power quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># plot barchart</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span><span class="p">])</span>
        <span class="n">data_col_max</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.15</span>  <span class="c1"># 1 / len(x)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">data_col_max</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">r</span> <span class="o">+</span> <span class="n">width</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))],</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># label = [&quot;C3794_H (2-Cell)&quot;, &quot;C3795_H (5-Cell)&quot;]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_comparison_bar.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.get_power_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_power_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cav</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cavity: object</span>
<span class="sd">            Cavity object</span>
<span class="sd">        op_field: float</span>
<span class="sd">            Cavity operating field</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">uq</span><span class="p">:</span>
            <span class="n">qois</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">get_power_uq</span><span class="p">(</span><span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qois</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">get_power</span><span class="p">(</span><span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qois</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_power_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_power_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_power_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots bar chart of power quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span> <span class="o">=</span> <span class="n">rf_config</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Lengh of Q0 [] must equal number of Cavity objects.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;inv_eta []&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Lengh of inv_eta [] must equal number of Cavity objects.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;length of accelerating field &#39;</span>
                                                                                   <span class="s1">&#39;Eacc [MV/m] must equal number &#39;</span>
                                                                                   <span class="s1">&#39;of Cavity objects in Cavities.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;length of RF Voltage &#39;</span>
                                                                          <span class="s1">&#39;V [GV] must equal number &#39;</span>
                                                                          <span class="s1">&#39;of operating points.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op_points_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">op_points_list</span><span class="p">]</span>

        <span class="c1"># display formula used</span>
        <span class="n">display</span><span class="p">(</span><span class="n">Math</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dims: </span><span class="si">{}</span><span class="s1">x</span><span class="si">{}</span><span class="s1">m </span><span class="se">\\</span><span class="s1"> Area: </span><span class="si">{}</span><span class="s1">m^2 </span><span class="se">\\</span><span class="s1"> Volume: </span><span class="si">{}</span><span class="s1">m^3&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="c1"># set cavity intrinsic quality factor and inv_eta</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">Q0</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">inv_eta</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;inv_eta []&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># change this later, not effective way</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">power_qois</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power_qois</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_qois_uq</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power_qois</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_points_list</span><span class="p">:</span>
                <span class="c1"># get nominal qois</span>
                <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># for metric, values in metrics[op_pt][&#39;SR&#39;].items():</span>
                    <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span>

                <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">df_nominal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_nominal</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># get uq opt</span>
                <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_qois_uq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">opt_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span><span class="p">)):</span>
                        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                        <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                    <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                                    <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># plot nominal</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_scatter_</span><span class="si">{</span><span class="n">op_points_list</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_fm_scatter</span><span class="p">(</span><span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_fm_bar</span><span class="p">(</span><span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_hom_scatter</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_hom_bar</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span></div>


    <span class="c1"># def plot_compare_hom_bar_(self, opt, ncols=3, uq=False):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Plot bar chart of higher-order mode&#39;s quantities of interest</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # plt.rcParams[&quot;figure.figsize&quot;] = (15 / 27 * 6 * len(self.cavities_list), 3)</span>
    <span class="c1">#     plt.rcParams[&quot;figure.figsize&quot;] = (12, 4)</span>
    <span class="c1">#</span>
    <span class="c1">#     if not uq:</span>
    <span class="c1">#         # plot barchart</span>
    <span class="c1">#         self.hom_results = self.qois_hom(opt)</span>
    <span class="c1">#         df = pd.DataFrame.from_dict(self.hom_results)</span>
    <span class="c1">#         fig, axd = plt.subplot_mosaic([list(df.columns)], layout=&#39;constrained&#39;)</span>
    <span class="c1">#         # Plot each column in a separate subplot</span>
    <span class="c1">#         labels = [cav.plot_label for cav in self.cavities_list]</span>
    <span class="c1">#         for key, ax in axd.items():</span>
    <span class="c1">#             ax.bar(df.index, df[key], label=labels, color=matplotlib.colormaps[&#39;Set2&#39;].colors[:len(df)],</span>
    <span class="c1">#                    edgecolor=&#39;k&#39;, width=1)</span>
    <span class="c1">#             ax.set_xticklabels([])</span>
    <span class="c1">#             ax.set_ylabel(key)</span>
    <span class="c1">#             h, l = ax.get_legend_handles_labels()</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         # Step 1: Flatten the dictionary into a DataFrame</span>
    <span class="c1">#         rows = []</span>
    <span class="c1">#         for cav, metrics in self.uq_hom_results.items():</span>
    <span class="c1">#             for metric, values in metrics.items():</span>
    <span class="c1">#                 rows.append({</span>
    <span class="c1">#                     &#39;cavity&#39;: cav,</span>
    <span class="c1">#                     &#39;metric&#39;: metric,</span>
    <span class="c1">#                     &#39;mean&#39;: values[&#39;expe&#39;][0],</span>
    <span class="c1">#                     &#39;std&#39;: values[&#39;stdDev&#39;][0]</span>
    <span class="c1">#                 })</span>
    <span class="c1">#</span>
    <span class="c1">#         df = pd.DataFrame(rows)</span>
    <span class="c1">#</span>
    <span class="c1">#         labels = [cav.plot_label for cav in self.cavities_list]</span>
    <span class="c1">#</span>
    <span class="c1">#         # Step 2: Create a Mosaic Plot</span>
    <span class="c1">#         metrics = df[&#39;metric&#39;].unique()</span>
    <span class="c1">#         num_metrics = len(metrics)</span>
    <span class="c1">#</span>
    <span class="c1">#         layout = [[metric for metric in metrics]]</span>
    <span class="c1">#         fig, axd = plt.subplot_mosaic(layout, layout=&#39;constrained&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#         # Plot each metric on a separate subplot</span>
    <span class="c1">#         for metric, ax in axd.items():</span>
    <span class="c1">#             sub_df = df[df[&#39;metric&#39;] == metric]</span>
    <span class="c1">#             ax.bar(sub_df[&#39;cavity&#39;], sub_df[&#39;mean&#39;], yerr=sub_df[&#39;std&#39;], label=labels, capsize=5,</span>
    <span class="c1">#                    color=matplotlib.colormaps[&#39;Set2&#39;].colors[:len(df)], edgecolor=&#39;k&#39;,</span>
    <span class="c1">#                    width=1)</span>
    <span class="c1">#</span>
    <span class="c1">#             ax.set_xticklabels([])</span>
    <span class="c1">#             ax.set_xticks([])</span>
    <span class="c1">#             ax.set_ylabel(metric)</span>
    <span class="c1">#             h, l = ax.get_legend_handles_labels()</span>
    <span class="c1">#</span>
    <span class="c1">#     if not ncols:</span>
    <span class="c1">#         ncols = min(4, len(self.cavities_list))</span>
    <span class="c1">#     fig.legend(h, l, loc=&#39;outside upper center&#39;, borderaxespad=0, ncol=ncols)</span>
    <span class="c1">#</span>
    <span class="c1">#     # fig.set_tight_layout(True)</span>
    <span class="c1">#</span>
    <span class="c1">#     # save plots</span>
    <span class="c1">#     fname = [cav.name for cav in self.cavities_list]</span>
    <span class="c1">#     fname = &#39;_&#39;.join(fname)</span>
    <span class="c1">#</span>
    <span class="c1">#     self.save_all_plots(f&quot;{fname}_hom_bar.png&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     return axd</span>

<div class="viewcode-block" id="Cavities.plot_compare_hom_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_hom_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_hom_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of fundamental mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op_points_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">op_points_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">op_points_list</span><span class="p">:</span>

                <span class="c1"># get nominal qois</span>
                <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ops_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">ops_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">_SR&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                            <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

                <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">df_nominal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_nominal</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># get uq opt</span>
                <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">opt_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span><span class="p">)):</span>
                        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                        <span class="n">bar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                     <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">bar</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># plot nominal</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_hom_scatter_</span><span class="si">{</span><span class="n">op_points_list</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_hom_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_hom_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_hom_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of fundamental mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op_points_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">op_points_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">op_points_list</span><span class="p">:</span>

                <span class="c1"># get nominal qois</span>
                <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ops_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">ops_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">_SR&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                            <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

                <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">df_nominal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_nominal</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># get uq opt</span>
                <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">opt_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span><span class="p">)):</span>
                        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                        <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                    <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                                    <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># plot nominal</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_hom_scatter_</span><span class="si">{</span><span class="n">op_points_list</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_fm_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_fm_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_fm_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot bar chart of fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_fm</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)],</span>
                       <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">num_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># fig.set_tight_layout(True)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_fm_bar.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_fm_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_fm_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_fm_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of higher-order mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_fm</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="c1"># layout = [metrics[:4], [*metrics[4:], &#39;.&#39;]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

            <span class="c1"># Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                    <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># plot nominal</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Design Point&#39;</span><span class="p">,</span>
                               <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="c1"># ax.set_ylabel(LABELS[metric])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># by_label = dict(zip(l, h))</span>
        <span class="c1"># if &#39;nominal&#39; in by_label.keys():</span>
        <span class="c1">#     nominal_handle = by_label.pop(&#39;nominal&#39;)  # Remove &#39;nominal&#39; entry</span>
        <span class="c1">#     # Reinsert &#39;nominal&#39; as the last entry</span>
        <span class="c1">#     by_label[&#39;nominal&#39;] = nominal_handle</span>

        <span class="c1"># Set legend</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_fm_scatter.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_all_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_all_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_all_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of fundamental mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get nominal qois</span>
            <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ops_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">ops_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">_SR&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                        <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

            <span class="n">dict_all_nominal</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">dd_nominal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span>
                                <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)}</span>
            <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict_all_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">dict_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                    <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># plot nominal</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                               <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># by_label = dict(zip(l, h))</span>
        <span class="c1"># if &#39;nominal&#39; in by_label.keys():</span>
        <span class="c1">#     nominal_handle = by_label.pop(&#39;nominal&#39;)</span>
        <span class="c1">#     # Reinsert &#39;nominal&#39; as the last entry</span>
        <span class="c1">#     by_label[&#39;nominal&#39;] = nominal_handle</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_all_scatter_</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_all_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_all_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_all_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot bar chart of fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># plot barchart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_all</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_results</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="c1"># Plot each column in a separate subplot</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)],</span>
                   <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># fig.set_tight_layout(True)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_all_bar_</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_cavities_contour">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_cavities_contour">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cavities_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot geometric contour of Cavity objects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt: {&quot;mid&quot;, &quot;end&quot;, &quot;all&quot;}</span>
<span class="sd">            Either plot contour for only mid cells or end cells or the entire cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">figsize</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>

            <span class="k">if</span> <span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">/</span> <span class="n">c0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cav</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span>
                                                  <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span>
                                          <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

            <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$z/\lambda$&quot;</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$r/\lambda$&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">min_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">min_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            <span class="n">max_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">max_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># plt.tight_layout()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_contour_</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span></div>


        <span class="c1"># fig.show()</span>

<div class="viewcode-block" id="Cavities.plot_cavities_contour_dimension">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_cavities_contour_dimension">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cavities_contour_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot geometric contour of Cavity objects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt: {&quot;mid&quot;, &quot;end&quot;, &quot;all&quot;}</span>
<span class="sd">            Either plot contour for only mid cells or end cells or the entire cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">figsize</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">,</span> <span class="n">axs</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>

            <span class="k">if</span> <span class="n">cav</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">mid_cell</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_left</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_right</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span>
                                                  <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">dimension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">mid_cell</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_left</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_right</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span>
                                          <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dimension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

            <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$z$ [mm]&quot;</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$r$ [mm]&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">min_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">min_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            <span class="n">max_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">max_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_dimension.png&quot;</span><span class="p">)</span></div>


        <span class="c1"># fig.show()</span>

<div class="viewcode-block" id="Cavities.plot_axis_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_axis_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_axis_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot axis fields of cavities</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="c1"># normalize fields</span>
            <span class="n">e_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">])</span>
            <span class="n">e_axis_norm</span> <span class="o">=</span> <span class="n">e_axis</span> <span class="o">/</span> <span class="n">e_axis</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># shift to mid</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">]</span>
            <span class="n">z_shift</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_shift</span><span class="p">,</span> <span class="n">e_axis_norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [mm]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$|E_\mathrm{0, z}|/|E_\mathrm{0, z}|_\mathrm</span><span class="si">{max}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_axis_fields.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_surface_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_surface_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_surface_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot surface fields of cavities</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="c1"># normalize fields</span>
            <span class="n">e_surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">surface_field</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">])</span>
            <span class="n">e_surf_norm</span> <span class="o">=</span> <span class="n">e_surf</span> <span class="o">/</span> <span class="n">e_surf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e_surf_norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$L_\mathrm</span><span class="si">{surf}</span><span class="s1">$ [mm]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$|E_\mathrm</span><span class="si">{surf}</span><span class="s1">|/|E_\mathrm</span><span class="si">{surf}</span><span class="s1">|_\mathrm</span><span class="si">{max}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_surface_fields.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_multipac_triplot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_multipac_triplot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_multipac_triplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;triplot&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Multipac triplot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folders: list, array like</span>
<span class="sd">            List of folder to read multipacting results from</span>
<span class="sd">        kind</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This will be changed later so that the multipac results will be in the same location as the SLANS and ABCI</span>
<span class="sd">        results</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
            <span class="c1"># create figure</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

        <span class="n">Eacc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">Epk_Eacc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">Eacc</span><span class="p">,</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Eacc_list</span><span class="p">,</span> <span class="n">Epk_Eacc_list</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="c1"># load_output_data</span>
            <span class="c1"># files</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Ccounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;Acounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;Atcounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;Efcounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;geodata.n&quot;</span><span class="p">,</span> <span class="s2">&quot;secy1&quot;</span><span class="p">,</span> <span class="s2">&quot;counter_flevels.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;counter_initials.mat&quot;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># files_folder = &quot;D:\Dropbox\multipacting\MPGUI21&quot;</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;.mat&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">spio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">A</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Acounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
            <span class="n">At</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Atcounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;At&quot;</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ccounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
            <span class="n">Ef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Efcounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;Ef&quot;</span><span class="p">]</span>
            <span class="n">flevel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;counter_flevels.mat&quot;</span><span class="p">][</span><span class="s2">&quot;flevel&quot;</span><span class="p">]</span>
            <span class="n">initials</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;counter_initials.mat&quot;</span><span class="p">][</span><span class="s2">&quot;initials&quot;</span><span class="p">]</span>
            <span class="n">secy1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;secy1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">Pow</span> <span class="o">=</span> <span class="n">flevel</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initials</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># number of initials in the bright set</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># number of impacts</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">flevel</span>
            <span class="n">Efl</span> <span class="o">=</span> <span class="n">flevel</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mf">1.6021773e-19</span>
            <span class="n">Efq</span> <span class="o">=</span> <span class="n">Ef</span> <span class="o">/</span> <span class="n">q</span>

            <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># lower threshold</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># upper threshold</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">e3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># maximum secondary yield</span>

            <span class="n">cl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ok</span><span class="p">,</span> <span class="n">ok1</span><span class="p">,</span> <span class="n">ok2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ok</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to plot the counters. No initial points.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">ok1</span> <span class="o">*</span> <span class="n">ok2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cl</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Counter functions or impact energy missing.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if ss &gt; 0:</span>
                    <span class="c1">#     cl = error(np.array([&#39;Plotting the triplot (counter, enhanced &#39;, &#39;counter and impact energy).&#39;]))</span>

                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;counter function&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
                        <span class="c1"># fig, axs = plt.subplots(3)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Efl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">C</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$c_&quot;</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}/ c_0 $&quot;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\mathrm</span><span class="si">{pk}</span><span class="s1">$ [MV/m]&#39;</span><span class="p">)</span>
                        <span class="c1"># axs[0].set_title(r&#39;$\mathbf{MultiPac 2.1~~~~~Counter function~~~~}$&#39;)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]]))</span>

                        <span class="c1"># plot peak operating field</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Epk_Eacc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                    <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;final impact energy&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;final impact energy&#39;</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">Efl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">Efq</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

                        <span class="c1"># axs[1-s].plot([np.min(Efl) / 1e6, np.max(Efl) / 1e6], [secy1[e1, 0], secy1[e1, 0]], &#39;-r&#39;)</span>
                        <span class="n">e0</span> <span class="o">=</span> <span class="n">sci</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">secy1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">e1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">secy1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">e1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="n">e0</span><span class="p">,</span> <span class="n">e0</span><span class="p">],</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="n">secy1</span><span class="p">[</span><span class="n">e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">secy1</span><span class="p">[</span><span class="n">e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="n">secy1</span><span class="p">[</span><span class="n">e3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">secy1</span><span class="p">[</span><span class="n">e3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;--r&#39;</span><span class="p">)</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$Ef_&quot;</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}$&quot;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\mathrm</span><span class="si">{pk}</span><span class="s1">$ [MV/m]&#39;</span><span class="p">)</span>
                        <span class="c1"># axs[1-s].set_title(&#39;$\mathbf{Final~Impact~Energy~in~eV}$&#39;)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Epk_Eacc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                                        <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;enhanced counter function&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;enhanced counter function&#39;</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">Efl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$V$ [MV]&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">A</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">),</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$e_&quot;</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="s2">&quot;/ c_0$&quot;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\mathrm</span><span class="si">{pk}</span><span class="s1">$ [MV/m]&#39;</span><span class="p">)</span>
                        <span class="c1"># axs[2-s].set_title(&#39;$\mathbf{Enhanced~counter~function}$&#39;)</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Epk_Eacc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                                        <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="c1"># def plot_dispersion(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Plot dispersion curve for the cavities</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     fig, ax = plt.subplots()</span>
    <span class="c1">#     ax.margins(x=0)</span>
    <span class="c1">#     for cav in self.cavities_list:</span>
    <span class="c1">#         x = range(1, cav.n_cells + 1)</span>
    <span class="c1">#         ax.plot(x, cav.d_slans_all_results[&#39;FREQUENCY&#39;][0:cav.n_cells], marker=&#39;o&#39;, mec=&#39;k&#39;,</span>
    <span class="c1">#                 label=f&#39;{cav.name} (kcc={round(cav.k_cc, 2)} %)&#39;)</span>
    <span class="c1">#         ax.set_xlabel(&#39;Mode Number&#39;)</span>
    <span class="c1">#         ax.set_ylabel(&#39;Frequency [MHz]&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     plt.legend()</span>
    <span class="c1">#</span>
    <span class="c1">#     # save plots</span>
    <span class="c1">#     fname = [cav.name for cav in self.cavities_list]</span>
    <span class="c1">#     fname = &#39;_&#39;.join(fname)</span>
    <span class="c1">#</span>
    <span class="c1">#     self.save_all_plots(f&quot;{fname}_dispersion.png&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     plt.show()</span>
    <span class="c1">#</span>
    <span class="c1"># # def ql_pin(self, labels, geometry, RF, QOI, Machine, p_data=None):</span>
    <span class="c1"># #     &quot;&quot;&quot;</span>
    <span class="c1"># #     Calculate the value of input power as a function of loaded quality factor</span>
    <span class="c1"># #</span>
    <span class="c1"># #     Parameters</span>
    <span class="c1"># #     ----------</span>
    <span class="c1"># #     labels: list, array like</span>
    <span class="c1"># #         Descriptive labels on matplotlib plot</span>
    <span class="c1"># #     geometry: list, array like</span>
    <span class="c1"># #         List of grouped geometric input parameters</span>
    <span class="c1"># #     RF: list, array like</span>
    <span class="c1"># #         List of grouped radio-frequency (RF) properties</span>
    <span class="c1"># #     QOI:</span>
    <span class="c1"># #         List of quantities of interest for cavities</span>
    <span class="c1"># #     Machine:</span>
    <span class="c1"># #         List of grouped machine related materials</span>
    <span class="c1"># #     p_data:</span>
    <span class="c1"># #</span>
    <span class="c1"># #</span>
    <span class="c1"># #     Returns</span>
    <span class="c1"># #     -------</span>
    <span class="c1"># #</span>
    <span class="c1"># #     &quot;&quot;&quot;</span>
    <span class="c1"># #     # check if entries are of same length</span>
    <span class="c1"># #</span>
    <span class="c1"># #     it = iter(geometry)</span>
    <span class="c1"># #     the_len = len(next(it))</span>
    <span class="c1"># #     if not all(len(l) == the_len for l in it):</span>
    <span class="c1"># #         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     it = iter(RF)</span>
    <span class="c1"># #     the_len = len(next(it))</span>
    <span class="c1"># #     if not all(len(l) == the_len for l in it):</span>
    <span class="c1"># #         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     it = iter(QOI)</span>
    <span class="c1"># #     the_len = len(next(it))</span>
    <span class="c1"># #     if not all(len(l) == the_len for l in it):</span>
    <span class="c1"># #         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     it = iter(Machine)</span>
    <span class="c1"># #     the_len = len(next(it))</span>
    <span class="c1"># #     if not all(len(l) == the_len for l in it):</span>
    <span class="c1"># #         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     n_cells, l_cells, G, b = [np.array(x) for x in geometry]</span>
    <span class="c1"># #     E_acc, Vrf = [np.array(x) for x in RF]</span>
    <span class="c1"># #</span>
    <span class="c1"># #     fig, ax = plt.subplots()</span>
    <span class="c1"># #     ax.margins(x=0)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     # QOI</span>
    <span class="c1"># #     f0, R_Q = [np.array(x) for x in QOI]</span>
    <span class="c1"># #</span>
    <span class="c1"># #     # Machine</span>
    <span class="c1"># #     I0, rho, E0 = [np.array(x) for x in Machine]</span>
    <span class="c1"># #</span>
    <span class="c1"># #     l_active = 2 * n_cells * l_cells</span>
    <span class="c1"># #     l_cavity = l_active + 8 * l_cells</span>
    <span class="c1"># #</span>
    <span class="c1"># #     # CALCULATED</span>
    <span class="c1"># #     v_cav = E_acc * l_active</span>
    <span class="c1"># #</span>
    <span class="c1"># #     U_loss = 88.46 * E0 ** 4 / rho * 1e-6  # GeV # energy lost per turn per beam</span>
    <span class="c1"># #     v_loss = U_loss * 1e9  # V # v loss per beam</span>
    <span class="c1"># #</span>
    <span class="c1"># #     phi = np.arccos(v_loss / Vrf)</span>
    <span class="c1"># #     delta_f = -R_Q * f0 * I0 * np.sin(phi) / (2 * v_cav)  # optimal df</span>
    <span class="c1"># #     QL_0_x = v_cav / (R_Q * I0 * np.cos(phi))  # optimal Q loaded</span>
    <span class="c1"># #</span>
    <span class="c1"># #     QL_0 = np.linspace(1e4, 1e9, 1000000)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     xy_list = [(0.15, 0.13), (0.1, 0.16), (0.1, 0.19), (0.1, 0.21)]</span>
    <span class="c1"># #     for i in range(len(E_acc)):</span>
    <span class="c1"># #         f1_2 = f0[i] / (2 * QL_0)  # 380.6</span>
    <span class="c1">#</span>
    <span class="c1"># #         pin = v_cav[i] ** 2 / (4 * R_Q[i] * QL_0) * \</span>
    <span class="c1"># #               ((1 + ((R_Q[i] * QL_0 * I0[i]) / v_cav[i]) * np.cos(phi[i])) ** 2 +</span>
    <span class="c1"># #                ((delta_f[i] / f1_2) + ((R_Q[i] * QL_0 * I0[i]) / v_cav[i]) * np.sin(phi[i])) ** 2)</span>
    <span class="c1"># #</span>
    <span class="c1"># #         # material/ wall power</span>
    <span class="c1"># #         e_acc = np.linspace(0.5, 25, 1000) * 1e6  # MV/m</span>
    <span class="c1"># #</span>
    <span class="c1"># #         txt = labels[i]</span>
    <span class="c1"># #</span>
    <span class="c1"># #         if &quot;*&quot; in labels[i]:</span>
    <span class="c1"># #             l = ax.plot(QL_0, pin * 1e-3, label=txt, lw=4,</span>
    <span class="c1"># #                         ls=&#39;--&#39;)</span>
    <span class="c1"># #         else:</span>
    <span class="c1"># #             l = ax.plot(QL_0, pin * 1e-3, label=txt, lw=4)</span>
    <span class="c1"># #</span>
    <span class="c1"># #         # add annotations</span>
    <span class="c1"># #</span>
    <span class="c1"># #         # annotext = ax.annotate(txt, xy=xy_list[i], xycoords=&#39;figure fraction&#39;, size=8, rotation=0,</span>
    <span class="c1"># #         #                        c=l[0].get_color())</span>
    <span class="c1"># #</span>
    <span class="c1"># #     if p_data:</span>
    <span class="c1"># #         # plot QL with penetration</span>
    <span class="c1"># #         ax_2 = ax.twinx()</span>
    <span class="c1"># #         data = fr.excel_reader(p_data)</span>
    <span class="c1"># #         data_ = data[list(data.keys())[0]]</span>
    <span class="c1"># #         ax_2.plot(data_[&quot;QL&quot;], data_[&quot;penetration&quot;], lw=4)</span>
    <span class="c1"># #</span>
    <span class="c1"># #     # plot decorations</span>
    <span class="c1"># #     ax.set_xlabel(r&quot;$Q_{L,0}$&quot;)</span>
    <span class="c1"># #     ax.set_ylabel(r&quot;$P_\mathrm{in} ~[\mathrm{kW}]$&quot;)</span>
    <span class="c1"># #     ax.set_xscale(&#39;log&#39;)</span>
    <span class="c1"># #     ax.set_xlim(5e3, 1e9)</span>
    <span class="c1"># #     ax.set_ylim(0, 3000)</span>
    <span class="c1"># #     ax.legend(loc=&#39;upper left&#39;)  #</span>
    <span class="c1"># #     ax.minorticks_on()</span>
    <span class="c1"># #     # ax.grid(which=&#39;both&#39;)</span>
    <span class="c1"># #     fig.show()</span>

<div class="viewcode-block" id="Cavities.run_abci">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_abci">[docs]</a>
    <span class="k">def</span> <span class="nf">run_abci</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">run_abci</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.run_multipacting">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_multipacting">[docs]</a>
    <span class="k">def</span> <span class="nf">run_multipacting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">run_multipacting</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.define_operating_points">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.define_operating_points">[docs]</a>
    <span class="k">def</span> <span class="nf">define_operating_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="n">ops</span></div>


<div class="viewcode-block" id="Cavities.linspace">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.linspace">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like np.linspace but uses step instead of num</span>
<span class="sd">        This is inclusive to stop, so if start=1, stop=3, step=0.5</span>
<span class="sd">        Output is: array([1., 1.5, 2., 2.5, 3.])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ll</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">start</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ll</span></div>


<div class="viewcode-block" id="Cavities.lineTo">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.lineTo">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">lineTo</span><span class="p">(</span><span class="n">prevPt</span><span class="p">,</span> <span class="n">nextPt</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># vertical line</span>
            <span class="c1"># chwxk id nextPt is greater</span>
            <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">py</span><span class="p">))</span> <span class="o">*</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># horizontal line</span>
            <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>

            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">px</span><span class="p">))</span> <span class="o">*</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate angle to get appropriate step size for x and y</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">px</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">px</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


        <span class="c1"># plt.plot(px, py)</span>

<div class="viewcode-block" id="Cavities.arcTo2">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.arcTo2">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">arcTo2</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start_angle</span><span class="p">,</span> <span class="n">end_angle</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">x_center</span>  <span class="c1"># x-position of the center</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">y_center</span>  <span class="c1"># y-position of the center</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># radius on the x-axis</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>  <span class="c1"># radius on the y-axis</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_angle</span> <span class="o">/</span> <span class="mi">360</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># convert angle to radians</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_angle</span> <span class="o">/</span> <span class="mi">360</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># convert angle to radians</span>

        <span class="k">if</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="n">sa</span><span class="p">:</span>
            <span class="c1"># end point of curve</span>
            <span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sa</span><span class="p">),</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># t = np.linspace(ea, sa, 100)</span>
            <span class="c1"># check if end angle is included, include if not</span>
            <span class="k">if</span> <span class="n">sa</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sa</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># end point of curve</span>
            <span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># t = np.linspace(ea, sa, 100)</span>
            <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ea</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span><span class="p">]</span></div>


<div class="viewcode-block" id="Cavities.arcTo">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.arcTo">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">arcTo</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">x_center</span>  <span class="c1"># x-position of the center</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">y_center</span>  <span class="c1"># y-position of the center</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># radius on the x-axis</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>  <span class="c1"># radius on the y-axis</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="n">inidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pts</span><span class="p">,</span> <span class="n">pts</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">inidx</span><span class="p">]</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">inbox</span><span class="p">[</span><span class="n">inbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

        <span class="c1"># plt.plot(inbox[:, 0], inbox[:, 1])</span>

        <span class="k">return</span> <span class="n">inbox</span></div>


<div class="viewcode-block" id="Cavities.make_latex_summary_tables">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.make_latex_summary_tables">[docs]</a>
    <span class="k">def</span> <span class="nf">make_latex_summary_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">op_pts_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="c1"># create new sub directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Geometric parameters of &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity geometries.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>
                <span class="n">A</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$A$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">B</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">a</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$a$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">b</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$b$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{i}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">L</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$L$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Req</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{eq}</span><span class="s2">$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ \alpha [^\circ]$&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> geometric properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_geom_latex.tex&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;fm&#39;</span><span class="p">:</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{FM QoIs of &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity geometries.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. [MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">R_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~[\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">G</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G$ ~[$\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">GR_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~[10^4\Omega^2]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">kcc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">~[\%]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">epk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">}$ []&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">bpk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">} ~\left[\mathrm{\frac</span><span class="si">{mT}</span><span class="s2">{MV/m}}\right]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> fm properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">rf_freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">GR_Q</span><span class="p">,</span> <span class="n">kcc</span><span class="p">,</span> <span class="n">epk</span><span class="p">,</span> <span class="n">bpk</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>
                <span class="c1"># save plots</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_fm_latex.tex&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;hom&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_pts_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op_pts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{HOM QoIs of &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity geometries for the &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">op_pt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">op_pts_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; operating points.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}{c|}{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">kfm</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm</span><span class="si">{FM}</span><span class="s2">|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_fm</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_fm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_fm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kloss</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_loss</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_loss</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kkick</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_kick</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_kick</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> hom properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">kfm</span><span class="p">,</span> <span class="n">kloss</span><span class="p">,</span> <span class="n">kkick</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_hom_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;qois&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_pts_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op_pts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Geometric parameters and QoIs of cavities.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}</span><span class="si">{c}</span><span class="s1">{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. ~[MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">R_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~\mathrm{[\Omega$]} &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">G</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G$ ~[$\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">GR_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~[10^4\Omega^2]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">kcc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">~[\%]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">epk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">}$ []&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">bpk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">} ~\left[\mathrm{\frac</span><span class="si">{mT}</span><span class="s2">{MV/m}}\right]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kfm</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_fm</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_fm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_fm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kloss</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_loss</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_loss</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kkick</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_kick</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_kick</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Ncav</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Q0</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Q_\mathrm</span><span class="si">{0}</span><span class="s2">~[]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Pin</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">\mathrm{/cav} [\mathrm</span><span class="si">{kW}</span><span class="s2">]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pin/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pstat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pstat/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pdyn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pdyn/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pwp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pwp/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">PHOM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$ ~[kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: selected shape}&quot;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">rf_freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">GR_Q</span><span class="p">,</span> <span class="n">kcc</span><span class="p">,</span> <span class="n">epk</span><span class="p">,</span> <span class="n">bpk</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">kfm</span><span class="p">,</span> <span class="n">kloss</span><span class="p">,</span> <span class="n">kkick</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span> <span class="n">Ncav</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Pstat</span><span class="p">,</span> <span class="n">Pdyn</span><span class="p">,</span> <span class="n">Pwp</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span> <span class="n">PHOM</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_qois_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_pts_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op_pts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Static, dynamic and HOM power loss and input power per cavity for &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity geometries for the &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">op_pt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">op_pts_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; operating points.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}{c|}{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. [MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">Vrf</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{RF}</span><span class="s2">$ [GV] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Vrf</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{RF}</span><span class="s2">$ [GV] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Eacc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">Eacc_rf_config</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Ncav</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Q0</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Q_\mathrm</span><span class="si">{0}</span><span class="s2">$~[]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Pin</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">\mathrm{/cav} ~[\mathrm</span><span class="si">{kW}</span><span class="s2">]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pin/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pstat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pstat/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pdyn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pdyn/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pwp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pwp/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">PHOM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$ [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> power properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span> <span class="n">rf_freq</span><span class="p">,</span> <span class="n">Vrf</span><span class="p">,</span> <span class="n">Eacc</span><span class="p">,</span> <span class="n">Ncav</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Pstat</span><span class="p">,</span> <span class="n">Pdyn</span><span class="p">,</span> <span class="n">Pwp</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="c1"># PHOM,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Geometric parameters and QoIs of cavities.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}</span><span class="si">{c}</span><span class="s1">{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>
                <span class="n">A</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$A$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">B</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">a</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$a$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">b</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$b$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{i}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">L</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$L$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Req</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{eq}</span><span class="s2">$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ \alpha [^\circ]$&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. ~[MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Vrf</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{RF}</span><span class="s2">$ ~[GV] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Eacc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">R_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~[\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">G</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G$ [$\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">GR_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~[10^4\Omega^2]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">epk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">}$ [] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">bpk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">} \left[\mathrm{\frac</span><span class="si">{mT}</span><span class="s2">{MV/m}}\right]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kfm</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_fm</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_fm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_fm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kloss</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_loss</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_loss</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kkick</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_kick</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_kick</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="c1"># kloss = r&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(k_loss, 4)) for k_loss in cav.k_loss])} &quot; for cav in</span>
                <span class="c1">#      self.cavities_list]) + r&quot; \\&quot;</span>
                <span class="c1">#</span>
                <span class="c1"># kkick = r&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(k_kick, 4)) for k_kick in cav.k_kick])} &quot; for cav in</span>
                <span class="c1">#      self.cavities_list]) + r&quot; \\&quot;</span>

                <span class="n">Ncav</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Q0</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Q_\mathrm</span><span class="si">{0}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Pin</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">\mathrm{/cav} [\mathrm</span><span class="si">{kW}</span><span class="s2">]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pin/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pstat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pstat/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pdyn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pdyn/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pwp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pwp/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="c1"># Phom = r&quot;$P_\mathrm{HOM}$/cav [kW] &quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(phom, 4)) for phom in cav.phom])} &quot; for cav in self.cavities_list]) + r&quot; \\&quot;</span>

                <span class="n">phom_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">phom</span> <span class="k">for</span> <span class="n">phom</span> <span class="ow">in</span> <span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="p">]</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span>

                <span class="c1"># if len(phom_values) % 2 == 0:</span>
                <span class="c1">#     result_array = phom_values[1::2] - phom_values[::2]</span>
                <span class="c1">#</span>
                <span class="c1">#     Phom_diff = r&quot;$\Delta P_\mathrm{HOM}$/cav [W] &amp; \multicolumn{2}{c|}{&quot; + &quot; &amp; \multicolumn{2}{c|}{&quot;.join(</span>
                <span class="c1">#         [fr&quot;{&#39;/&#39;.join([str(round(val * 1e3, 2)) for val in arr])} &quot; + &#39;}&#39; for arr in result_array]) + r&quot; \\&quot;</span>

                <span class="n">PHOM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$ [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="c1"># PHOM = r&quot;$P_\mathrm{HOM}$ [kW] &quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(phom * cav.n_cav_op_field, 2)) for phom in cav.phom])} &quot; for cav in</span>
                <span class="c1">#      self.cavities_list]) + r&quot; \\&quot;</span>

                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: selected shape}&quot;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">rf_freq</span><span class="p">,</span> <span class="n">Vrf</span><span class="p">,</span> <span class="n">Eacc</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">GR_Q</span><span class="p">,</span> <span class="n">epk</span><span class="p">,</span> <span class="n">bpk</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">kfm</span><span class="p">,</span> <span class="n">kloss</span><span class="p">,</span> <span class="n">kkick</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span> <span class="n">Ncav</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Pstat</span><span class="p">,</span> <span class="n">Pdyn</span><span class="p">,</span> <span class="n">Pwp</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span> <span class="n">PHOM</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_all_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either NGSolve or ABCI results not available. Please use &#39;&lt;cav&gt;.set_eigenmode_qois(&lt;folder&gt;)&#39; &quot;</span>
                  <span class="s2">&quot;or &#39;&lt;cav&gt;.set_wakefield_qois(&lt;folder&gt;)&#39; to fix this. Error: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.make_excel_summary">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.make_excel_summary">[docs]</a>
    <span class="k">def</span> <span class="nf">make_excel_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">project</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;CW/Pulsed&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">cw_pulsed</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Material&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">material</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;N_cells&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">n_cells</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Freq [MHz]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">op_freq</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Beta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">beta</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;T_oper [K]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">op_temp</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;I0 [mA]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">I0</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;sigma [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">sigma</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;A_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;B_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;a_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;b_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Req [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;alpha_i [deg]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;A_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;B_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;a_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;b_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="c1"># &#39;Req [mm]&#39;: [round(cav.shape_space[&#39;OC&#39;][6], 2) for cav in self.cavities_list],</span>
                    <span class="s1">&#39;alpha__el [deg]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;A_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;B_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;a_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;b_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="c1"># &#39;Req [mm]&#39;: [round(cav.shape_space[&#39;OC&#39;][6], 2) for cav in self.cavities_list],</span>
                    <span class="s1">&#39;alpha_er [deg]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_shunt [Ohm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;k_cc [%]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;field flatness [%]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">ff</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_active [m]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">l_active</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Epk/Eacc []&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Bpk/Eacc [mT/MV/m]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;G [Ohm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R/Q.G [Ohm^2]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;P_HOM/cav [kW]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">reference</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                    <span class="p">}</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_excel_summary.xlsx&quot;</span><span class="p">),</span>
                <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Cavities&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either SLANS or ABCI results not available. Please use &#39;&lt;cav&gt;.set_slans_qois(&lt;folder&gt;)&#39; &quot;</span>
                  <span class="s2">&quot;or &#39;&lt;cav&gt;.set_wakefield_qois(&lt;folder&gt;)&#39; to fix this.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.remove_cavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.remove_cavity">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_cavity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cav</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes cavity from cavity list</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cav: object</span>
<span class="sd">            Cavity object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cav</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.save_all_plots">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.save_all_plots">[docs]</a>
    <span class="k">def</span> <span class="nf">save_all_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save all plots</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_name: str</span>
<span class="sd">            Name of saved plot</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># check if folder exists</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots&quot;</span><span class="p">):</span>
                <span class="c1"># create new subdirectory</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">save_folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">save_folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.calc_limits">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.calc_limits">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">selection</span>
            <span class="n">E0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;E [GeV]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">nu_s</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;nu_s []&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">I0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;I0 [mA]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">alpha_c</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">tau_z</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">tau_xy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">f_rev</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">beta_xy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">n_cav</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;N_c []&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>

            <span class="n">unit</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MHz&#39;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>
                    <span class="s1">&#39;GHz&#39;</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">}</span>

            <span class="n">Z_list</span><span class="p">,</span> <span class="n">ZT_le</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;longitudinal&#39;</span><span class="p">:</span>
                <span class="n">f_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="n">Z_le</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_cav</span><span class="p">):</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">E0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">*</span> <span class="n">nu_s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                             <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">I0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">alpha_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">tau_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span>
                             <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">1e-8</span> <span class="k">else</span> <span class="mf">1e5</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">]</span>

                        <span class="n">Z_le</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">E0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">*</span> <span class="n">nu_s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                             <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">I0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">alpha_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-5</span>
                                                <span class="o">*</span> <span class="n">tau_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

                        <span class="n">Z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># convert to kOhm</span>

                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;ZeroDivisionError, check input&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">f_list</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">cols</span>

            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;transversal&#39;</span><span class="p">:</span>

                <span class="n">f_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># print(E0, beta_xy, tau_xy, n_cav, f_rev, I0)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_cav</span><span class="p">):</span>
                        <span class="c1"># print(E0[i], beta_xy[i], tau_xy[i], n_cav[i], f_rev[i], I0[i])</span>
                        <span class="n">ZT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">E0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">I0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">beta_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">tau_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">f_rev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span>
                        <span class="n">ZT_le</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ZT</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="n">Z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZT</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># convert to kOhm/m</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;ZeroDivisionError, check input&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">f_list</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">cols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Please load a valid operating point(s) file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot_thresholds">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_thresholds">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncav_mod</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">labels_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">update_text_positions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Callback function to update the text positions based on current limits.&quot;&quot;&quot;</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">labels_info</span><span class="p">:</span>
                <span class="c1"># Check if the label is out of bounds</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># Reposition the label to the center of the current view</span>
                    <span class="n">axes_coord</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="c1"># Transform axes coordinate to display coordinate</span>
                    <span class="n">display_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">axes_coord</span><span class="p">)</span>
                    <span class="c1"># Transform display coordinate to data coordinate</span>
                    <span class="n">data_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">display_coord</span><span class="p">)</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">data_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span> <span class="o">-</span> <span class="n">new_x</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                    <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;text_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_texts_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s1">&#39;longitudinal&#39;</span><span class="p">:</span>
            <span class="c1"># calculate limits</span>
            <span class="n">f_list</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_limits</span><span class="p">(</span><span class="s1">&#39;longitudinal&#39;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

            <span class="c1"># plot baselines</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">aa</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f_list</span><span class="p">,</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">labels_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">aa</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">axis_data_coords_sys_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_list</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="c1"># x, y = axis_data_coords_sys_transform(ax, f_list[indx], z[indx], True)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">LABELS</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span>

                <span class="n">ab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">txt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">))</span>
                <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span>
                                                   <span class="s1">&#39;text_obj&#39;</span><span class="p">:</span> <span class="n">ab</span><span class="p">}</span>
                <span class="c1"># ab = add_text(ax, txt, box=&quot;Square&quot;, xy=(x, y), xycoords=&#39;axes fraction&#39;, size=12)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold_texts_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate limits</span>
            <span class="n">f_list</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_limits</span><span class="p">(</span><span class="s1">&#39;transversal&#39;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

            <span class="c1"># plot baselines</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">labels_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">aa</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">axis_data_coords_sys_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_list</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="c1"># x, y = axis_data_coords_sys_transform(ax, f_list[indx], z, True)</span>

                <span class="n">txt</span> <span class="o">=</span> <span class="n">LABELS</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span>

                <span class="n">ab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">))</span>
                <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s1">&#39;text_obj&#39;</span><span class="p">:</span> <span class="n">ab</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold_texts_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

        <span class="c1"># Attach the callback to limit changes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;xlim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;ylim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_adjust_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">separation</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">renderer</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_text_bbox</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">)</span>
            <span class="n">bbox_axes_coords</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">bbox_axes_coords</span>

        <span class="k">def</span> <span class="nf">calculate_adjustment</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">):</span>
            <span class="n">center1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bbox1</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">center2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bbox2</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">pos1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">text1</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>
            <span class="n">pos2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">text2</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">bbox2</span><span class="p">):</span>
                <span class="n">overlap_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
                <span class="n">overlap_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">y0</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">overlap_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">midpoint_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">center1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">center2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">x1</span><span class="p">:</span>
                        <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">+</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">separation</span>
                        <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">-</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">separation</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">-</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">separation</span>
                        <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">+</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">separation</span>

                <span class="c1"># if overlap_y &gt; 0:</span>
                <span class="c1">#     midpoint_y = (center1[1] + center2[1]) / 2</span>
                <span class="c1">#     if bbox1.y1 &gt; bbox2.y1:</span>
                <span class="c1">#         pos1[1] = midpoint_y + bbox1.height / 2 + separation</span>
                <span class="c1">#         pos2[1] = midpoint_y - bbox2.height / 2 - separation</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         pos1[1] = midpoint_y - bbox1.height / 2 - separation</span>
                <span class="c1">#         pos2[1] = midpoint_y + bbox2.height / 2 + separation</span>

            <span class="k">return</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span>

        <span class="c1"># Run the adjustment algorithm</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
                <span class="n">bbox1</span> <span class="o">=</span> <span class="n">get_text_bbox</span><span class="p">(</span><span class="n">text1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">text2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">bbox2</span> <span class="o">=</span> <span class="n">get_text_bbox</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">bbox2</span><span class="p">):</span>
                        <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span> <span class="o">=</span> <span class="n">calculate_adjustment</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">)</span>
                        <span class="n">text1</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">text2</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Ensure the texts are within the plot limits</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">text</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<div class="viewcode-block" id="Cavities.plot_cutoff">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_cutoff">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ri_list</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">labels_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">update_text_positions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Callback function to update the text positions based on current limits.&quot;&quot;&quot;</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">labels_info</span><span class="p">:</span>
                <span class="c1"># Check if the label is out of bounds</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># Reposition the label to the center of the current view</span>
                    <span class="n">axes_coord</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
                    <span class="c1"># Transform axes coordinate to display coordinate</span>
                    <span class="n">display_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">axes_coord</span><span class="p">)</span>
                    <span class="c1"># Transform display coordinate to data coordinate</span>
                    <span class="n">data_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">display_coord</span><span class="p">)</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="n">data_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span> <span class="o">-</span> <span class="n">new_y</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                    <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;text_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">f_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_beampipe_cutoff</span><span class="p">(</span><span class="n">Ri_list</span><span class="p">,</span> <span class="n">which</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">Ri</span> <span class="ow">in</span> <span class="n">Ri_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mode_type</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">f_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]):</span>
                <span class="n">vl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>  <span class="c1"># label=f&quot;{sc[0]} cutoff (Ri={sc[1]})&quot;,</span>
                <span class="n">labels_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">vl</span><span class="p">})</span>

                <span class="c1"># get y text position from axis position. Position x is not used</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">axis_data_coords_sys_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">txt</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$f_\mathrm{c,&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode_type</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;} (R_\mathrm</span><span class="si">{i}</span><span class="s2"> = &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; ~\mathrm</span><span class="si">{mm}</span><span class="s2">) $&quot;</span>
                <span class="n">ab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">txt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s1">&#39;text_obj&#39;</span><span class="p">:</span> <span class="n">ab</span><span class="p">}</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># ab = add_text(ax, r&quot;$f_\mathrm{c,&quot; + f&quot;{mode_type}&quot; + r&quot;} (R_\mathrm{i} = &quot;</span>
                <span class="c1">#               + f&quot;{Ri}&quot; + r&quot; ~\mathrm{mm}) $&quot;,</span>
                <span class="c1">#               box=&quot;None&quot;, xy=(freq, pos[1]),</span>
                <span class="c1">#               xycoords=&#39;data&#39;, size=14, rotation=90)</span>

        <span class="c1"># Attach the callback to limit changes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;xlim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;ylim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.calculate_beampipe_cutoff">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.calculate_beampipe_cutoff">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_beampipe_cutoff</span><span class="p">(</span><span class="n">Ri_list</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span>
        <span class="n">mode_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">f_list</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">mode_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">mode_type</span> <span class="o">=</span> <span class="n">mode</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">mode_dict</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">mode_type</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">Ri</span> <span class="ow">in</span> <span class="n">Ri_list</span><span class="p">:</span>
            <span class="n">f_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">mode_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span>
                <span class="c1"># get jacobian</span>
                <span class="k">if</span> <span class="n">mode_dict</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;tm&#39;</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jn_zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jnp_zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">f</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ri</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">))</span>

                <span class="c1"># append to f list</span>
                <span class="n">f_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f_list</span></div>


<div class="viewcode-block" id="Cavities.run_optimisation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_optimisation">[docs]</a>
    <span class="k">def</span> <span class="nf">run_optimisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimisation_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_optimisation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">optimisation_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.calc_cutoff">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.calc_cutoff">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calc_cutoff</span><span class="p">(</span><span class="n">Ri</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="c1"># calculate frequency from Ri</span>
        <span class="n">p_TM01</span><span class="p">,</span> <span class="n">p_TE11</span> <span class="o">=</span> <span class="mf">2.405</span><span class="p">,</span> <span class="mf">1.841</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span>  <span class="c1"># m/s</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;TM01&#39;</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">p_TM01</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Ri</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">p_TE11</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Ri</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>

        <span class="k">return</span> <span class="n">freq</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">p</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;tune&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">tune_results</span><span class="p">,</span>
                <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">,</span>
                <span class="s1">&#39;hom&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="p">,</span>
                <span class="s1">&#39;uq&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;tune&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="p">,</span>
                    <span class="s1">&#39;hom&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_hom_results</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid key. Cavities does not contain a Cavity named </span><span class="si">{key}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid argument type. Must be int or str.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Cavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity">[docs]</a>
<span class="k">class</span> <span class="nc">Cavity</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command Line Interface module for running analysis.</span>

<span class="sd">    .. note::</span>

<span class="sd">       Still under development so some functions might not work properly</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mid_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">end_cell_right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cavity&#39;</span><span class="p">,</span>
                 <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;simplecell&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                 <span class="n">plot_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geo_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise cavity object. You can either specify geometry by dimensions</span>
<span class="sd">        (n_cells, mid_cell, end_cell_left, end_cell_right, etc.) *or* by providing</span>
<span class="sd">        a path to a geometry file (`geo_filepath`). If `geo_filepath` is not None,</span>
<span class="sd">        we load that file and skip the dimension‐based setup.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cells (ignored if geo_filepath is provided)</span>
<span class="sd">        mid_cell: list or ndarray</span>
<span class="sd">            Mid‐cell geometric parameters (ignored if geo_filepath is provided)</span>
<span class="sd">        end_cell_left: list or ndarray</span>
<span class="sd">            Left end‐cell geometric parameters (ignored if geo_filepath is provided)</span>
<span class="sd">        end_cell_right: list or ndarray</span>
<span class="sd">            Right end‐cell geometric parameters (ignored if geo_filepath is provided)</span>
<span class="sd">        beampipe: {&#39;none&#39;, &#39;both&#39;, &#39;left&#39;, &#39;right&#39;}</span>
<span class="sd">            Beampipe options (ignored if geo_filepath is provided)</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of the cavity</span>
<span class="sd">        cell_parameterisation: {&#39;simplecell&#39;, &#39;flattop&#39;, ...}</span>
<span class="sd">            Parameterisation approach (ignored if geo_filepath is provided)</span>
<span class="sd">        color: str</span>
<span class="sd">            Colour for plotting</span>
<span class="sd">        plot_label: str or None</span>
<span class="sd">            Label for plotting; defaults to `name` if None</span>
<span class="sd">        geo_filepath: str or None</span>
<span class="sd">            If given, load geometry from this file instead of using dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ───────────────────────────────────────────────────────────────────────────────────────────</span>
        <span class="c1">#  1) Set all “always‐present” attributes first (so nothing else breaks).</span>
        <span class="c1"># ───────────────────────────────────────────────────────────────────────────────────────────</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Epk_Eacc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bpk_Eacc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_nodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_df_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_rf_config</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results_uq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># plot_label: default to `name` if not provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span> <span class="k">if</span> <span class="n">plot_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="mi">33</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_eig_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wake_op_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall_material</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># eigenmode results placeholders</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">k_fm</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">axis_field</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">surface_field</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">11</span>

        <span class="c1"># wakefield results placeholders</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fm</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">k_loss</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">k_kick</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">phom</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">I0</span><span class="p">)</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="n">geo_filepath</span>

        <span class="c1"># ───────────────────────────────────────────────────────────────────────────────────────────</span>
        <span class="c1">#  2) Choose initialisation path: “from file” or “from dimensions”</span>
        <span class="c1"># ───────────────────────────────────────────────────────────────────────────────────────────</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If a geometry file is provided, skip dimension‐based setup:</span>
        <span class="k">if</span> <span class="n">geo_filepath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_geo</span><span class="p">(</span><span class="n">geo_filepath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_geometric_parameters</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_from_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load geometry from a file (e.g. a .geo)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_geo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">load_geo</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<div class="viewcode-block" id="Cavity.get_geometric_parameters">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_geometric_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_geometric_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*(\w+)\s*=\s*DefineNumber\[\s*([\d.eE+-]+)\s*,\s*Name\s*&quot;Parameters/[^&quot;]*&quot;\s*\];&#39;</span><span class="p">,</span>
                                 <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">var_name</span><span class="p">,</span> <span class="n">var_value</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">var_value</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Cavity.set_name">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_name">[docs]</a>
    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Cavity.set_color">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_color">[docs]</a>
    <span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color: str</span>
<span class="sd">            color of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span></div>


<div class="viewcode-block" id="Cavity.set_parameterisation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_parameterisation">[docs]</a>
    <span class="k">def</span> <span class="nf">set_parameterisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="n">cell_parameterisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_parameterisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavity.set_plot_label">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_plot_label">[docs]</a>
    <span class="k">def</span> <span class="nf">set_plot_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity plot label</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_label: str</span>
<span class="sd">            Cavity plot label</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plot_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span></div>


<div class="viewcode-block" id="Cavity.set_n_cells">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_n_cells">[docs]</a>
    <span class="k">def</span> <span class="nf">set_n_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets number of cells of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cavity cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavity.set_mid_cell">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_mid_cell">[docs]</a>
    <span class="k">def</span> <span class="nf">set_mid_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set mid cell geometric parameters of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell: list, array like</span>
<span class="sd">            Geometric parameters of cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavity.set_end_cell_left">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_end_cell_left">[docs]</a>
    <span class="k">def</span> <span class="nf">set_end_cell_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set left end cell geometric parameters of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell: list, array like</span>
<span class="sd">            Geometric parameters of cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavity.set_end_cell_right">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_end_cell_right">[docs]</a>
    <span class="k">def</span> <span class="nf">set_end_cell_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set right end cell geometric parameters of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell: list, array like</span>
<span class="sd">            Geometric parameters of cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavity.set_boundary_conditions">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_boundary_conditions">[docs]</a>
    <span class="k">def</span> <span class="nf">set_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets boundary conditions for the beampipes of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bc: int</span>
<span class="sd">            Boundary condition of left and right cell/beampipe ends</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.set_beampipe">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_beampipe">[docs]</a>
    <span class="k">def</span> <span class="nf">set_beampipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set beampipe option of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bp: str</span>
<span class="sd">            Beampipe option of cell</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">bp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavity.load">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load existing cavity project folder</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.load_shape_space">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.load_shape_space">[docs]</a>
    <span class="k">def</span> <span class="nf">load_shape_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cavity geometric parameters from shape space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Shape space directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.save_shape_space">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.save_shape_space">[docs]</a>
    <span class="k">def</span> <span class="nf">save_shape_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save current geometric parameters as shape space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Directory to save shape space to. If no input is given, it is saved to the Cavities directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.sweep">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.sweep">[docs]</a>
    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sweep_config</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;cross&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">interval_def</span> <span class="ow">in</span> <span class="n">sweep_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># save nominal variable value form shape space</span>
                <span class="n">current_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">par_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">interval_def</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval_def</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">interval_def</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">par_vals</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
                        <span class="c1"># change value</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_eigenmode</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results_uq</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="p">)</span>

                <span class="c1"># replace initial value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">current_var</span></div>


<div class="viewcode-block" id="Cavity.study_mesh_convergence">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.study_mesh_convergence">[docs]</a>
    <span class="k">def</span> <span class="nf">study_mesh_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">h_passes</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">h_step</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p_passes</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">p_step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h</span>
<span class="sd">        passes</span>
<span class="sd">        solver</span>
<span class="sd">        type: str</span>
<span class="sd">            h or p refinement</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">convergence_df_ph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">convergence_df_data_ph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># define start value, refinement (adaptive? fixed step?)</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">h</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p_passes</span><span class="p">):</span>
            <span class="n">convergence_dict_h</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ih</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h_passes</span><span class="p">):</span>
                <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">:</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;mesh_config&#39;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">hs</span><span class="p">,</span>
                                        <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">p</span>
                                    <span class="p">}</span>
                                    <span class="p">}</span>

                <span class="n">run_eigenmode_s</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">},</span> <span class="n">eigenmode_config</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># read results</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>

                <span class="n">convergence_dict_h</span><span class="p">[</span><span class="n">ih</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span>
                <span class="n">convergence_dict_h</span><span class="p">[</span><span class="n">ih</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hs</span>
                <span class="n">convergence_dict_h</span><span class="p">[</span><span class="n">ih</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">convergence_dict_h</span><span class="p">[</span><span class="n">ih</span><span class="p">][</span><span class="s1">&#39;No of Mesh Elements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;No of Mesh Elements&#39;</span><span class="p">]</span>

                <span class="n">hs</span> <span class="o">/=</span> <span class="n">h_step</span>
            <span class="n">convergence_df_data_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">convergence_dict_h</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">convergence_df_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rel_errors</span><span class="p">(</span><span class="n">convergence_df_data_h</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">convergence_df_ph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">convergence_df_data_ph</span> <span class="o">=</span> <span class="n">convergence_df_data_h</span>
                <span class="n">convergence_df_ph</span> <span class="o">=</span> <span class="n">convergence_df_h</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">convergence_df_data_ph</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">convergence_df_data_ph</span><span class="p">,</span>
                                                    <span class="n">convergence_df_data_h</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">convergence_df_ph</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">convergence_df_ph</span><span class="p">,</span>
                                               <span class="n">convergence_df_h</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="n">p_step</span>

        <span class="c1"># convert to dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_df_data</span> <span class="o">=</span> <span class="n">convergence_df_data_ph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_df</span> <span class="o">=</span> <span class="n">convergence_df_ph</span></div>


<div class="viewcode-block" id="Cavity.calculate_rel_errors">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.calculate_rel_errors">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_rel_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="c1"># Specify the columns to exclude</span>
        <span class="n">columns_to_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;No of Mesh Elements&#39;</span><span class="p">]</span>
        <span class="n">df_to_compute</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_exclude</span><span class="p">)</span>
        <span class="n">df_prev</span> <span class="o">=</span> <span class="n">df_to_compute</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">relative_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_to_compute</span> <span class="o">-</span> <span class="n">df_prev</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_prev</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">relative_errors</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rel_error_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_to_compute</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">excluded_columns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_to_exclude</span><span class="p">]</span>
        <span class="n">rel_errors_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">relative_errors</span><span class="p">,</span> <span class="n">excluded_columns</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rel_errors_df</span></div>


<div class="viewcode-block" id="Cavity.run_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.run_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">run_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">,</span> <span class="n">freq_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">boundary_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run eigenmode analysis on cavity</span>

<span class="sd">        Parameters ---------- solver: {&#39;SLANS&#39;, &#39;NGSolve&#39;} Solver to be used. Native solver is still under</span>
<span class="sd">        development. Results are not as accurate as that of SLANS. freq_shift: Frequency shift. Eigenmode solver</span>
<span class="sd">        searches for eigenfrequencies around this value boundary_cond: int Boundary condition of left and right</span>
<span class="sd">        cell/beampipe ends subdir: str Sub directory to save results to uq_config: None | dict Provides inputs</span>
<span class="sd">        required for uncertainty quantification. Default is None and disables uncertainty quantification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">boundary_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">boundary_cond</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span>
                              <span class="n">freq_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                              <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="n">uq_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span>
                              <span class="n">freq_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                              <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="n">uq_config</span><span class="p">)</span>

        <span class="c1"># load quantities of interest</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_uq_fm_results</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;uq.json&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find eigenmode results. Please rerun eigenmode analysis:: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Cavity.run_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.run_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">wakelength</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                      <span class="n">DDR_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operating_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ABCI&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run wakefield analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        MROT: {0, 1}</span>
<span class="sd">            Polarisation 0 for longitudinal polarization and 1 for transversal polarization</span>
<span class="sd">        MT: int</span>
<span class="sd">            Number of time steps it takes for a beam to move from one mesh cell to the other</span>
<span class="sd">        NFS: int</span>
<span class="sd">            Number of frequency samples</span>
<span class="sd">        wakelength:</span>
<span class="sd">            Wakelength to be analysed</span>
<span class="sd">        bunch_length: float</span>
<span class="sd">            Length of the bunch</span>
<span class="sd">        DDR_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the r axis</span>
<span class="sd">        DDZ_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the z axis</span>
<span class="sd">        WG_M:</span>
<span class="sd">            For module simulation. Specifies the length of the beampipe between two cavities.</span>
<span class="sd">        marker: str</span>
<span class="sd">            Marker for the cavities. Adds this to the cavity name specified in a shape space json file</span>
<span class="sd">        wp_dict: dict</span>
<span class="sd">            Python dictionary containing relevant parameters for the wakefield analysis for a specific operating point</span>
<span class="sd">        solver: {&#39;ABCI&#39;}</span>
<span class="sd">            Only one solver is currently available</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :param MROT:</span>
<span class="sd">        :param wakelength:</span>
<span class="sd">        :param WG_M:</span>
<span class="sd">        :param marker:</span>
<span class="sd">        :param solver:</span>
<span class="sd">        :param operating_points:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">operating_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># check if R/Q is set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_abci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                               <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">wakelength</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                               <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span>
                               <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="n">WG_M</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                               <span class="n">operating_points</span><span class="o">=</span><span class="n">operating_points</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.calc_op_freq">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.calc_op_freq">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_op_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates operating frequency. The operating frequency is used for tuning when a frequency is not given.</span>
<span class="sd">        It is advisable to always include the desired tune frequency. Example</span>

<span class="sd">        .. py:function:: cav.run_tune(&#39;Req&#39;, freq=1300)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c0</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_ngsolve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">,</span> <span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span>
                     <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># create folders for all keys</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;OC_R&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC_R&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC&#39;</span>

        <span class="c1"># ngsolve_mevp.cavity(n_cells, n_modules, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[OC_R],</span>
        <span class="c1">#                     n_modes=n_modes, fid=f&quot;{name}&quot;, f_shift=f_shift, bc=bc, beampipes=shape[&#39;BP&#39;],</span>
        <span class="c1">#                     parentDir=parentDir, projectDir=projectDir, subdir=sub_dir)</span>
        <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
            <span class="c1"># write_cst_paramters(f&quot;{key}_n{n_cell}&quot;, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;],</span>
            <span class="c1">#                     projectDir=projectDir, cell_type=&quot;None&quot;, solver=select_solver.lower())</span>

            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                        <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span>
                                        <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                        <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
            <span class="c1"># write_cst_paramters(f&quot;{key}_n{n_cell}&quot;, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;],</span>
            <span class="c1">#                     projectDir=projectDir, cell_type=&quot;None&quot;, solver=select_solver.lower())</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_multicell</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape_multi</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape_multi</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                          <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span>
                                          <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                          <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># write_cst_paramters(f&quot;{key}_n{n_cell}&quot;, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;],</span>
            <span class="c1">#                     projectDir=projectDir, cell_type=&quot;None&quot;, solver=select_solver.lower())</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="c1"># run UQ</span>
        <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
            <span class="n">objectives</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span>
            <span class="n">solver_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span> <span class="n">ngsolve_mevp</span><span class="p">}</span>
            <span class="n">solver_args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
                                    <span class="p">{</span><span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="n">n_cells</span><span class="p">,</span> <span class="s1">&#39;n_modules&#39;</span><span class="p">:</span> <span class="n">n_modules</span><span class="p">,</span> <span class="s1">&#39;f_shift&#39;</span><span class="p">:</span> <span class="n">f_shift</span><span class="p">,</span> <span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="n">bc</span><span class="p">,</span>
                                     <span class="s1">&#39;beampipes&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span>
                                     <span class="p">},</span>
                                <span class="s1">&#39;parentDir&#39;</span><span class="p">:</span> <span class="n">parentDir</span><span class="p">,</span>
                                <span class="s1">&#39;projectDir&#39;</span><span class="p">:</span> <span class="n">projectDir</span><span class="p">,</span>
                                <span class="s1">&#39;analysis folder&#39;</span><span class="p">:</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;cell_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mid cell&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;optimisation&#39;</span><span class="p">:</span> <span class="kc">False</span>
                                <span class="p">}</span>

            <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;cell_complexity&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;cell_complexity&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">uq_cell_complexity</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
                <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape_multi</span><span class="p">}</span>
                <span class="n">uq_parallel_multicell</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape</span><span class="p">}</span>
                <span class="n">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done with Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Cavity.set_wall_material">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_wall_material">[docs]</a>
    <span class="k">def</span> <span class="nf">set_wall_material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall_material</span> <span class="o">=</span> <span class="n">wm</span></div>


<div class="viewcode-block" id="Cavity.get_ngsolve_tune_res">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_ngsolve_tune_res">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ngsolve_tune_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tune_variable: {&#39;A&#39;, &#39;B&#39;, &#39;a&#39;. &#39;b&#39;, &#39;Ri&#39;, &#39;L&#39;, &#39;Req&#39;}</span>
<span class="sd">            Tune variable.</span>
<span class="sd">        cell_type: {&#39;mid cell&#39;, &#39;end-mid cell&#39;, &#39;mid-end cell&#39;, &#39;single cell&#39;}</span>
<span class="sd">            Type of cell to tune</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tune_res</span> <span class="o">=</span> <span class="s1">&#39;tune_res.json&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;tune_res.json&#39;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;tune_res.json&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tune_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_results</span><span class="p">[</span><span class="s1">&#39;FREQ&#39;</span><span class="p">]</span>
            <span class="c1"># self.shape[&#39;IC&#39;] = self.tune_results[&#39;IC&#39;]</span>
            <span class="c1"># self.shape[&#39;OC&#39;] = self.tune_results[&#39;OC&#39;]</span>
            <span class="c1"># self.shape[&#39;OC_R&#39;] = self.tune_results[&#39;OC_R&#39;]</span>
            <span class="c1"># self.mid_cell = self.shape[&#39;IC&#39;]</span>
            <span class="c1"># self.end_cell_left = self.shape[&#39;OC&#39;]</span>
            <span class="c1"># self.end_cell_right = self.shape[&#39;OC_R&#39;]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tune results not found. Please tune the cavity&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_eigenmode_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_eigenmode_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenmode_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quantities of interest written by the SLANS code</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qois</span> <span class="o">=</span> <span class="s1">&#39;qois.json&#39;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">qois</span><span class="p">)),</span> <span class="p">(</span>
            <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eigenmode result does not exist </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;monopole&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">qois</span><span class="p">)</span><span class="si">}</span><span class="s2">, please run eigenmode simulation.&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">qois</span><span class="p">))</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;qois_all_modes.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c1"># with open(os.path.join(self.self_dir, &#39;eigenmode&#39;, &#39;monopole&#39;, &#39;Ez_0_abs.csv&#39;)) as csv_file:</span>
        <span class="c1">#     self.Ez_0_abs = pd.read_csv(csv_file, sep=&#39;\t&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;kcc [%]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;ff [%]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;GR/Q [Ohm^2]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Q []&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Epk/Eacc []&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Bpk/Eacc [mT/MV/m]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Epk_Eacc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bpk_Eacc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span></div>


<div class="viewcode-block" id="Cavity.plot_dispersion">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_dispersion">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">axis_label</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\pi$&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="k">else</span> <span class="sa">r</span><span class="s1">&#39;$\pi$&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                      <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$f$ [MHz]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$k$&#39;</span><span class="p">)</span>

        <span class="c1"># if show_continuous:</span>
        <span class="c1">#     # calculate continuous</span>
        <span class="c1">#     k = np.linspace(0, np.pi, 100, endpoint=True)</span>
        <span class="c1">#     f_pi_over_2 = (freqs[0] + freqs[-1])/2</span>
        <span class="c1">#     freq_c = np.sqrt(freqs[0]**2 + freqs[-1]**2 - 2*freqs[0]*freqs[-1]*np.cos(k))</span>
        <span class="c1">#     ax.plot(k, freq_c, c=&#39;k&#39;, lw=2)</span>

        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Cavity.plot_axis_field">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_axis_field">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_axis_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_min_max</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$|E_z(0,0)|$&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># Position (normalized coordinates)</span>
                <span class="s1">&#39;$\eta=&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">\%&#39;</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span>  <span class="c1"># Text content</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>  <span class="c1"># Font size</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>  <span class="c1"># Horizontal alignment</span>
                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>  <span class="c1"># Vertical alignment</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span>  <span class="c1"># Use axes-relative positioning</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_min_max</span><span class="p">:</span>
                <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">])</span>
                <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxz</span> <span class="o">-</span> <span class="n">minz</span><span class="p">))</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">Ez_0_abs_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">][</span><span class="n">peaks</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">][</span><span class="n">peaks</span><span class="p">],</span> <span class="n">Ez_0_abs_peaks</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Ez_0_abs.csv&#39;</span><span class="p">)):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Ez_0_abs.csv&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$|E_z(0,0)|$&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># Position (normalized coordinates)</span>
                    <span class="s1">&#39;$\eta=$&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">\%&#39;</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span>  <span class="c1"># Text content</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>  <span class="c1"># Font size</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>  <span class="c1"># Horizontal alignment</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>  <span class="c1"># Vertical alignment</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span>  <span class="c1"># Use axes-relative positioning</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_min_max</span><span class="p">:</span>
                    <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">])</span>
                    <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxz</span> <span class="o">-</span> <span class="n">minz</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                                          <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">Ez_0_abs_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">][</span><span class="n">peaks</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Axis field plot data not found.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.plot_spectra">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_spectra">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results_all_modes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="n">sub_k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub_k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">sub_dict</span> <span class="ow">in</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results_all_modes</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

            <span class="c1"># Generate KDE data</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;freq_1 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_2 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_3 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_4 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_5 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_6 [MHz]&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;freq_7 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_8 [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_9 [MHz]&#39;</span><span class="p">]:</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;expe&quot;</span><span class="p">]</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;stdDev&quot;</span><span class="p">]</span>
                <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>  <span class="c1"># Adjust range as needed</span>
                <span class="k">if</span> <span class="n">std</span> <span class="o">/</span> <span class="n">mean</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>  <span class="c1"># set a very narrow range for the x-axis around the mean.</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
                    <span class="n">y_values</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_values</span> <span class="o">*</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y_values</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span> <span class="o">*</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

            <span class="c1"># Plot settings</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;KDE Plots for Frequencies&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (MHz)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1270</span><span class="p">,</span> <span class="mi">1310</span><span class="p">)</span>
            <span class="c1"># ax.set_ylim(0, 3)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;uq_fm_results_all_modes not found&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_uq_fm_results">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_uq_fm_results">[docs]</a>
    <span class="k">def</span> <span class="nf">get_uq_fm_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="c1"># load uq result</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;uq.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;uq_all_modes.json&#39;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;uq_all_modes.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results_all_modes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c1"># get neighbours and all qois</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dirr</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">dirr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="n">dirr</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="s1">&#39;qois.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                    <span class="n">neighbour_uq_fm_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                <span class="n">neighbours</span><span class="p">[</span><span class="n">dirr</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbour_uq_fm_results</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="c1"># nodes, weights = cn_leg_05_2(7)</span>
        <span class="c1"># write weights</span>

        <span class="c1"># data_table = pd.DataFrame(weights, columns=[&#39;weights&#39;])</span>
        <span class="c1"># data_table.to_csv(fr&#39;{folder}\weights.csv&#39;, index=False, sep=&#39;\t&#39;, float_format=&#39;%.32f&#39;)</span>

        <span class="c1"># get nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;nodes.csv&#39;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># get weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;weights.csv&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Cavity.get_uq_hom_results">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_uq_hom_results">[docs]</a>
    <span class="k">def</span> <span class="nf">get_uq_hom_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_wakefield_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_wakefield_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the quantities of interest written by the ABCI code</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt: {&#39;SR&#39;, &#39;BS&#39;}</span>
<span class="sd">            SR - Synchrotron radiation bunch length</span>
<span class="sd">            BS - Bremsstrahlung</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qois</span> <span class="o">=</span> <span class="s1">&#39;qois.json&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;qois.json&#39;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;qois.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">all_wakefield_qois</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c1"># get only keys in op_points</span>
        <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">all_wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_fm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I0</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;I0 [mA]&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Cavity.get_abci_data">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_abci_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_abci_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Long&#39;</span><span class="p">:</span> <span class="n">ABCIData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span><span class="p">,</span> <span class="s1">&#39;longitudinal&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                          <span class="s1">&#39;Trans&#39;</span><span class="p">:</span> <span class="n">ABCIData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span><span class="p">,</span> <span class="s1">&#39;transversal&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span></div>


<div class="viewcode-block" id="Cavity.plot_animate_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_animate_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_animate_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">plot_contour_for_frame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frame_key</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DOTS&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;SOLID&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">frame_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">frame_key</span><span class="p">]:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">plot_type</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X-axis (m)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y-axis (m)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contour Plot for </span><span class="si">{</span><span class="n">frame_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">animate_frames</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">frame_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Sort frames by their order</span>

            <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">frame_key</span><span class="p">):</span>
                <span class="n">plot_contour_for_frame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frame_key</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frame_keys</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ani</span>

        <span class="n">top_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">efield_contour</span> <span class="o">=</span> <span class="n">get_wakefield_data</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">top_folder</span><span class="si">}</span><span class="s1">/Cavity_MROT_0.top&#39;</span><span class="p">)</span>
        <span class="n">ani</span> <span class="o">=</span> <span class="n">animate_frames</span><span class="p">(</span><span class="n">efield_contour</span><span class="p">)</span>
        <span class="n">display_html</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">animate_frames</span><span class="p">(</span><span class="n">efield_contour</span><span class="p">)</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="c1"># Save the animation as an MP4 file</span>
            <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">top_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_e_field_animation.mp4&#39;</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_power_uq">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_power_uq">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power_uq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">):</span>
        <span class="n">stat_moms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                    <span class="n">sig_id</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

                    <span class="n">Q0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Q0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">inv_eta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_sr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;SR per turn [MW]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">n_cav</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_in</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_cryo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">pdyn</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">pstat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_wp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

                    <span class="c1"># test</span>
                    <span class="n">n_cav</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">v_rf</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)))</span>

                    <span class="c1"># p_in = rf_config[&#39;SR per turn [MW]&#39;] * 1e6 / n_cav * 1e-3  # maximum synchrotron radiation per beam</span>

                    <span class="n">p_cryo_n</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">500</span><span class="p">))</span>  <span class="c1"># W/m</span>

                    <span class="n">pdyn_n</span> <span class="o">=</span> <span class="n">v_rf</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># per cavity</span>
                    <span class="n">pdyn_expe</span><span class="p">,</span> <span class="n">pdyn_std</span><span class="p">,</span> <span class="n">pdyn_skew</span><span class="p">,</span> <span class="n">pdyn_kurtosis</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">pdyn_n</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span><span class="p">)</span>
                    <span class="n">pdyn</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="n">pdyn_expe</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="n">pdyn_std</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="n">pdyn_skew</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">pdyn_kurtosis</span><span class="p">}</span>

                    <span class="n">pstat_n</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">*</span> <span class="n">v_rf</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="n">p_cryo_n</span>
                    <span class="n">pstat_expe</span><span class="p">,</span> <span class="n">pstat_std</span><span class="p">,</span> <span class="n">pstat_skew</span><span class="p">,</span> <span class="n">pstat_kurtosis</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">pstat_n</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span><span class="p">)</span>
                    <span class="n">pstat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="n">pstat_expe</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="n">pstat_std</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="n">pstat_skew</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">pstat_kurtosis</span><span class="p">}</span>

                    <span class="n">p_wp_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdyn_n</span> <span class="o">+</span> <span class="n">pstat_n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># per cavity</span>
                    <span class="n">p_wp_expe</span><span class="p">,</span> <span class="n">p_wp_std</span><span class="p">,</span> <span class="n">p_wp_skew</span><span class="p">,</span> <span class="n">p_wp_kurtosis</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">p_wp_n</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span><span class="p">)</span>
                    <span class="n">p_wp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="n">p_wp_expe</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="n">p_wp_std</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="n">p_wp_skew</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">p_wp_kurtosis</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">stat_mom</span> <span class="ow">in</span> <span class="n">stat_moms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">op_field</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># n_cav[stat_mom] = [</span>
                            <span class="c1">#     int(np.ceil(v_rf[stat_mom][0] / (op_field[stat_mom][0] * self.l_active)))]</span>

                            <span class="n">p_in</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">p_sr</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_cav</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">]</span>  <span class="c1"># maximum synchrotron radiation per beam</span>

                        <span class="c1"># if self.uq_fm_results[&#39;freq [MHz]&#39;][stat_mom][0] != 0:</span>
                        <span class="c1">#     p_cryo[stat_mom] = [</span>
                        <span class="c1">#         8 / (np.sqrt(self.uq_fm_results[&#39;freq [MHz]&#39;][stat_mom][0] / 500))]  # W/m</span>
                        <span class="c1">#</span>
                        <span class="c1"># if self.uq_fm_results[&#39;R/Q [Ohm]&#39;][stat_mom][0] * Q0[stat_mom][0] * n_cav[stat_mom][0] != 0:</span>
                        <span class="c1">#     pdyn[stat_mom] = [v_rf[stat_mom][0] * (op_field[stat_mom][0] * self.l_active) / (</span>
                        <span class="c1">#             self.uq_fm_results[&#39;R/Q [Ohm]&#39;][stat_mom][0] * Q0[stat_mom][0] *</span>
                        <span class="c1">#             n_cav[stat_mom][0])]  # per cavity</span>
                        <span class="c1">#</span>
                        <span class="c1"># if op_field[stat_mom][0] != 0 and n_cav[stat_mom][0] != 0:</span>
                        <span class="c1">#     pstat[stat_mom] = [(self.l_cavity * v_rf[stat_mom][0] / (</span>
                        <span class="c1">#             self.l_active * op_field[stat_mom][0] * n_cav[stat_mom][0])) * p_cryo[stat_mom][</span>
                        <span class="c1">#                            0]]</span>
                        <span class="c1">#</span>
                        <span class="c1"># if inv_eta[stat_mom][0] != 0:</span>
                        <span class="c1">#     p_wp[stat_mom] = [</span>
                        <span class="c1">#         (inv_eta[stat_mom][0]) * (pdyn[stat_mom][0] + pstat[stat_mom][0]) * 1e-3]  # per cavity</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="n">sig_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sa">r</span><span class="s2">&quot;Ncav&quot;</span><span class="p">:</span> <span class="n">n_cav</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Q0 []&quot;</span><span class="p">:</span> <span class="n">Q0</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pstat/cav [W]&quot;</span><span class="p">:</span> <span class="n">pstat</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pdyn/cav [W]&quot;</span><span class="p">:</span> <span class="n">pdyn</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pwp/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_wp</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pin/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_in</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;PHOM/cav [kW]&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;P_HOM [kW]_</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sig_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">vv</span><span class="si">}</span><span class="s1">mm&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span></div>


<div class="viewcode-block" id="Cavity.get_power">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_power">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                    <span class="n">sig_id</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="n">op_field</span>

                    <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>

                    <span class="n">Q0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span>
                    <span class="n">inv_eta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span>
                    <span class="n">p_sr</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;SR per turn [MW]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>

                    <span class="n">n_cav</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">v_rf</span> <span class="o">/</span> <span class="p">(</span><span class="n">op_field</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)))</span>
                    <span class="n">p_in</span> <span class="o">=</span> <span class="n">p_sr</span> <span class="o">/</span> <span class="n">n_cav</span>  <span class="c1"># maximum synchrotron radiation per beam</span>

                    <span class="n">p_cryo</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">500</span><span class="p">))</span>

                    <span class="n">pdyn</span> <span class="o">=</span> <span class="n">v_rf</span> <span class="o">*</span> <span class="p">(</span><span class="n">op_field</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">*</span> <span class="n">Q0</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">)</span>

                    <span class="n">pstat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">*</span> <span class="n">v_rf</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">*</span> <span class="n">op_field</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">))</span> <span class="o">*</span> <span class="n">p_cryo</span>  <span class="c1"># per cavity</span>
                    <span class="n">p_wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">inv_eta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdyn</span> <span class="o">+</span> <span class="n">pstat</span><span class="p">)</span>  <span class="c1"># per cavity</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="n">sig_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sa">r</span><span class="s2">&quot;Ncav&quot;</span><span class="p">:</span> <span class="n">n_cav</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Q0 []&quot;</span><span class="p">:</span> <span class="n">Q0</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pstat/cav [W]&quot;</span><span class="p">:</span> <span class="n">pstat</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pdyn/cav [W]&quot;</span><span class="p">:</span> <span class="n">pdyn</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pwp/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_wp</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pin/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_in</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;PHOM/cav [kW]&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sig_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">vv</span><span class="si">}</span><span class="s1">mm&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span></div>


<div class="viewcode-block" id="Cavity.get_uq_post">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_uq_post">[docs]</a>
    <span class="k">def</span> <span class="nf">get_uq_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qoi</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.get_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span> <span class="o">=</span> <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">load_fields</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span>
                                                             <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">),</span>
                                                <span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span></div>


<div class="viewcode-block" id="Cavity.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mid_cell&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">new_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;mid_cell&#39;</span><span class="p">}</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span>
                                               <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;end_cell_left&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span>
                                               <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;end_cell_right&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span>
                                               <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [mm]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ [mm]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Long.)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Long.)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\parallel} ~[\mathrm{k\Omega}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Trans.)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Trans.)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\perp} ~[\mathrm{k\Omega/m}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wpl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Wake Potentials&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Longitudinal wake potentials)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Wake Potentials&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Longitudinal wake potentials)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance from Bunch Head S [m]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Scaled Wake Potentials $W (S)$ [V/pC]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;wpt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Wake Potentials&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Transversal wake potentials)&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Wake Potentials&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Transversal wake potentials)&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance from Bunch Head S [m]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Scaled Wake Potentials $W (S)$ [V/pC/m]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_err&#39;</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ax</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convergence data not available.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.plot_mesh">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">):</span>
        <span class="n">mesh_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mesh_path</span><span class="p">):</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">(</span><span class="n">mesh_path</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="n">plotter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;The folder or mesh does not exist. Please check that a mesh file was writtten.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.plot_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">):</span>
        <span class="n">field_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">field_path</span><span class="p">):</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">plot_fields</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">plotter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;The foler or field file does not exist. Please check that a mesh file was writtten.&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_plot_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># plot convergence</span>
        <span class="n">conv_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s2">&quot;tune_convergence.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conv_filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">conv_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">convergence_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convergence_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">convergence_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">convergence_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">convergence_dict</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># plot directions</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span>
                                       <span class="n">scale_units</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                       <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="n">headaxislength</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># plot absolute error</span>
        <span class="n">abs_err_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s2">&quot;tune_absolute_error.json&quot;</span><span class="p">)</span>
        <span class="n">abs_err_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conv_filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_err_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">abs_err_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_err_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">abs_err_dict</span><span class="p">[</span><span class="s1">&#39;abs_err&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Parameter&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Absolute error&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Cavity.define_operating_points">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.define_operating_points">[docs]</a>
    <span class="k">def</span> <span class="nf">define_operating_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="n">op</span></div>


<div class="viewcode-block" id="Cavity.inspect">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.inspect">[docs]</a>
    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s1">&#39;mid-cell&#39;</span><span class="p">,</span> <span class="n">variation</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;mid-cell&#39;</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;end-cell-left&#39;</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;end-cell-right&#39;</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
            <span class="n">A_</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">a_</span><span class="p">,</span> <span class="n">b_</span><span class="p">,</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">L_</span><span class="p">,</span> <span class="n">Req_</span><span class="p">,</span> <span class="n">l_</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>

            <span class="c1"># Define the function that plots the graph</span>
            <span class="k">def</span> <span class="nf">plot_cavity_geometry_flattop</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
                <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">BP</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                                  <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Update the sum display</span>
                <span class="n">sum_label</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sum of A + a + l: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, L: </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">, delta: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">L</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># Create sliders for each variable</span>
            <span class="n">A_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">A_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">B_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">B_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">a_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">b_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">b_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">Ri_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Ri_</span><span class="p">,</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Ri&#39;</span><span class="p">)</span>
            <span class="n">L_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">L_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">Req_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                             <span class="n">value</span><span class="o">=</span><span class="n">Req_</span><span class="p">,</span>
                                             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Req&#39;</span><span class="p">)</span>
            <span class="n">l_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">l_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
            <span class="c1"># Create a label to display the sum of A + a</span>
            <span class="n">sum_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">()</span>

            <span class="c1"># Arrange the sliders in a 3x3 layout</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">A_slider</span><span class="p">,</span> <span class="n">B_slider</span><span class="p">,</span> <span class="n">a_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">b_slider</span><span class="p">,</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="n">L_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">Req_slider</span><span class="p">,</span> <span class="n">l_slider</span><span class="p">]),</span>
                <span class="n">sum_label</span>  <span class="c1"># Add the sum label to the layout</span>
            <span class="p">])</span>

            <span class="c1"># Create an interactive widget to update the plot</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_cavity_geometry_flattop</span><span class="p">,</span>
                                             <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A_slider</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">B_slider</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_slider</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b_slider</span><span class="p">,</span>
                                              <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">L_slider</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="n">Req_slider</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="n">l_slider</span><span class="p">})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">A_</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">a_</span><span class="p">,</span> <span class="n">b_</span><span class="p">,</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">L_</span><span class="p">,</span> <span class="n">Req_</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>

            <span class="c1"># Define the function that plots the graph</span>
            <span class="k">def</span> <span class="nf">plot_cavity_geometry</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">):</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">BP</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">tangent_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Update the sum display</span>
                <span class="n">sum_label</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sum of A + a: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, L: </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">, delta: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">L</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># Create sliders for each variable</span>
            <span class="n">A_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">A_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">B_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">B_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">a_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">b_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">b_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">Ri_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Ri_</span><span class="p">,</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Ri&#39;</span><span class="p">)</span>
            <span class="n">L_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">L_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">Req_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                             <span class="n">value</span><span class="o">=</span><span class="n">Req_</span><span class="p">,</span>
                                             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Req&#39;</span><span class="p">)</span>
            <span class="c1"># Create a label to display the sum of A + a</span>
            <span class="n">sum_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">()</span>

            <span class="c1"># Arrange the sliders in a 3x3 layout</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">A_slider</span><span class="p">,</span> <span class="n">B_slider</span><span class="p">,</span> <span class="n">a_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">b_slider</span><span class="p">,</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="n">L_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">Req_slider</span><span class="p">]),</span>
                <span class="n">sum_label</span>  <span class="c1"># Add the sum label to the layout</span>
            <span class="p">])</span>

            <span class="c1"># Create an interactive widget to update the plot</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_cavity_geometry</span><span class="p">,</span>
                                             <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A_slider</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">B_slider</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_slider</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b_slider</span><span class="p">,</span>
                                              <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">L_slider</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="n">Req_slider</span><span class="p">})</span>

        <span class="c1"># Display the layout</span>
        <span class="n">display</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ui</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.config_sample">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.config_sample">[docs]</a>
    <span class="k">def</span> <span class="nf">config_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EIGENMODE_CONFIG</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAKEFIELD_CONFIG</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;tune&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TUNE_CONFIG</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;uq&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UQ_CONFIG</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;optimisation&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;sa&#39;</span><span class="p">:</span>
            <span class="k">return</span></div>

    <span class="c1"># def inspect(self, cell_type=&#39;mid-cell&#39;, variation=0.2, tangent_check=False):</span>
    <span class="c1">#</span>
    <span class="c1">#     fig, ax = plt.subplots(figsize=(12, 6))</span>
    <span class="c1">#     ax.set_aspect(&#39;equal&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     if cell_type == &#39;mid-cell&#39;:</span>
    <span class="c1">#         cell = self.shape[&#39;IC&#39;]</span>
    <span class="c1">#     elif cell_type == &#39;end-cell-left&#39;:</span>
    <span class="c1">#         cell = self.shape[&#39;OC&#39;]</span>
    <span class="c1">#     elif cell_type == &#39;end-cell-right&#39;:</span>
    <span class="c1">#         cell = self.shape[&#39;OC_R&#39;]</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         cell = self.shape[&#39;IC&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     if self.cell_parameterisation == &#39;flattop&#39;:</span>
    <span class="c1">#         A_, B_, a_, b_, Ri_, L_, Req_, l_ = cell[:8]</span>
    <span class="c1">#</span>
    <span class="c1">#         # Define the function that plots the graph</span>
    <span class="c1">#         def plot_cavity_geometry_flattop(A, B, a, b, Ri, L, Req, l):</span>
    <span class="c1">#             cell = np.array([A, B, a, b, Ri, L, Req, l])</span>
    <span class="c1">#             write_cavity_geometry_cli_flattop(cell, cell, cell, BP=&#39;none&#39;,</span>
    <span class="c1">#                                               n_cell=1, tangent_check=True, lw=1,</span>
    <span class="c1">#                                               plot=True,</span>
    <span class="c1">#                                               ignore_degenerate=True)</span>
    <span class="c1">#</span>
    <span class="c1">#             # Update the sum display</span>
    <span class="c1">#             sum_label.value = f&#39;Sum of A + a + l: {A + a + l:.2f}, L: {L}, delta: {A + a + l - L}&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#         # Create sliders for each variable</span>
    <span class="c1">#         A_slider = widgets.FloatSlider(min=(1 - variation) * A_, max=(1 + variation) * A_, step=0.1, value=A_,</span>
    <span class="c1">#                                        description=&#39;A&#39;)</span>
    <span class="c1">#         B_slider = widgets.FloatSlider(min=(1 - variation) * B_, max=(1 + variation) * B_, step=0.1, value=B_,</span>
    <span class="c1">#                                        description=&#39;B&#39;)</span>
    <span class="c1">#         a_slider = widgets.FloatSlider(min=(1 - variation) * a_, max=(1 + variation) * a_, step=0.1, value=a_,</span>
    <span class="c1">#                                        description=&#39;a&#39;)</span>
    <span class="c1">#         b_slider = widgets.FloatSlider(min=(1 - variation) * b_, max=(1 + variation) * b_, step=0.1, value=b_,</span>
    <span class="c1">#                                        description=&#39;b&#39;)</span>
    <span class="c1">#         Ri_slider = widgets.FloatSlider(min=(1 - variation) * Ri_, max=(1 + variation) * Ri_, step=0.1, value=Ri_,</span>
    <span class="c1">#                                         description=&#39;Ri&#39;)</span>
    <span class="c1">#         L_slider = widgets.FloatSlider(min=(1 - variation) * L_, max=(1 + variation) * L_, step=0.1, value=L_,</span>
    <span class="c1">#                                        description=&#39;L&#39;)</span>
    <span class="c1">#         Req_slider = widgets.FloatSlider(min=(1 - variation) * Req_, max=(1 + variation) * Req_, step=0.1,</span>
    <span class="c1">#                                          value=Req_,</span>
    <span class="c1">#                                          description=&#39;Req&#39;)</span>
    <span class="c1">#         l_slider = widgets.FloatSlider(min=(1 - variation) * l_, max=(1 + variation) * l_, step=0.1, value=l_,</span>
    <span class="c1">#                                        description=&#39;l&#39;)</span>
    <span class="c1">#         # Create a label to display the sum of A + a</span>
    <span class="c1">#         sum_label = Label()</span>
    <span class="c1">#</span>
    <span class="c1">#         # Arrange the sliders in a 3x3 layout</span>
    <span class="c1">#         ui = VBox([</span>
    <span class="c1">#             HBox([A_slider, B_slider, a_slider]),</span>
    <span class="c1">#             HBox([b_slider, Ri_slider, L_slider]),</span>
    <span class="c1">#             HBox([Req_slider, l_slider]),</span>
    <span class="c1">#             sum_label  # Add the sum label to the layout</span>
    <span class="c1">#         ])</span>
    <span class="c1">#</span>
    <span class="c1">#         # Create an interactive widget to update the plot</span>
    <span class="c1">#         out = widgets.interactive_output(plot_cavity_geometry_flattop,</span>
    <span class="c1">#                                          {&#39;A&#39;: A_slider, &#39;B&#39;: B_slider, &#39;a&#39;: a_slider, &#39;b&#39;: b_slider,</span>
    <span class="c1">#                                           &#39;Ri&#39;: Ri_slider, &#39;L&#39;: L_slider, &#39;Req&#39;: Req_slider, &#39;l&#39;: l_slider})</span>
    <span class="c1">#</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         A_, B_, a_, b_, Ri_, L_, Req_ = cell[:7]</span>
    <span class="c1">#</span>
    <span class="c1">#         # Define the function that plots the graph</span>
    <span class="c1">#         def plot_cavity_geometry(A, B, a, b, Ri, L, Req):</span>
    <span class="c1">#             cell = np.array([A, B, a, b, Ri, L, Req])</span>
    <span class="c1">#             # ax.clear()</span>
    <span class="c1">#             write_cavity_geometry_cli(cell, cell, cell, BP=&#39;none&#39;, n_cell=1,</span>
    <span class="c1">#                                       tangent_check=tangent_check, lw=3,</span>
    <span class="c1">#                                       plot=True, ax=ax,</span>
    <span class="c1">#                                       ignore_degenerate=True)</span>
    <span class="c1">#             # Update the sum display</span>
    <span class="c1">#             sum_label.value = f&#39;Sum of A + a: {A + a:.2f}, L: {L}, delta: {A + a - L}&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#         def run_eigenmode(b):</span>
    <span class="c1">#             eigenmode_config = {&#39;processes&#39;: 1}</span>
    <span class="c1">#             boundary_conds = &#39;mm&#39;</span>
    <span class="c1">#             eigenmode_config[&#39;boundary_conditions&#39;] = BOUNDARY_CONDITIONS_DICT[boundary_conds]</span>
    <span class="c1">#</span>
    <span class="c1">#             shape_space = {}</span>
    <span class="c1">#</span>
    <span class="c1">#             # run_eigenmode_s({self.name: self.shape}, {self.name: self.shape_multicell}, self.projectDir, eigenmode_config)</span>
    <span class="c1">#</span>
    <span class="c1">#         # Create sliders for each variable</span>
    <span class="c1">#         A_slider = widgets.FloatSlider(min=(1 - variation) * A_, max=(1 + variation) * A_, step=0.1, value=A_,</span>
    <span class="c1">#                                        description=&#39;A&#39;)</span>
    <span class="c1">#         B_slider = widgets.FloatSlider(min=(1 - variation) * B_, max=(1 + variation) * B_, step=0.1, value=B_,</span>
    <span class="c1">#                                        description=&#39;B&#39;)</span>
    <span class="c1">#         a_slider = widgets.FloatSlider(min=(1 - variation) * a_, max=(1 + variation) * a_, step=0.1, value=a_,</span>
    <span class="c1">#                                        description=&#39;a&#39;)</span>
    <span class="c1">#         b_slider = widgets.FloatSlider(min=(1 - variation) * b_, max=(1 + variation) * b_, step=0.1, value=b_,</span>
    <span class="c1">#                                        description=&#39;b&#39;)</span>
    <span class="c1">#         Ri_slider = widgets.FloatSlider(min=(1 - variation) * Ri_, max=(1 + variation) * Ri_, step=0.1, value=Ri_,</span>
    <span class="c1">#                                         description=&#39;Ri&#39;)</span>
    <span class="c1">#         L_slider = widgets.FloatSlider(min=(1 - variation) * L_, max=(1 + variation) * L_, step=0.1, value=L_,</span>
    <span class="c1">#                                        description=&#39;L&#39;)</span>
    <span class="c1">#         Req_slider = widgets.FloatSlider(min=(1 - variation) * Req_, max=(1 + variation) * Req_, step=0.1,</span>
    <span class="c1">#                                          value=Req_,</span>
    <span class="c1">#                                          description=&#39;Req&#39;)</span>
    <span class="c1">#         # Create a label to display the sum of A + a</span>
    <span class="c1">#         sum_label = Label()</span>
    <span class="c1">#</span>
    <span class="c1">#         # create run tune and run eigenmode button</span>
    <span class="c1">#         button_tune = widgets.Button(description=&quot;Tune&quot;)</span>
    <span class="c1">#         button_eigenmode = widgets.Button(description=&quot;Eigenmode&quot;)</span>
    <span class="c1">#         button_eigenmode.on_click(run_eigenmode)</span>
    <span class="c1">#</span>
    <span class="c1">#         # Arrange the sliders in a 3x3 layout</span>
    <span class="c1">#         ui = VBox([</span>
    <span class="c1">#             HBox([A_slider, B_slider, a_slider]),</span>
    <span class="c1">#             HBox([b_slider, Ri_slider, L_slider]),</span>
    <span class="c1">#             HBox([Req_slider]),</span>
    <span class="c1">#             sum_label,  # Add the sum label to the layout</span>
    <span class="c1">#             # HBox([button_tune, button_eigenmode])</span>
    <span class="c1">#         ])</span>
    <span class="c1">#</span>
    <span class="c1">#         # Create an interactive widget to update the plot</span>
    <span class="c1">#         out = widgets.interactive_output(plot_cavity_geometry,</span>
    <span class="c1">#                                          {&#39;A&#39;: A_slider, &#39;B&#39;: B_slider, &#39;a&#39;: a_slider, &#39;b&#39;: b_slider,</span>
    <span class="c1">#                                           &#39;Ri&#39;: Ri_slider, &#39;L&#39;: L_slider, &#39;Req&#39;: Req_slider})</span>
    <span class="c1">#</span>
    <span class="c1">#     # Display the layout</span>
    <span class="c1">#     display(out, ui)</span>

<div class="viewcode-block" id="Cavity.eval_expr">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.eval_expr">[docs]</a>
    <span class="k">def</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate numeric expression with symbols.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>

        <span class="k">def</span> <span class="nf">_eval</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Num</span><span class="p">):</span> <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">n</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span> <span class="k">return</span> <span class="n">symbols</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span> <span class="k">return</span> <span class="n">_ops</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">op</span><span class="p">)](</span><span class="n">_eval</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">left</span><span class="p">),</span> <span class="n">_eval</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">):</span> <span class="k">return</span> <span class="n">_ops</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">op</span><span class="p">)](</span><span class="n">_eval</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">operand</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported expression: </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_eval</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>


    <span class="c1"># Main converter</span>
<div class="viewcode-block" id="Cavity.geo_to_abc">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.geo_to_abc">[docs]</a>
    <span class="k">def</span> <span class="nf">geo_to_abc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Read input</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

        <span class="c1"># 1) Build symbol table from DefineNumber</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">define_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+)\s*=\s*DefineNumber\[\s*([^,\]]+)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">define_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">symbols</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Evaluate until fixed</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">symbols</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">symbols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_expr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">symbols</span><span class="p">)</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="c1"># 2) Parse geometry segments</span>
        <span class="n">point_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Point\((\d+)\)\s*=\s*\{([^}]+)\}&quot;</span><span class="p">)</span>
        <span class="n">ellipse_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Ellipse\(\d+\)\s*=\s*\{([^}]+)\}&quot;</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># pid -&gt; (r,z)</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of (&#39;point&#39;, r, z) or (&#39;ellipse&#39;, end_pid)</span>

        <span class="c1"># First pass: collect points structs and z-values</span>
        <span class="n">zvals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">point_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_expr</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">symbols</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_expr</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">symbols</span><span class="p">)</span>
                <span class="n">points</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                <span class="n">zvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="n">zmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zvals</span><span class="p">)</span> <span class="k">if</span> <span class="n">zvals</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Second pass: build segment list</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Point(&#39;</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">point_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
                <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;point&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Line(&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Ellipse(&#39;</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ellipse_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="c1"># remove last 3 point segments</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">segments</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="c1"># add ellipse indicator + endpoint</span>
                <span class="n">mid_pid</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">end_pid</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="c1"># segments.append((&#39;ellipse&#39;, mid_pid))</span>
                <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">mid_pid</span><span class="p">,</span> <span class="n">end_pid</span><span class="p">))</span>

        <span class="c1"># Create geometry if not crated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="c1"># 3) Write output</span>
        <span class="n">wakefield_folder_structure</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;wakefield&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;longitudinal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;transversal&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">wakefield_folder_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">)</span>

        <span class="n">MROT</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span>
        <span class="k">if</span>  <span class="n">MROT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_abc</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_abc</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">MROT</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_abc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">MROT</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># defaults</span>
        <span class="n">RDRIVE</span><span class="p">,</span> <span class="n">ISIG</span> <span class="o">=</span> <span class="mf">5e-3</span><span class="p">,</span> <span class="mi">5</span>
        <span class="n">LCRBW</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>  <span class="c1"># counter-rotating beam</span>
        <span class="n">ZSEP</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">BSEP</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">NBUNCH</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">BETA</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">LMATPR</span> <span class="o">=</span> <span class="s1">&#39;.F.&#39;</span>
        <span class="n">LPRW</span><span class="p">,</span> <span class="n">LPPW</span><span class="p">,</span> <span class="n">LSVW</span><span class="p">,</span> <span class="n">LSVWA</span><span class="p">,</span> <span class="n">LSVWT</span><span class="p">,</span> <span class="n">LSVWL</span><span class="p">,</span> <span class="n">LSVF</span> <span class="o">=</span> <span class="s1">&#39;.T.&#39;</span><span class="p">,</span> <span class="s1">&#39;.T.&#39;</span><span class="p">,</span> <span class="s1">&#39;.T.&#39;</span><span class="p">,</span> <span class="s1">&#39;.F.&#39;</span><span class="p">,</span> <span class="s1">&#39;.T.&#39;</span><span class="p">,</span> <span class="s1">&#39;.T.&#39;</span><span class="p">,</span> <span class="s1">&#39;.F.&#39;</span>
        <span class="n">LSAV</span><span class="p">,</span> <span class="n">LCPUTM</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span>
        <span class="n">LCBACK</span> <span class="o">=</span> <span class="s1">&#39;.T.&#39;</span>
        <span class="n">LPLE</span> <span class="o">=</span> <span class="s1">&#39;.F.&#39;</span>
        <span class="n">NSHOT</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">UBT</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">SIG</span> <span class="o">=</span> <span class="mf">25e-3</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">mesh_DDR</span> <span class="o">=</span> <span class="mf">0.00125</span>
        <span class="n">mesh_DDZ</span> <span class="o">=</span> <span class="mf">0.00125</span>

        <span class="c1"># unpack kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;RADIAL BEAM OFFSET AT (RDRIVE)&#39;</span><span class="p">:</span>
                <span class="n">RDRIVE</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;NUMBER OF WAKE POTENTIAL POINTS (NW)&#39;</span><span class="p">:</span>
                <span class="n">NW</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;WAKE FOR A COUNTER-ROTATING BEAM (LCRBW)&#39;</span><span class="p">:</span>
                <span class="n">LCRBW</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;VELOCITY OF THE BUNCH / C (BETA)&#39;</span><span class="p">:</span>
                <span class="n">BETA</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PRINTOUT OF CAVITY SHAPE USED (LMATPR)&#39;</span><span class="p">:</span>
                <span class="n">LMATPR</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PRINTOUT OF WAKE POTENTIALS (LPRW)&#39;</span><span class="p">:</span>
                <span class="n">LPRW</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;LINE-PRINTER PLOT OF WAKE POT. (LPPW)&#39;</span><span class="p">:</span>
                <span class="n">LPPW</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SAVE WAKE POTENTIALS IN A FILE (LSVW)&#39;</span><span class="p">:</span>
                <span class="n">LSVW</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SAVE AZIMUTHAL WAKE IN A FILE (LSVWA)&#39;</span><span class="p">:</span>
                <span class="n">LSVWA</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SAVE TRANSVERSE WAKE IN A FILE (LSVWT)&#39;</span><span class="p">:</span>
                <span class="n">LSVWT</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SAVE LONGITUDINAL WAKE IN A FILE (LSVWL)&#39;</span><span class="p">:</span>
                <span class="n">LSVWL</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SAVE FFT RESULTS IN A FILE (LSVF)&#39;</span><span class="p">:</span>
                <span class="n">LSVF</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;SAVE FIELDS INTO FILE (LSAV)&#39;</span><span class="p">:</span>
                <span class="n">LSAV</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;CPUTIME MONITOR ACTIVE (LCPUTM)&#39;</span><span class="p">:</span>
                <span class="n">LCPUTM</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="s1">&#39;save_fields&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">LPLE</span><span class="p">,</span> <span class="n">LCBACK</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;save_fields&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;nshot&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;save_fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">NSHOT</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;save_fields&#39;</span><span class="p">][</span><span class="s1">&#39;nshot&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;wake_config&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">wake_config</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wake_config&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;MT&#39;</span> <span class="ow">in</span> <span class="n">wake_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">MT</span> <span class="o">=</span> <span class="n">wake_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;counter_rotating&#39;</span><span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wake_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">LCRBW</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;separation&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wake_config&#39;</span><span class="p">][</span><span class="s1">&#39;counter_rotating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">ZSEP</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wake_config&#39;</span><span class="p">][</span><span class="s1">&#39;counter_rotating&#39;</span><span class="p">][</span><span class="s1">&#39;separation&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;beam_config&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;beam_offset&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">RDRIVE</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">][</span><span class="s1">&#39;beam_offset&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;nbunch&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">NBUNCH</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">][</span><span class="s1">&#39;nbunch&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;separation&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">BSEP</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;beam_config&#39;</span><span class="p">][</span><span class="s1">&#39;separation&#39;</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">,</span> <span class="n">MROT_DICT</span><span class="p">[</span><span class="n">MROT</span><span class="p">],</span> <span class="s1">&#39;cavity.abc&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="c1"># Header</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; &amp;FILE LSAV = .</span><span class="si">{</span><span class="n">LSAV</span><span class="si">}</span><span class="s1">., ITEST = 0, LREC = .F., LCPUTM = .</span><span class="si">{</span><span class="n">LCPUTM</span><span class="si">}</span><span class="s1">. &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; SAMPLE INPUT #1 A SIMPLE CAVITY STRUCTURE </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp;BOUN  IZL = 3, IZR = 3  &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; &amp;MESH DDR = </span><span class="si">{</span><span class="n">mesh_DDR</span><span class="si">}</span><span class="s1">, DDZ = </span><span class="si">{</span><span class="n">mesh_DDZ</span><span class="si">}</span><span class="s1"> &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; #CAVITYSHAPE</span><span class="se">\n</span><span class="s2">0.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Body</span>
            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">seg</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">.16f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.16f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">pid_m</span><span class="p">,</span> <span class="n">pid_e</span> <span class="o">=</span> <span class="n">seg</span>
                    <span class="n">r_m</span><span class="p">,</span> <span class="n">z_m</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">pid_m</span><span class="p">]</span>
                    <span class="n">r_e</span><span class="p">,</span> <span class="n">z_e</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">pid_e</span><span class="p">]</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-3., 0.000</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r_m</span><span class="si">:</span><span class="s2">.16f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zmin</span><span class="si">:</span><span class="s2">.16f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r_e</span><span class="si">:</span><span class="s2">.16f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z_e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zmin</span><span class="si">:</span><span class="s2">.16f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Closing</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.000 0.000</span><span class="se">\n</span><span class="s2">9999. 9999.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># wakefield simulation paramters</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; &amp;BEAM  SIG = </span><span class="si">{</span><span class="n">SIG</span><span class="si">}</span><span class="s1">, ISIG = </span><span class="si">{</span><span class="n">ISIG</span><span class="si">}</span><span class="s1">, RDRIVE = </span><span class="si">{</span><span class="n">RDRIVE</span><span class="si">}</span><span class="s1">, MROT = </span><span class="si">{</span><span class="n">MROT</span><span class="si">}</span><span class="s1">, NBUNCH = </span><span class="si">{</span><span class="n">NBUNCH</span><span class="si">}</span><span class="s1">, BSEP = </span><span class="si">{</span><span class="n">BSEP</span><span class="si">}</span><span class="s1"> &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># out.write(&#39; &amp;BEAM  SIG = {}, MROT = {}, RDRIVE = {}  &amp;END \n&#39;.format(SIG, MROT, 0.005))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; &amp;TIME  MT = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span><span class="si">}</span><span class="s1"> &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39; &amp;WAKE  UBT = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">UBT</span><span class="p">)</span><span class="si">}</span><span class="s1">, LCRBW = .</span><span class="si">{</span><span class="n">LCRBW</span><span class="si">}</span><span class="s1">., LCBACK = </span><span class="si">{</span><span class="n">LCBACK</span><span class="si">}</span><span class="s1">, LCRBW = .</span><span class="si">{</span><span class="n">LCRBW</span><span class="si">}</span><span class="s1">., ZSEP = </span><span class="si">{</span><span class="n">ZSEP</span><span class="si">}</span><span class="s1"> &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># , NFS = {NFS}</span>
            <span class="c1"># f.write(&#39; &amp;WAKE  UBT = {}, LCHIN = F, LNAPOLY = F, LNONAP = F &amp;END \n&#39;.format(UBT, wake_offset))</span>
            <span class="c1"># f.write(&#39; &amp;WAKE R  = {}   &amp;END \n&#39;.format(wake_offset))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; &amp;PLOT  LCAVIN = .T., LCAVUS = .F., LPLW = .T., LFFT = .T., LSPEC = .T., &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;LINTZ = .F., LPATH = .T., LPLE = </span><span class="si">{</span><span class="n">LPLE</span><span class="si">}</span><span class="s1">, LPLC= .F. &amp;END </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; &amp;PRIN  LMATPR = </span><span class="si">{</span><span class="n">LMATPR</span><span class="si">}</span><span class="s1">, LPRW = </span><span class="si">{</span><span class="n">LPRW</span><span class="si">}</span><span class="s1">, LPPW = </span><span class="si">{</span><span class="n">LPPW</span><span class="si">}</span><span class="s1">, LSVW = </span><span class="si">{</span><span class="n">LSVW</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;LSVWA = </span><span class="si">{</span><span class="n">LSVWA</span><span class="si">}</span><span class="s1">, LSVWT = </span><span class="si">{</span><span class="n">LSVWT</span><span class="si">}</span><span class="s1">, LSVWL = </span><span class="si">{</span><span class="n">LSVWL</span><span class="si">}</span><span class="s1">,  LSVF = </span><span class="si">{</span><span class="n">LSVF</span><span class="si">}</span><span class="s1">   &amp;END</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">STOP</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Cavity.to_multicell">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.to_multicell">[docs]</a>
    <span class="k">def</span> <span class="nf">to_multicell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mid_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mid_cell_multi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mid_cell</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid_cell_multi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;multicell&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;geo_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">_create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>

        <span class="k">if</span> <span class="n">project_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>

            <span class="c1"># check if folder already exist</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_path_exists</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">make_dirs_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">current_dir</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                            <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

                <span class="c1"># create project structure in folders</span>
                <span class="n">project_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;Cavities&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;OperatingPoints&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;SimulationData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;SLANS&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;SLANS_Opt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;NativeEig&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;CavitiesAnalysis&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;PostprocessingData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;Plots&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;CSTData&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">project_dir_structure</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;An exception occurred in created project: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Please enter a valid project name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_if_path_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">directory_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Cavities&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;PostprocessingData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;SimulationData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">directory_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">It seems that the folder specified is not a cavity project folder. Please check folder&#39;</span>
                             <span class="s1">&#39;again to avoid deleting important files.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_overwriteFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invar</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;SLANS&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_process_</span><span class="si">{</span><span class="n">invar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dir_util</span><span class="o">.</span><span class="n">_path_created</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_copyFiles</span><span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parentDir</span><span class="p">,</span> <span class="s1">&#39;exe&#39;</span><span class="p">,</span> <span class="s1">&#39;SLANS_exe&#39;</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;SLANS&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_process_</span><span class="si">{</span><span class="n">invar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;SLANS_exe&#39;</span><span class="p">)</span>

        <span class="n">dir_util</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">p</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tune&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_results</span><span class="p">,</span>
            <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">,</span>
            <span class="s1">&#39;hom&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="p">,</span>
            <span class="s1">&#39;uq&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;tune&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="p">,</span>
                <span class="s1">&#39;hom&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="Cavity.create">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.create">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="EllipticalCavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavity">[docs]</a>
<span class="k">class</span> <span class="nc">EllipticalCavity</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mid_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">end_cell_right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cavity&#39;</span><span class="p">,</span>
                 <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;simplecell&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">plot_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the old “dimension‐based” logic has been moved here.</span>
<span class="sd">        Assumes self.kind, self.name, self.color, etc. are already set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;elliptical cavity&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">beampipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="n">cell_parameterisation</span>

        <span class="c1"># Basic counters / containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_of_modules</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Handle the special case: mid_cell can be a dict with keys OC, OC_R, IC</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
            <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
            <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">mid_cell</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">)</span>

        <span class="c1"># Unpack 7 parameters</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_el</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">b_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">Req_el</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_er</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">b_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">Req_er</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>

        <span class="c1"># Active length &amp; cavity length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span>
                        <span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span>

        <span class="c1"># Build self.shape dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
            <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
            <span class="s2">&quot;OC_R&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
            <span class="s2">&quot;BP&quot;</span><span class="p">:</span> <span class="n">beampipe</span><span class="p">,</span>
            <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span>
            <span class="s2">&quot;CELL PARAMETERISATION&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">,</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_geometric_parameters</span><span class="p">()</span>

<div class="viewcode-block" id="EllipticalCavity.create">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavity.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span>
        <span class="k">if</span> <span class="n">beampipe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beampipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">:</span>
            <span class="n">cav_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">)):</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>

            <span class="c1"># write geometry file to folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># define different paths for easier reference later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;uq&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;geodata.geo&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_quarter_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="EllipticalCavity.write_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavity.write_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">BP</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">contour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tangent_check</span>
<span class="sd">        bc</span>
<span class="sd">        ax</span>
<span class="sd">        ignore_degenerate</span>
<span class="sd">        IC: list, ndarray</span>
<span class="sd">            Inner Cell geometric parameters list</span>
<span class="sd">        OC: list, ndarray</span>
<span class="sd">            Left outer Cell geometric parameters list</span>
<span class="sd">        OC_R: list, ndarray</span>
<span class="sd">            Right outer Cell geometric parameters list</span>
<span class="sd">        BP: str {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        n_cell: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        scale: float</span>
<span class="sd">            Scale of the cavity geometry</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">GEO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># IC, OC, OC_R = shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;]</span>
        <span class="c1"># BP = self.beampipe</span>
        <span class="c1"># n_cell = self.n_cells</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A_m&#39;</span><span class="p">,</span> <span class="s1">&#39;B_m&#39;</span><span class="p">,</span> <span class="s1">&#39;a_m&#39;</span><span class="p">,</span> <span class="s1">&#39;b_m&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri_m&#39;</span><span class="p">,</span> <span class="s1">&#39;L_m&#39;</span><span class="p">,</span> <span class="s1">&#39;Req_m&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;A_el&#39;</span><span class="p">,</span> <span class="s1">&#39;B_el&#39;</span><span class="p">,</span> <span class="s1">&#39;a_el&#39;</span><span class="p">,</span> <span class="s1">&#39;b_el&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri_el&#39;</span><span class="p">,</span> <span class="s1">&#39;L_el&#39;</span><span class="p">,</span> <span class="s1">&#39;Req_el&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;A_er&#39;</span><span class="p">,</span> <span class="s1">&#39;B_er&#39;</span><span class="p">,</span> <span class="s1">&#39;a_er&#39;</span><span class="p">,</span> <span class="s1">&#39;b_er&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri_er&#39;</span><span class="p">,</span> <span class="s1">&#39;L_er&#39;</span><span class="p">,</span> <span class="s1">&#39;Req_er&#39;</span><span class="p">]</span>

        <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">Req_m</span><span class="p">,</span> \
            <span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="n">L_el</span><span class="p">,</span> <span class="n">Req_el</span><span class="p">,</span> \
            <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="n">L_er</span><span class="p">,</span> <span class="n">Req_er</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>

        <span class="n">Req</span> <span class="o">=</span> <span class="n">Req_m</span>  <span class="c1"># CHANGE THIS, Req should be same</span>

        <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L_m</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="ow">or</span> <span class="n">contour</span><span class="p">:</span>
            <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">L_m</span>

        <span class="k">if</span> <span class="n">BP</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">elif</span> <span class="n">BP</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>
        <span class="k">elif</span> <span class="n">BP</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.0005</span>

        <span class="c1"># calculate shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># calculate angles outside loop</span>
        <span class="c1"># CALCULATE x1_el, y1_el, x2_el, y2_el</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="n">L_el</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
        <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">,</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                <span class="c1"># save figure of error</span>
                <span class="k">return</span>

        <span class="c1"># CALCULATE x1, y1, x2, y2</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                <span class="c1"># save figure of error</span>
                <span class="k">return</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="n">L_er</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_r</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
        <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span><span class="p">,</span> <span class="n">x2er</span><span class="p">,</span> <span class="n">y2er</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                <span class="c1"># save figure of error</span>
                <span class="k">return</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.n&#39;</span><span class="p">,</span> <span class="s1">&#39;.geo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cav</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetFactory(&quot;OpenCASCADE&quot;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># # define parameters</span>
            <span class="c1"># cav.write(f&#39;\nA_el = DefineNumber[{A_el}, Name &quot;Parameters/End cell 1 Equator ellipse major axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nB_el = DefineNumber[{B_el}, Name &quot;Parameters/End cell 1 Equator ellipse minor axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\na_el = DefineNumber[{a_el}, Name &quot;Parameters/End cell 1 Iris ellipse major axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nb_el = DefineNumber[{b_el}, Name &quot;Parameters/End cell 1 Iris ellipse minor axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nRi_el = DefineNumber[{Ri_el}, Name &quot;Parameters/End cell 1 Iris radius&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nL_el = DefineNumber[{L_el}, Name &quot;Parameters/End cell 1 Half cell length&quot;];&#39;)</span>
            <span class="c1"># # cav.write(f&#39;\nReq_el = DefineNumber[{Req}, Name &quot;Parameters/End cell 1 Equator radius&quot;];\n&#39;)</span>
            <span class="c1">#</span>
            <span class="c1"># cav.write(f&#39;\nA_m = DefineNumber[{A_el}, Name &quot;Parameters/Mid cell Equator ellipse major axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nB_m = DefineNumber[{B_el}, Name &quot;Parameters/Mid cell Equator ellipse minor axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\na_m = DefineNumber[{a_el}, Name &quot;Parameters/Mid cell Iris ellipse major axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nb_m = DefineNumber[{b_el}, Name &quot;Parameters/Mid cell Iris ellipse minor axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nRi_m = DefineNumber[{Ri_el}, Name &quot;Parameters/Mid cell Iris radius&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nL_m = DefineNumber[{L_el}, Name &quot;Parameters/Mid cell Half cell length&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nReq = DefineNumber[{Req}, Name &quot;Parameters/Mid cell Equator radius&quot;];\n&#39;)</span>
            <span class="c1">#</span>
            <span class="c1"># cav.write(f&#39;\nA_er = DefineNumber[{A_el}, Name &quot;Parameters/End cell 2 Equator ellipse major axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nB_er = DefineNumber[{B_el}, Name &quot;Parameters/End cell 2 Equator ellipse minor axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\na_er = DefineNumber[{a_el}, Name &quot;Parameters/End cell 2 Iris ellipse major axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nb_er = DefineNumber[{b_el}, Name &quot;Parameters/End cell 2 Iris ellipse minor axis&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nRi_er = DefineNumber[{Ri_el}, Name &quot;Parameters/End cell 2 Iris radius&quot;];&#39;)</span>
            <span class="c1"># cav.write(f&#39;\nL_er = DefineNumber[{L_el}, Name &quot;Parameters/End cell 2 Half cell length&quot;];&#39;)</span>
            <span class="c1"># # cav.write(f&#39;\nReq_er = DefineNumber[{Req}, Name &quot;Parameters/End cell 2 Equator radius&quot;];\n&#39;)</span>

            <span class="c1"># SHIFT POINT TO START POINT</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0]])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">bc</span><span class="p">:</span>
                <span class="c1"># draw left boundary condition</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="o">-</span><span class="n">shift</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">Ri_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">,</span> <span class="o">-</span><span class="n">shift</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ri_el</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">-</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">,</span> <span class="o">-</span><span class="n">shift</span> <span class="o">-</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">Ri_el</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

            <span class="c1"># ADD BEAM PIPE LENGTH</span>
            <span class="k">if</span> <span class="n">L_bp_l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="c1"># for pp in pts:</span>
                <span class="c1">#     geo.append([pp[1], pp[0]])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">]</span>

                <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># DRAW ARC:</span>
                    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                        <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_el</span><span class="p">,</span>
                                                                 <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                                 <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span>
                                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span>
                                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">),</span>
                                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span>
                                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># DRAW LINE CONNECTING ARCS</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                    <span class="c1"># for pp in pts:</span>
                    <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                        <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A_el</span><span class="p">,</span>
                                                                 <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                                 <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span>
                                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_el</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span>
                                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">),</span>
                                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span>
                                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">A_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">B_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                    <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>

                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_el</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">n_cells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">L_bp_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                            <span class="c1"># half of bounding box is required,</span>
                            <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>

                            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">]</span>
                            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">]</span>
                            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span>
                                                              <span class="n">end_pt</span><span class="p">)</span>
                            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                            <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">])</span>
                            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>

                            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                                <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                                                         <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A_er</span><span class="p">,</span>
                                                                         <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                                                         <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                                         <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">),</span>
                                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">A_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                        <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">B_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                            <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                            <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                            <span class="c1"># for pp in pts:</span>
                            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>

                            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                            <span class="c1"># ARC</span>
                            <span class="c1"># half of bounding box is required,</span>
                            <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">]</span>
                            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">]</span>
                            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span>
                                                              <span class="n">end_pt</span><span class="p">)</span>
                            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                            <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>

                            <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                                <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                                                         <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_er</span><span class="p">,</span>
                                                                         <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                                                         <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                                         <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">),</span>
                                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>

                            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                            <span class="c1"># calculate new shift</span>
                            <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                            <span class="c1"># half of bounding box is required,</span>
                            <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">]</span>
                            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">]</span>
                            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span>
                                                              <span class="n">end_pt</span><span class="p">)</span>
                            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                            <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">])</span>
                            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>

                            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                            <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                            <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                            <span class="c1"># for pp in pts:</span>
                            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>

                            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                            <span class="c1"># ARC</span>
                            <span class="c1"># half of bounding box is required,</span>
                            <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                            <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                                <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                                                         <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_er</span><span class="p">,</span>
                                                                         <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                                                         <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                                         <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">),</span>
                                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">]</span>
                            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">]</span>
                            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span>
                                                              <span class="n">end_pt</span><span class="p">)</span>
                            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                            <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>
                            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>

                            <span class="c1"># pt_indx += 1</span>

                            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                        <span class="c1"># half of bounding box is required,</span>
                        <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>

                        <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                        <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                        <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                        <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                        <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span>
                                                          <span class="n">end_pt</span><span class="p">)</span>
                        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                        <span class="c1"># for pp in pts:</span>
                        <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>

                        <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                        <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># ARC</span>
                        <span class="c1"># half of bounding box is required,</span>
                        <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                        <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                        <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                        <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                        <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>
                        <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span>
                                                          <span class="n">end_pt</span><span class="p">)</span>
                        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># calculate new shift</span>
                        <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span><span class="p">)</span>
                        <span class="c1"># ic(shift)</span>

                <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">n_cells</span><span class="p">:</span>
                    <span class="c1"># DRAW ARC:</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># DRAW LINE CONNECTING ARCS</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                    <span class="c1"># for pp in pts:</span>
                    <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                    <span class="c1"># half of bounding box is required,</span>
                    <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                    <span class="c1"># for pp in pts:</span>
                    <span class="c1">#     geo.append([pp[1], pp[0]])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># ARC</span>
                    <span class="c1"># half of bounding box is required,</span>
                    <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># calculate new shift</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># DRAW ARC:</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># DRAW LINE CONNECTING ARCS</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                    <span class="c1"># for pp in pts:</span>
                    <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                    <span class="c1"># half of bounding box is required,</span>
                    <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                    <span class="c1"># for pp in pts:</span>
                    <span class="c1">#     geo.append([pp[1], pp[0]])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># ARC</span>
                    <span class="c1"># half of bounding box is required,</span>
                    <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">]</span>
                    <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">]</span>
                    <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">L_bp_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># BEAM PIPE</span>
            <span class="c1"># reset shift</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">L_bp_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if there&#39;s a problem, check here.</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="c1"># for pp in pts:</span>
                <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>

                <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># END PATH</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                         <span class="n">step</span><span class="p">)</span>  <span class="c1"># to add beam pipe to right</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># closing line</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Line(</span><span class="si">{</span><span class="n">curve_indx</span><span class="si">}</span><span class="s2">) = </span><span class="se">{{</span><span class="si">{</span><span class="n">pt_indx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># lineTo(pt, [2 * n_cell * L_er + L_bp_l - shift, 0], step)</span>
            <span class="c1"># pt = [2 * n_cell * L_er + L_bp_l - shift, 0]</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">pmcs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curve</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmcs</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)]</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PEC&quot;) = </span><span class="si">{</span><span class="n">pecs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PMC&quot;) = </span><span class="si">{</span><span class="n">pmcs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;AXI&quot;) = </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Curve Loop(1) = </span><span class="si">{</span><span class="n">curve</span><span class="si">}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plane Surface(1) = </span><span class="se">{{</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse Surface </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Surface(&quot;Domain&quot;) = </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span>

        <span class="c1"># write geometry</span>
        <span class="c1"># if write:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         df = pd.DataFrame(geo, columns=[&#39;r&#39;, &#39;z&#39;, &#39;bc&#39;])</span>
        <span class="c1">#         # change point data precision</span>
        <span class="c1">#         df[&#39;r&#39;] = df[&#39;r&#39;].round(8)</span>
        <span class="c1">#         df[&#39;z&#39;] = df[&#39;z&#39;].round(8)</span>
        <span class="c1">#         # drop duplicates</span>
        <span class="c1">#         df.drop_duplicates(subset=[&#39;r&#39;, &#39;z&#39;], inplace=True, keep=&#39;last&#39;)</span>
        <span class="c1">#         df.to_csv(write, sep=&#39;\t&#39;, index=False)</span>
        <span class="c1">#     except FileNotFoundError as e:</span>
        <span class="c1">#         error(&#39;Check file path:: &#39;, e)</span>

        <span class="c1"># append start point</span>
        <span class="c1"># geo.append([start_point[1], start_point[0], 0])</span>

        <span class="k">if</span> <span class="n">bc</span><span class="p">:</span>
            <span class="c1"># draw right boundary condition</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">Ri_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">shift</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">shift</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">shift</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">shift</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># CLOSE PATH</span>
        <span class="c1"># lineTo(pt, start_point, step)</span>
        <span class="c1"># geo.append([start_point[1], start_point[0], 0])</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geo</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">dimension</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">geo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># recenter asymmetric cavity to center</span>
                <span class="n">shift_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">n_cells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">shift_to_center</span> <span class="o">=</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_r</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shift_to_center</span> <span class="o">=</span> <span class="n">n_cells</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_r</span>

                <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">geo</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_left</span> <span class="o">+</span> <span class="n">shift_to_center</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">geo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">geo</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_left</span> <span class="o">+</span> <span class="n">shift_to_center</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="o">-</span><span class="n">geo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span>
                                 <span class="n">c</span><span class="o">=</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># plot legend without duplicates</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="EllipticalCavity.write_quarter_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavity.write_quarter_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_quarter_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">bp</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">contour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tangent_check</span>
<span class="sd">        bc</span>
<span class="sd">        ax</span>
<span class="sd">        ignore_degenerate</span>
<span class="sd">        IC: list, ndarray</span>
<span class="sd">            Inner Cell geometric parameters list</span>
<span class="sd">        OC: list, ndarray</span>
<span class="sd">            Left outer Cell geometric parameters list</span>
<span class="sd">        OC_R: list, ndarray</span>
<span class="sd">            Right outer Cell geometric parameters list</span>
<span class="sd">        BP: str {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        n_cell: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        scale: float</span>
<span class="sd">            Scale of the cavity geometry</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">GEO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_m&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_el&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_er&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_m&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>

        <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="ow">or</span> <span class="n">contour</span><span class="p">:</span>
            <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">L</span>

        <span class="k">if</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span> <span class="ow">or</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.0005</span>

        <span class="c1"># calculate shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.n&#39;</span><span class="p">,</span> <span class="s1">&#39;.geo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cav</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetFactory(&quot;OpenCASCADE&quot;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># define parameters</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">A = DefineNumber[</span><span class="si">{</span><span class="n">A</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Equator ellipse major axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">B = DefineNumber[</span><span class="si">{</span><span class="n">B</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Equator ellipse minor axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">a = DefineNumber[</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Iris ellipse major axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">b = DefineNumber[</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Iris ellipse minor axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Ri = DefineNumber[</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Iris radius&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">L = DefineNumber[</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Half cell length&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Req = DefineNumber[</span><span class="si">{</span><span class="n">Req</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Equator radius&quot;];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># SHIFT POINT TO START POINT</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># ADD BEAM PIPE LENGTH</span>
            <span class="k">if</span> <span class="n">L_bp_l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span>

                <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                    <span class="c1"># save figure of error</span>
                    <span class="k">return</span>

            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="s1">&#39;Ri + b&#39;</span><span class="p">]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> + a&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri + b&#39;</span><span class="p">]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcTo(L_bp_l - shift, Ri + b, a, b, step, pt, [-shift + x1, y1])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>

            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="c1"># geo.append([pt[1], pt[0], 0])</span>

            <span class="c1"># DRAW LINE CONNECTING ARCS</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>

            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;L + </span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Req - B&#39;</span><span class="p">]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;L + </span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> - A&#39;</span><span class="p">,</span> <span class="s1">&#39;Req - B&#39;</span><span class="p">]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> + L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcTo(L + L_bp_l - shift, Req - B, A, B, step, pt, [L_bp_l + L - shift, Req])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> + L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>

            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># BEAM PIPE</span>
            <span class="c1"># reset shift</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># END PATH</span>
            <span class="c1"># pts = lineTo(pt, [L+ L_bp_l + - shift, 0],</span>
            <span class="c1">#              step)  # to add beam pipe to right</span>

            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># closing line</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Line(</span><span class="si">{</span><span class="n">curve_indx</span><span class="si">}</span><span class="s2">) = </span><span class="se">{{</span><span class="si">{</span><span class="n">pt_indx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">pmcs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curve</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmcs</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)]</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PEC&quot;) = </span><span class="si">{</span><span class="n">pecs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PMC&quot;) = </span><span class="si">{</span><span class="n">pmcs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;AXI&quot;) = </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Curve Loop(1) = </span><span class="si">{</span><span class="n">curve</span><span class="si">}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plane Surface(1) = </span><span class="se">{{</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse Surface </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Surface(&quot;Domain&quot;) = </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EllipticalCavity.get_geometric_parameters">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavity.get_geometric_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_geometric_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;Ri&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;Req&quot;</span><span class="p">]</span>
        <span class="n">shape_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="s1">&#39;el&#39;</span><span class="p">,</span> <span class="s2">&quot;OC_R&quot;</span><span class="p">:</span> <span class="s1">&#39;er&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">shape_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">shape_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>
</div>



<div class="viewcode-block" id="SplineCavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.SplineCavity">[docs]</a>
<span class="k">class</span> <span class="nc">SplineCavity</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SplineCavity&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;Berzier&#39;</span><span class="p">):</span>
        <span class="c1"># self.shape_space = {</span>
        <span class="c1">#     &#39;IC&#39;: [L, Req, Ri, S, L_bp],</span>
        <span class="c1">#     &#39;BP&#39;: beampipe</span>
        <span class="c1"># }</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>  <span class="c1"># consider removing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="s1">&#39;n_cells&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s1">&#39;beampipe&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">beampipe</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;beampipe&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;n_cells&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
            <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_geometric_parameters</span><span class="p">()</span>

<div class="viewcode-block" id="SplineCavity.create">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.SplineCavity.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span>
        <span class="k">if</span> <span class="n">beampipe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beampipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">:</span>
            <span class="n">cav_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">)):</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>

            <span class="c1"># write geometry file to folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># define different paths for easier reference later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;uq&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;geodata.geo&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">,</span>
                                <span class="n">write</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="SplineCavity.get_geometric_parameters">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.SplineCavity.get_geometric_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_geometric_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SplineCavity.write_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.SplineCavity.write_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tangent_check</span>
<span class="sd">        bc</span>
<span class="sd">        ax</span>
<span class="sd">        ignore_degenerate</span>
<span class="sd">        IC: list, ndarray</span>
<span class="sd">            Inner Cell geometric parameters list</span>
<span class="sd">        OC: list, ndarray</span>
<span class="sd">            Left outer Cell geometric parameters list</span>
<span class="sd">        OC_R: list, ndarray</span>
<span class="sd">            Right outer Cell geometric parameters list</span>
<span class="sd">        BP: str {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        n_cell: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        scale: float</span>
<span class="sd">            Scale of the cavity geometry</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">*</span><span class="mf">1e-3</span>

        <span class="n">Ri_el</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">L_m</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.0005</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.n&#39;</span><span class="p">,</span> <span class="s1">&#39;.geo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cav</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetFactory(&quot;OpenCASCADE&quot;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># SHIFT POINT TO START POINT</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>

            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_indx</span><span class="p">)</span>

            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># cavity cell surface</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;BSpline&#39;</span><span class="p">:</span>
                <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_bspline</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">n_cells</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Bezier&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cells</span><span class="p">):</span>
                    <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_bezierspline</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_cells</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


            <span class="c1"># right iris</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># closing line</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Line(</span><span class="si">{</span><span class="n">curve_indx</span><span class="si">}</span><span class="s2">) = </span><span class="se">{{</span><span class="si">{</span><span class="n">pt_indx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">pmcs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curve</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmcs</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)]</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PEC&quot;) = </span><span class="si">{</span><span class="n">pecs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PMC&quot;) = </span><span class="si">{</span><span class="n">pmcs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;AXI&quot;) = </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Curve Loop(1) = </span><span class="si">{</span><span class="n">curve</span><span class="si">}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plane Surface(1) = </span><span class="se">{{</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse Surface </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Surface(&quot;Domain&quot;) = </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SplineCavity.write_quarter_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.SplineCavity.write_quarter_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_quarter_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">bp</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">contour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tangent_check</span>
<span class="sd">        bc</span>
<span class="sd">        ax</span>
<span class="sd">        ignore_degenerate</span>
<span class="sd">        IC: list, ndarray</span>
<span class="sd">            Inner Cell geometric parameters list</span>
<span class="sd">        OC: list, ndarray</span>
<span class="sd">            Left outer Cell geometric parameters list</span>
<span class="sd">        OC_R: list, ndarray</span>
<span class="sd">            Right outer Cell geometric parameters list</span>
<span class="sd">        BP: str {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        n_cell: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        scale: float</span>
<span class="sd">            Scale of the cavity geometry</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">GEO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_m&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_el&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_er&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">_m&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>

        <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="ow">or</span> <span class="n">contour</span><span class="p">:</span>
            <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">L</span>

        <span class="k">if</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span> <span class="ow">or</span> <span class="n">bp</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.0005</span>

        <span class="c1"># calculate shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.n&#39;</span><span class="p">,</span> <span class="s1">&#39;.geo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cav</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetFactory(&quot;OpenCASCADE&quot;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># define parameters</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">A = DefineNumber[</span><span class="si">{</span><span class="n">A</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Equator ellipse major axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">B = DefineNumber[</span><span class="si">{</span><span class="n">B</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Equator ellipse minor axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">a = DefineNumber[</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Iris ellipse major axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">b = DefineNumber[</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Iris ellipse minor axis&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Ri = DefineNumber[</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Iris radius&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">L = DefineNumber[</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Half cell length&quot;];&#39;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Req = DefineNumber[</span><span class="si">{</span><span class="n">Req</span><span class="si">}</span><span class="s1">, Name &quot;Parameters/Equator radius&quot;];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># SHIFT POINT TO START POINT</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># ADD BEAM PIPE LENGTH</span>
            <span class="k">if</span> <span class="n">L_bp_l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span>

                <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                    <span class="c1"># save figure of error</span>
                    <span class="k">return</span>

            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="s1">&#39;Ri + b&#39;</span><span class="p">]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> + a&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri + b&#39;</span><span class="p">]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcTo(L_bp_l - shift, Ri + b, a, b, step, pt, [-shift + x1, y1])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>

            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="c1"># geo.append([pt[1], pt[0], 0])</span>

            <span class="c1"># DRAW LINE CONNECTING ARCS</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>

            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;L + </span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Req - B&#39;</span><span class="p">]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;L + </span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> - A&#39;</span><span class="p">,</span> <span class="s1">&#39;Req - B&#39;</span><span class="p">]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> + L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcTo(L + L_bp_l - shift, Req - B, A, B, step, pt, [L_bp_l + L - shift, Req])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">L_bp_l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift</span><span class="si">}</span><span class="s1"> + L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>

            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># BEAM PIPE</span>
            <span class="c1"># reset shift</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># END PATH</span>
            <span class="c1"># pts = lineTo(pt, [L+ L_bp_l + - shift, 0],</span>
            <span class="c1">#              step)  # to add beam pipe to right</span>

            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     geo.append([pp[1], pp[0], 0])</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># closing line</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Line(</span><span class="si">{</span><span class="n">curve_indx</span><span class="si">}</span><span class="s2">) = </span><span class="se">{{</span><span class="si">{</span><span class="n">pt_indx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">pmcs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curve</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmcs</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)]</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PEC&quot;) = </span><span class="si">{</span><span class="n">pecs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PMC&quot;) = </span><span class="si">{</span><span class="n">pmcs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;AXI&quot;) = </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Curve Loop(1) = </span><span class="si">{</span><span class="n">curve</span><span class="si">}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plane Surface(1) = </span><span class="se">{{</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse Surface </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Surface(&quot;Domain&quot;) = </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EllipticalCavityFlatTop">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavityFlatTop">[docs]</a>
<span class="k">class</span> <span class="nc">EllipticalCavityFlatTop</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mid_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">end_cell_right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cavity&#39;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">plot_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the old “dimension‐based” logic has been moved here.</span>
<span class="sd">        Assumes self.kind, self.name, self.color, etc. are already set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;elliptical cavity flat top&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">beampipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="s1">&#39;flattop&#39;</span>

        <span class="c1"># Basic counters / containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_of_modules</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Handle the special case: mid_cell can be a dict with keys OC, OC_R, IC</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
            <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
            <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">mid_cell</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>

        <span class="c1"># Must have at least length = 8 in each cell‐parameter list</span>
        <span class="k">assert</span> <span class="n">mid_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">,</span> \
            <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Flattop cavity mid‐cells require at least 8 input parameters, with the 8th representing length (l).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">,</span> \
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Flattop cavity left end‐cells require at least 8 input parameters, with the 8th representing &quot;</span>
                    <span class="s2">&quot;length (l).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">,</span> \
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Flattop cavity right end‐cells require at least 8 input parameters, with the 8th representing &quot;</span>
                    <span class="s2">&quot;length (l).&quot;</span><span class="p">)</span>

        <span class="c1"># Truncate or pad to exactly 8 elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span> <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span> <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span>

        <span class="c1"># Ensure end_cell_left / end_cell_right exist</span>
        <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span>
        <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span>

        <span class="c1"># Unpack</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_el</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">Ri_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_el</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_er</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">Ri_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_er</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>

        <span class="c1"># Active length &amp; cavity length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_el</span> <span class="o">+</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_er</span>
                        <span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>

        <span class="c1"># Build self.shape dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
            <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
            <span class="s2">&quot;OC_R&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
            <span class="s2">&quot;BP&quot;</span><span class="p">:</span> <span class="n">beampipe</span><span class="p">,</span>
            <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span>
            <span class="s2">&quot;CELL PARAMETERISATION&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">,</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="s2">&quot;geo_file&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Produce multicell representation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_geometric_parameters</span><span class="p">()</span>

<div class="viewcode-block" id="EllipticalCavityFlatTop.create">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavityFlatTop.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span>
        <span class="k">if</span> <span class="n">beampipe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beampipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">:</span>
            <span class="n">cav_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">)):</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>

            <span class="c1"># write geometry file to folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;geodata.geo&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">,</span>
                                <span class="n">write</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="EllipticalCavityFlatTop.write_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavityFlatTop.write_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">BP</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">contour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        BP</span>
<span class="sd">        OC_R</span>
<span class="sd">        OC</span>
<span class="sd">        ignore_degenerate</span>
<span class="sd">        file_path: str</span>
<span class="sd">            File path to write geometry to</span>
<span class="sd">        n_cell: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        mid_cell: list, ndarray</span>
<span class="sd">            Array of cavity middle cells&#39; geometric parameters</span>
<span class="sd">        end_cell_left: list, ndarray</span>
<span class="sd">            Array of cavity left end cell&#39;s geometric parameters</span>
<span class="sd">        end_cell_right: list, ndarray</span>
<span class="sd">            Array of cavity left end cell&#39;s geometric parameters</span>
<span class="sd">        beampipe: str {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        plot: bool</span>
<span class="sd">            If True, the cavity geometry is plotted for viewing</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A_m&#39;</span><span class="p">,</span> <span class="s1">&#39;B_m&#39;</span><span class="p">,</span> <span class="s1">&#39;a_m&#39;</span><span class="p">,</span> <span class="s1">&#39;b_m&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri_m&#39;</span><span class="p">,</span> <span class="s1">&#39;L_m&#39;</span><span class="p">,</span> <span class="s1">&#39;Req_m&#39;</span><span class="p">,</span> <span class="s1">&#39;l_m&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;A_el&#39;</span><span class="p">,</span> <span class="s1">&#39;B_el&#39;</span><span class="p">,</span> <span class="s1">&#39;a_el&#39;</span><span class="p">,</span> <span class="s1">&#39;b_el&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri_el&#39;</span><span class="p">,</span> <span class="s1">&#39;L_el&#39;</span><span class="p">,</span> <span class="s1">&#39;Req_el&#39;</span><span class="p">,</span> <span class="s1">&#39;l_el&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;A_er&#39;</span><span class="p">,</span> <span class="s1">&#39;B_er&#39;</span><span class="p">,</span> <span class="s1">&#39;a_er&#39;</span><span class="p">,</span> <span class="s1">&#39;b_er&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri_er&#39;</span><span class="p">,</span> <span class="s1">&#39;L_er&#39;</span><span class="p">,</span> <span class="s1">&#39;Req_er&#39;</span><span class="p">,</span> <span class="s1">&#39;l_er&#39;</span><span class="p">]</span>

        <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">Req_m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> \
            <span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="n">L_el</span><span class="p">,</span> <span class="n">Req_el</span><span class="p">,</span> <span class="n">l_el</span><span class="p">,</span> \
            <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="n">L_er</span><span class="p">,</span> <span class="n">Req_er</span><span class="p">,</span> <span class="n">l_er</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="n">Req</span> <span class="o">=</span> <span class="n">Req_m</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.005</span>

        <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L_m</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="ow">or</span> <span class="n">contour</span><span class="p">:</span>
            <span class="n">L_bp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">L_m</span>

        <span class="k">if</span> <span class="n">BP</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">elif</span> <span class="n">BP</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>
        <span class="k">elif</span> <span class="n">BP</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>

        <span class="c1"># calculate shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">l_er</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># calculate angles outside loop</span>
        <span class="c1"># CALCULATE x1_el, y1_el, x2_el, y2_el</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="n">L_el</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">l_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
        <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">,</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                <span class="c1"># save figure of error</span>
                <span class="k">return</span>

        <span class="c1"># CALCULATE x1, y1, x2, y2</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                <span class="c1"># save figure of error</span>
                <span class="k">return</span>

        <span class="c1"># CALCULATE x1_er, y1_er, x2_er, y2_er</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="n">L_er</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_r</span><span class="p">,</span> <span class="n">l_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="n">tangent_check</span><span class="p">)</span>
        <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span><span class="p">,</span> <span class="n">x2er</span><span class="p">,</span> <span class="n">y2er</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_degenerate</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Parameter set leads to degenerate geometry.&#39;</span><span class="p">)</span>
                <span class="c1"># save figure of error</span>
                <span class="k">return</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># SHIFT POINT TO START POINT</span>
        <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">lineTo</span><span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">]</span>
        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># ADD BEAM PIPE LENGTH</span>
        <span class="k">if</span> <span class="n">L_bp_l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">]</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># DRAW ARC:</span>
                <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_el</span><span class="p">,</span>
                                                             <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span>
                                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span>
                                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">),</span>
                                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span>
                                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">a_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># DRAW LINE CONNECTING ARCS</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A_el</span><span class="p">,</span>
                                                             <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span>
                                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_el</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span>
                                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">),</span>
                                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span>
                                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">A_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">A_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">B_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># flat top</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="c1"># Plot the straight line</span>
                    <span class="n">line_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                    <span class="n">line_end</span> <span class="o">=</span> <span class="n">pt</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">line_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">line_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">line_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line_start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">line_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
                                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">line_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_end</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">line_start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">l_el</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">n_cells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">L_bp_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                        <span class="c1"># half of bounding box is required,</span>
                        <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                            <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                                                     <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A_er</span><span class="p">,</span>
                                                                     <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                                                     <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                                                     <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">),</span>
                                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span>
                                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">+</span> <span class="n">A_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">A_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">B_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                        <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                        <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                            <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_er</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">),</span>
                                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                        <span class="c1"># ARC</span>
                        <span class="c1"># half of bounding box is required,</span>
                        <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="c1"># calculate new shift</span>
                        <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                        <span class="c1"># half of bounding box is required,</span>
                        <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                        <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="c1"># ARC</span>
                        <span class="c1"># half of bounding box is required,</span>
                        <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                        <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">dimension</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                            <span class="n">ellipse</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_er</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">),</span>
                                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">a_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">),</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="p">(</span><span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b_er</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>

                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                        <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                    <span class="c1"># half of bounding box is required,</span>
                    <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                    <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                    <span class="c1"># ARC</span>
                    <span class="c1"># half of bounding box is required,</span>
                    <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">])</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                    <span class="c1"># calculate new shift</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l_el</span><span class="p">)</span>
                    <span class="c1"># ic(shift)</span>

            <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">n_cells</span><span class="p">:</span>
                <span class="c1"># DRAW ARC:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># DRAW LINE CONNECTING ARCS</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># flat top</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                <span class="c1"># half of bounding box is required,</span>
                <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># ARC</span>
                <span class="c1"># half of bounding box is required,</span>
                <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># calculate new shift</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># DRAW ARC:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># DRAW LINE CONNECTING ARCS</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># DRAW ARC, FIRST EQUATOR ARC TO NEXT POINT</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># flat top</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># EQUATOR ARC TO NEXT POINT</span>
                <span class="c1"># half of bounding box is required,</span>
                <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># STRAIGHT LINE TO NEXT POINT</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># ARC</span>
                <span class="c1"># half of bounding box is required,</span>
                <span class="c1"># start is the lower coordinate of the bounding box and end is the upper</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">arcTo</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># BEAM PIPE</span>
        <span class="c1"># reset shift</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">l_er</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span>
            <span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span>
            <span class="n">Ri_er</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">L_bp_r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span>
                  <span class="n">Ri_er</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># END PATH</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="n">step</span><span class="p">)</span>  <span class="c1"># to add beam pipe to right</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l_el</span> <span class="o">+</span> <span class="n">l_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># lineTo(pt, [2 * n_cells * L_er + L_bp_l - shift, 0], step)</span>
        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># CLOSE PATH</span>
        <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">])</span>

        <span class="c1"># # write geometry</span>
        <span class="c1"># if write:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         df = pd.DataFrame(geo, columns=[&#39;r&#39;, &#39;z&#39;])</span>
        <span class="c1">#         df.to_csv(write, sep=&#39;\t&#39;, index=False)</span>
        <span class="c1">#     except FileNotFoundError as e:</span>
        <span class="c1">#         error(&#39;Check file path:: &#39;, e)</span>

        <span class="c1"># append start point</span>
        <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">bc</span><span class="p">:</span>
            <span class="c1"># draw right boundary condition</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">Ri_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">shift</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">shift</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">shift</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">shift</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">Ri_er</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># CLOSE PATH</span>
        <span class="c1"># lineTo(pt, start_point, step)</span>
        <span class="c1"># geo.append([start_point[1], start_point[0], 3])</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geo</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dimension</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">geo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># recenter asymmetric cavity to center</span>
                <span class="n">shift_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">n_cells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">shift_to_center</span> <span class="o">=</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_r</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shift_to_center</span> <span class="o">=</span> <span class="n">n_cells</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_r</span>

                <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geo</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_left</span> <span class="o">+</span> <span class="n">shift_to_center</span><span class="p">,</span> <span class="n">geo</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># bottom = ax.plot(geo[:, 1] - shift_left + shift_to_center, -geo[:, 0], c=top[0].get_color(), **kwargs)</span>

            <span class="c1"># plot legend wthout duplicates</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="EllipticalCavityFlatTop.get_geometric_parameters">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.EllipticalCavityFlatTop.get_geometric_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_geometric_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;Ri&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;Req&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">]</span>
        <span class="n">shape_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="s1">&#39;el&#39;</span><span class="p">,</span> <span class="s2">&quot;OC_R&quot;</span><span class="p">:</span> <span class="s1">&#39;er&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">shape_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">shape_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>
</div>



<div class="viewcode-block" id="RFGun">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun">[docs]</a>
<span class="k">class</span> <span class="nc">RFGun</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gun&#39;</span><span class="p">):</span>
        <span class="c1"># self.shape_space = {</span>
        <span class="c1">#     &#39;IC&#39;: [L, Req, Ri, S, L_bp],</span>
        <span class="c1">#     &#39;BP&#39;: beampipe</span>
        <span class="c1"># }</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>  <span class="c1"># consider removing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;vhf gun&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
            <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_geometric_parameters</span><span class="p">()</span>

<div class="viewcode-block" id="RFGun.create">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span>
        <span class="k">if</span> <span class="n">beampipe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beampipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">:</span>
            <span class="n">cav_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">)):</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>

            <span class="c1"># write geometry file to folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># define different paths for easier reference later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;uq&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;geodata.geo&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
                                <span class="n">write</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="RFGun.get_geometric_parameters">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.get_geometric_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_geometric_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="RFGun.write_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.write_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">,</span> <span class="s2">&quot;L3&quot;</span><span class="p">,</span> <span class="s2">&quot;R4&quot;</span><span class="p">,</span> <span class="s2">&quot;L5&quot;</span><span class="p">,</span> <span class="s2">&quot;R6&quot;</span><span class="p">,</span> <span class="s2">&quot;L7&quot;</span><span class="p">,</span> <span class="s2">&quot;R8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T9&quot;</span><span class="p">,</span> <span class="s2">&quot;R10&quot;</span><span class="p">,</span> <span class="s2">&quot;T10&quot;</span><span class="p">,</span> <span class="s2">&quot;L11&quot;</span><span class="p">,</span> <span class="s2">&quot;R12&quot;</span><span class="p">,</span> <span class="s2">&quot;L13&quot;</span><span class="p">,</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span>
        <span class="p">]</span>

        <span class="n">y1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">L3</span><span class="p">,</span> <span class="n">R4</span><span class="p">,</span> <span class="n">L5</span><span class="p">,</span> <span class="n">R6</span><span class="p">,</span> <span class="n">L7</span><span class="p">,</span> <span class="n">R8</span><span class="p">,</span> <span class="n">T9</span><span class="p">,</span> <span class="n">R10</span><span class="p">,</span> \
            <span class="n">T10</span><span class="p">,</span> <span class="n">L11</span><span class="p">,</span> <span class="n">R12</span><span class="p">,</span> <span class="n">L13</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>


        <span class="c1"># calcualte R9</span>
        <span class="n">R9</span> <span class="o">=</span> <span class="p">(((</span><span class="n">y1</span> <span class="o">+</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">+</span> <span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">+</span> <span class="n">L5</span> <span class="o">+</span> <span class="n">R6</span><span class="p">)</span> <span class="o">-</span>
               <span class="p">(</span><span class="n">R14</span> <span class="o">+</span> <span class="n">L13</span> <span class="o">+</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)</span> <span class="o">+</span> <span class="n">L11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)</span> <span class="o">+</span> <span class="n">R10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">R8</span> <span class="o">*</span> <span class="p">(</span>
                       <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">)))))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mf">1e-2</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.n&#39;</span><span class="p">,</span> <span class="s1">&#39;.geo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cav</span><span class="p">:</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetFactory(&quot;OpenCASCADE&quot;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">start_pt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># DRAW LINE CONNECTING ARCS</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">start_pt</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">R2</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">R2</span> <span class="o">+</span> <span class="n">R2</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">-</span> <span class="n">R2</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(-R2, y1, R2, R2, pt, [R2 * np.cos(T2) - R2, y1 + R2 * np.sin(T2)], 0, T2, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">-</span> <span class="n">R2</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">-</span> <span class="n">R2</span> <span class="o">-</span> <span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">),</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">+</span> <span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">-</span> <span class="n">R2</span> <span class="o">-</span> <span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">),</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">+</span> <span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="o">+</span> <span class="n">R4</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R4</span> <span class="o">-</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0] + R4 * np.cos(T2), pt[1] + R4 * np.sin(T2), R4, R4,</span>
            <span class="c1">#                  pt, [pt[0] - (R4 - R4 * np.cos(T2)), pt[1] + R4 * np.sin(T2)], -(np.pi - T2), np.pi, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R4</span> <span class="o">-</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T2</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T2</span><span class="p">)]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">L5</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">L5</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R6</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R6</span> <span class="o">+</span> <span class="n">R6</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R6</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R6</span><span class="p">]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0] + R6, pt[1], R6, R6, pt, [pt[0] + R6, pt[1] + R6], np.pi, np.pi / 2, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R6</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R6</span><span class="p">]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L7</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L7</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R8</span><span class="p">]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R8</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R8</span><span class="p">]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T9</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R8</span> <span class="o">-</span> <span class="n">R8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">))]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0], pt[1] - R8, R8, R8, pt, [pt[0] + R8 * np.cos(T9), pt[1] - (R8 - R8 * np.sin(T9))],</span>
            <span class="c1">#                  np.pi / 2, T9, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T9</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R8</span> <span class="o">-</span> <span class="n">R8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">))]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T9</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">)]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T9</span><span class="p">)</span> <span class="o">+</span> <span class="n">R9</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">)]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">R9</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T9</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">)]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0] - R9 * np.cos(T9), pt[1] - R9 * np.sin(T9), R9, R9,</span>
            <span class="c1">#                  pt, [pt[0] + (R9 - R9 * np.cos(T9)), pt[1] - R9 * np.sin(T9)], T9, 0, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">R9</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T9</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T9</span><span class="p">)]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R10</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R10</span> <span class="o">+</span> <span class="n">R10</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R10</span> <span class="o">-</span> <span class="n">R10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0] - R10, pt[1], R10, R10,</span>
            <span class="c1">#                  pt, [pt[0] - (R10 - R10 * np.cos(T10)), pt[1] - R10 * np.sin(T10)], 0, -T10, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R10</span> <span class="o">-</span> <span class="n">R10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">L11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">L11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">L11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">L11</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)</span> <span class="o">+</span> <span class="n">R12</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R12</span> <span class="o">-</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0] + R12 * np.cos(T10), pt[1] - R12 * np.sin(T10), R12, R12,</span>
            <span class="c1">#                  pt, [pt[0] - (R12 - R12 * np.cos(T10)), pt[1] - R12 * np.sin(T10)], (np.pi - T10), np.pi,</span>
            <span class="c1">#                  step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">R12</span> <span class="o">-</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">T10</span><span class="p">)),</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">T10</span><span class="p">)]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">L13</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">L13</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># DRAW ARC:</span>
            <span class="n">start_pt</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">center_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R14</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">majax_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R14</span> <span class="o">+</span> <span class="n">R14</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">end_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R14</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R14</span><span class="p">]</span>
            <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_ellipse</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">center_pt</span><span class="p">,</span> <span class="n">majax_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># pts = arcToTheta(pt[0] + R14, pt[1], R14, R14, pt, [pt[0] + R14, pt[1] - R14], np.pi, -np.pi / 2, step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R14</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R14</span><span class="p">]</span>
            <span class="c1"># for pp in pts:</span>
            <span class="c1">#     if (np.around(pp, 12) != np.around(pt, 12)).all():</span>
            <span class="c1">#         geo.append([pp[1], pp[0], 0])</span>
            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">y1</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">y1</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># line</span>
            <span class="n">lineTo</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># closing line</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Line(</span><span class="si">{</span><span class="n">curve_indx</span><span class="si">}</span><span class="s2">) = </span><span class="se">{{</span><span class="si">{</span><span class="n">pt_indx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">geo</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">pmcs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curve</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmcs</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)]</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PEC&quot;) = </span><span class="si">{</span><span class="n">pecs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PMC&quot;) = </span><span class="si">{</span><span class="n">pmcs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;AXI&quot;) = </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Curve Loop(1) = </span><span class="si">{</span><span class="n">curve</span><span class="si">}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plane Surface(1) = </span><span class="se">{{</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse Surface </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Surface(&quot;Domain&quot;) = </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span></div>


        <span class="c1"># start_pt = [0, 0]</span>
        <span class="c1"># geo.append([start_pt[1], start_pt[0], 1])</span>

        <span class="c1"># pandss</span>
        <span class="c1"># df = pd.DataFrame(geo)</span>
        <span class="c1"># # print(df[df.duplicated(keep=False)])</span>
        <span class="c1">#</span>
        <span class="c1"># geo = np.array(geo)</span>
        <span class="c1"># _, idx = np.unique(geo[:, 0:2], axis=0, return_index=True)</span>
        <span class="c1"># geo = geo[np.sort(idx)]</span>

        <span class="c1"># print(&#39;length of geometry:: &#39;, len(geo))</span>

        <span class="c1"># top = plt.plot(geo[:, 1], geo[:, 0])</span>
        <span class="c1"># bottom = plt.plot(geo[:, 1], -geo[:, 0], c=top[0].get_color())</span>

        <span class="c1"># # plot legend wthout duplicates</span>
        <span class="c1"># handles, labels = plt.gca().get_legend_handles_labels()</span>
        <span class="c1"># by_label = dict(zip(labels, handles))</span>
        <span class="c1"># plt.legend(by_label.values(), by_label.keys())</span>
        <span class="c1"># plt.gca().set_aspect(&#39;equal&#39;)</span>
        <span class="c1"># plt.xlim(left=-30 * 1e-2)</span>
        <span class="c1">#</span>
        <span class="c1"># # # write geometry</span>
        <span class="c1"># # if write:</span>
        <span class="c1"># #     try:</span>
        <span class="c1"># #         df = pd.DataFrame(geo, columns=[&#39;r&#39;, &#39;z&#39;, &#39;bc&#39;])</span>
        <span class="c1"># #         # change point data precision</span>
        <span class="c1"># #         df[&#39;r&#39;] = df[&#39;r&#39;].round(8)</span>
        <span class="c1"># #         df[&#39;z&#39;] = df[&#39;z&#39;].round(8)</span>
        <span class="c1"># #         # drop duplicates</span>
        <span class="c1"># #         df.drop_duplicates(subset=[&#39;r&#39;, &#39;z&#39;], inplace=True, keep=&#39;last&#39;)</span>
        <span class="c1"># #         df.to_csv(write, sep=&#39;\t&#39;, index=False)</span>
        <span class="c1"># #     except FileNotFoundError as e:</span>
        <span class="c1"># #         error(&#39;Check file path:: &#39;, e)</span>
        <span class="c1">#</span>
        <span class="c1"># return plt.gca()</span>

<div class="viewcode-block" id="RFGun.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># file_path = os.path.join(self.projectDir, &quot;SimulationData&quot;, &quot;NGSolveMEVP&quot;, self.name, &quot;monopole&quot;, &quot;geodata.n&quot;)</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [m]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ [m]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\parallel} ~[\mathrm{k\Omega}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\perp} ~[\mathrm{k\Omega/m}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_err&#39;</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ax</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convergence data not available.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RFGun.get_eigenmode_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.get_eigenmode_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenmode_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quantities of interest written by the SLANS code</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;it is here&#39;)</span>
        <span class="n">qois</span> <span class="o">=</span> <span class="s1">&#39;qois.json&#39;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">qois</span><span class="p">)),</span> <span class="p">(</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Eigenmode result does not exist, please run eigenmode simulation.&#39;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">qois</span><span class="p">))</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="s1">&#39;qois_all_modes.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois_all_modes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="s1">&#39;Ez_0_abs.csv&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;GR/Q [Ohm^2]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Q []&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Epk/Eacc []&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Bpk/Eacc [mT/MV/m]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Epk_Eacc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bpk_Eacc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span></div>


<div class="viewcode-block" id="RFGun.plot_axis_field">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.plot_axis_field">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_axis_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_min_max</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$|E_z(0,0)|$&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_min_max</span><span class="p">:</span>
                <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">])</span>
                <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxz</span> <span class="o">-</span> <span class="n">minz</span><span class="p">))</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">Ez_0_abs_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">][</span><span class="n">peaks</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">][</span><span class="n">peaks</span><span class="p">],</span> <span class="n">Ez_0_abs_peaks</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Ez_0_abs.csv&#39;</span><span class="p">)):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;SimulationData&#39;</span><span class="p">,</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Ez_0_abs.csv&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$|E_z(0,0)|$&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_min_max</span><span class="p">:</span>
                    <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;z(0, 0)&#39;</span><span class="p">])</span>
                    <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">],</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxz</span> <span class="o">-</span> <span class="n">minz</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                                          <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">Ez_0_abs_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ez_0_abs</span><span class="p">[</span><span class="s1">&#39;|Ez(0, 0)|&#39;</span><span class="p">][</span><span class="n">peaks</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Ez_0_abs_peaks</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Axis field plot data not found.&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># p[self.name] = {</span>
        <span class="c1">#     &#39;tune&#39;: self.tune_results,</span>
        <span class="c1">#     &#39;fm&#39;: self.eigenmode_qois,</span>
        <span class="c1">#     &#39;hom&#39;: self.wakefield_qois,</span>
        <span class="c1">#     &#39;uq&#39;: {</span>
        <span class="c1">#         &#39;tune&#39;: 0,</span>
        <span class="c1">#         &#39;fm&#39;: self.uq_fm_results,</span>
        <span class="c1">#         &#39;hom&#39;: self.uq_hom_results</span>
        <span class="c1">#     }</span>
        <span class="c1"># }</span>
        <span class="k">return</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="Pillbox">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox">[docs]</a>
<span class="k">class</span> <span class="nc">Pillbox</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">)</span>

        <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">L_bp</span> <span class="o">=</span> <span class="n">dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;pillbox&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># change later to enable module run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">Req</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span> <span class="o">=</span> <span class="n">Ri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">S</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_bp</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">beampipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="mi">33</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">L_bp</span><span class="p">],</span>
            <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="n">beampipe</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_geometric_parameters</span><span class="p">()</span>

<div class="viewcode-block" id="Pillbox.create">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span>
        <span class="k">if</span> <span class="n">beampipe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beampipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">:</span>
            <span class="n">cav_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">)):</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>
                <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">cav_dir_structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">))</span>


            <span class="c1"># write geometry file to folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># define different paths for easier reference later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_dir</span><span class="p">,</span> <span class="s1">&#39;uq&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s1">&#39;Cavities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;geodata.geo&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.write_geometry">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.write_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path</span>
<span class="sd">        n_cell</span>
<span class="sd">        cell_par</span>
<span class="sd">        beampipe</span>
<span class="sd">        plot</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;L_bp&#39;</span><span class="p">]</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">L_bp</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="k">if</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">elif</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>
        <span class="k">elif</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="n">L_bp</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>
        <span class="k">elif</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve_indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.n&#39;</span><span class="p">,</span> <span class="s1">&#39;.geo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cav</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetFactory(&quot;OpenCASCADE&quot;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">n_cells</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># SHIFT POINT TO START POINT</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="c1"># cav.write(f&quot;  {start_point[1]:.16E}  {start_point[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

            <span class="c1"># lineTo(start_point, [-shift, Ri], step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>
            <span class="c1"># cav.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

            <span class="c1"># add beampipe</span>
            <span class="k">if</span> <span class="n">L_bp_l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># lineTo(pt, [-shift + L_bp_l, Ri], step)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">Ri</span><span class="p">]</span>

                <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># lineTo(pt, [-shift + L_bp_l, Req], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="c1"># lineTo(pt, [-shift + L_bp_l + L, Req], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="c1"># lineTo(pt, [-shift + L_bp_l + L, Ri], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L</span><span class="p">,</span> <span class="n">Ri</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="n">shift</span> <span class="o">-=</span> <span class="n">L</span>
                <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># lineTo(pt, [-shift + L_bp_l + S, Ri], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">S</span><span class="p">,</span> <span class="n">Ri</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="c1"># lineTo(pt, [-shift + L_bp_l + S, Req], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">S</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="c1"># lineTo(pt, [-shift + L_bp_l + S + L, Req], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">S</span> <span class="o">+</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="c1"># lineTo(pt, [-shift + L_bp_l + S + L, Ri], step)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">S</span> <span class="o">+</span> <span class="n">L</span><span class="p">,</span> <span class="n">Ri</span><span class="p">]</span>

                    <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                    <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                    <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                    <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

                    <span class="n">shift</span> <span class="o">-=</span> <span class="n">L</span>

            <span class="k">if</span> <span class="n">L_bp_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># lineTo(pt, [-shift + L_bp_l + (n_cell - 1) * S + L_bp_r, Ri], step)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="n">L_bp_r</span><span class="p">,</span> <span class="n">Ri</span><span class="p">]</span>

                <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
                <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

                <span class="c1"># fil.write(f&quot;  {pt[1]:.16E}  {pt[0]:.16E}   1.0000000e+00   1.0000000e+00\n&quot;)</span>

            <span class="c1"># END PATH</span>
            <span class="c1"># lineTo(pt, [-shift + L_bp_l + (n_cell - 1) * S + L_bp_r, 0], step)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="n">L_bp_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">pt_indx</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">)</span>
            <span class="n">curve_indx</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">pt_indx</span><span class="p">,</span> <span class="n">curve_indx</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve_indx</span><span class="p">)</span>

            <span class="c1"># closing line</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Line(</span><span class="si">{</span><span class="n">curve_indx</span><span class="si">}</span><span class="s2">) = </span><span class="se">{{</span><span class="si">{</span><span class="n">pt_indx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">pmcs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curve</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmcs</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)]</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PEC&quot;) = </span><span class="si">{</span><span class="n">pecs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;PMC&quot;) = </span><span class="si">{</span><span class="n">pmcs</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Line(&quot;AXI&quot;) = </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>

            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Curve Loop(1) = </span><span class="si">{</span><span class="n">curve</span><span class="si">}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plane Surface(1) = </span><span class="se">{{</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse Surface </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Physical Surface(&quot;Domain&quot;) = </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.get_geometric_parameters">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.get_geometric_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_geometric_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span>
            <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
            <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span><span class="p">,</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
            <span class="s1">&#39;L_bp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_bp</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Pillbox.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_pillbox_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_bp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [m]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ [m]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\parallel} ~[\mathrm{k\Omega}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\perp} ~[\mathrm{k\Omega/m}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_err&#39;</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ax</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convergence data not available.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.run_tune">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_tune">[docs]</a>
    <span class="k">def</span> <span class="nf">run_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tune_variable</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s1">&#39;Mid Cell&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;SLANS&#39;</span><span class="p">,</span> <span class="n">proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tune current cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cells used for tuning.</span>
<span class="sd">        resume: bool</span>
<span class="sd">            Option to resume tuning or not. Only for shape space with multiple entries.</span>
<span class="sd">        proc: int</span>
<span class="sd">            Processor number</span>
<span class="sd">        solver: {&#39;SLANS&#39;, &#39;Native&#39;}</span>
<span class="sd">            Solver to be used. Native solver is still under development. Results are not as accurate as that of SLANS.</span>
<span class="sd">        freq: float</span>
<span class="sd">            Reference frequency in MHz</span>
<span class="sd">        cell_type: {&#39;mid cell&#39;, &#39;end-mid cell&#39;, &#39;mid-end cell&#39;, &#39;end-end cell&#39;, &#39;single cell&#39;}</span>
<span class="sd">            Type of cell to tune</span>
<span class="sd">        tune_variable: {&#39;Req&#39;, &#39;L&#39;}</span>
<span class="sd">            Tune variable. Currently supports only the tuning of the equator radius ``Req`` and half-cell length ``L``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">iter_set</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Linear Interpolation&#39;</span><span class="p">,</span> <span class="n">TUNE_ACCURACY</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># calculate freq from mid cell length</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculated freq from mid cell half length: &quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1"># create new shape space based on cell_type</span>
        <span class="c1"># if cell_type.lower() == &#39;mid cell&#39;:</span>
        <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;BP&quot;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="n">freq</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slans_tune_res</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">run_tune</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;This cavity has already been tuned. Run tune again? (y/N)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">run_tune</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_tune_ngsolve</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                                      <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                      <span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span>
                                      <span class="n">progress_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">convergence_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence_list</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="n">n_cells</span><span class="p">)</span>

            <span class="c1"># read tune results and update geometry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ngsolve_tune_res</span><span class="p">(</span><span class="n">tune_variable</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_tune_ngsolve</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                                  <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span>
                                  <span class="n">progress_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">convergence_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence_list</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="n">n_cells</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ngsolve_tune_res</span><span class="p">(</span><span class="n">tune_variable</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oops! Something went wrong. Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.run_tune_ngsolve">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_tune_ngsolve">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">run_tune_ngsolve</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                         <span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">progress_list</span><span class="p">,</span> <span class="n">convergence_list</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
        <span class="n">tuner</span><span class="o">.</span><span class="n">tune_ngsolve</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                           <span class="n">tune_variable</span><span class="o">=</span><span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="o">=</span><span class="n">iter_set</span><span class="p">,</span>
                           <span class="n">cell_type</span><span class="o">=</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;Optimisation&#39;</span><span class="p">,</span>
                           <span class="n">progress_list</span><span class="o">=</span><span class="n">progress_list</span><span class="p">,</span> <span class="n">convergence_list</span><span class="o">=</span><span class="n">convergence_list</span><span class="p">,</span>
                           <span class="n">save_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">n_cell_last_run</span><span class="o">=</span><span class="n">n_cells</span><span class="p">)</span>  <span class="c1"># last_key=last_key This would have to be tested again #val2</span></div>


<div class="viewcode-block" id="Pillbox.run_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">run_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">,</span> <span class="n">freq_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">boundary_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run eigenmode analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        solver: {&#39;SLANS&#39;, &#39;NGSolve&#39;}</span>
<span class="sd">            Solver to be used. Native solver is still under development. Results are not as accurate as that of SLANS.</span>
<span class="sd">        freq_shift:</span>
<span class="sd">            Frequency shift. Eigenmode solver searches for eigenfrequencies around this value</span>
<span class="sd">        boundary_cond: int</span>
<span class="sd">            Boundary condition of left and right cell/beampipe ends</span>
<span class="sd">        subdir: str</span>
<span class="sd">            Sub directory to save results to</span>
<span class="sd">        uq_config: None | dict</span>
<span class="sd">            Provides inputs required for uncertainty quantification. Default is None and disables uncertainty quantification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">boundary_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">boundary_cond</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_shift</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span> <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="n">uq_config</span><span class="p">)</span>
        <span class="c1"># load quantities of interest</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find eigenmode results. Please rerun eigenmode analysis:: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.run_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">wakelength</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                      <span class="n">DDR_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operating_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ABCI&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run wakefield analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        MROT: {0, 1}</span>
<span class="sd">            Polarisation 0 for longitudinal polarization and 1 for transversal polarization</span>
<span class="sd">        MT: int</span>
<span class="sd">            Number of time steps it takes for a beam to move from one mesh cell to the other</span>
<span class="sd">        NFS: int</span>
<span class="sd">            Number of frequency samples</span>
<span class="sd">        wakelength:</span>
<span class="sd">            Wakelength to be analysed</span>
<span class="sd">        bunch_length: float</span>
<span class="sd">            Length of the bunch</span>
<span class="sd">        DDR_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the r axis</span>
<span class="sd">        DDZ_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the z axis</span>
<span class="sd">        WG_M:</span>
<span class="sd">            For module simulation. Specifies the length of the beampipe between two cavities.</span>
<span class="sd">        marker: str</span>
<span class="sd">            Marker for the cavities. Adds this to the cavity name specified in a shape space json file</span>
<span class="sd">        wp_dict: dict</span>
<span class="sd">            Python dictionary containing relevant parameters for the wakefield analysis for a specific operating point</span>
<span class="sd">        solver: {&#39;ABCI&#39;}</span>
<span class="sd">            Only one solver is currently available</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">operating_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_abci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span>
                               <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">wakelength</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                               <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span>
                               <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="n">WG_M</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                               <span class="n">operating_points</span><span class="o">=</span><span class="n">operating_points</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_ngsolve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">,</span> <span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># create folders for all keys</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">pillbox</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span>
                             <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                             <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="c1"># run UQ</span>
        <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
            <span class="n">uq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc&quot;</span><span class="p">],</span>
               <span class="n">n_cells</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="o">=</span><span class="n">n_modules</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
               <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done with Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_abci</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
                  <span class="n">DDR_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operating_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R_Q</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># run abci code</span>
        <span class="k">if</span> <span class="n">WG_M</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">WG_M</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># run both polarizations if MROT == 2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">WG_M</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MROT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                     <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                     <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                     <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MROT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                     <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                     <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                     <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_Q</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># save qois</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">operating_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">WP</span> <span class="o">=</span> <span class="n">key</span>
                        <span class="n">I0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;I0 [mA]&#39;</span><span class="p">])</span>
                        <span class="n">Nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;Nb [1e11]&#39;</span><span class="p">])</span>
                        <span class="n">sigma_z</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">])]</span>
                        <span class="n">bl_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SR&#39;</span><span class="p">,</span> <span class="s1">&#39;BS&#39;</span><span class="p">]</span>

                        <span class="c1"># info(&quot;Running wakefield analysis for given operating points.&quot;)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sigma_z</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">WG_M</span><span class="p">:</span>
                                <span class="n">fid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WP</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bl_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">mm</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                                         <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                                                         <span class="n">bunch_length</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                                         <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                                                         <span class="n">bunch_length</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="n">dirc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
                                <span class="c1"># try:</span>
                                <span class="n">k_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">])</span>
                                <span class="n">k_kick</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">])</span>
                                <span class="c1"># except:</span>
                                <span class="c1">#     k_loss = 0</span>
                                <span class="c1">#     k_kick = 0</span>

                                <span class="n">d</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_qois_value</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">k_loss</span><span class="p">,</span> <span class="n">k_kick</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>

                    <span class="c1"># save qoi dictionary</span>
                    <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="s2">&quot;qois.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

                    <span class="n">done</span><span class="p">(</span><span class="s2">&quot;Done with the secondary analysis for working points&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;To run analysis for working points, eigenmode simulation has to be run first&quot;</span>
                         <span class="s2">&quot;to obtain the cavity operating frequency and R/Q&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;The working point entered is not valid. See below for the proper input structure.&#39;</span><span class="p">)</span>
                <span class="n">show_valid_operating_point_structure</span><span class="p">()</span></div>



<div class="viewcode-block" id="Dakota">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota">[docs]</a>
<span class="k">class</span> <span class="nc">Dakota</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scripts_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="sa">f</span><span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please ensure directory paths use forward slashes.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="k">if</span> <span class="n">scripts_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scripts_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;D:/Dropbox/CavityDesignHub/analysis_modules/uq/dakota_scripts&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scripts_folder</span> <span class="o">=</span> <span class="n">scripts_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<div class="viewcode-block" id="Dakota.write_input_file">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.write_input_file">[docs]</a>
    <span class="k">def</span> <span class="nf">write_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;variables_config&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;variables config&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;interface_config&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;interface config&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;method_config&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;method config&quot;&#39;</span><span class="p">)</span>

        <span class="n">variables_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;variables_config&#39;</span><span class="p">]</span>
        <span class="n">interface_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;interface_config&#39;</span><span class="p">]</span>
        <span class="n">method_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method_config&#39;</span><span class="p">]</span>

        <span class="c1"># check if folder exists, if not, create folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not create folder. Make sure target location exists.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.in&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">method_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">variables_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.environment">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.environment">[docs]</a>
    <span class="k">def</span> <span class="nf">environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;environment</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">tabular_data</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">tabular_data_file = &#39;sim_result_table.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">results_output</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">results_output_file = &#39;result_output_file.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.method">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.method">[docs]</a>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter &quot;method&quot; in &quot;method config&quot;.&#39;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;method</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">export_expansion_file =&#39;expansion_file.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">cubature_integrand = 3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">samples_on_emulator = 10000</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">seed = 12347</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">variance_based_decomp interaction_order = 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.variables">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.variables">[docs]</a>
    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f: File</span>
<span class="sd">            File</span>
<span class="sd">        kind: {&#39;uniform_uncertain&#39;, &#39;normal_uncertain&#39;, &#39;beta_uncertain&#39;}</span>
<span class="sd">            Type of distribution of the variables</span>
<span class="sd">        descriptors: list, ndarray</span>
<span class="sd">            Uncertain variable names</span>
<span class="sd">        kwargs: kwargs</span>
<span class="sd">            Other relevant arguments eg. {means: [], &#39;std_deviations&#39;: [], &#39;lower_bounds&#39;: [], &#39;upper_bounds&#39;: []}</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;kind&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter &quot;kind&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;lower_bounds&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter keyword &quot;lower_bounds&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;upper_bounds&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter keyword &quot;upper bounds&quot;&#39;</span><span class="p">)</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">upper_bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;upper_bounds&#39;</span><span class="p">]</span>
        <span class="n">lower_bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lower_bounds&#39;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">upper_bounds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower_bounds</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Length of upper and lower bounds must be equal.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;descriptors&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">descriptors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;&quot;descriptors&quot; not entered. Using default parameter labelling.&#39;</span><span class="p">)</span>
            <span class="n">descriptors</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">upper_bounds</span><span class="p">))]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;upper_bounds&#39;</span><span class="p">])</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;variables</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">descriptors       =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">descriptor</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span> <span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;means&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">means      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="k">for</span> <span class="n">mean</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;std_deviations&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;std_deviations&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">std_deviations      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;std_deviations&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;lower_bounds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">lower_bounds      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lower_bounds&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;upper_bounds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">upper_bounds      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span> <span class="k">for</span> <span class="n">ub</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;upper_bounds&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.interface">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.interface">[docs]</a>
    <span class="k">def</span> <span class="nf">interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;analysis_driver&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;analysis driver&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;responses&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter &quot;responses&quot;&#39;</span><span class="p">)</span>

        <span class="n">analysis_driver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;analysis_driver&#39;</span><span class="p">]</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;responses&#39;</span><span class="p">]</span>

        <span class="n">nodes_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;nodes_only&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">nodes_only</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nodes_only&#39;</span><span class="p">]</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>

        <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;interface</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">common options</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">fork</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">parameters_file = &#39;params.in&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">results_file    = &#39;results.out&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">system asynchronous evaluation_concurrency = </span><span class="si">{</span><span class="n">processes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">analysis_driver = &#39;</span><span class="si">{</span><span class="n">analysis_driver</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nodes_only</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_folder</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">parameters_file = &#39;params.in&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">results_file    = &#39;results.out&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">file_tag</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">file_save</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">aprepro</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.responses">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.responses">[docs]</a>
    <span class="k">def</span> <span class="nf">responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;responses</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">response_functions = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">no_gradients</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">no_hessians</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.nodes_to_cst_sweep_input">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.nodes_to_cst_sweep_input">[docs]</a>
    <span class="k">def</span> <span class="nf">nodes_to_cst_sweep_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># save parts</span>
        <span class="n">row_partition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">partitions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">partitions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">partitions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">row_partition</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">row_partition</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">row_partition</span><span class="p">:]</span>

            <span class="n">df_part</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/cst_sweep_files/cst_par_in_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.run_analysis">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.run_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_cst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dakota_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.in&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">dakota_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.out&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;dakota&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dakota_in</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">dakota_out</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># read results</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/sim_result_table.dat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">)</span>

        <span class="c1"># delete unnecessary columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;response|interface|eval_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/nodes.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write_cst</span><span class="p">:</span>
            <span class="c1"># check if folder exist and clear</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span>

            <span class="c1"># post processes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_to_cst_sweep_input</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Dakota.plot_sobol_indices">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.plot_sobol_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_sobol_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stacked&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span>
                           <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reorder_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">selection_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">which</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Main&#39;</span><span class="p">]</span>

        <span class="n">start_keyword</span> <span class="o">=</span> <span class="s2">&quot;Main&quot;</span>
        <span class="n">interaction_start_keyword</span> <span class="o">=</span> <span class="s2">&quot;Interaction&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s+(-?\d\.\d+e[+-]\d+)\s+(-?\d\.\d+e[+-]\d+)\s+(\w+)&#39;</span>
        <span class="n">pattern_interaction</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s*(-?\d+\.\d+e[-+]\d+)\s+(\w+)\s+(\w+)\s*&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1"># read the file line by line</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="c1"># initialize a flag to indicate when to start and stop recording lines</span>
            <span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">record_interaction</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># initialize a list to store the lines between the keywords</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">result_interaction</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># loop through each line in the file</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="c1"># check if the line contains the start keyword</span>
                <span class="k">if</span> <span class="n">start_keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># if it does, set the flag to start recording lines</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">interaction_start_keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">record_interaction</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result_interaction</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>

                <span class="c1"># if the flag is set to record, add the line to the result list</span>
                <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\S+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">record_interaction</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern_interaction</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                        <span class="n">result_interaction</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\S+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">record_interaction</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">selection_index</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection_index</span><span class="p">)}</span>
        <span class="c1"># result = result_interaction</span>
        <span class="c1"># check if any function is empty and repeat the first one</span>
        <span class="c1"># result[0] = result[2]</span>

        <span class="n">df_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;vars&#39;</span><span class="p">])</span>

        <span class="c1"># print the lines between the keywords</span>
        <span class="c1"># df_merge_list = []</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;vars&#39;</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;main&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">})</span>
            <span class="c1"># df_merge_list.append(df)</span>
            <span class="c1"># ic(df)</span>
            <span class="c1"># ic(df_merge)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_merge</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_merge</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="c1"># df.plot.bar(x=&#39;var&#39;, y=&#39;Main&#39;)</span>
        <span class="c1"># ic(df_merge_list)</span>
        <span class="c1"># df_merge = pd.merge(df_merge_list, on=&#39;vars&#39;)</span>
        <span class="c1"># ic(df_merge)</span>

        <span class="n">df_merge_interaction</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;var1&#39;</span><span class="p">,</span> <span class="s1">&#39;var2&#39;</span><span class="p">])</span>
        <span class="c1"># ic(result_interaction.items())</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result_interaction</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;var1&#39;</span><span class="p">,</span> <span class="s1">&#39;var2&#39;</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;interaction&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_merge_interaction</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># df_merge_interaction = pd.merge(df_merge_interaction, df, on=[&#39;var1&#39;, &#39;var2&#39;])</span>
                <span class="k">pass</span>
            <span class="c1"># ic(df_merge_interaction)</span>

            <span class="c1"># combine var columns</span>
            <span class="c1"># df_merge_interaction[&quot;vars&quot;] = df_merge_interaction[[&quot;var1&quot;, &quot;var2&quot;]].agg(&#39;,&#39;.join, axis=1)</span>
            <span class="c1"># df.plot.bar(x=&#39;var&#39;, y=&#39;Main&#39;)</span>

        <span class="c1"># ic(df_merge)</span>

        <span class="c1"># group columns</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">df_merge_T</span> <span class="o">=</span> <span class="n">df_merge</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df_merge_T</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_merge_T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span>
            <span class="n">df_merge_T</span> <span class="o">=</span> <span class="n">df_merge_T</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">df_merge_T</span><span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_merge_T</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># drop columns</span>
                <span class="n">df_merge_T</span> <span class="o">=</span> <span class="n">df_merge_T</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># reorder index</span>
            <span class="k">if</span> <span class="n">reorder_index</span><span class="p">:</span>
                <span class="n">df_merge_T</span> <span class="o">=</span> <span class="n">df_merge_T</span><span class="p">[</span><span class="n">reorder_index</span><span class="p">]</span>
            <span class="n">df_merge</span> <span class="o">=</span> <span class="n">df_merge_T</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="c1"># ic(df_merge)</span>

        <span class="c1"># ic(df_merge_interaction)</span>

        <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
            <span class="c1"># normalise dataframe columns</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;main&#39;</span> <span class="ow">in</span> <span class="n">column</span> <span class="ow">or</span> <span class="s1">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
                    <span class="n">df_merge</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_merge</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_merge</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># ic(df_merge)</span>
        <span class="c1"># filter df</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;main&#39;</span> <span class="ow">or</span> <span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df_merge</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">|vars&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create new column which is a combination of the two variable names</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df_merge_interaction</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">|vars&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dff</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_merge_interaction</span><span class="p">[[</span><span class="s1">&#39;var1&#39;</span><span class="p">,</span> <span class="s1">&#39;var2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;tab20&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dff</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stacked&#39;</span><span class="p">:</span>
                    <span class="n">dff_T</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">dff_T</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># , cmap=cmap</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">dff_T</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># , cmap=cmap</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
                        <span class="c1"># for bars in ax.containers:</span>
                        <span class="c1">#     ax.bar_label(bars, fmt=&#39;%.2f&#39;, label_type=&#39;center&#39;, color=&#39;white&#39;, fontsize=5)</span>

                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># , cmap=cmap</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># , cmap=cmap</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2"> found.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.get_sobol_indices">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.get_sobol_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sobol_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">which</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">which</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Main&#39;</span><span class="p">]</span>

        <span class="n">start_keyword</span> <span class="o">=</span> <span class="s2">&quot;Main&quot;</span>
        <span class="n">interaction_start_keyword</span> <span class="o">=</span> <span class="s2">&quot;Interaction&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s+(-?\d\.\d+e[+-]\d+)\s+(-?\d\.\d+e[+-]\d+)\s+(\w+)&#39;</span>
        <span class="n">pattern_interaction</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\s*(-?\d+\.\d+e[-+]\d+)\s+(\w+)\s+(\w+)\s*&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1"># read the file line by line</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="c1"># initialize a flag to indicate when to start and stop recording lines</span>
            <span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">record_interaction</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># initialize a list to store the lines between the keywords</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">result_interaction</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># loop through each line in the file</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="c1"># check if the line contains the start keyword</span>
                <span class="k">if</span> <span class="n">start_keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># if it does, set the flag to start recording lines</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">interaction_start_keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">record_interaction</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result_interaction</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>

                <span class="c1"># if the flag is set to record, add the line to the result list</span>
                <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\S+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">record_interaction</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern_interaction</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                        <span class="n">result_interaction</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\S+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">record_interaction</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">selection_index</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection_index</span><span class="p">)}</span>
        <span class="c1"># result = result_interaction</span>
        <span class="c1"># check if any function is empty and repeat the first one</span>
        <span class="c1"># result[0] = result[2]</span>

        <span class="n">df_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;vars&#39;</span><span class="p">])</span>

        <span class="c1"># print the lines between the keywords</span>
        <span class="c1"># df_merge_list = []</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">objectives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_main&#39;</span><span class="p">,</span>
                                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">objectives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_total&#39;</span><span class="p">,</span> <span class="s1">&#39;vars&#39;</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">objectives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_main&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">objectives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_total&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">})</span>
            <span class="c1"># df_merge_list.append(df)</span>
            <span class="c1"># ic(df)</span>
            <span class="c1"># ic(df_merge)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_merge</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_merge</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="c1"># df.plot.bar(x=&#39;var&#39;, y=&#39;Main&#39;)</span>
        <span class="c1"># ic(df_merge_list)</span>
        <span class="c1"># df_merge = pd.merge(df_merge_list, on=&#39;vars&#39;)</span>
        <span class="c1"># ic(df_merge)</span>

        <span class="k">return</span> <span class="n">df_merge</span></div>


<div class="viewcode-block" id="Dakota.quadrature_nodes_to_cst_par_input">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.quadrature_nodes_to_cst_par_input">[docs]</a>
    <span class="k">def</span> <span class="nf">quadrature_nodes_to_cst_par_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filefolder</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filefolder</span><span class="si">}</span><span class="s2">\sim_result_table.dat&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">)</span>

        <span class="c1"># delete unnecessary columns</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;response|interface|eval_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filefolder</span><span class="si">}</span><span class="s2">\cubature_nodes_pars.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># save parts</span>
        <span class="n">row_partition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">n</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">row_partition</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">row_partition</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">row_partition</span><span class="p">:]</span>

            <span class="n">df_part</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filefolder</span><span class="si">}</span><span class="s2">\cst_par_in_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.get_pce">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.get_pce">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filefolder</span><span class="p">):</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filefolder</span><span class="si">}</span><span class="s2">\uq_pce_expansion.dat&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">poly</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">poly</span> <span class="o">+=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="Dakota.quote_to_float">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.quote_to_float">[docs]</a>
    <span class="k">def</span> <span class="nf">quote_to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Dakota.combine_params_output">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.combine_params_output">[docs]</a>
    <span class="k">def</span> <span class="nf">combine_params_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/m</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">skipfooter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/m</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">skipfooter</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># rearrange column according to the reference column order</span>
        <span class="n">df_reference</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">\cubature_nodes_pars.xlsx&quot;</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_reference</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># check if 3D Run ID in column and drop if yes</span>
        <span class="k">if</span> <span class="s1">&#39; 3D Run ID&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; 3D Run ID&#39;</span><span class="p">)</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_reference</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">\cubature_nodes.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.plot_sobol">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.plot_sobol">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_sobol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="n">reorder_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reorder_index&#39;</span><span class="p">]</span>
        <span class="n">filefolder</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">normalise</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;normalise&#39;</span><span class="p">]</span>
        <span class="n">which</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span>
        <span class="n">selection_index</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection_index&#39;</span><span class="p">]</span>

        <span class="c1"># obj = [r&quot;$Q_\mathrm{ext, FM}$&quot;, r&quot;$\max(Q_\mathrm{ext, dip})$&quot;]</span>
        <span class="c1"># obj = [r&quot;$S_\mathrm{max}~\mathrm{[dB]}$&quot;, r&quot;$S_\mathrm{min}~\mathrm{[dB]}$&quot;, r&quot;$f(S_\mathrm{max})~\mathrm{[MHz]}$&quot;, r&quot;$f(S_\mathrm{min})~\mathrm{[MHz]}$&quot;]</span>
        <span class="c1"># obj =</span>
        <span class="c1"># obj = [r&quot;$freq [MHz]$&quot;,	fr&quot;$R/Q [Ohm]$&quot;, r&quot;$Epk/Eacc []$&quot;,	r&quot;$Bpk/Eacc [mT/MV/m]$&quot;, &#39;G&#39;, &#39;kcc&#39;, &#39;ff&#39;]</span>
        <span class="c1"># obj =</span>
        <span class="c1"># obj = [r&quot;$freq [MHz]$&quot;, &#39;kcc&#39;]</span>
        <span class="c1"># plot_sobol_indices(fr&quot;{filefolder}\dakota_HC.out&quot;, obj, [&#39;main&#39;, &#39;Total&#39;, &#39;Interaction&#39;], kind=&#39;stacked&#39;, orientation=&#39;horizontal&#39;, group=group, reorder_index=reorder_index, normalise=False)#</span>
        <span class="c1"># plot_sobol_indices(fr&quot;{filefolder}\dakota_HC.out&quot;, obj, [&#39;main&#39;, &#39;Total&#39;, &#39;Interaction&#39;], kind=&#39;stacked&#39;, orientation=&#39;horizontal&#39;, reorder_index=reorder_index, normalise=False)#</span>
        <span class="c1"># plot_sobol_indices(fr&quot;{filefolder}\dakota_HC.out&quot;, obj, [&#39;main&#39;, &#39;Total&#39;, &#39;Interaction&#39;], kind=&#39;stacked&#39;, orientation=&#39;horizontal&#39;, selection_index=selection_index, normalise=False)#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_sobol_indices</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filefolder</span><span class="si">}</span><span class="s2">\dakota.out&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="n">which</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                                <span class="n">selection_index</span><span class="o">=</span><span class="n">selection_index</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="n">normalise</span><span class="p">)</span>  <span class="c1">#</span></div>
</div>



<div class="viewcode-block" id="OperationPoints">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.OperationPoints">[docs]</a>
<span class="k">class</span> <span class="nc">OperationPoints</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_operating_point</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<div class="viewcode-block" id="OperationPoints.load_operating_point">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.OperationPoints.load_operating_point">[docs]</a>
    <span class="k">def</span> <span class="nf">load_operating_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">op_points</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="n">op_points</span>
        <span class="k">return</span> <span class="n">op_points</span></div>


<div class="viewcode-block" id="OperationPoints.get_default_operating_points">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.OperationPoints.get_default_operating_points">[docs]</a>
    <span class="k">def</span> <span class="nf">get_default_operating_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;Z_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">5.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0370</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">354.91</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">709.82</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">4.32</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.76</span>
            <span class="p">},</span>
            <span class="s2">&quot;W_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">135</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">10.61</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0801</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">65.99</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">131.98</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">132</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.55</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">7.02</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.29</span>
            <span class="p">},</span>
            <span class="s2">&quot;H_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mf">53.4</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">10.61</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0328</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">39.2</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">528</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">4.45</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.51</span>
            <span class="p">},</span>
            <span class="s2">&quot;ttbar_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">182.5</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">9.2</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">20.12</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0826</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">5.63</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">11.26</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">488</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">1.67</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.26</span>
            <span class="p">},</span>
            <span class="s2">&quot;Z_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">1400</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">5.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0370</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">354.91</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">709.82</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">4.32</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.76</span>
            <span class="p">},</span>
            <span class="s2">&quot;W_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">135</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">11.91</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0801</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">65.99</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">131.98</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">112</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.55</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">7.02</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.29</span>
            <span class="p">},</span>
            <span class="s2">&quot;H_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mf">53.4</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">10.61</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0328</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">39.2</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">528</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">4.45</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.51</span>
            <span class="p">},</span>
            <span class="s2">&quot;ttbar_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">182.5</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">9.2</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">20.12</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0826</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">5.63</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">11.26</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">488</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">1.67</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.26</span>
            <span class="p">},</span>
            <span class="s2">&quot;Z_booster_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">6.23</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0370</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">354.91</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">709.82</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">4.32</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">0.276</span>
            <span class="p">},</span>
            <span class="s2">&quot;Z_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">1390</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">5.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">1.48</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">424.6</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">849.2</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">12.1</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.7</span>
            <span class="p">},</span>
            <span class="s2">&quot;W_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">147</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">11.91</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0506</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">1.48</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">78.7</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">157.4</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.5</span>
            <span class="p">},</span>
            <span class="s2">&quot;H_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">11.87</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.036</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.73</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">23.4</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">46.8</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">136</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.15</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">5.3</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.8</span>
            <span class="p">},</span>
            <span class="s2">&quot;ttbar_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">182.5</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mf">10.8</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">10.93</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">24.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.087</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.73</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">6.8</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">13.6</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">584</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">1.97</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.3</span>
            <span class="p">}</span>
        <span class="p">})</span></div>
</div>



<div class="viewcode-block" id="show_welcome">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.show_welcome">[docs]</a>
<span class="k">def</span> <span class="nf">show_welcome</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;docs/images/cavsim2d_logo.svg&#39;</span><span class="p">)</span>

    <span class="c1"># Convert the image to base64</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">img_file</span><span class="p">:</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="c1"># HTML and CSS to display image and colourful text on the same line</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;div style=&quot;display: flex; align-items: center;&quot;&gt;</span>
<span class="s2">        &lt;img src=&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">encoded_image</span><span class="si">}</span><span class="s2">&quot; style=&quot;height: 32px;&quot;&gt;</span>
<span class="s2">        &lt;p style=&quot;margin: 0; font-size: 16px; </span>
<span class="s2">                  background: -webkit-linear-gradient(left, #EFC3CA, #5DE2E7, #FE9900, #E7DDFF, #FFDE59);</span>
<span class="s2">                  -webkit-background-clip: text; </span>
<span class="s2">                  -webkit-text-fill-color: transparent;&quot;&gt;</span>
<span class="s2">            &lt;b&gt;CAV-SIM-2D&lt;/b&gt; loaded successfully!</span>
<span class="s2">        &lt;/p&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Display the HTML</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Sosoho-Abasi Udongwo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>