<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cavsim2d.cavity &mdash; cavsim2d 13.08.2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f5513fb5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            cavsim2d
              <img src="../../_static/cavsim2d_logo_2x.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#understanding-the-geometry-types">Understanding the geometry types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#advanced">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#parallelisation">Parallelisation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">cavsim2d</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">cavsim2d</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cavsim2d.cavity</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cavsim2d.cavity</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">distutils</span> <span class="kn">import</span> <span class="n">dir_util</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sps</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display_html</span><span class="p">,</span> <span class="n">Math</span>
<span class="kn">from</span> <span class="nn">IPython.core.display_functions</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span><span class="p">,</span> <span class="n">Delaunay</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">jn_zeros</span><span class="p">,</span> <span class="n">jnp_zeros</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">sci</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">qmc</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">oapackage</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">cavsim2d.analysis.tune.tuner</span> <span class="kn">import</span> <span class="n">Tuner</span>
<span class="kn">from</span> <span class="nn">cavsim2d.data_module.abci_data</span> <span class="kn">import</span> <span class="n">ABCIData</span>
<span class="kn">from</span> <span class="nn">cavsim2d.solvers.NGSolve.eigen_ngsolve</span> <span class="kn">import</span> <span class="n">NGSolveMEVP</span>
<span class="kn">from</span> <span class="nn">cavsim2d.analysis.wakefield.abci_geometry</span> <span class="kn">import</span> <span class="n">ABCIGeometry</span>
<span class="kn">from</span> <span class="nn">cavsim2d.utils.shared_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">Label</span>

<span class="n">ngsolve_mevp</span> <span class="o">=</span> <span class="n">NGSolveMEVP</span><span class="p">()</span>
<span class="n">abci_geom</span> <span class="o">=</span> <span class="n">ABCIGeometry</span><span class="p">()</span>
<span class="n">tuner</span> <span class="o">=</span> <span class="n">Tuner</span><span class="p">()</span>

<span class="n">SOFTWARE_DIRECTORY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>  <span class="c1"># str(Path().parents[0])</span>
<span class="n">CUSTOM_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#4b8f63&#39;</span><span class="p">,</span> <span class="s1">&#39;#fc6d2d&#39;</span><span class="p">,</span> <span class="s1">&#39;#6a7bbf&#39;</span><span class="p">,</span> <span class="s1">&#39;#e567a7&#39;</span><span class="p">,</span> <span class="s1">&#39;#8cd839&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff5f00&#39;</span><span class="p">,</span> <span class="s1">&#39;#d1a67a&#39;</span><span class="p">,</span> <span class="s1">&#39;#a3a3a3&#39;</span><span class="p">]</span>
<span class="n">VAR_TO_INDEX_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">}</span>
<span class="n">TUNE_ACCURACY</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">DIMENSION</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<span class="n">DIMENSION_FACTOR</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mm&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cm&#39;</span><span class="p">:</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">}</span>
<span class="n">BOUNDARY_CONDITIONS_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ee&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">}</span>
<span class="n">LABELS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$f$ [MHz]&#39;</span><span class="p">,</span> <span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~\mathrm{[\Omega]}$&quot;</span><span class="p">,</span>
          <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{pk}</span><span class="s2">/E_\mathrm</span><span class="si">{acc}</span><span class="s2"> ~[\cdot]$&quot;</span><span class="p">,</span>
          <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$B_\mathrm</span><span class="si">{pk}</span><span class="s2">/E_\mathrm</span><span class="si">{acc}</span><span class="s2"> ~\mathrm{[mT/MV/m]}$&quot;</span><span class="p">,</span>
          <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$G ~\mathrm{[\Omega]}$&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$Q$ []&#39;</span><span class="p">,</span>
          <span class="s1">&#39;kcc [%]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$k_\mathrm</span><span class="si">{cc}</span><span class="s1">$ [%]&#39;</span><span class="p">,</span> <span class="s1">&#39;GR/Q [Ohm^2]&#39;</span><span class="p">:</span> <span class="s1">&#39;$G \cdot R/Q \mathrm{[\Omega^2]}$&#39;</span><span class="p">,</span>
          <span class="s1">&#39;ff [%]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\eta_ff$ [%]&#39;</span><span class="p">,</span>
          <span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm</span><span class="si">{FM}</span><span class="s2">| ~\mathrm{[V/pC]}$&quot;</span><span class="p">,</span>
          <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$|k_\parallel| ~\mathrm{[V/pC]}$&quot;</span><span class="p">,</span>
          <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$|k_\perp| ~\mathrm{[V/pC/m]}$&quot;</span><span class="p">,</span>
          <span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">/\mathrm</span><span class="si">{cav}</span><span class="s2"> ~\mathrm{[kW]}$&quot;</span><span class="p">,</span>
          <span class="s1">&#39;Z_2023&#39;</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;W_2023&#39;</span><span class="p">:</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;H_2023&#39;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;ttbar_2023&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\mathrm{t \bar t}$&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Z_b_2024&#39;</span><span class="p">:</span> <span class="s1">&#39;Z$_\mathrm</span><span class="si">{b}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="s1">&#39;W_b_2024&#39;</span><span class="p">:</span> <span class="s1">&#39;W$_\mathrm</span><span class="si">{b}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="s1">&#39;H_b_2024&#39;</span><span class="p">:</span> <span class="s1">&#39;H$_\mathrm</span><span class="si">{b}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="s1">&#39;ttbar_b_2024&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\mathrm{t \bar t}_\mathrm</span><span class="si">{b}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Z_b_2024_FB&#39;</span><span class="p">:</span> <span class="s1">&#39;Z$_\mathrm</span><span class="si">{b}</span><span class="s1">$[FB]&#39;</span><span class="p">,</span> <span class="s1">&#39;W_b_2024_FB&#39;</span><span class="p">:</span> <span class="s1">&#39;W$_\mathrm</span><span class="si">{b}</span><span class="s1">$[FB]&#39;</span><span class="p">,</span>
          <span class="s1">&#39;H_b_2024_FB&#39;</span><span class="p">:</span> <span class="s1">&#39;H$_\mathrm</span><span class="si">{b}</span><span class="s1">$[FB]&#39;</span><span class="p">,</span> <span class="s1">&#39;ttbar_b_2024_FB&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\mathrm{t \bar t}_\mathrm</span><span class="si">{b}</span><span class="s1">$[FB]&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;Ncav&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$&quot;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;Q0 []&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$Q_0 ~\mathrm{[]}$&quot;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;Pstat/cav [W]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W]&quot;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;Pdyn/cav [W]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W]&quot;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;Pwp/cav [kW]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW]&quot;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;Pin/cav [kW]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">$/cav [kW]&quot;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s2">&quot;PHOM/cav [kW]&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW]&quot;</span>
          <span class="p">}</span>

<span class="n">m0</span> <span class="o">=</span> <span class="mf">9.1093879e-31</span>
<span class="n">q0</span> <span class="o">=</span> <span class="mf">1.6021773e-19</span>
<span class="n">c0</span> <span class="o">=</span> <span class="mf">2.99792458e8</span>
<span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">1e-7</span>
<span class="n">eps0</span> <span class="o">=</span> <span class="mf">8.85418782e-12</span>


<div class="viewcode-block" id="Optimisation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation">[docs]</a>
<span class="k">class</span> <span class="nc">Optimisation</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f2_interp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutation_factor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover_factor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elites_to_crossover</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chaos_factor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_parameter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objs_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_interp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_error_avg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives_unprocessed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ng_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_freq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pareto_history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Optimisation.start_optimisation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.start_optimisation">[docs]</a>
    <span class="k">def</span> <span class="nf">start_optimisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pareto_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># apply optimisation settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">projectDir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_points</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_points&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ng_max</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;no_of_generation&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives_unprocessed</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">process_objectives</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;objectives&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;weights&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> \
                <span class="p">(</span><span class="s2">&quot;Length of delta must be equal to the length of the variables. For impedance Z entries, one less than&quot;</span>
                 <span class="s2">&quot;the length of the interval list weights are needed. Eg. for [&#39;min&#39;, &#39;ZL&#39;, [1, 2, 3]], two weights are&quot;</span>
                 <span class="s2">&quot; required. &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;constraints&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_constraints</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be greater than zero!&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be integer!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes_count</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutation_factor</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;mutation_factor&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover_factor</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;crossover_factor&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elites_to_crossover</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;elites_for_crossover&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chaos_factor</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;chaos_factor&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tune_config&#39;</span><span class="p">]</span>
        <span class="n">tune_config_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;freqs&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter the target tune frequency.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter the tune variable in tune_config_dict&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;cell_types&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter the cell_type in tune_config_dict&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;cell_types&#39;</span><span class="p">]</span>
        <span class="n">cts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;end-cell&#39;</span><span class="p">,</span> <span class="s1">&#39;mid-end-cell&#39;</span><span class="p">,</span> <span class="s1">&#39;end-mid-cell&#39;</span><span class="p">,</span> <span class="s1">&#39;end_cell&#39;</span><span class="p">,</span> <span class="s1">&#39;mid_end_cell&#39;</span><span class="p">,</span> <span class="s1">&#39;end_mid_cell&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cts</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s1">&#39;mid-cell&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;To optimise an end-cell, mid cell dimensions are required&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mid-cell&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Incomplete mid cell dimension.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;mid-cell&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tune_parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="s1">&#39;ZL&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span><span class="p">])</span>
                <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;ZT&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span><span class="p">])</span>
                <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">,</span> <span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span><span class="p">])):</span>
            <span class="k">assert</span> <span class="s1">&#39;wakefield_config&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Wakefield impedance objective detected in objectives. &#39;</span>
                                                              <span class="s1">&#39;Please include a field for wakefield_config. An empty&#39;</span>
                                                              <span class="s1">&#39; config entry implies that default values will be used.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;wakefield_config&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
                <span class="c1"># replace objectives with processed objectives</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives_unprocessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives_unprocessed</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of deltas must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;eigenmode_config&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;eigenmode_config&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of deltas must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objs_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_interp</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_error_avg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ng_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ea</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optimisation.ea">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.ea">[docs]</a>
    <span class="k">def</span> <span class="nf">ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># update lists</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_first_men</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_points</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">f2_interp</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_interp</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">))]</span>

            <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation&quot;</span><span class="p">),</span>
                       <span class="n">Path</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation&quot;</span><span class="p">)]</span>

            <span class="c1"># clear folder to avoid reading from previous optimization attempt</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">/</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">NotADirectoryError</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">/</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># optimize by page rank</span>
        <span class="c1"># remove the lowest ranking members</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

        <span class="c1"># compare with global dict and remove duplicates</span>
        <span class="n">compared_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">compared_cols</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">compared_cols</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>  <span class="c1"># this line of code removes duplicates</span>

        <span class="n">pseudo_shape_space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">rw</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid-cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid_cell&#39;</span><span class="p">:</span>
                <span class="n">pseudo_shape_space</span><span class="p">[</span><span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_freq</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">}</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid-end cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid-end-cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid_end_cell&#39;</span><span class="p">:</span>

                <span class="k">assert</span> <span class="s1">&#39;mid cell&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> \
                    <span class="p">(</span><span class="s2">&quot;If cell_type is set as &#39;mid-end cell&#39;, the mid cell geometry parameters must &quot;</span>
                     <span class="s2">&quot;be provided in the optimisation_config dictionary.&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span><span class="p">[</span><span class="s1">&#39;mid cell&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Incomplete mid cell geometry parameter. &quot;</span>
                                                                       <span class="s2">&quot;At least 7 geometric parameters &quot;</span>
                                                                       <span class="s2">&quot;[A, B, a, b, Ri, L, Req] required.&quot;</span><span class="p">)</span>
                <span class="n">IC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span><span class="p">[</span><span class="s1">&#39;mid cell&#39;</span><span class="p">]</span>
                <span class="c1"># check if mid-cell is not a degenerate geometry</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IC</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;The mid-cell geometry dimensions given result in a degenerate geometry. &quot;</span>
                                     <span class="s2">&quot;Please check.&quot;</span><span class="p">)</span>

                <span class="n">pseudo_shape_space</span><span class="p">[</span><span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">IC</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_freq</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">}</span>

            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end-end cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end-end-cell&#39;</span>
                  <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end_end_cell&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end end cell&#39;</span><span class="p">:</span>

                <span class="n">pseudo_shape_space</span><span class="p">[</span><span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_freq</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pseudo_shape_space</span><span class="p">[</span><span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_freq</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">}</span>

        <span class="n">pseudo_shape_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_duplicate_values</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">)</span>

        <span class="c1">############################</span>
        <span class="c1"># run tune</span>
        <span class="n">n_cells</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># self.run_tune_parallel(pseudo_shape_space, n_cells)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_tune_opt</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span><span class="p">)</span>
        <span class="c1"># get successfully tuned geometries and filter initial generation dictionary</span>
        <span class="n">processed_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tune_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pseudo_shape_space</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\Optimisation\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\tune_res.json&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">tune_res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># get only tune_variable, alpha_i, and alpha_o and freq but why these quantities</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">tune_res</span><span class="p">[</span><span class="s1">&#39;FREQ&#39;</span><span class="p">]</span>
                <span class="n">tune_variable_value</span> <span class="o">=</span> <span class="n">tune_res</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tune_parameter</span><span class="p">]]</span>
                <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">tune_res</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>
                <span class="n">alpha_o</span> <span class="o">=</span> <span class="n">tune_res</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>

                <span class="n">tune_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tune_variable_value</span><span class="p">,</span> <span class="n">alpha_i</span><span class="p">,</span> <span class="n">alpha_o</span><span class="p">,</span> <span class="n">freq</span><span class="p">])</span>
                <span class="n">processed_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># after removing duplicates, dataframe might change size</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">processed_keys</span><span class="p">)]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tune_parameter</span><span class="p">,</span> <span class="s1">&#39;alpha_i&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha_o&#39;</span><span class="p">,</span> <span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tune_result</span>

        <span class="c1"># eigen objective variables</span>
        <span class="c1"># for o in self.objectives:</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;freq [MHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># process tune results</span>
            <span class="n">obj_result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">processed_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pseudo_shape_space</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\Optimisation\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\monopole\qois.json&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">qois</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="c1"># extract objectives from tune_res</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span> <span class="ow">in</span> <span class="n">qois</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span><span class="p">}</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                    <span class="n">obj_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="c1"># tune_result.append(list(qois.values()))</span>
                    <span class="n">processed_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># after removing duplicates, dataframe might change size</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unfortunately, none survived. </span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot;This is most likely due to all generated initial geometries being degenerate.</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot;Check the variable bounds or increase the number of initial geometries to increase the&quot;</span>
                      <span class="s2">&quot;changes of survival. </span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot;Can&#39;t even say that this was a good run.&quot;</span>
                      <span class="s2">&quot;Tune ended.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">processed_keys</span><span class="p">)]</span>

            <span class="n">obj_eigen</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="k">if</span>
                         <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;freq [MHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">]]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">obj_eigen</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_result</span>

        <span class="c1"># for o in self.objectives:</span>
        <span class="c1">#     if o[1] in [&quot;mts monopole&quot;, &#39;mts dipole&#39;]:</span>
        <span class="c1">#         # process tune results</span>
        <span class="c1">#         obj_vars = self.ui.ccb_Populate_Objectives.currentText().split(&#39;, &#39;)</span>
        <span class="c1">#         for i, obj_var in enumerate(obj_vars):</span>
        <span class="c1">#             if obj_var == &quot;mts monopole&quot; or obj_var == &quot;mts dipole&quot;:</span>
        <span class="c1">#                 goal = self.ui.tw_Objectives.cellWidget(i, 1).currentText()</span>
        <span class="c1">#                 if goal == &#39;equal&#39;:</span>
        <span class="c1">#                     fshift = float(self.ui.tw_Objectives.item(i, 2).text())</span>
        <span class="c1">#</span>
        <span class="c1">#         obj_result = []</span>
        <span class="c1">#         tune_result = []</span>
        <span class="c1">#         processed_keys = []</span>
        <span class="c1">#         # run dipole simulation with frequency shift</span>
        <span class="c1">#         if o[1] == &quot;mts monopole&quot;:</span>
        <span class="c1">#             slans_shape_space = self.run_slans_parallel(df, n_cells, fshift, &#39;monopole&#39;)</span>
        <span class="c1">#             for key, val in slans_shape_space.items():</span>
        <span class="c1">#                 filename = self.projectDir / fr&#39;SimulationData\SLANS_opt\{key}\cavity_33.svl&#39;</span>
        <span class="c1">#                 try:</span>
        <span class="c1">#                     params = fr.svl_reader(filename)</span>
        <span class="c1">#                     obj = self.get_objectives_value(params, self.objectives, norm_length, n_cells)</span>
        <span class="c1">#</span>
        <span class="c1">#                     obj_result.append(obj)</span>
        <span class="c1">#</span>
        <span class="c1">#                     df_slans_mts = pd.DataFrame(obj, columns=[key, o[1]])</span>
        <span class="c1">#                     df = df.merge(df_slans_mts, on=&#39;key&#39;, how=&#39;inner&#39;)</span>
        <span class="c1">#                 except FileNotFoundError:</span>
        <span class="c1">#                     pass</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             slans_shape_space = self.run_slans_parallel(df, n_cells, fshift, &#39;dipole&#39;)</span>
        <span class="c1">#             for key, val in slans_shape_space.items():</span>
        <span class="c1">#                 filename = self.projectDir / fr&#39;SimulationData\SLANS_opt\{key}_n1\cavity_33_2.sv2&#39;</span>
        <span class="c1">#                 try:</span>
        <span class="c1">#                     params = fr.sv2_reader(filename)</span>
        <span class="c1">#                     obj = params[&#39;Frequency&#39;][-1]</span>
        <span class="c1">#                     obj_result.append([key, obj])</span>
        <span class="c1">#                     processed_keys.append(key)</span>
        <span class="c1">#                 except FileNotFoundError:</span>
        <span class="c1">#                     pass</span>
        <span class="c1">#</span>
        <span class="c1">#             df_slans_mts = pd.DataFrame(obj_result, columns=[&#39;key&#39;, o[1]])</span>
        <span class="c1">#             df = df.merge(df_slans_mts, on=&#39;key&#39;, how=&#39;inner&#39;)</span>

        <span class="c1"># wakefield objective variables</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ZL&quot;</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;ZT&quot;</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">]:</span>
                <span class="c1"># run wakefield analysis and return shape space</span>
                <span class="n">wake_shape_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_wakefield_opt</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">)</span>

                <span class="c1"># process wakefield results</span>
                <span class="n">df_wake</span><span class="p">,</span> <span class="n">processed_keys</span> <span class="o">=</span> <span class="n">get_wakefield_objectives_value</span><span class="p">(</span><span class="n">wake_shape_space</span><span class="p">,</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">objectives_unprocessed</span><span class="p">,</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\ABCI&#39;</span><span class="p">)</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_wake</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># apply UQ</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>

            <span class="c1"># get uq_parameters</span>
            <span class="n">uq_result_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]:</span>
                <span class="n">filename_eigen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\Optimisation\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\uq.json&#39;</span>
                <span class="n">filename_abci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\uq.json&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename_eigen</span><span class="p">):</span>  <span class="c1"># and os.path.exists(filename_abci):</span>
                    <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_eigen</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                        <span class="n">uq_d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Req&quot;</span><span class="p">,</span> <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">]:</span>
                                <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                                    <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                                    <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># for equal, calculate |expected_value - design_value| + 6sigma</span>
                                    <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename_abci</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uq_result_dict</span><span class="p">:</span>
                        <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_abci</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                        <span class="n">uq_d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Req&quot;</span><span class="p">,</span> <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">]:</span>
                                <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                                    <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                                    <span class="n">uq_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">uq_d</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">uq_column_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
                <span class="n">uq_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="n">uq_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                    <span class="n">uq_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                    <span class="n">uq_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uq_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>

            <span class="n">df_uq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">uq_result_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_uq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unfortunately, no geometry was returned from uq, optimisation terminated.&#39;</span><span class="p">)</span>
            <span class="n">df_uq</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">uq_column_names</span>
            <span class="n">df_uq</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;key&#39;</span>
            <span class="n">df_uq</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_uq</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="c1"># filter by constraints</span>
        <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>
            <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;==&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>

        <span class="c1"># update with global dataframe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reset total rank</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># rank shapes by objectives</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> \
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span>
                        <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;rank_|E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                                                                                <span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> \
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># if &#39;total_rank&#39; in df.columns:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;rank_|E[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span>
                <span class="c1"># else:</span>
                <span class="c1">#     if obj[0] == &#39;min&#39;:</span>
                <span class="c1">#         df[f&#39;total_rank&#39;] = df[f&#39;rank_E[{obj[1]}] + 6*std[{obj[1]}]&#39;]</span>
                <span class="c1">#     elif obj[0] == &#39;max&#39;:</span>
                <span class="c1">#         df[f&#39;total_rank&#39;] = df[f&#39;rank_E[{obj[1]}] - 6*std[{obj[1]}]&#39;]</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         df[f&#39;total_rank&#39;] = df[f&#39;rank_std[{obj[1]}]&#39;]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equal&quot;</span> <span class="ow">and</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;freq [MHz]&#39;</span><span class="p">:</span>  <span class="c1"># define properly later</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rank_</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="c1"># reorder</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># normalize by sum of weights</span>

        <span class="c1"># order shapes by rank</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_rank&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># pareto condition</span>
        <span class="n">reorder_indx</span><span class="p">,</span> <span class="n">pareto_indx_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_front</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># estimate convergence</span>
        <span class="n">obj_error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obj0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pareto_shapes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pareto_indx_list</span><span class="p">,</span> <span class="p">[</span><span class="n">obj0</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                <span class="n">pareto_shapes_sorted</span> <span class="o">=</span> <span class="n">pareto_shapes</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">obj0</span><span class="p">)</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pareto_shapes</span><span class="p">[</span><span class="n">obj0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pareto_shapes</span><span class="p">[</span><span class="n">obj0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_interp</span><span class="p">)</span>
                <span class="n">f2_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">pareto_shapes_sorted</span><span class="p">[</span><span class="n">obj0</span><span class="p">],</span> <span class="n">pareto_shapes_sorted</span><span class="p">[</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">rel_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">f2_interp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_interp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f2_interp</span><span class="p">))</span>
                <span class="n">obj_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_error</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">f2_interp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f2_interp</span>

        <span class="c1"># new error</span>
        <span class="c1"># stack previous and current pareto fronts</span>
        <span class="c1"># if n == 0:</span>
        <span class="c1">#     pareto_shapes = df.loc[pareto_indx_list, self.objective_vars]</span>
        <span class="c1">#     self.pareto_history.append(pareto_shapes)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     pareto_shapes = df.loc[pareto_indx_list, self.objective_vars]</span>
        <span class="c1">#     pareto_stack = np.vstack([self.pareto_history[-1], pareto_shapes])</span>
        <span class="c1">#</span>
        <span class="c1">#     # Compute Delaunay triangulation</span>
        <span class="c1">#     delaunay = Delaunay(pareto_stack)</span>
        <span class="c1">#     simplices = delaunay.simplices</span>
        <span class="c1">#</span>
        <span class="c1">#     hypervolumes = self.calculate_hypervolumes(pareto_stack, simplices)</span>
        <span class="c1">#     self.err.append(sum(hypervolumes))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_error</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">obj_error</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_error_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_error</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reorder_indx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="c1"># reset index</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># update global</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># check if df_global is empty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unfortunately, none survived the constraints and the program has to end. &quot;</span>
                  <span class="s2">&quot;Can&#39;t even say that this was a good run.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="p">)</span>

        <span class="c1"># save dataframe</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation\Generation</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recursive_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_global</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">reorder_indx</span><span class="p">)</span>

        <span class="c1"># birth next generation</span>
        <span class="c1"># crossover</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">df_cross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_cross</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># mutation</span>
        <span class="n">df_mutation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutation_factor</span><span class="p">)</span>

        <span class="c1"># chaos</span>
        <span class="n">df_chaos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chaos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chaos_factor</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="c1"># take elites from previous generation over to next generation</span>
        <span class="n">df_ng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_cross</span><span class="p">,</span> <span class="n">df_mutation</span><span class="p">,</span> <span class="n">df_chaos</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># update dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df_ng</span>

        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ng_max</span><span class="p">:</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;End time: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_error</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;max error&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_error_avg</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;avereage&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">))],</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;convex hull vol&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Generation $n$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Pareto surface interp. error&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="Optimisation.run_uq">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.run_uq">[docs]</a>
    <span class="k">def</span> <span class="nf">run_uq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pd.DataFrame</span>
<span class="sd">            Pandas dataframe containing cavity geometry parameters</span>
<span class="sd">        objectives: list|ndarray</span>
<span class="sd">            List of objective functions</span>
<span class="sd">        solver_dict: dict</span>
<span class="sd">            Python dictionary of solver settings</span>
<span class="sd">        solver_args_dict: dict</span>
<span class="sd">            Python dictionary of solver arguments</span>
<span class="sd">        uq_config:</span>
<span class="sd">            Python dictionary of uncertainty quantification settings</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proc_count</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>

        <span class="c1"># get geometric parameters</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">,</span> <span class="s2">&quot;alpha_i&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha_o&quot;</span><span class="p">]]</span>
        <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">rw</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid-cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid_cell&#39;</span><span class="p">:</span>
                <span class="n">shape_space</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">}</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid-end cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid-end-cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid_end_cell&#39;</span><span class="p">:</span>

                <span class="k">assert</span> <span class="s1">&#39;mid cell&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> \
                    <span class="p">(</span><span class="s2">&quot;If cell_type is set as &#39;mid-end cell&#39;, the mid cell geometry parameters must &quot;</span>
                     <span class="s2">&quot;be provided in the optimisation_config dictionary.&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span><span class="p">[</span><span class="s1">&#39;mid cell&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Incomplete mid cell geometry parameter. &quot;</span>
                                                                       <span class="s2">&quot;At least 7 geometric parameters &quot;</span>
                                                                       <span class="s2">&quot;[A, B, a, b, Ri, L, Req] required.&quot;</span><span class="p">)</span>

                <span class="n">IC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimisation_config</span><span class="p">[</span><span class="s1">&#39;mid cell&#39;</span><span class="p">]</span>
                <span class="c1"># check if mid-cell is not a degenerate geometry</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IC</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;The mid-cell geometry dimensions given result in a degenerate geometry. &quot;</span>
                                     <span class="s2">&quot;Please check.&quot;</span><span class="p">)</span>
                <span class="n">shape_space</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">IC</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">}</span>

            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end-end cell&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end-end-cell&#39;</span>
                  <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end_end_cell&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end end cell&#39;</span><span class="p">:</span>

                <span class="n">shape_space</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape_space</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">][</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives_unprocessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives_unprocessed</span>
                <span class="n">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;wakefield&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;wakefield&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;wakefield&#39;</span><span class="p">][</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives_unprocessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives_unprocessed</span>
                <span class="n">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shape_space</span></div>


<div class="viewcode-block" id="Optimisation.calculate_hypervolumes">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.calculate_hypervolumes">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_hypervolumes</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">simplices</span><span class="p">):</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">simplex</span> <span class="ow">in</span> <span class="n">simplices</span><span class="p">:</span>
            <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">simplex</span><span class="p">])</span>
            <span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hull</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">volumes</span></div>


<div class="viewcode-block" id="Optimisation.plot_pareto">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.plot_pareto">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_pareto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">):</span>
        <span class="c1">################## plot 2d ##################################</span>
        <span class="n">grid_results_folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;D:\Dropbox\CavityDesignHub\KWT_simulations\PostprocessingData\Data\grid_results.xlsx&#39;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">columns_array</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;Epk/Eacc&#39;</span><span class="p">,</span> <span class="s1">&#39;Bpk/Eacc&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Epk/Eacc&#39;</span><span class="p">,</span> <span class="s1">&#39;R/Q&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Bpk/Eacc&#39;</span><span class="p">,</span> <span class="s1">&#39;R/Q&#39;</span><span class="p">]]</span>
        <span class="n">columns_par_array</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]]</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Pastel2_r&#39;</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">49</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;D:\Dropbox\CavityDesignHub\Cavity800\SimulationData&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns_par</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns_array</span><span class="p">,</span> <span class="n">columns_par_array</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">lab</span><span class="p">,</span> <span class="n">opt_code_result_folder</span><span class="p">,</span> <span class="n">error_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;LHS&#39;</span><span class="p">,</span> <span class="s1">&#39;LHS2&#39;</span><span class="p">,</span> <span class="s1">&#39;Random&#39;</span><span class="p">],</span>
                                                                   <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">\SLANS_LHS\Generation</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">,</span>
                                                                    <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">\SLANS_LHS2\Generation</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">,</span>
                                                                    <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">\SLANS_kwt_random1\Generation</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">],</span>
                                                                   <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">\SLANS_LHS2\inerp_error_and_average.txt&#39;</span><span class="p">,</span>
                                                                    <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">\SLANS_LHS2\inerp_error_and_average.txt&#39;</span><span class="p">,</span>
                                                                    <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">\SLANS_LHS2\inerp_error_and_average.txt&#39;</span><span class="p">]):</span>
                    <span class="n">opt_code_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">opt_code_result_folder</span><span class="p">,</span> <span class="s1">&#39;Sheet1&#39;</span><span class="p">)</span>

                    <span class="n">pareto_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_front</span><span class="p">(</span><span class="n">opt_code_result</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                                      <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">: g</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> ($n$=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_code_result</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
                                                      <span class="n">kwargs_dataframe</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;facecolors&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">},</span>
                                                      <span class="n">kwargs_pareto</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;mec&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                                                      <span class="c1"># kwargs_pareto={&#39;c&#39;: f&#39;{matplotlib.colors.rgb2hex(cmap(norm(r)))}&#39;, &#39;marker&#39;: &#39;o&#39;,</span>
                                                      <span class="c1">#                &#39;mec&#39;: &#39;k&#39;}</span>
                                                      <span class="p">)</span>
                    <span class="c1"># axs[i+3].plot(grid_results[columns[0]], grid_results[columns[1]], marker=&#39;o&#39;, ms=5, lw=0)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">opt_code_result</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">opt_code_result</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># axs[i+3].plot(qmc_pareto_shapes[columns[0]], qmc_pareto_shapes[columns[1]], marker=&#39;o&#39;, c=&#39;r&#39;, label=&#39;qmc&#39;, ms=5, lw=0)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pareto_shapes</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">pareto_shapes</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ea&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># # load interpolation error</span>
                    <span class="c1"># error = pd.read_csv(error_file, header=None, sep=&#39;\s+&#39;)</span>
                    <span class="c1"># axs[3].plot(error[0], label=lab)</span>
                    <span class="c1"># axs[4].plot(error[1], label=lab)</span>

            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">columns_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">columns_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="c1"># axs[i].legend(bbox_to_anchor=(0, 1.02, 1, 0.2), ncol=10, loc=&#39;lower left&#39;, mode=&#39;expand&#39;)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Interpolation error&#39;</span><span class="p">)</span>
        <span class="c1"># axs[3].set_ylabel()</span>
        <span class="c1"># plot error</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


        <span class="c1"># ################### plot surface #########################</span>
        <span class="c1"># grid_results_folder = fr&#39;D:\Dropbox\CavityDesignHub\KWT_simulations\PostprocessingData\Data\grid_results.xlsx&#39;</span>
        <span class="c1"># opt_code_result_folder_lhs = fr&#39;D:\Dropbox\CavityDesignHub\Cavity800\SimulationData\SLANS_opt_KWT\Generation49.xlsx&#39;</span>
        <span class="c1"># opt_code_result_folder_random = fr&#39;D:\Dropbox\CavityDesignHub\Cavity800\SimulationData\SLANS\Generation49.xlsx&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># grid_results = pd.read_excel(grid_results_folder, &#39;Sheet1&#39;)</span>
        <span class="c1"># opt_code_result_lhs = pd.read_excel(opt_code_result_folder_lhs, &#39;Sheet1&#39;)</span>
        <span class="c1"># opt_code_result_random = pd.read_excel(opt_code_result_folder_random, &#39;Sheet1&#39;)</span>
        <span class="c1">#</span>
        <span class="c1"># fig = plt.figure()</span>
        <span class="c1"># ax1 = fig.add_subplot(1, 2, 1, projection=&#39;3d&#39;)</span>
        <span class="c1"># ax2 = fig.add_subplot(1, 2, 2, projection=&#39;3d&#39;)</span>
        <span class="c1"># # ax3 = fig.add_subplot(1, 2, 3, projection=&#39;3d&#39;)</span>
        <span class="c1"># axs = [ax1, ax2]</span>
        <span class="c1">#</span>
        <span class="c1"># grid_pareto_surface = plot_pareto_surface(grid_results, [&#39;Epk/Eacc&#39;, &#39;Bpk/Eacc&#39;, &#39;R/Q&#39;], axs[0],</span>
        <span class="c1">#                                           {&#39;cmap&#39;: &#39;gray&#39;, &#39;edgecolor&#39;: &#39;k&#39;})</span>
        <span class="c1"># opt_pareto_surface_lhs = plot_pareto_surface(opt_code_result_lhs, [&#39;Epk/Eacc&#39;, &#39;Bpk/Eacc&#39;, &#39;R/Q&#39;], axs[1],</span>
        <span class="c1">#                                              {&#39;cmap&#39;: &#39;RdBu&#39;, &#39;edgecolor&#39;: &#39;k&#39;})</span>
        <span class="c1"># # opt_pareto_surface_random = plot_pareto_surface(opt_code_result_random, [&#39;Epk/Eacc&#39;, &#39;Bpk/Eacc&#39;, &#39;R/Q&#39;], axs[2],</span>
        <span class="c1"># #                                                 {&#39;cmap&#39;: &#39;RdBu&#39;, &#39;edgecolor&#39;: &#39;k&#39;})</span>
        <span class="c1">#</span>
        <span class="c1"># plt.show()</span>

        <span class="c1"># fig, axs = plt.subplot_mosaic([[0, 1, 2], [3, 4, 5]], figsize=(12, 5.5))</span>
        <span class="c1"># ani = animation.FuncAnimation(fig=fig, func=create_evolution_animation, frames=49, interval=1000)</span>
        <span class="c1"># ani.save(filename=&quot;D:\Dropbox\Quick presentation files/ffmpeg_example.gif&quot;, writer=&quot;pillow&quot;)</span>
        <span class="c1"># # plt.show()</span>

<div class="viewcode-block" id="Optimisation.pareto_front_">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.pareto_front_">[docs]</a>
    <span class="k">def</span> <span class="nf">pareto_front_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">kwargs_dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs_pareto</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs_dataframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs_dataframe</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">kwargs_pareto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs_pareto</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">datapoints</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pareto</span> <span class="o">=</span> <span class="n">oapackage</span><span class="o">.</span><span class="n">ParetoDoubleLong</span><span class="p">()</span>
        <span class="c1"># ic(datapoints)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">datapoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">oapackage</span><span class="o">.</span><span class="n">doubleVector</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datapoints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="n">pareto</span><span class="o">.</span><span class="n">addvalue</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
        <span class="c1"># pareto.show(verbose=1)  # Prints out the results from pareto</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="n">pareto</span><span class="o">.</span><span class="n">allindices</span><span class="p">()</span>  <span class="c1"># the indices of the Pareto optimal designs</span>
        <span class="n">poc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>  <span class="c1"># number of pareto shapes</span>
        <span class="n">reorder_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">if</span>
                                   <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>  <span class="c1"># reordered index putting pareto shapes first</span>

        <span class="n">pareto_shapes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lst</span><span class="p">,</span> <span class="p">:]</span>
        <span class="c1"># sort pareto shapes in ascending x axis data</span>
        <span class="n">pareto_shapes</span> <span class="o">=</span> <span class="n">pareto_shapes</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs_dataframe</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pareto_shapes</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">pareto_shapes</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs_pareto</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pareto_shapes</span></div>


<div class="viewcode-block" id="Optimisation.plot_pareto_surface">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.plot_pareto_surface">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_pareto_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pareto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_front</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">pareto</span><span class="p">[</span><span class="s1">&#39;Epk/Eacc []&#39;</span><span class="p">],</span> <span class="n">pareto</span><span class="p">[</span><span class="s1">&#39;Bpk/Eacc&#39;</span><span class="p">],</span> <span class="n">pareto</span><span class="p">[</span><span class="s1">&#39;R/Q&#39;</span><span class="p">]</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">zi</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">surf</span></div>


    <span class="c1"># def create_evolution_animation(self, frame):</span>
    <span class="c1">#     for ax_index in axs:</span>
    <span class="c1">#         axs[ax_index].clear()</span>
    <span class="c1">#</span>
    <span class="c1">#     ################### plot 2d ##################################</span>
    <span class="c1">#     grid_results_folder = fr&#39;D:\Dropbox\CavityDesignHub\KWT_simulations\PostprocessingData\Data\grid_results.xlsx&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     columns_array = [[&#39;Epk/Eacc&#39;, &#39;Bpk/Eacc&#39;], [&#39;Epk/Eacc&#39;, &#39;R/Q&#39;], [&#39;Bpk/Eacc&#39;, &#39;R/Q&#39;]]</span>
    <span class="c1">#     columns_par_array = [[&#39;A&#39;, &#39;B&#39;], [&#39;a&#39;, &#39;b&#39;], [&#39;A&#39;, &#39;Ri&#39;]]</span>
    <span class="c1">#     cmap = matplotlib.colormaps[&#39;Pastel2_r&#39;]</span>
    <span class="c1">#     norm = matplotlib.colors.Normalize(vmin=0, vmax=49)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i, (columns, columns_par) in enumerate(zip(columns_array, columns_par_array)):</span>
    <span class="c1">#         grid_results = pd.read_excel(grid_results_folder, &#39;Sheet1&#39;)</span>
    <span class="c1">#         qmc_pareto_shapes = pareto_front(grid_results, columns, axs[i], show=&#39;pareto&#39;,</span>
    <span class="c1">#                                          label=f&#39;QMC \n({len(grid_results.index)} geoems.)&#39;,</span>
    <span class="c1">#                                          kwargs_dataframe={&#39;facecolors&#39;: &#39;none&#39;, &#39;edgecolor&#39;: &#39;grey&#39;},</span>
    <span class="c1">#                                          kwargs_pareto={&#39;c&#39;: &#39;k&#39;, &#39;marker&#39;: &#39;o&#39;, &#39;mec&#39;: &#39;k&#39;})</span>
    <span class="c1">#</span>
    <span class="c1">#         for r in [frame]:</span>
    <span class="c1">#             for lab, opt_code_result_folder, error_file in zip([&#39;LHS2&#39;],</span>
    <span class="c1">#                                                                [</span>
    <span class="c1">#                                                                    fr&#39;D:\Dropbox\CavityDesignHub\Cavity800\SimulationData\SLANS\Generation{r}.xlsx&#39;],</span>
    <span class="c1">#                                                                [</span>
    <span class="c1">#                                                                    fr&#39;D:\Dropbox\CavityDesignHub\Cavity800\SimulationData\SLANS_LHS2\inerp_error_and_average.txt&#39;]):</span>
    <span class="c1">#                 opt_code_result = pd.read_excel(opt_code_result_folder, &#39;Sheet1&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#                 pareto_shapes = pareto_front(opt_code_result, columns, axs[i], show=&#39;pareto&#39;,</span>
    <span class="c1">#                                              label=f&quot;{lab}: G{r} \n({len(opt_code_result.index)} geoms).&quot;,</span>
    <span class="c1">#                                              kwargs_dataframe={&#39;facecolors&#39;: &#39;none&#39;, &#39;edgecolor&#39;: &#39;b&#39;},</span>
    <span class="c1">#                                              kwargs_pareto={&#39;marker&#39;: &#39;o&#39;,</span>
    <span class="c1">#                                                             &#39;mec&#39;: &#39;k&#39;},</span>
    <span class="c1">#                                              # kwargs_pareto={&#39;c&#39;: f&#39;{matplotlib.colors.rgb2hex(cmap(norm(r)))}&#39;, &#39;marker&#39;: &#39;o&#39;,</span>
    <span class="c1">#                                              #                &#39;mec&#39;: &#39;k&#39;}</span>
    <span class="c1">#                                              )</span>
    <span class="c1">#                 axs[i + 3].scatter(grid_results[columns_par[0]], grid_results[columns_par[1]], s=5)</span>
    <span class="c1">#                 axs[i + 3].scatter(opt_code_result[columns_par[0]], opt_code_result[columns_par[1]], s=5)</span>
    <span class="c1">#                 axs[i + 3].scatter(qmc_pareto_shapes[columns_par[0]], qmc_pareto_shapes[columns_par[1]], c=&#39;r&#39;,</span>
    <span class="c1">#                                    label=&#39;qmc&#39;, s=5)</span>
    <span class="c1">#                 axs[i + 3].scatter(pareto_shapes[columns_par[0]], pareto_shapes[columns_par[1]], c=&#39;b&#39;,</span>
    <span class="c1">#                                    edgecolor=&#39;k&#39;,</span>
    <span class="c1">#                                    label=&#39;ea&#39;, s=5)</span>
    <span class="c1">#</span>
    <span class="c1">#                 # load interpolation error</span>
    <span class="c1">#                 error = pd.read_csv(error_file, header=None, sep=&#39;\s+&#39;)</span>
    <span class="c1">#                 # axs[3].plot(error[0], label=lab)</span>
    <span class="c1">#                 # axs[4].plot(error[1], label=lab)</span>
    <span class="c1">#</span>
    <span class="c1">#         axs[i].set_xlabel(columns[0])</span>
    <span class="c1">#         axs[i].set_ylabel(columns[1])</span>
    <span class="c1">#         axs[i + 3].set_xlabel(columns_par[0])</span>
    <span class="c1">#         axs[i + 3].set_ylabel(columns_par[1])</span>
    <span class="c1">#</span>
    <span class="c1">#     # axs[i].legend(bbox_to_anchor=(0, 1.02, 1, 0.2), ncol=10, loc=&#39;lower left&#39;, mode=&#39;expand&#39;)</span>
    <span class="c1">#     axs[0].legend()</span>
    <span class="c1">#     axs[3].legend()</span>
    <span class="c1">#</span>
    <span class="c1">#     # axs[3].set_yscale(&#39;log&#39;)</span>
    <span class="c1">#     # axs[4].set_yscale(&#39;log&#39;)</span>
    <span class="c1">#     # axs[3].set_xlabel(&#39;Interpolation error&#39;)</span>
    <span class="c1">#     # axs[3].set_ylabel()</span>
    <span class="c1">#     # plot error</span>
    <span class="c1">#</span>
    <span class="c1">#     # plt.tight_layout()</span>
    <span class="c1">#     # plt.show()</span>

<div class="viewcode-block" id="Optimisation.stroud">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.stroud">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">stroud</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># Stroud-3 method</span>
        <span class="c1">#</span>
        <span class="c1"># Input parameters:</span>
        <span class="c1">#  p   number of dimensions</span>
        <span class="c1"># Output parameters:</span>
        <span class="c1">#  nodes   nodes of quadrature rule in [0,1]^p (column-wise)</span>
        <span class="c1">#</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">p</span><span class="p">))</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">p</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span><span class="p">))):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">)</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">)</span>

            <span class="k">if</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span><span class="p">):</span>
                <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># transform nodes from [-1,+1]^p to [0,1]^p</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nodes</span> <span class="o">+</span> <span class="mf">0.5</span>

        <span class="k">return</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="Optimisation.quad_stroud3">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.quad_stroud3">[docs]</a>
    <span class="k">def</span> <span class="nf">quad_stroud3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">):</span>
        <span class="c1"># data for Stroud-3 quadrature in [0,1]^k</span>
        <span class="c1"># nodes and weights</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stroud</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
        <span class="n">nodestr</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes</span> <span class="o">-</span> <span class="mf">1.</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rdim</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rdim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># evaluation of Legendre polynomials</span>
        <span class="n">bpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rdim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rdim</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rdim</span><span class="p">):</span>
                <span class="n">bpoly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">bpoly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodestr</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">degree</span><span class="p">):</span>
                    <span class="n">bpoly</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nodestr</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">bpoly</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">bpoly</span><span class="p">[</span>
                        <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># standardisation of Legendre polynomials</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">bpoly</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bpoly</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">bpoly</span></div>


<div class="viewcode-block" id="Optimisation.weighted_mean_obj">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.weighted_mean_obj">[docs]</a>
    <span class="k">def</span> <span class="nf">weighted_mean_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab_var</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">rows_sims_no</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tab_var</span><span class="p">)</span>
        <span class="n">no_weights</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># z funckji quadr_stroud wekt columnowy</span>

        <span class="k">if</span> <span class="n">rows_sims_no</span> <span class="o">==</span> <span class="n">no_weights</span><span class="p">:</span>
            <span class="n">expe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">outvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">expe</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tab_var</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">)</span>
                <span class="n">outvar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tab_var</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
            <span class="n">stdDev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">outvar</span> <span class="o">-</span> <span class="n">expe</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expe</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stdDev</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cols_sims_no != No_weights&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">expe</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(</span><span class="n">stdDev</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="Optimisation.run_tune_opt">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.run_tune_opt">[docs]</a>
    <span class="k">def</span> <span class="nf">run_tune_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudo_shape_space</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">):</span>
        <span class="n">tune_config_keys</span> <span class="o">=</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]</span>
        <span class="n">tune_parameters</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
        <span class="n">cell_types</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;cell_types&#39;</span><span class="p">]</span>

        <span class="c1"># perform all necessary checks</span>
        <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">freqs</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Number of target frequencies must correspond to the number of cavities&#39;</span><span class="p">)</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tune_parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">],</span> <span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Please enter a valid tune parameter&#39;</span><span class="p">)</span>
            <span class="n">tune_variables</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tune_parameters</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">))])</span>
            <span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cell_types</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tune_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Number of tune parameters must correspond to the number of cavities&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Number of cell types must correspond to the number of cavities&#39;</span><span class="p">)</span>
            <span class="n">tune_variables</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tune_parameters</span><span class="p">)</span>
            <span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span>

        <span class="n">run_tune_parallel</span><span class="p">(</span><span class="n">pseudo_shape_space</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optimisation.run_wakefield_opt">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.run_wakefield_opt">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">):</span>
        <span class="c1"># # get analysis parameters</span>
        <span class="c1"># n_cells = 5</span>
        <span class="c1"># n_modules = 1</span>
        <span class="c1">#</span>
        <span class="c1"># # change later</span>
        <span class="c1"># WG_M = [&#39;&#39;]  # half length of beam pipe between cavities in module</span>
        <span class="c1">#</span>
        <span class="c1"># # change all of these later</span>
        <span class="c1"># MROT = 2  # run both longitudinal and transverse wakefield analysis</span>
        <span class="c1"># MT = 4  # number of time steps for a beam to move one cell to another default = 3</span>
        <span class="c1"># bunch_length = 25</span>
        <span class="c1"># NFS = 10000  # Number of samples in FFT (max 10000)</span>
        <span class="c1"># UBT = 50  # Wakelength in m</span>
        <span class="c1"># DDZ_SIG = 0.1</span>
        <span class="c1"># DDR_SIG = 0.1</span>
        <span class="c1"># proc_count = self.processes_count</span>

        <span class="c1"># get geometric parameters</span>

        <span class="n">wakefield_config_keys</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">MROT</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">NFS</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">wakelength</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">bunch_length</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">DDR_SIG</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">DDZ_SIG</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># check inputs</span>
        <span class="k">if</span> <span class="s1">&#39;bunch_length&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Bunch length must be of type integer or float.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bunch_length</span>
        <span class="k">if</span> <span class="s1">&#39;wakelength&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Wakelength must be of type integer or float.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wakelength</span>

        <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processes</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;polarisation&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Polarisation should be 0 for longitudinal, &#39;</span>
                                                                        <span class="s1">&#39;1 for transverse, 2 for both.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MROT</span>

        <span class="k">if</span> <span class="s1">&#39;MT&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;MT must be integer between 4 and 20, with 4 and 20 &#39;</span>
                                                                  <span class="s1">&#39;included.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span>

        <span class="k">if</span> <span class="s1">&#39;NFS&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;NFS must be integer.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NFS</span>

        <span class="k">if</span> <span class="s1">&#39;DDR_SIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;DDR_SIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDR_SIG</span>

        <span class="k">if</span> <span class="s1">&#39;DDZ_SIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;DDZ_SIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDZ_SIG</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">,</span> <span class="s2">&quot;alpha_i&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha_o&quot;</span><span class="p">]]</span>
        <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">rw</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end-mid cell&#39;</span><span class="p">:</span>

                <span class="n">A_i</span><span class="p">,</span> <span class="n">B_i</span><span class="p">,</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">b_i</span><span class="p">,</span> <span class="n">Ri_i</span><span class="p">,</span> <span class="n">L_i</span><span class="p">,</span> <span class="n">Req_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span>

                <span class="n">IC</span> <span class="o">=</span> <span class="p">[</span><span class="n">A_i</span><span class="p">,</span> <span class="n">B_i</span><span class="p">,</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">b_i</span><span class="p">,</span> <span class="n">Ri_i</span><span class="p">,</span> <span class="n">L_i</span><span class="p">,</span> <span class="n">Req_i</span><span class="p">]</span>

                <span class="n">shape_space</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">IC</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape_space</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">rw</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">}</span>

        <span class="n">shape_space_multicell</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">shape_space_multicell</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_multicell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

        <span class="n">run_wakefield_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">shape_space_multicell</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shape_space</span></div>


<div class="viewcode-block" id="Optimisation.generate_first_men">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.generate_first_men">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_first_men</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_points</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LHS&quot;</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;LHS&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">l_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">()))[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">u_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">()))[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">const_var</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">u_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">const_var</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                    <span class="k">del</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">l_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">l_bounds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">u_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u_bounds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">initial_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discrepancy</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

            <span class="n">sample</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="n">u_bounds</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_P&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">const_var</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">df</span><span class="p">[</span><span class="n">const_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">const_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;alpha_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;alpha_o&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sobol Sequence&quot;</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;LHS&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s2">&quot;Sobol Sequence&quot;</span><span class="p">][</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
            <span class="n">l_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())))[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">u_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())))[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">const_var</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">u_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">const_var</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                    <span class="k">del</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">l_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">l_bounds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">u_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u_bounds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="n">reduced_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">Sobol</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">reduced_dim</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random_base2</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="n">u_bounds</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G0_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_P&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">const_var</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">df</span><span class="p">[</span><span class="n">const_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">const_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;alpha_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;alpha_o&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">df</span>
        <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Random&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G0_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_P&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)],</span>
                    <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">6</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">initial_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                        <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;alpha_i&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;alpha_o&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)}</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G0_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_P&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)],</span>
                    <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">6</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;alpha_i&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">),</span>
                    <span class="s1">&#39;alpha_o&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">initial_points</span><span class="p">)}</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optimisation.process_constraints">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.process_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">process_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
        <span class="n">processed_constraints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">processed_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">processed_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> &lt; </span><span class="si">{</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">processed_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processed_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">bounds</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">processed_constraints</span></div>


<div class="viewcode-block" id="Optimisation.crossover">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.crossover">[docs]</a>
    <span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">generation</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>  <span class="c1"># , rq, grq</span>
        <span class="n">elites</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                    <span class="n">elites</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                    <span class="n">elites</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                    <span class="n">elites</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                        <span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                    <span class="n">elites</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                    <span class="n">elites</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                    <span class="n">elites</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">obj_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                    <span class="n">obj_dict</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elites</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                    <span class="n">obj_dict</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elites</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obj_dict</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elites</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if o[0] != &#39;equal&#39;:</span>
                <span class="n">obj_dict</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">elites</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obj_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># e, b, rq = obj_list</span>
        <span class="c1"># e = e.reset_index(drop=True)</span>
        <span class="c1"># b = b.reset_index(drop=True)</span>
        <span class="c1"># rq = rq.reset_index(drop=True)</span>

        <span class="c1"># naming convention G&lt;generation number&gt;_C&lt;cavity number&gt;_&lt;type&gt;</span>
        <span class="c1"># type refers to mutation M or crossover C</span>
        <span class="n">df_co</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">,</span> <span class="s2">&quot;alpha_i&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha_o&quot;</span><span class="p">])</span>

        <span class="c1"># select only best characteristics</span>
        <span class="n">A_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>
        <span class="n">B_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>
        <span class="n">a_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>
        <span class="n">b_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>
        <span class="n">Ri_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>
        <span class="n">L_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>
        <span class="n">Req_inf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]</span>

        <span class="n">inf_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">A_inf</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">B_inf</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a_inf</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b_inf</span><span class="p">,</span> <span class="s2">&quot;Ri&quot;</span><span class="p">:</span> <span class="n">Ri_inf</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="n">L_inf</span><span class="p">,</span> <span class="s2">&quot;Req&quot;</span><span class="p">:</span> <span class="n">Req_inf</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">influence</span> <span class="ow">in</span> <span class="n">inf_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">influence</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">influence</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                            <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                            <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                    <span class="n">inf_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># inf_dict[key] = [o[1] for o in self.objectives if o[0] != &#39;equal&#39;]</span>
                    <span class="n">inf_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span>

        <span class="n">n_elites_to_cross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elites_to_crossover</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="c1"># (&lt;obj&gt;[&lt;rank&gt;][&lt;variable&gt;] -&gt; (b[c[1]][0]</span>

            <span class="n">df_co</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G</span><span class="si">{</span><span class="n">generation</span><span class="si">}</span><span class="s2">_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_CO&quot;</span><span class="p">,</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span>
                                 <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]),</span>  <span class="c1"># A</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span>
                                 <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]),</span>  <span class="c1"># B</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span>
                                 <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]),</span>  <span class="c1"># a</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span>
                                 <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]),</span>  <span class="c1"># b</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;Ri&quot;</span><span class="p">]</span> <span class="k">for</span>
                                 <span class="n">key</span> <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;Ri&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;Ri&quot;</span><span class="p">]),</span>  <span class="c1"># Ri</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span>
                                 <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]),</span>  <span class="c1"># L</span>
                            <span class="nb">sum</span><span class="p">([</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                                <span class="n">n_elites_to_cross</span> <span class="k">if</span> <span class="n">n_elites_to_cross</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;Req&quot;</span><span class="p">]</span> <span class="k">for</span>
                                 <span class="n">key</span> <span class="ow">in</span> <span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;Req&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_dict</span><span class="p">[</span><span class="s2">&quot;Req&quot;</span><span class="p">]),</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="mi">0</span>
                            <span class="p">]</span>
        <span class="k">return</span> <span class="n">df_co</span></div>


<div class="viewcode-block" id="Optimisation.mutation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.mutation">[docs]</a>
    <span class="k">def</span> <span class="nf">mutation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>

        <span class="c1"># get list based on mutation length</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">df_ng_mut</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">,</span> <span class="s2">&quot;alpha_i&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha_o&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;Ri&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;Ri&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">6</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;Req&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="s2">&quot;Req&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;alpha_i&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha_o&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ml</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;alpha_i&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha_o&quot;</span><span class="p">]]</span>

        <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_ng_mut</span><span class="p">)):</span>
            <span class="n">key1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;G</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_M&quot;</span><span class="p">)</span>

        <span class="n">df_ng_mut</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key1</span>

        <span class="k">return</span> <span class="n">df_ng_mut</span></div>


<div class="viewcode-block" id="Optimisation.chaos">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.chaos">[docs]</a>
    <span class="k">def</span> <span class="nf">chaos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_first_men</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Optimisation.remove_duplicate_values">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.remove_duplicate_values">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_duplicate_values</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Optimisation.proof_filename">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.proof_filename">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">proof_filename</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="c1"># check if extension is included</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">.json&#39;</span>

        <span class="k">return</span> <span class="n">filepath</span></div>


<div class="viewcode-block" id="Optimisation.recursive_save">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.recursive_save">[docs]</a>
    <span class="k">def</span> <span class="nf">recursive_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pareto_index</span><span class="p">):</span>
        <span class="n">styler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_pareto</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">poc</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">styler</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># df.to_excel(filename)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">_1.xlsx&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recursive_save</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pareto_index</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optimisation.pareto_front">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.pareto_front">[docs]</a>
    <span class="k">def</span> <span class="nf">pareto_front</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="c1"># datapoints = np.array([reverse_list(x), reverse_list(y), reverse_list(z)])</span>
        <span class="c1"># reverse list or not based on objective goal: minimize or maximize</span>
        <span class="c1"># datapoints = [self.negate_list(df.loc[:, o[1]], o[0]) for o in self.objectives]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>

            <span class="n">datapoints</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">obj</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_vars</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">datapoints</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datapoints</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] + 6*std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">datapoints</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">datapoints</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">datapoints</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datapoints</span><span class="p">[</span>
                                                                             <span class="sa">fr</span><span class="s1">&#39;|E[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">] - </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">| + std[</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                                             <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">datapoints</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">datapoints</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># convert datapoints to numpy array</span>

        <span class="n">pareto</span> <span class="o">=</span> <span class="n">oapackage</span><span class="o">.</span><span class="n">ParetoDoubleLong</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">datapoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">oapackage</span><span class="o">.</span><span class="n">doubleVector</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datapoints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="n">pareto</span><span class="o">.</span><span class="n">addvalue</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
        <span class="n">pareto</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Prints out the results from pareto</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="n">pareto</span><span class="o">.</span><span class="n">allindices</span><span class="p">()</span>  <span class="c1"># the indices of the Pareto optimal designs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">reorder_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>

        <span class="c1"># return [optimal_datapoints[i, :] for i in range(datapoints.shape[0])]</span>
        <span class="k">return</span> <span class="n">reorder_idx</span><span class="p">,</span> <span class="n">lst</span></div>


<div class="viewcode-block" id="Optimisation.negate_list">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.negate_list">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">negate_list</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ll</span>  <span class="c1"># to find the pareto maxima</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">]</span>  <span class="c1"># to find the pareto minima</span></div>


<div class="viewcode-block" id="Optimisation.overwriteFolder">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.overwriteFolder">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">overwriteFolder</span><span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\SLANS_opt\_process_</span><span class="si">{</span><span class="n">invar</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dir_util</span><span class="o">.</span><span class="n">_path_created</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optimisation.copyFiles">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.copyFiles">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">copyFiles</span><span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parentDir</span><span class="si">}</span><span class="s2">\exe\SLANS_exe&quot;</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\SLANS_opt\_process_</span><span class="si">{</span><span class="n">invar</span><span class="si">}</span><span class="s2">\SLANS_exe&quot;</span>

        <span class="n">dir_util</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span></div>


<div class="viewcode-block" id="Optimisation.color_pareto">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Optimisation.color_pareto">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">color_pareto</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">no_pareto_optimal</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">color</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="c1"># if row.isnull().values.any():</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="n">no_pareto_optimal</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;background-color: #6bbcd1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># Save Styler Object for Later</span>
        <span class="n">styler</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span>
        <span class="c1"># Apply Styles (This can be chained or on separate lines)</span>
        <span class="n">styler</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Export the styler to excel</span>
        <span class="k">return</span> <span class="n">styler</span></div>
</div>



<div class="viewcode-block" id="Cavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity">[docs]</a>
<span class="k">class</span> <span class="nc">Cavity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command Line Interface module for running analysis.</span>

<span class="sd">    .. note::</span>

<span class="sd">       Still under development so some functions might not work properly</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cavity&#39;</span><span class="p">,</span>
                 <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;simplecell&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">plot_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise cavity object. A cavity object is defined by the number of cells, the cell geometric parameters,</span>
<span class="sd">        if it has beampipes or not and the name. These properties could be changed and retrieved later using the</span>
<span class="sd">        corresponding ``set`` and ``get`` functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cells</span>
<span class="sd">        mid_cell: list, ndarray</span>
<span class="sd">            Mid cell geometric parameters of the cavity</span>
<span class="sd">        end_cell_left: list, ndarray</span>
<span class="sd">            Left end cell geometric parameters of the cavity</span>
<span class="sd">        end_cell_right: list, ndarray</span>
<span class="sd">            Right end cell geometric parameters of the cavity</span>
<span class="sd">        beampipe: {&#39;none&#39;, &#39;both&#39;, &#39;left&#39;, &#39;right&#39;}</span>
<span class="sd">            Beampipe options</span>
<span class="sd">        name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_rf_config</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results_uq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">plot_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="mi">33</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># self.n_cav_op_field = {}</span>
        <span class="c1"># self.op_field = {}</span>
        <span class="c1"># self.p_wp = {}</span>
        <span class="c1"># self.pstat = {}</span>
        <span class="c1"># self.pdyn = {}</span>
        <span class="c1"># self.p_cryo = {}</span>
        <span class="c1"># self.p_in = {}</span>
        <span class="c1"># self.Q0 = {}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">beampipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_of_modules</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_eig_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wake_op_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># eigenmode results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface_field</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)]</span>

        <span class="c1"># wakefield results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_fm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_kick</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I0</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wall_material</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="n">cell_parameterisation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Flattop cavity mid-cells require at least 8 input parameters, &#39;</span>
                                            <span class="s1">&#39;with the 8th representing length (l).&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_cell_left</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Flattop cavity left end-cells require at least 8 input parameters, &#39;</span>
                    <span class="s1">&#39;with the 8th representing length (l).&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_cell_right</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Flattop cavity right end-cells require at least 8 input parameters,&#39;</span>
                    <span class="s1">&#39;with the 8th representing length (l).&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_left</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">end_cell_left</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_right</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[</span>
                                                                                                        <span class="p">:</span><span class="mi">8</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_er</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[</span>
                                                                                                        <span class="p">:</span><span class="mi">8</span><span class="p">]</span>

            <span class="c1"># active cavity length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_el</span> <span class="o">+</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_er</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>

            <span class="c1"># get geometric parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
                <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
                <span class="s2">&quot;OC_R&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
                <span class="s2">&quot;BP&quot;</span><span class="p">:</span> <span class="n">beampipe</span><span class="p">,</span>
                <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span>
                <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span>  <span class="c1"># &lt;- get multicell representation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_left</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">end_cell_left</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_right</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req_er</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>

            <span class="c1"># active cavity length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_el</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_er</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span>

            <span class="c1"># get geometric parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
                <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
                <span class="s2">&quot;OC_R&quot;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span><span class="p">),</span>
                <span class="s2">&quot;BP&quot;</span><span class="p">:</span> <span class="n">beampipe</span><span class="p">,</span>
                <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span>
                <span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_multicell</span><span class="p">()</span>  <span class="c1"># &lt;- get multicell representation</span>

<div class="viewcode-block" id="Cavity.set_name">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_name">[docs]</a>
    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Cavity.set_color">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_color">[docs]</a>
    <span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color: str</span>
<span class="sd">            color of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span></div>


<div class="viewcode-block" id="Cavity.set_parameterisation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_parameterisation">[docs]</a>
    <span class="k">def</span> <span class="nf">set_parameterisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="n">cell_parameterisation</span></div>


<div class="viewcode-block" id="Cavity.set_plot_label">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_plot_label">[docs]</a>
    <span class="k">def</span> <span class="nf">set_plot_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity plot label</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_label: str</span>
<span class="sd">            Cavity plot label</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plot_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span></div>


<div class="viewcode-block" id="Cavity.set_n_cells">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_n_cells">[docs]</a>
    <span class="k">def</span> <span class="nf">set_n_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets number of cells of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cavity cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.set_mid_cell">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_mid_cell">[docs]</a>
    <span class="k">def</span> <span class="nf">set_mid_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set mid cell geometric parameters of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell: list, array like</span>
<span class="sd">            Geometric parameters of cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="n">cell</span></div>


<div class="viewcode-block" id="Cavity.set_end_cell_left">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_end_cell_left">[docs]</a>
    <span class="k">def</span> <span class="nf">set_end_cell_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set left end cell geometric parameters of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell: list, array like</span>
<span class="sd">            Geometric parameters of cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">cell</span></div>


<div class="viewcode-block" id="Cavity.set_end_cell_right">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_end_cell_right">[docs]</a>
    <span class="k">def</span> <span class="nf">set_end_cell_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set right end cell geometric parameters of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell: list, array like</span>
<span class="sd">            Geometric parameters of cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">cell</span></div>


<div class="viewcode-block" id="Cavity.set_boundary_conditions">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_boundary_conditions">[docs]</a>
    <span class="k">def</span> <span class="nf">set_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets boundary conditions for the beampipes of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bc: int</span>
<span class="sd">            Boundary condition of left and right cell/beampipe ends</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.set_beampipe">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_beampipe">[docs]</a>
    <span class="k">def</span> <span class="nf">set_beampipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set beampipe option of cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bp: str</span>
<span class="sd">            Beampipe option of cell</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">bp</span></div>


<div class="viewcode-block" id="Cavity.load">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load existing cavity project folder</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.load_shape_space">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.load_shape_space">[docs]</a>
    <span class="k">def</span> <span class="nf">load_shape_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cavity geometric parameters from shape space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Shape space directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.save_shape_space">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.save_shape_space">[docs]</a>
    <span class="k">def</span> <span class="nf">save_shape_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save current geometric parameters as shape space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Directory to save shape space to. If no input is given, it is saved to the Cavities directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.sweep">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.sweep">[docs]</a>
    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sweep_config</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;cross&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">interval_def</span> <span class="ow">in</span> <span class="n">sweep_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># save nominal variable value form shape space</span>
                <span class="n">current_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">par_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">interval_def</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval_def</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">interval_def</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">par_vals</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
                        <span class="c1"># change value</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_eigenmode</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results_uq</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="p">)</span>

                <span class="c1"># replace initial value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">current_var</span></div>


<div class="viewcode-block" id="Cavity.study_convergence">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.study_convergence">[docs]</a>
    <span class="k">def</span> <span class="nf">study_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_refinement</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.run_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.run_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">run_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">,</span> <span class="n">freq_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">boundary_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run eigenmode analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        solver: {&#39;SLANS&#39;, &#39;NGSolve&#39;}</span>
<span class="sd">            Solver to be used. Native solver is still under development. Results are not as accurate as that of SLANS.</span>
<span class="sd">        freq_shift:</span>
<span class="sd">            Frequency shift. Eigenmode solver searches for eigenfrequencies around this value</span>
<span class="sd">        boundary_cond: int</span>
<span class="sd">            Boundary condition of left and right cell/beampipe ends</span>
<span class="sd">        subdir: str</span>
<span class="sd">            Sub directory to save results to</span>
<span class="sd">        uq_config: None | dict</span>
<span class="sd">            Provides inputs required for uncertainty quantification. Default is None and disables uncertainty quantification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">boundary_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">boundary_cond</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span>
                              <span class="n">freq_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                              <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="n">uq_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span>
                              <span class="n">freq_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                              <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="n">uq_config</span><span class="p">)</span>

        <span class="c1"># load quantities of interest</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_uq_fm_results</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\NGSolveMEVP\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\uq.json&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find eigenmode results. Please rerun eigenmode analysis.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Cavity.run_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.run_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">wakelength</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                      <span class="n">DDR_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operating_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ABCI&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run wakefield analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        MROT: {0, 1}</span>
<span class="sd">            Polarisation 0 for longitudinal polarization and 1 for transversal polarization</span>
<span class="sd">        MT: int</span>
<span class="sd">            Number of time steps it takes for a beam to move from one mesh cell to the other</span>
<span class="sd">        NFS: int</span>
<span class="sd">            Number of frequency samples</span>
<span class="sd">        wakelength:</span>
<span class="sd">            Wakelength to be analysed</span>
<span class="sd">        bunch_length: float</span>
<span class="sd">            Length of the bunch</span>
<span class="sd">        DDR_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the r axis</span>
<span class="sd">        DDZ_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the z axis</span>
<span class="sd">        WG_M:</span>
<span class="sd">            For module simulation. Specifies the length of the beampipe between two cavities.</span>
<span class="sd">        marker: str</span>
<span class="sd">            Marker for the cavities. Adds this to the cavity name specified in a shape space json file</span>
<span class="sd">        wp_dict: dict</span>
<span class="sd">            Python dictionary containing relevant parameters for the wakefield analysis for a specific operating point</span>
<span class="sd">        solver: {&#39;ABCI&#39;}</span>
<span class="sd">            Only one solver is currently available</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :param MROT:</span>
<span class="sd">        :param wakelength:</span>
<span class="sd">        :param WG_M:</span>
<span class="sd">        :param marker:</span>
<span class="sd">        :param solver:</span>
<span class="sd">        :param operating_points:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">operating_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># check if R/Q is set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_abci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                               <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">wakelength</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                               <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span>
                               <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="n">WG_M</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                               <span class="n">operating_points</span><span class="o">=</span><span class="n">operating_points</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.calc_op_freq">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.calc_op_freq">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_op_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates operating frequency. The operating frequency is used for tuning when a frequency is not given.</span>
<span class="sd">        It is advisable to always include the desired tune frequency. Example</span>

<span class="sd">        .. py:function:: cav.run_tune(&#39;Req&#39;, freq=1300)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c0</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_ngsolve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">,</span> <span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span>
                     <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># create folders for all keys</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;OC_R&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC_R&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC&#39;</span>

        <span class="c1"># ngsolve_mevp.cavity(n_cells, n_modules, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[OC_R],</span>
        <span class="c1">#                     n_modes=n_modes, fid=f&quot;{name}&quot;, f_shift=f_shift, bc=bc, beampipes=shape[&#39;BP&#39;],</span>
        <span class="c1">#                     parentDir=parentDir, projectDir=projectDir, subdir=sub_dir)</span>
        <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
            <span class="c1"># write_cst_paramters(f&quot;{key}_n{n_cell}&quot;, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;],</span>
            <span class="c1">#                     projectDir=projectDir, cell_type=&quot;None&quot;, solver=select_solver.lower())</span>

            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                        <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span>
                                        <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                        <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
            <span class="c1"># write_cst_paramters(f&quot;{key}_n{n_cell}&quot;, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;],</span>
            <span class="c1">#                     projectDir=projectDir, cell_type=&quot;None&quot;, solver=select_solver.lower())</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_multicell</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape_multi</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape_multi</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                          <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span>
                                          <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                          <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># write_cst_paramters(f&quot;{key}_n{n_cell}&quot;, shape[&#39;IC&#39;], shape[&#39;OC&#39;], shape[&#39;OC_R&#39;],</span>
            <span class="c1">#                     projectDir=projectDir, cell_type=&quot;None&quot;, solver=select_solver.lower())</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="c1"># run UQ</span>
        <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
            <span class="n">objectives</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span>
            <span class="n">solver_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span> <span class="n">ngsolve_mevp</span><span class="p">}</span>
            <span class="n">solver_args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
                                    <span class="p">{</span><span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="n">n_cells</span><span class="p">,</span> <span class="s1">&#39;n_modules&#39;</span><span class="p">:</span> <span class="n">n_modules</span><span class="p">,</span> <span class="s1">&#39;f_shift&#39;</span><span class="p">:</span> <span class="n">f_shift</span><span class="p">,</span> <span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="n">bc</span><span class="p">,</span>
                                     <span class="s1">&#39;beampipes&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span>
                                     <span class="p">},</span>
                                <span class="s1">&#39;parentDir&#39;</span><span class="p">:</span> <span class="n">parentDir</span><span class="p">,</span>
                                <span class="s1">&#39;projectDir&#39;</span><span class="p">:</span> <span class="n">projectDir</span><span class="p">,</span>
                                <span class="s1">&#39;analysis folder&#39;</span><span class="p">:</span> <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;cell_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mid cell&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;optimisation&#39;</span><span class="p">:</span> <span class="kc">False</span>
                                <span class="p">}</span>

            <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;cell_complexity&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;cell_complexity&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">uq_cell_complexity</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
                <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape_multi</span><span class="p">}</span>
                <span class="n">uq_parallel_multicell</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape</span><span class="p">}</span>
                <span class="n">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done with Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Cavity.set_wall_material">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.set_wall_material">[docs]</a>
    <span class="k">def</span> <span class="nf">set_wall_material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall_material</span> <span class="o">=</span> <span class="n">wm</span></div>


<div class="viewcode-block" id="Cavity.get_ngsolve_tune_res">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_ngsolve_tune_res">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ngsolve_tune_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tune_variable: {&#39;A&#39;, &#39;B&#39;, &#39;a&#39;. &#39;b&#39;, &#39;Ri&#39;, &#39;L&#39;, &#39;Req&#39;}</span>
<span class="sd">            Tune variable.</span>
<span class="sd">        cell_type: {&#39;mid cell&#39;, &#39;end-mid cell&#39;, &#39;mid-end cell&#39;, &#39;single cell&#39;}</span>
<span class="sd">            Type of cell to tune</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tune_res</span> <span class="o">=</span> <span class="s1">&#39;tune_res.json&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">tune_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">tune_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span><span class="p">[</span><span class="s1">&#39;FREQ&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tune results not found. Please tune the cavity&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_eigenmode_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_eigenmode_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenmode_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quantities of interest written by the SLANS code</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qois</span> <span class="o">=</span> <span class="s1">&#39;qois.json&#39;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/SimulationData/NGSolveMEVP/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/monopole/</span><span class="si">{</span><span class="n">qois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="p">(</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Eigenmode result does not exist, please run eigenmode simulation.&#39;</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/SimulationData/NGSolveMEVP/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/monopole/</span><span class="si">{</span><span class="n">qois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;kcc [%]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;ff [%]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;GR/Q [Ohm^2]&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Q []&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Epk/Eacc []&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="s1">&#39;Bpk/Eacc [mT/MV/m]&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Cavity.get_uq_fm_results">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_uq_fm_results">[docs]</a>
    <span class="k">def</span> <span class="nf">get_uq_fm_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="c1"># load uq result</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">\uq.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c1"># get neighbours and all qois</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dirr</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">dirr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">dirr</span><span class="si">}</span><span class="s1">\monopole\qois.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                    <span class="n">neighbour_uq_fm_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                <span class="n">neighbours</span><span class="p">[</span><span class="n">dirr</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbour_uq_fm_results</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">cn_leg_05_2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="c1"># write weights</span>

        <span class="n">data_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
        <span class="n">data_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">\weights.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># get weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">\weights.csv&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_uq_hom_results">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_uq_hom_results">[docs]</a>
    <span class="k">def</span> <span class="nf">get_uq_hom_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_wakefield_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_wakefield_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the quantities of interest written by the ABCI code</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt: {&#39;SR&#39;, &#39;BS&#39;}</span>
<span class="sd">            SR - Synchrotron radiation bunch length</span>
<span class="sd">            BS - Bremsstrahlung</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qois</span> <span class="o">=</span> <span class="s1">&#39;qois.json&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\ABCI\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">qois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\ABCI\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">qois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">all_wakefield_qois</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c1"># get only keys in op_points</span>
        <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">all_wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_fm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I0</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;I0 [mA]&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Cavity.get_abci_data">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_abci_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_abci_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">abci_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Long&#39;</span><span class="p">:</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                          <span class="s1">&#39;Trans&#39;</span><span class="p">:</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span></div>


<div class="viewcode-block" id="Cavity.plot_animate_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_animate_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_animate_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">plot_contour_for_frame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frame_key</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DOTS&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;SOLID&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">frame_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">frame_key</span><span class="p">]:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">plot_type</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X-axis (m)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y-axis (m)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contour Plot for </span><span class="si">{</span><span class="n">frame_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">animate_frames</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">frame_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Sort frames by their order</span>

            <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">frame_key</span><span class="p">):</span>
                <span class="n">plot_contour_for_frame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frame_key</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

            <span class="n">ani</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frame_keys</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ani</span>

        <span class="n">top_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">efield_contour</span> <span class="o">=</span> <span class="n">get_wakefield_data</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">top_folder</span><span class="si">}</span><span class="s1">/Cavity_MROT_0.top&#39;</span><span class="p">)</span>
        <span class="n">ani</span> <span class="o">=</span> <span class="n">animate_frames</span><span class="p">(</span><span class="n">efield_contour</span><span class="p">)</span>
        <span class="n">display_html</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">animate_frames</span><span class="p">(</span><span class="n">efield_contour</span><span class="p">)</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="c1"># Save the animation as an MP4 file</span>
            <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">top_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_e_field_animation.mp4&#39;</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.get_power_uq">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_power_uq">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power_uq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">):</span>
        <span class="n">stat_moms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                    <span class="n">sig_id</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

                    <span class="n">Q0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Q0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">inv_eta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_sr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;SR per turn [MW]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">n_cav</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_in</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_cryo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">pdyn</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">pstat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">p_wp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

                    <span class="c1"># test</span>
                    <span class="n">n_cav</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">v_rf</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)))</span>

                    <span class="c1"># p_in = rf_config[&#39;SR per turn [MW]&#39;] * 1e6 / n_cav * 1e-3  # maximum synchrotron radiation per beam</span>

                    <span class="n">p_cryo_n</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">500</span><span class="p">))</span>  <span class="c1"># W/m</span>

                    <span class="n">pdyn_n</span> <span class="o">=</span> <span class="n">v_rf</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># per cavity</span>
                    <span class="n">pdyn_expe</span><span class="p">,</span> <span class="n">pdyn_std</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">pdyn_n</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span><span class="p">)</span>
                    <span class="n">pdyn</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="n">pdyn_expe</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="n">pdyn_std</span><span class="p">}</span>

                    <span class="n">pstat_n</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">*</span> <span class="n">v_rf</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="n">p_cryo_n</span>
                    <span class="n">pstat_expe</span><span class="p">,</span> <span class="n">pstat_std</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">pstat_n</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span><span class="p">)</span>
                    <span class="n">pstat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="n">pstat_expe</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="n">pstat_std</span><span class="p">}</span>

                    <span class="n">p_wp_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdyn_n</span> <span class="o">+</span> <span class="n">pstat_n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># per cavity</span>
                    <span class="n">p_wp_expe</span><span class="p">,</span> <span class="n">p_wp_std</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">p_wp_n</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_weights</span><span class="p">)</span>
                    <span class="n">p_wp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="n">p_wp_expe</span><span class="p">,</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="n">p_wp_std</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">stat_mom</span> <span class="ow">in</span> <span class="n">stat_moms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">op_field</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># n_cav[stat_mom] = [</span>
                            <span class="c1">#     int(np.ceil(v_rf[stat_mom][0] / (op_field[stat_mom][0] * self.l_active)))]</span>

                            <span class="n">p_in</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_sr</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_cav</span><span class="p">[</span><span class="n">stat_mom</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">]</span>  <span class="c1"># maximum synchrotron radiation per beam</span>

                        <span class="c1"># if self.uq_fm_results[&#39;freq [MHz]&#39;][stat_mom][0] != 0:</span>
                        <span class="c1">#     p_cryo[stat_mom] = [</span>
                        <span class="c1">#         8 / (np.sqrt(self.uq_fm_results[&#39;freq [MHz]&#39;][stat_mom][0] / 500))]  # W/m</span>
                        <span class="c1">#</span>
                        <span class="c1"># if self.uq_fm_results[&#39;R/Q [Ohm]&#39;][stat_mom][0] * Q0[stat_mom][0] * n_cav[stat_mom][0] != 0:</span>
                        <span class="c1">#     pdyn[stat_mom] = [v_rf[stat_mom][0] * (op_field[stat_mom][0] * self.l_active) / (</span>
                        <span class="c1">#             self.uq_fm_results[&#39;R/Q [Ohm]&#39;][stat_mom][0] * Q0[stat_mom][0] *</span>
                        <span class="c1">#             n_cav[stat_mom][0])]  # per cavity</span>
                        <span class="c1">#</span>
                        <span class="c1"># if op_field[stat_mom][0] != 0 and n_cav[stat_mom][0] != 0:</span>
                        <span class="c1">#     pstat[stat_mom] = [(self.l_cavity * v_rf[stat_mom][0] / (</span>
                        <span class="c1">#             self.l_active * op_field[stat_mom][0] * n_cav[stat_mom][0])) * p_cryo[stat_mom][</span>
                        <span class="c1">#                            0]]</span>
                        <span class="c1">#</span>
                        <span class="c1"># if inv_eta[stat_mom][0] != 0:</span>
                        <span class="c1">#     p_wp[stat_mom] = [</span>
                        <span class="c1">#         (inv_eta[stat_mom][0]) * (pdyn[stat_mom][0] + pstat[stat_mom][0]) * 1e-3]  # per cavity</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="n">sig_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sa">r</span><span class="s2">&quot;Ncav&quot;</span><span class="p">:</span> <span class="n">n_cav</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Q0 []&quot;</span><span class="p">:</span> <span class="n">Q0</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pstat/cav [W]&quot;</span><span class="p">:</span> <span class="n">pstat</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pdyn/cav [W]&quot;</span><span class="p">:</span> <span class="n">pdyn</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pwp/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_wp</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pin/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_in</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;PHOM/cav [kW]&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;P_HOM [kW]_</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sig_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">vv</span><span class="si">}</span><span class="s1">mm&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois_uq</span></div>


<div class="viewcode-block" id="Cavity.get_power">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_power">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                    <span class="n">sig_id</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">*</span> <span class="mf">1e6</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">op_field</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="n">op_field</span>

                    <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_rf</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>

                    <span class="n">Q0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span>
                    <span class="n">inv_eta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_eta</span>
                    <span class="n">p_sr</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;SR per turn [MW]&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>

                    <span class="n">n_cav</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">v_rf</span> <span class="o">/</span> <span class="p">(</span><span class="n">op_field</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)))</span>
                    <span class="n">p_in</span> <span class="o">=</span> <span class="n">p_sr</span> <span class="o">/</span> <span class="n">n_cav</span>  <span class="c1"># maximum synchrotron radiation per beam</span>

                    <span class="n">p_cryo</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">500</span><span class="p">))</span>

                    <span class="n">pdyn</span> <span class="o">=</span> <span class="n">v_rf</span> <span class="o">*</span> <span class="p">(</span><span class="n">op_field</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_active</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span> <span class="o">*</span> <span class="n">Q0</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">)</span>

                    <span class="n">pstat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_cavity</span> <span class="o">*</span> <span class="n">v_rf</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_active</span> <span class="o">*</span> <span class="n">op_field</span> <span class="o">*</span> <span class="n">n_cav</span><span class="p">))</span> <span class="o">*</span> <span class="n">p_cryo</span>  <span class="c1"># per cavity</span>
                    <span class="n">p_wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">inv_eta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdyn</span> <span class="o">+</span> <span class="n">pstat</span><span class="p">)</span>  <span class="c1"># per cavity</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="n">sig_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sa">r</span><span class="s2">&quot;Ncav&quot;</span><span class="p">:</span> <span class="n">n_cav</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Q0 []&quot;</span><span class="p">:</span> <span class="n">Q0</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pstat/cav [W]&quot;</span><span class="p">:</span> <span class="n">pstat</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pdyn/cav [W]&quot;</span><span class="p">:</span> <span class="n">pdyn</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pwp/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_wp</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;Pin/cav [kW]&quot;</span><span class="p">:</span> <span class="n">p_in</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;PHOM/cav [kW]&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sig_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">vv</span><span class="si">}</span><span class="s1">mm&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_performance_qois</span></div>


<div class="viewcode-block" id="Cavity.get_uq_post">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.get_uq_post">[docs]</a>
    <span class="k">def</span> <span class="nf">get_uq_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qoi</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Cavity.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mid_cell&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">new_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;mid_cell&#39;</span><span class="p">}</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span>
                                               <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;end_cell_left&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span>
                                               <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;end_cell_right&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span>
                                               <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [mm]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ [mm]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Long.)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Long.)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\parallel} ~[\mathrm{k\Omega}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Trans.)&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (Wake. Trans.)&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\perp} ~[\mathrm{k\Omega/m}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_err&#39;</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ax</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convergence data not available.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.plot_mesh">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">):</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\NGSolveMEVP\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">\monopole&#39;</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="n">plotter</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.plot_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.plot_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">):</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">plot_fields</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\NGSolveMEVP\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">\monopole&#39;</span><span class="p">,</span>
                                 <span class="n">mode</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">plotter</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_plot_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># plot convergence</span>
        <span class="n">conv_filepath</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\convergence.json&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conv_filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">conv_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">convergence_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convergence_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">convergence_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">convergence_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">convergence_dict</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

                <span class="c1"># plot directions</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span>
                                       <span class="n">scale_units</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                       <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="n">headaxislength</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># plot absolute error</span>
        <span class="n">abs_err_filepath</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\Optimisation\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\absolute_error.json&quot;</span>
        <span class="n">abs_err_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conv_filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_err_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">abs_err_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_err_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">abs_err_dict</span><span class="p">[</span><span class="s1">&#39;abs_err&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Parameter&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Absolute error&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Cavity.define_operating_points">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.define_operating_points">[docs]</a>
    <span class="k">def</span> <span class="nf">define_operating_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="n">op</span></div>


<div class="viewcode-block" id="Cavity.inspect">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.inspect">[docs]</a>
    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s1">&#39;mid-cell&#39;</span><span class="p">,</span> <span class="n">variation</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;mid-cell&#39;</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;end-cell-left&#39;</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;end-cell-right&#39;</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
            <span class="n">A_</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">a_</span><span class="p">,</span> <span class="n">b_</span><span class="p">,</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">L_</span><span class="p">,</span> <span class="n">Req_</span><span class="p">,</span> <span class="n">l_</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>

            <span class="c1"># Define the function that plots the graph</span>
            <span class="k">def</span> <span class="nf">plot_cavity_geometry_flattop</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
                <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">BP</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                                  <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tangent_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Update the sum display</span>
                <span class="n">sum_label</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sum of A + a + l: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, L: </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">, delta: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">L</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># Create sliders for each variable</span>
            <span class="n">A_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">A_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">B_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">B_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">a_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">b_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">b_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">Ri_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Ri_</span><span class="p">,</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Ri&#39;</span><span class="p">)</span>
            <span class="n">L_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">L_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">Req_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                             <span class="n">value</span><span class="o">=</span><span class="n">Req_</span><span class="p">,</span>
                                             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Req&#39;</span><span class="p">)</span>
            <span class="n">l_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">l_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
            <span class="c1"># Create a label to display the sum of A + a</span>
            <span class="n">sum_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">()</span>

            <span class="c1"># Arrange the sliders in a 3x3 layout</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">A_slider</span><span class="p">,</span> <span class="n">B_slider</span><span class="p">,</span> <span class="n">a_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">b_slider</span><span class="p">,</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="n">L_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">Req_slider</span><span class="p">,</span> <span class="n">l_slider</span><span class="p">]),</span>
                <span class="n">sum_label</span>  <span class="c1"># Add the sum label to the layout</span>
            <span class="p">])</span>

            <span class="c1"># Create an interactive widget to update the plot</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_cavity_geometry_flattop</span><span class="p">,</span>
                                             <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A_slider</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">B_slider</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_slider</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b_slider</span><span class="p">,</span>
                                              <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">L_slider</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="n">Req_slider</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="n">l_slider</span><span class="p">})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">A_</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">a_</span><span class="p">,</span> <span class="n">b_</span><span class="p">,</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">L_</span><span class="p">,</span> <span class="n">Req_</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>

            <span class="c1"># Define the function that plots the graph</span>
            <span class="k">def</span> <span class="nf">plot_cavity_geometry</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">):</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">BP</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">tangent_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Update the sum display</span>
                <span class="n">sum_label</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sum of A + a: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, L: </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">, delta: </span><span class="si">{</span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">L</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># Create sliders for each variable</span>
            <span class="n">A_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">A_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">A_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">B_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">B_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">a_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">b_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">b_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">Ri_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ri_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Ri_</span><span class="p">,</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Ri&#39;</span><span class="p">)</span>
            <span class="n">L_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">L_</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">Req_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span> <span class="o">*</span> <span class="n">Req_</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                             <span class="n">value</span><span class="o">=</span><span class="n">Req_</span><span class="p">,</span>
                                             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Req&#39;</span><span class="p">)</span>
            <span class="c1"># Create a label to display the sum of A + a</span>
            <span class="n">sum_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">()</span>

            <span class="c1"># Arrange the sliders in a 3x3 layout</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">A_slider</span><span class="p">,</span> <span class="n">B_slider</span><span class="p">,</span> <span class="n">a_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">b_slider</span><span class="p">,</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="n">L_slider</span><span class="p">]),</span>
                <span class="n">HBox</span><span class="p">([</span><span class="n">Req_slider</span><span class="p">]),</span>
                <span class="n">sum_label</span>  <span class="c1"># Add the sum label to the layout</span>
            <span class="p">])</span>

            <span class="c1"># Create an interactive widget to update the plot</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_cavity_geometry</span><span class="p">,</span>
                                             <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A_slider</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">B_slider</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_slider</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b_slider</span><span class="p">,</span>
                                              <span class="s1">&#39;Ri&#39;</span><span class="p">:</span> <span class="n">Ri_slider</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">L_slider</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">:</span> <span class="n">Req_slider</span><span class="p">})</span>

        <span class="c1"># Display the layout</span>
        <span class="n">display</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ui</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavity.to_multicell">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavity.to_multicell">[docs]</a>
    <span class="k">def</span> <span class="nf">to_multicell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mid_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
        <span class="n">mid_cell_multi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mid_cell</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid_cell_multi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_multicell</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;multicell&#39;</span></div>


    <span class="k">def</span> <span class="nf">_create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>

        <span class="k">if</span> <span class="n">project_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>

            <span class="c1"># check if folder already exist</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_path_exists</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">make_dirs_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">current_dir</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                            <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

                <span class="c1"># create project structure in folders</span>
                <span class="n">project_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;Cavities&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;OperatingPoints&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;SimulationData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;SLANS&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;SLANS_Opt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;NativeEig&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;CavitiesAnalysis&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;PostprocessingData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;Plots&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;CSTData&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">project_dir_structure</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;An exception occurred in created project: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Please enter a valid project name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_if_path_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">directory_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Cavities&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;PostprocessingData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;SimulationData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">directory_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">It seems that the folder specified is not a cavity project folder. Please check folder&#39;</span>
                             <span class="s1">&#39;again to avoid deleting important files.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_overwriteFolder</span><span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\SLANS\_process_</span><span class="si">{</span><span class="n">invar</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dir_util</span><span class="o">.</span><span class="n">_path_created</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_copyFiles</span><span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parentDir</span><span class="si">}</span><span class="s2">\exe\SLANS_exe&quot;</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\SLANS\_process_</span><span class="si">{</span><span class="n">invar</span><span class="si">}</span><span class="s2">\SLANS_exe&quot;</span>

        <span class="n">dir_util</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span></div>



<div class="viewcode-block" id="Cavities">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities">[docs]</a>
<span class="k">class</span> <span class="nc">Cavities</span><span class="p">(</span><span class="n">Optimisation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cavities object is an object containing several Cavity objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cavities_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs all the necessary attributes of the Cavity object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cavities_list: list, array like</span>
<span class="sd">            List containing Cavity objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_qois_uq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span> <span class="o">=</span> <span class="n">cavities_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cavities_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cavities_list</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_cavity</span><span class="p">(</span><span class="n">cavities_list</span><span class="p">,</span> <span class="n">names_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;cavities&#39;</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter valid project name.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power_qois</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points_threshold</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># V/m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cavities_field</span><span class="p">()</span>

<div class="viewcode-block" id="Cavities.add_cavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.add_cavity">[docs]</a>
    <span class="k">def</span> <span class="nf">add_cavity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cavs</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds cavity to cavities</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_labels: list, str</span>
<span class="sd">            Plot labels</span>
<span class="sd">        cavs: Cavity, list</span>
<span class="sd">            Cavity object or list of cavity objects</span>
<span class="sd">        names: list, str</span>
<span class="sd">            Cavity name or list of cavity names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cavs</span><span class="p">,</span> <span class="n">Cavity</span><span class="p">):</span>
            <span class="n">cavs</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>
            <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cav_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_plot_label</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cavs</span><span class="o">.</span><span class="n">set_plot_label</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cavs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">[</span><span class="n">cavs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cavs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="n">cavs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cavs</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span><span class="p">[</span><span class="n">cavs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cavs</span><span class="o">.</span><span class="n">shape_multicell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cavs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="s2">&quot;Number of cavities does not correspond to number of names.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cav_</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))]</span>

            <span class="k">if</span> <span class="n">plot_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cavs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">),</span> <span class="s2">&quot;Number of cavities does not correspond to number of labels.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_labels</span> <span class="o">=</span> <span class="n">names</span>

            <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cavs</span><span class="p">):</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">set_plot_label</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cav</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">shape_multicell</span></div>


<div class="viewcode-block" id="Cavities.set_name">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.set_name">[docs]</a>
    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cavity name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Cavities.save">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set folder to save cavity analysis results</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files_path: str</span>
<span class="sd">            Save project directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">project_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please specify a folder to write the simulation results to.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">project_folder</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_project</span><span class="p">(</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="n">project_folder</span><span class="si">}</span><span class="s2"> could not be created. Please check the folder and try again.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="n">project_folder</span><span class="si">}</span><span class="s2"> created successfully/already exists.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">project_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span></div>


<div class="viewcode-block" id="Cavities.save_plot_as_json">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.save_plot_as_json">[docs]</a>
    <span class="k">def</span> <span class="nf">save_plot_as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">ax_children</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>

        <span class="n">ax_objects_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ax props&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;fig props&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># &#39;line1&#39;: line_properties,</span>
            <span class="p">},</span>
            <span class="s1">&#39;axvline&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;axhline&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;patches&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># get axis properties</span>
        <span class="n">axis_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis_properties</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_objects_dict</span><span class="p">[</span><span class="s1">&#39;ax props&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis_properties</span>

        <span class="c1"># get figure properties</span>
        <span class="n">fig_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_figure_properties</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">())</span>
        <span class="n">ax_objects_dict</span><span class="p">[</span><span class="s1">&#39;fig props&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig_props</span>

        <span class="c1"># List of known properties for Line2D</span>
        <span class="n">line_properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;xdata&#39;</span><span class="p">,</span> <span class="s1">&#39;ydata&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;animated&#39;</span><span class="p">,</span> <span class="s1">&#39;antialiased&#39;</span><span class="p">,</span> <span class="s1">&#39;clip_on&#39;</span><span class="p">,</span> <span class="s1">&#39;clip_path&#39;</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;dash_capstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;dash_joinstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;drawstyle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;markeredgecolor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;markeredgewidth&#39;</span><span class="p">,</span> <span class="s1">&#39;markerfacecolor&#39;</span><span class="p">,</span> <span class="s1">&#39;markersize&#39;</span><span class="p">,</span> <span class="s1">&#39;path_effects&#39;</span><span class="p">,</span> <span class="s1">&#39;rasterized&#39;</span><span class="p">,</span> <span class="s1">&#39;sketch_params&#39;</span><span class="p">,</span>
            <span class="s1">&#39;snap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solid_capstyle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solid_joinstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span> <span class="s1">&#39;zorder&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;transform&#39;,</span>
            <span class="c1"># &#39;clip_box&#39;,</span>
            <span class="c1"># &#39;figure&#39;, &#39;picker&#39;, &#39;pickradius&#39;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">mpl_obj</span> <span class="ow">in</span> <span class="n">ax_children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mpl_obj</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">):</span>
                <span class="c1"># Extract properties into a dictionary</span>
                <span class="n">line_properties_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mpl_obj</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)()</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">line_properties</span><span class="p">}</span>
                <span class="n">ax_objects_dict</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">mpl_obj</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_properties_data</span>

        <span class="k">return</span> <span class="n">ax_objects_dict</span></div>


<div class="viewcode-block" id="Cavities.load_plot_from_json">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.load_plot_from_json">[docs]</a>
    <span class="k">def</span> <span class="nf">load_plot_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">plot_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plot_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[])</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;patches&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="Cavities.plot_from_json">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_from_json">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_config</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plot_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line_keys</span><span class="p">,</span> <span class="n">line_values</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[])</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">line_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># ax[0].scatter(value[&#39;x&#39;], value[&#39;y&#39;], value[&#39;kwargs&#39;])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;patches&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># if value[&#39;type&#39;] == &#39;text&#39;:</span>
                <span class="c1">#     ax[0].add_text(value[&#39;x&#39;], value[&#39;y&#39;], value[&#39;kwargs&#39;])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fig props&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ax props&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

        <span class="c1"># plot legend wthout duplicates</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


    <span class="k">def</span> <span class="nf">_get_axis_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="c1"># List of common properties for an Axis</span>
        <span class="n">axis_properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;margin&#39;</span><span class="p">,</span> <span class="s1">&#39;bound&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect&#39;</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_axis_properties</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">axis_properties</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Use get_* methods dynamically if available</span>
                    <span class="n">getter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">getter</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
                            <span class="n">properties</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span><span class="p">()</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">properties</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Fallback to axis.get_property()</span>
                        <span class="n">properties</span><span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">properties</span>

        <span class="n">axis_properties</span> <span class="o">=</span> <span class="n">get_axis_properties</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">axis_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_axis_properties</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">axis_properties</span>

    <span class="k">def</span> <span class="nf">_get_figure_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">):</span>
        <span class="c1"># List of properties to retrieve</span>
        <span class="n">figure_properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;figwidth&#39;</span><span class="p">,</span> <span class="s1">&#39;figheight&#39;</span><span class="p">,</span> <span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="s1">&#39;tight_layout&#39;</span><span class="p">,</span> <span class="s1">&#39;constrained_layout&#39;</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_figure_properties</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">figure_properties</span><span class="p">:</span>
                <span class="n">getter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">getter</span><span class="p">):</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">properties</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
            <span class="k">return</span> <span class="n">properties</span>

        <span class="c1"># Get properties of the figure</span>
        <span class="n">fig_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fig_properties</span> <span class="o">=</span> <span class="n">get_figure_properties</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig_properties</span>

    <span class="k">def</span> <span class="nf">_create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span>

        <span class="k">if</span> <span class="n">project_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>

            <span class="c1"># check if folder already exist</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_path_exists</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">make_dirs_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">current_dir</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                            <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

                <span class="c1"># create project structure in folders</span>
                <span class="n">project_dir_structure</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;Cavities&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;OperatingPoints&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;SimulationData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;SLANS&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;SLANS_Opt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;NativeEig&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;CavitiesAnalysis&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;PostprocessingData&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;Plots&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;CSTData&#39;</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">make_dirs_from_dict</span><span class="p">(</span><span class="n">project_dir_structure</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;An exception occurred in created project: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># self.projectDir = os.path.join(project_dir, project_name)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Please enter a valid project name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">f2b_slashes</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_if_path_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">directory_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Cavities&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;PostprocessingData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> \
                            <span class="ow">and</span> <span class="s1">&#39;SimulationData&#39;</span> <span class="ow">in</span> <span class="n">directory_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">directory_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">It seems that the folder specified is not a cavity project folder. Please check folder&#39;</span>
                              <span class="s1">&#39;again to avoid deleting important files.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Cavities.sweep">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.sweep">[docs]</a>
    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sweep_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">sweep_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">sweep_results</span></div>


<div class="viewcode-block" id="Cavities.check_uq_config">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.check_uq_config">[docs]</a>
    <span class="k">def</span> <span class="nf">check_uq_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
        <span class="n">uq_ok</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">check_uq_config</span><span class="p">(</span><span class="n">uq_config</span><span class="p">)</span>
            <span class="n">uq_ok</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">info</span><span class="p">(</span><span class="n">uq_ok</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.run_tune">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_tune">[docs]</a>
    <span class="k">def</span> <span class="nf">run_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tune_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tune_config: dict</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                tune_config = {</span>
<span class="sd">                            &#39;freqs&#39;: 801.58,</span>
<span class="sd">                            &#39;parameters&#39;: &#39;Req&#39;,</span>
<span class="sd">                            &#39;cell_types&#39;: &#39;mid-cell&#39;,</span>
<span class="sd">                            &#39;processes&#39;: 1,</span>
<span class="sd">                            &#39;rerun&#39;: True</span>
<span class="sd">                        }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;The number of deltas must &quot;</span>
                                                                                     <span class="s2">&quot;be equal to the number of &quot;</span>
                                                                                     <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;The number of epsilons must &quot;</span>
                    <span class="s2">&quot;be equal to the number of &quot;</span>
                    <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;eigenmode_config&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;eigenmode_config&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">uq_config_eig</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of deltas must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config_eig</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of epsilons must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config_eig</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">tune_config</span><span class="p">:</span>
            <span class="n">rerun</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rerun</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;rerun should be boolean.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rerun</span>

        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="n">run_tune_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tune_config</span> <span class="o">=</span> <span class="n">tune_config</span>
        <span class="c1"># get tune results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_tune_res</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.get_tune_res">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_tune_res">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tune_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_ngsolve_tune_res</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_tune_res</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">eigenmode_tune_res</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oops! Something went wrong. Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.run_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">run_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the eigenmode analysis with the given configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eigenmode_config : dict</span>
<span class="sd">            Configuration for running the eigenmode analysis. Example structure:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                eigenmode_config = {</span>
<span class="sd">                    &#39;processes&#39;: 3,</span>
<span class="sd">                    &#39;rerun&#39;: True,</span>
<span class="sd">                    &#39;boundary_conditions&#39;: &#39;mm&#39;,</span>
<span class="sd">                    &#39;uq_config&#39;: {</span>
<span class="sd">                        &#39;variables&#39;: [&#39;A&#39;, &#39;B&#39;, &#39;a&#39;, &#39;b&#39;],</span>
<span class="sd">                        # &#39;objectives&#39;: [&quot;freq [MHz]&quot;, &quot;R/Q [Ohm]&quot;, &quot;Epk/Eacc []&quot;, &quot;Bpk/Eacc [mT/MV/m]&quot;, &quot;G [Ohm]&quot;, &quot;kcc [%]&quot;, &quot;ff [%]&quot;],</span>
<span class="sd">                        &#39;objectives&#39;: [&quot;Epk/Eacc []&quot;, &quot;Bpk/Eacc [mT/MV/m]&quot;, &quot;R/Q [Ohm]&quot;, &quot;G [Ohm]&quot;],</span>
<span class="sd">                        # &#39;objectives&#39;: [&quot;ZL&quot;],</span>
<span class="sd">                        &#39;delta&#39;: [0.05, 0.05, 0.05, 0.05],</span>
<span class="sd">                        &#39;processes&#39;: 4,</span>
<span class="sd">                        &#39;distribution&#39;: &#39;gaussian&#39;,</span>
<span class="sd">                        # &#39;method&#39;: [&#39;QMC&#39;, &#39;LHS&#39;, 1000],</span>
<span class="sd">                        # &#39;method&#39;: [&#39;QMC&#39;, &#39;Sobol&#39;, 1000],</span>
<span class="sd">                        # &#39;method&#39;: [&#39;Qudrature&#39;, &#39;Gaussian&#39;, 1000],</span>
<span class="sd">                        &#39;method&#39;: [&#39;Quadrature&#39;, &#39;Stroud3&#39;],</span>
<span class="sd">                        # &#39;method&#39;: [&#39;Quadrature&#39;, &#39;Stroud5&#39;],</span>
<span class="sd">                        # &#39;gaussian&#39;: [&#39;Quadrature&#39;, &#39;Gaussian&#39;],</span>
<span class="sd">                        # &#39;from file&#39;: [&#39;&lt;file path&gt;&#39;, columns],</span>
<span class="sd">                        &#39;cell_type&#39;: &#39;mid-cell&#39;,</span>
<span class="sd">                        &#39;cell_complexity&#39;: &#39;simplecell&#39;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">eigenmode_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

        <span class="n">uq_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;The number of deltas must &quot;</span>
                                                                                         <span class="s2">&quot;be equal to the number of &quot;</span>
                                                                                         <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The number of epsilons must &quot;</span>
                        <span class="s2">&quot;be equal to the number of &quot;</span>
                        <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uq_config</span>

        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="c1"># add save directory field to eigenmode_config</span>
            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NGSolveMEVP&#39;</span>
            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">run_eigenmode_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span> <span class="o">=</span> <span class="n">eigenmode_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">(</span><span class="n">uq_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.get_eigenmode_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_eigenmode_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenmode_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
        <span class="c1"># get results</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">eigenmode_qois</span>
                <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">cav</span><span class="o">.</span><span class="n">get_uq_fm_results</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\NGSolveMEVP\</span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_fm_results</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the eigenmode results. Please rerun eigenmode analysis.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Cavities.run_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wakefield_config:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                op_points = {</span>
<span class="sd">                            &quot;Z&quot;: {</span>
<span class="sd">                                &quot;freq [MHz]&quot;: 400.79,  # Operating frequency</span>
<span class="sd">                                &quot;E [GeV]&quot;: 45.6,  # &lt;- Beam energy</span>
<span class="sd">                                &quot;I0 [mA]&quot;: 1280,  # &lt;- Beam current</span>
<span class="sd">                                &quot;V [GV]&quot;: 0.12,  # &lt;- Total voltage</span>
<span class="sd">                                &quot;Eacc [MV/m]&quot;: 5.72,  # &lt;- Accelerating field</span>
<span class="sd">                                &quot;nu_s []&quot;: 0.0370,  # &lt;- Synchrotron oscillation tune</span>
<span class="sd">                                &quot;alpha_p [1e-5]&quot;: 2.85,  # &lt;- Momentum compaction factor</span>
<span class="sd">                                &quot;tau_z [ms]&quot;: 354.91,  # &lt;- Longitudinal damping time</span>
<span class="sd">                                &quot;tau_xy [ms]&quot;: 709.82,  # &lt;- Transverse damping time</span>
<span class="sd">                                &quot;f_rev [kHz]&quot;: 3.07,  # &lt;- Revolution frequency</span>
<span class="sd">                                &quot;beta_xy [m]&quot;: 56,  # &lt;- Beta function</span>
<span class="sd">                                &quot;N_c []&quot;: 56,  # &lt;- Number of cavities</span>
<span class="sd">                                &quot;T [K]&quot;: 4.5,  # &lt;- Operating tempereature</span>
<span class="sd">                                &quot;sigma_SR [mm]&quot;: 4.32,  # &lt;- Bunch length</span>
<span class="sd">                                &quot;sigma_BS [mm]&quot;: 15.2,  # &lt;- Bunch length</span>
<span class="sd">                                &quot;Nb [1e11]&quot;: 2.76  # &lt;- Bunch population</span>
<span class="sd">                            }</span>
<span class="sd">                }</span>
<span class="sd">                wakefield_config = {</span>
<span class="sd">                    &#39;bunch_length&#39;: 25,</span>
<span class="sd">                    &#39;wakelength&#39;: 50,</span>
<span class="sd">                    &#39;processes&#39;: 2,</span>
<span class="sd">                    &#39;rerun&#39;: True,</span>
<span class="sd">                    &#39;operating_points&#39;: op_points,</span>
<span class="sd">                }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">wakefield_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wakefield_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">wakefield_config_keys</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span>

        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

        <span class="n">uq_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;The number of deltas must &quot;</span>
                                                                                     <span class="s2">&quot;be equal to the number of &quot;</span>
                                                                                     <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;The number of epsilons must &quot;</span>
                    <span class="s2">&quot;be equal to the number of &quot;</span>
                    <span class="s2">&quot;variables.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;epsilon and delta are both entered. Epsilon is preferred.&#39;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="s1">&#39;objectives&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter objectives in uq_config.&#39;</span><span class="p">)</span>

            <span class="n">objectives_unprocessed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># adjust objectives to match signature with optimisation</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">objectives_unprocessed</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">objectives_unprocessed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="n">objectives</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">process_objectives</span><span class="p">(</span><span class="n">objectives_unprocessed</span><span class="p">)</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives_unprocessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objectives_unprocessed</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">][</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objectives</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uq_config</span>

        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="n">MROT</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">MT</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">NFS</span> <span class="o">=</span> <span class="mi">10000</span>
            <span class="n">wakelength</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">bunch_length</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="n">DDR_SIG</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">DDZ_SIG</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="c1"># check inputs</span>
            <span class="k">if</span> <span class="s1">&#39;bunch_length&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Bunch length must be of type integer or float.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bunch_length</span>
            <span class="k">if</span> <span class="s1">&#39;wakelength&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Wakelength must be of type integer or float.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wakelength</span>

            <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processes</span>

            <span class="k">if</span> <span class="s1">&#39;polarisation&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Polarisation should be 0 for longitudinal, &#39;</span>
                    <span class="s1">&#39;1 for transverse, 2 for both.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MROT</span>

            <span class="k">if</span> <span class="s1">&#39;MT&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;MT must be integer between 4 and 20, with 4 and 20 &#39;</span>
                    <span class="s1">&#39;included.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span>

            <span class="k">if</span> <span class="s1">&#39;NFS&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;NFS must be integer.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NFS</span>

            <span class="k">if</span> <span class="s1">&#39;DDR_SIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;DDR_SIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDR_SIG</span>

            <span class="k">if</span> <span class="s1">&#39;DDZ_SIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wakefield_config_keys</span><span class="p">:</span>
                <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;DDZ_SIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DDZ_SIG</span>

            <span class="n">run_wakefield_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space_multicell</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span> <span class="o">=</span> <span class="n">wakefield_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">(</span><span class="n">uq_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.get_wakefield_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_wakefield_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">wakefield_qois</span>
                <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                    <span class="n">cav</span><span class="o">.</span><span class="n">get_uq_hom_results</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">\uq.json&quot;</span><span class="p">)</span>
                    <span class="n">cav_uq_hom_results</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_hom_results</span>
                    <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="p">:</span>
                        <span class="c1"># separate into opearating points</span>
                        <span class="n">op_points</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span>
                        <span class="n">uq_hom_results_op</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">op_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">uq_hom_results_op</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                                    <span class="n">sig_id</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">ident</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sig_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">mm&#39;</span>
                                    <span class="n">uq_hom_results_op</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">sig_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">vv</span> <span class="k">for</span> <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="ow">in</span>
                                                                     <span class="n">cav_uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uq_hom_results_op</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">uq_hom_results</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">uq_hom_results_op</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oops! Something went wrong. Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Length of scale_x must be same as number of Cavity objects.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale_x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zl&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zl&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Length of scale_x must be same as number of Cavity objects.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale_x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;zt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">scale_x</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Cavities.set_cavities_field">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.set_cavities_field">[docs]</a>
    <span class="k">def</span> <span class="nf">set_cavities_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets cavities analysis field range.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">set_Eacc</span><span class="p">(</span><span class="n">Eacc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.compare_power">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.compare_power">[docs]</a>
    <span class="k">def</span> <span class="nf">compare_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E_acc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">E_acc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">=</span> <span class="n">E_acc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cavities_field</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_qois</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="c1"># E_acc_Pin(cavity, op_field[i], ls[i], fig, ax, ax_right, ax_right2)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qois</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">cav</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">E_acc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span> <span class="o">=</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.qois_fm">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.qois_fm">[docs]</a>
    <span class="k">def</span> <span class="nf">qois_fm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing fundamental mode quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;kcc [%]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;G [Ohm]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;GR/Q [Ohm^2]&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span>
            <span class="p">})</span>

        <span class="n">results_norm_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results_norm_units</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;$e_\mathrm</span><span class="si">{pk}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$b_\mathrm</span><span class="si">{pk}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$r/q$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$g$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$g\cdot r/q $&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.qois_hom">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.qois_hom">[docs]</a>
    <span class="k">def</span> <span class="nf">qois_hom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the higher-order modes quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing higher-order modes quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cavity</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wakefield_config</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;|k_loss| [V/pC]&quot;</span><span class="p">:</span> <span class="n">cavity</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;|k_kick| [V/pC/m]&quot;</span><span class="p">:</span> <span class="n">cavity</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;P_HOM [kW]&quot;</span><span class="p">:</span> <span class="n">cavity</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.qois_all">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.qois_all">[docs]</a>
    <span class="k">def</span> <span class="nf">qois_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing fundamental mode quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{pk}</span><span class="s2">/E_\mathrm</span><span class="si">{acc}</span><span class="s2"> ~[\cdot]$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$B_\mathrm</span><span class="si">{pk}</span><span class="s2">/E_\mathrm</span><span class="si">{acc}</span><span class="s2"> ~\mathrm{[mT/MV/m]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$R/Q~ \mathrm{[\Omega]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$G ~\mathrm{[\Omega]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~\mathrm{[10^4\Omega^2]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span> <span class="o">*</span> <span class="mf">1e-4</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$|k_\parallel| ~\mathrm{[V/pC]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$|k_\perp| ~\mathrm{[V/pC/m]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">/cav~ \mathrm{[kW]}$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="n">results_norm_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">results_norm_units</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="sa">r</span><span class="s2">&quot;$e_\mathrm</span><span class="si">{pk}</span><span class="s2">/e_\mathrm</span><span class="si">{acc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$b_\mathrm</span><span class="si">{pk}</span><span class="s2">/e_\mathrm</span><span class="si">{acc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$r/q$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;$g$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="c1"># r&quot;$g\cdot r/q $&quot;: cav.GR_Q,</span>
                <span class="c1"># r&quot;$|k_\mathrm{FM}|$&quot;: cav.k_fm,</span>
                <span class="sa">r</span><span class="s2">&quot;$|k_\parallel|$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$k_\perp$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span>
                <span class="sa">r</span><span class="s2">&quot;$p_\mathrm</span><span class="si">{HOM}</span><span class="s2">/cav$&quot;</span><span class="p">:</span> <span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Cavities.plot_uq_geometries">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_uq_geometries">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_uq_geometries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">,</span> <span class="n">axd</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="c1"># plot nominal</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">mid_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">/SimulationData/NGSolveMEVP/</span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_Q&#39;</span>
            <span class="n">uq_geom_folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_folders_with_tag</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

            <span class="c1"># load uq geometries</span>
            <span class="k">for</span> <span class="n">uq_geom_folder</span> <span class="ow">in</span> <span class="n">uq_geom_folders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uq_geom_folder</span><span class="si">}</span><span class="s1">/monopole/geodata.n&#39;</span><span class="p">):</span>
                    <span class="c1"># read geometry</span>
                    <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uq_geom_folder</span><span class="si">}</span><span class="s1">/monopole/geodata.n&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">skipfooter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

                    <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Cavities.find_folders_with_tag">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.find_folders_with_tag">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_folders_with_tag</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="n">matching_folders</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Walk through the directory</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="c1"># Check if the folder name contains the tag</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">):</span>
                    <span class="n">matching_folders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">matching_folders</span></div>


<div class="viewcode-block" id="Cavities.plot_power_comparison">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_power_comparison">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_power_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Can be called using ``cavities.plot_power_comparison()``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fig: matplotlib figure</span>
<span class="sd">        ax_list: list of matplotlib axes object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span>
            <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create figure</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># def E_acc_Pin(self, cavity, E_acc, op_field, ls=&#39;-&#39;, ):</span>

        <span class="c1"># ax_right2._get_lines.prop_cycler = ax._get_lines.prop_cycler</span>
        <span class="c1"># ax_right2.spines[&quot;right&quot;].set_position((&quot;axes&quot;, 1.2))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">pstat</span> <span class="o">/</span> <span class="n">cavity</span><span class="o">.</span><span class="n">n_cav</span><span class="p">,</span>
                     <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{static/cav}$&quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">pdyn</span> <span class="o">/</span> <span class="n">cavity</span><span class="o">.</span><span class="n">n_cav</span><span class="p">,</span>
                     <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{dynamic/cav}$&quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># p1, = ax1.plot(cavity.E_acc * 1e-6, cavity.p_wp/cavity.n_cav,</span>
            <span class="c1">#                ls=self.ls[i], lw=2, c=&#39;k&#39;, label=r&quot;$P_\mathrm{wp/beam}$&quot; + fr&quot;{cavity.name}&quot;)</span>

            <span class="n">p2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">n_cav</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">p3</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">cavity</span><span class="o">.</span><span class="n">p_in</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:purple&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m]&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{stat, dyn}$/cav [W]&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m]&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$N_\mathrm{cav/beam}$&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m]&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm{in/cav}$ [kW]&quot;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-6</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-6</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cavity</span><span class="o">.</span><span class="n">op_field</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-6</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                     <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

            <span class="c1"># ax.axvline(7.13, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax.axvline(10, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax.axvline(15, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax_right2.axhline(500, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax_right2.axhline(1000, ls=&#39;--&#39;, c=&#39;k&#39;)</span>
            <span class="c1"># ax.xaxis.set_major_locator(ticker.MultipleLocator(2))</span>
            <span class="c1"># ax.yaxis.set_major_locator(ticker.MultipleLocator(2))</span>
            <span class="c1"># ax_right.yaxis.set_major_locator(ticker.MultipleLocator(100))</span>
            <span class="c1"># ax_right2.yaxis.set_major_locator(ticker.MultipleLocator(200))</span>

            <span class="c1"># ax.yaxis.label.set_color(p1.get_color())</span>
            <span class="c1"># ax_right.yaxis.label.set_color(p2.get_color())</span>
            <span class="c1"># ax_right2.yaxis.label.set_color(p3.get_color())</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">cavity</span><span class="o">.</span><span class="n">E_acc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="c1"># # ax.set_ylim(0, 50)</span>
            <span class="c1"># ax_right.set_ylim(100, 400)f</span>
            <span class="c1"># ax_right2.set_ylim(0, 700)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

            <span class="c1"># tkw = dict(size=4, width=1.5)</span>
            <span class="c1"># ax.tick_params(axis=&#39;y&#39;, colors=p1.get_color(), **tkw)</span>
            <span class="c1"># ax_right.tick_params(axis=&#39;y&#39;, colors=p2.get_color(), **tkw)</span>
            <span class="c1"># ax_right2.tick_params(axis=&#39;y&#39;, colors=p3.get_color(), **tkw)</span>
            <span class="c1"># ax.tick_params(axis=&#39;x&#39;, **tkw)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
            <span class="c1"># ax.grid(True, which=&#39;both&#39;, axis=&#39;both&#39;)</span>

        <span class="c1"># dummy lines with NO entries, just to create the black style legend</span>
        <span class="n">dummy_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b_idx</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="n">dummy_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">[</span><span class="n">b_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="n">legend1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span>
                             <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">legend2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">dummy_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))],</span>
                             <span class="p">[</span><span class="n">cavity</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                             <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">legend1</span><span class="p">)</span>

        <span class="c1"># ax1.legend(ncol=len(cavities))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\mathbf{Z^*}$&quot;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\mathbf{W^*}$&quot;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_comparison.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots bar chart of power quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># plot barchart</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span><span class="p">])</span>
        <span class="n">data_col_max</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returned_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.15</span>  <span class="c1"># 1 / len(x)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">data_col_max</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">r</span> <span class="o">+</span> <span class="n">width</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))],</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># label = [&quot;C3794_H (2-Cell)&quot;, &quot;C3795_H (5-Cell)&quot;]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_comparison_bar.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.get_power_qois">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.get_power_qois">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power_qois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cav</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cavity: object</span>
<span class="sd">            Cavity object</span>
<span class="sd">        op_field: float</span>
<span class="sd">            Cavity operating field</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary containing quantities of interest (normed optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">uq</span><span class="p">:</span>
            <span class="n">qois</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">get_power_uq</span><span class="p">(</span><span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qois</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">get_power</span><span class="p">(</span><span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qois</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_power_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_power_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_power_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots bar chart of power quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span> <span class="o">=</span> <span class="n">rf_config</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Lengh of Q0 [] must equal number of Cavity objects.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;inv_eta []&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Lengh of inv_eta [] must equal number of Cavity objects.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;length of accelerating field &#39;</span>
                                                                                   <span class="s1">&#39;Eacc [MV/m] must equal number &#39;</span>
                                                                                   <span class="s1">&#39;of Cavity objects in Cavities.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;length of RF Voltage &#39;</span>
                                                                          <span class="s1">&#39;V [GV] must equal number &#39;</span>
                                                                          <span class="s1">&#39;of operating points.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op_points_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">op_points_list</span><span class="p">]</span>

        <span class="c1"># display formula used</span>
        <span class="n">display</span><span class="p">(</span><span class="n">Math</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dims: </span><span class="si">{}</span><span class="s1">x</span><span class="si">{}</span><span class="s1">m </span><span class="se">\\</span><span class="s1"> Area: </span><span class="si">{}</span><span class="s1">m^2 </span><span class="se">\\</span><span class="s1"> Volume: </span><span class="si">{}</span><span class="s1">m^3&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="c1"># set cavity intrinsic quality factor and inv_eta</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">Q0</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">inv_eta</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;inv_eta []&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;Eacc [MV/m]&#39;</span> <span class="ow">in</span> <span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cav</span><span class="o">.</span><span class="n">Eacc_rf_config</span> <span class="o">=</span> <span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># change this later, not effective way</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">power_qois</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power_qois</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_qois_uq</span><span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power_qois</span><span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">rf_config</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_points_list</span><span class="p">:</span>
                <span class="c1"># get nominal qois</span>
                <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># for metric, values in metrics[op_pt][&#39;SR&#39;].items():</span>
                    <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span>

                <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">df_nominal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_nominal</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># get uq opt</span>
                <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_qois_uq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">opt_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span><span class="p">)):</span>
                        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                        <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                    <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                                    <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># plot nominal</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_scatter_</span><span class="si">{</span><span class="n">op_points_list</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_fm_scatter</span><span class="p">(</span><span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_fm_bar</span><span class="p">(</span><span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;scatter&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_hom_scatter</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_compare_hom_bar</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span></div>


    <span class="c1"># def plot_compare_hom_bar_(self, opt, ncols=3, uq=False):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Plot bar chart of higher-order mode&#39;s quantities of interest</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # plt.rcParams[&quot;figure.figsize&quot;] = (15 / 27 * 6 * len(self.cavities_list), 3)</span>
    <span class="c1">#     plt.rcParams[&quot;figure.figsize&quot;] = (12, 4)</span>
    <span class="c1">#</span>
    <span class="c1">#     if not uq:</span>
    <span class="c1">#         # plot barchart</span>
    <span class="c1">#         self.hom_results = self.qois_hom(opt)</span>
    <span class="c1">#         df = pd.DataFrame.from_dict(self.hom_results)</span>
    <span class="c1">#         fig, axd = plt.subplot_mosaic([list(df.columns)], layout=&#39;constrained&#39;)</span>
    <span class="c1">#         # Plot each column in a separate subplot</span>
    <span class="c1">#         labels = [cav.plot_label for cav in self.cavities_list]</span>
    <span class="c1">#         for key, ax in axd.items():</span>
    <span class="c1">#             ax.bar(df.index, df[key], label=labels, color=matplotlib.colormaps[&#39;Set2&#39;].colors[:len(df)],</span>
    <span class="c1">#                    edgecolor=&#39;k&#39;, width=1)</span>
    <span class="c1">#             ax.set_xticklabels([])</span>
    <span class="c1">#             ax.set_ylabel(key)</span>
    <span class="c1">#             h, l = ax.get_legend_handles_labels()</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         # Step 1: Flatten the dictionary into a DataFrame</span>
    <span class="c1">#         rows = []</span>
    <span class="c1">#         for cav, metrics in self.uq_hom_results.items():</span>
    <span class="c1">#             for metric, values in metrics.items():</span>
    <span class="c1">#                 rows.append({</span>
    <span class="c1">#                     &#39;cavity&#39;: cav,</span>
    <span class="c1">#                     &#39;metric&#39;: metric,</span>
    <span class="c1">#                     &#39;mean&#39;: values[&#39;expe&#39;][0],</span>
    <span class="c1">#                     &#39;std&#39;: values[&#39;stdDev&#39;][0]</span>
    <span class="c1">#                 })</span>
    <span class="c1">#</span>
    <span class="c1">#         df = pd.DataFrame(rows)</span>
    <span class="c1">#</span>
    <span class="c1">#         labels = [cav.plot_label for cav in self.cavities_list]</span>
    <span class="c1">#</span>
    <span class="c1">#         # Step 2: Create a Mosaic Plot</span>
    <span class="c1">#         metrics = df[&#39;metric&#39;].unique()</span>
    <span class="c1">#         num_metrics = len(metrics)</span>
    <span class="c1">#</span>
    <span class="c1">#         layout = [[metric for metric in metrics]]</span>
    <span class="c1">#         fig, axd = plt.subplot_mosaic(layout, layout=&#39;constrained&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#         # Plot each metric on a separate subplot</span>
    <span class="c1">#         for metric, ax in axd.items():</span>
    <span class="c1">#             sub_df = df[df[&#39;metric&#39;] == metric]</span>
    <span class="c1">#             ax.bar(sub_df[&#39;cavity&#39;], sub_df[&#39;mean&#39;], yerr=sub_df[&#39;std&#39;], label=labels, capsize=5,</span>
    <span class="c1">#                    color=matplotlib.colormaps[&#39;Set2&#39;].colors[:len(df)], edgecolor=&#39;k&#39;,</span>
    <span class="c1">#                    width=1)</span>
    <span class="c1">#</span>
    <span class="c1">#             ax.set_xticklabels([])</span>
    <span class="c1">#             ax.set_xticks([])</span>
    <span class="c1">#             ax.set_ylabel(metric)</span>
    <span class="c1">#             h, l = ax.get_legend_handles_labels()</span>
    <span class="c1">#</span>
    <span class="c1">#     if not ncols:</span>
    <span class="c1">#         ncols = min(4, len(self.cavities_list))</span>
    <span class="c1">#     fig.legend(h, l, loc=&#39;outside upper center&#39;, borderaxespad=0, ncol=ncols)</span>
    <span class="c1">#</span>
    <span class="c1">#     # fig.set_tight_layout(True)</span>
    <span class="c1">#</span>
    <span class="c1">#     # save plots</span>
    <span class="c1">#     fname = [cav.name for cav in self.cavities_list]</span>
    <span class="c1">#     fname = &#39;_&#39;.join(fname)</span>
    <span class="c1">#</span>
    <span class="c1">#     self.save_all_plots(f&quot;{fname}_hom_bar.png&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     return axd</span>

<div class="viewcode-block" id="Cavities.plot_compare_hom_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_hom_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_hom_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of fundamental mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op_points_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">op_points_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">op_points_list</span><span class="p">:</span>

                <span class="c1"># get nominal qois</span>
                <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ops_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">ops_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">_SR&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                            <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

                <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">df_nominal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_nominal</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># get uq opt</span>
                <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">opt_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span><span class="p">)):</span>
                        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                        <span class="n">bar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                    <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">bar</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># plot nominal</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_hom_scatter_</span><span class="si">{</span><span class="n">op_points_list</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_hom_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_hom_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_hom_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_points_list</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of fundamental mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op_points_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">op_points_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">op_points_list</span><span class="p">:</span>

                <span class="c1"># get nominal qois</span>
                <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ops_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">ops_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">_SR&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                            <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

                <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">df_nominal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_nominal</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># get uq opt</span>
                <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">opt_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op_points_list</span><span class="p">,</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_nominal_list</span><span class="p">)):</span>
                        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                        <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                    <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                                    <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># plot nominal</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">opt_format</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_hom_scatter_</span><span class="si">{</span><span class="n">op_points_list</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_fm_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_fm_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_fm_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot bar chart of fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_fm</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)],</span>
                       <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">num_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># fig.set_tight_layout(True)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_fm_bar.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_fm_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_fm_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_fm_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of higher-order mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_fm</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cav</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                    <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># plot nominal</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                               <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># by_label = dict(zip(l, h))</span>
        <span class="c1"># if &#39;nominal&#39; in by_label.keys():</span>
        <span class="c1">#     nominal_handle = by_label.pop(&#39;nominal&#39;)  # Remove &#39;nominal&#39; entry</span>
        <span class="c1">#     # Reinsert &#39;nominal&#39; as the last entry</span>
        <span class="c1">#     by_label[&#39;nominal&#39;] = nominal_handle</span>

        <span class="c1"># Set legend</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_fm_scatter.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_all_scatter">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_all_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_all_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot scatter chart of fundamental mode quantities of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ncols : int, optional</span>
<span class="sd">            Number of columns for the legend. The default is 3.</span>
<span class="sd">        uq : bool, optional</span>
<span class="sd">            If True, plots with uncertainty quantification. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axd : dict</span>
<span class="sd">            A dictionary of axes from the scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_hom</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hom_results</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>  <span class="c1"># Ensure unique colors</span>

            <span class="c1"># Plot each column in a separate subplot</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get nominal qois</span>
            <span class="n">dd_nominal</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cav</span><span class="p">,</span> <span class="n">ops_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakefield_qois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">ops_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">_SR&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">:</span>
                        <span class="n">dd_nominal</span><span class="p">[</span><span class="n">cav</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

            <span class="n">dict_all_nominal</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_qois</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">dd_nominal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span>
                                <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_config</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">dd_nominal</span><span class="p">)}</span>
            <span class="n">df_nominal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict_all_nominal</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">dict_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span>

            <span class="c1"># Step 1: Flatten the dictionary into a DataFrame</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_fm_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="k">for</span> <span class="n">cavity</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq_hom_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;cavity&#39;</span><span class="p">:</span> <span class="n">cavity</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;expe&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;stdDev&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">})</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="c1"># Step 2: Create a Mosaic Plot</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

            <span class="c1"># Plotting labels and colors</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="c1"># colors = matplotlib.colormaps[&#39;Set2&#39;].colors[:len(labels)]  # Ensure unique colors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>

            <span class="c1"># Step 3: Plot each metric on a separate subplot</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)]</span>
                    <span class="n">scatter_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                                                <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;cavity&#39;</span><span class="p">],</span> <span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sub_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">scatter_points</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># plot nominal</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_nominal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_nominal</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                               <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">LABELS</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

            <span class="c1"># Step 4: Set legend</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># by_label = dict(zip(l, h))</span>
        <span class="c1"># if &#39;nominal&#39; in by_label.keys():</span>
        <span class="c1">#     nominal_handle = by_label.pop(&#39;nominal&#39;)</span>
        <span class="c1">#     # Reinsert &#39;nominal&#39; as the last entry</span>
        <span class="c1">#     by_label[&#39;nominal&#39;] = nominal_handle</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">reorder_legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_all_scatter_</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_compare_all_bar">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_compare_all_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_compare_all_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot bar chart of fundamental mode quantities of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># plot barchart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qois_all</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_results</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">plot_label</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="c1"># Plot each column in a separate subplot</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Set2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)],</span>
                   <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># fig.set_tight_layout(True)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_all_bar_</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axd</span></div>


<div class="viewcode-block" id="Cavities.plot_cavities_contour">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_cavities_contour">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cavities_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot geometric contour of Cavity objects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt: {&quot;mid&quot;, &quot;end&quot;, &quot;all&quot;}</span>
<span class="sd">            Either plot contour for only mid cells or end cells or the entire cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">figsize</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>

            <span class="k">if</span> <span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">/</span> <span class="n">c0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cav</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span>
                                                  <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span>
                                          <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

            <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$z/\lambda$&quot;</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$r/\lambda$&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">min_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">min_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            <span class="n">max_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">max_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># plt.tight_layout()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_contour_</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span></div>


        <span class="c1"># fig.show()</span>

<div class="viewcode-block" id="Cavities.plot_cavities_contour_dimension">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_cavities_contour_dimension">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cavities_contour_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot geometric contour of Cavity objects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt: {&quot;mid&quot;, &quot;end&quot;, &quot;all&quot;}</span>
<span class="sd">            Either plot contour for only mid cells or end cells or the entire cavity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">figsize</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                          <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cav</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">,</span> <span class="n">axs</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mid&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">])</span>
                <span class="n">beampipe</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>

            <span class="k">if</span> <span class="n">cav</span><span class="o">.</span><span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">mid_cell</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_left</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_right</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span>
                                                  <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">dimension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">mid_cell</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_left</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">end_cell_right</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span>
                                          <span class="n">BP</span><span class="o">=</span><span class="n">beampipe</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dimension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

            <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$z$ [mm]&quot;</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$r$ [mm]&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">min_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">min_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            <span class="n">max_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()))</span>
            <span class="n">max_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_dimension.png&quot;</span><span class="p">)</span></div>


        <span class="c1"># fig.show()</span>

<div class="viewcode-block" id="Cavities.plot_axis_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_axis_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_axis_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot axis fields of cavities</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="c1"># normalize fields</span>
            <span class="n">e_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">axis_field</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">])</span>
            <span class="n">e_axis_norm</span> <span class="o">=</span> <span class="n">e_axis</span> <span class="o">/</span> <span class="n">e_axis</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># shift to mid</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">cav</span><span class="o">.</span><span class="n">axis_field</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
            <span class="n">z_shift</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_shift</span><span class="p">,</span> <span class="n">e_axis_norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [mm]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$|E_\mathrm</span><span class="si">{axis}</span><span class="s1">|/|E_\mathrm</span><span class="si">{axis}</span><span class="s1">|_\mathrm</span><span class="si">{max}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_axis_fields.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_surface_fields">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_surface_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_surface_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot surface fields of cavities</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="c1"># normalize fields</span>
            <span class="n">e_surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">surface_field</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">])</span>
            <span class="n">e_surf_norm</span> <span class="o">=</span> <span class="n">e_surf</span> <span class="o">/</span> <span class="n">e_surf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e_surf_norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$L_\mathrm</span><span class="si">{surf}</span><span class="s1">$ [mm]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$|E_\mathrm</span><span class="si">{surf}</span><span class="s1">|/|E_\mathrm</span><span class="si">{surf}</span><span class="s1">|_\mathrm</span><span class="si">{max}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_surface_fields.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_multipac_triplot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_multipac_triplot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_multipac_triplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;triplot&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Multipac triplot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folders: list, array like</span>
<span class="sd">            List of folder to read multipacting results from</span>
<span class="sd">        kind</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This will be changed later so that the multipac results will be in the same location as the SLANS and ABCI</span>
<span class="sd">        results</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
            <span class="c1"># create figure</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

        <span class="n">Eacc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">op_field</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">Epk_Eacc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">Eacc</span><span class="p">,</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Eacc_list</span><span class="p">,</span> <span class="n">Epk_Eacc_list</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="c1"># load_output_data</span>
            <span class="c1"># files</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Ccounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;Acounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;Atcounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;Efcounter.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;geodata.n&quot;</span><span class="p">,</span> <span class="s2">&quot;secy1&quot;</span><span class="p">,</span> <span class="s2">&quot;counter_flevels.mat&quot;</span><span class="p">,</span> <span class="s2">&quot;counter_initials.mat&quot;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># files_folder = &quot;D:\Dropbox\multipacting\MPGUI21&quot;</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;.mat&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">spio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">A</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Acounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
            <span class="n">At</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Atcounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;At&quot;</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ccounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
            <span class="n">Ef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Efcounter.mat&quot;</span><span class="p">][</span><span class="s2">&quot;Ef&quot;</span><span class="p">]</span>
            <span class="n">flevel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;counter_flevels.mat&quot;</span><span class="p">][</span><span class="s2">&quot;flevel&quot;</span><span class="p">]</span>
            <span class="n">initials</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;counter_initials.mat&quot;</span><span class="p">][</span><span class="s2">&quot;initials&quot;</span><span class="p">]</span>
            <span class="n">secy1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;secy1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">Pow</span> <span class="o">=</span> <span class="n">flevel</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initials</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># number of initials in the bright set</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># number of impacts</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">flevel</span>
            <span class="n">Efl</span> <span class="o">=</span> <span class="n">flevel</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mf">1.6021773e-19</span>
            <span class="n">Efq</span> <span class="o">=</span> <span class="n">Ef</span> <span class="o">/</span> <span class="n">q</span>

            <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># lower threshold</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># upper threshold</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">e3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">secy1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># maximum secondary yield</span>

            <span class="n">cl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ok</span><span class="p">,</span> <span class="n">ok1</span><span class="p">,</span> <span class="n">ok2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ok</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to plot the counters. No initial points.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">ok1</span> <span class="o">*</span> <span class="n">ok2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cl</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Counter functions or impact energy missing.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if ss &gt; 0:</span>
                    <span class="c1">#     cl = error(np.array([&#39;Plotting the triplot (counter, enhanced &#39;, &#39;counter and impact energy).&#39;]))</span>

                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;counter function&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
                        <span class="c1"># fig, axs = plt.subplots(3)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Efl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">C</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$c_&quot;</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}/ c_0 $&quot;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\mathrm</span><span class="si">{pk}</span><span class="s1">$ [MV/m]&#39;</span><span class="p">)</span>
                        <span class="c1"># axs[0].set_title(r&#39;$\mathbf{MultiPac 2.1~~~~~Counter function~~~~}$&#39;)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]]))</span>

                        <span class="c1"># plot peak operating field</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Epk_Eacc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                    <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;final impact energy&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;final impact energy&#39;</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">Efl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">Efq</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

                        <span class="c1"># axs[1-s].plot([np.min(Efl) / 1e6, np.max(Efl) / 1e6], [secy1[e1, 0], secy1[e1, 0]], &#39;-r&#39;)</span>
                        <span class="n">e0</span> <span class="o">=</span> <span class="n">sci</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">secy1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">e1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">secy1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">e1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="n">e0</span><span class="p">,</span> <span class="n">e0</span><span class="p">],</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="n">secy1</span><span class="p">[</span><span class="n">e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">secy1</span><span class="p">[</span><span class="n">e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="n">secy1</span><span class="p">[</span><span class="n">e3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">secy1</span><span class="p">[</span><span class="n">e3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;--r&#39;</span><span class="p">)</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$Ef_&quot;</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}$&quot;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\mathrm</span><span class="si">{pk}</span><span class="s1">$ [MV/m]&#39;</span><span class="p">)</span>
                        <span class="c1"># axs[1-s].set_title(&#39;$\mathbf{Final~Impact~Energy~in~eV}$&#39;)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Epk_Eacc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                                        <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;enhanced counter function&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;triplot&#39;</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;enhanced counter function&#39;</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">Efl</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$V$ [MV]&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Efl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">A</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">),</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$e_&quot;</span> <span class="o">+</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="s2">&quot;/ c_0$&quot;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\mathrm</span><span class="si">{pk}</span><span class="s1">$ [MV/m]&#39;</span><span class="p">)</span>
                        <span class="c1"># axs[2-s].set_title(&#39;$\mathbf{Enhanced~counter~function}$&#39;)</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="n">Epk_Eacc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Eacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Epk_Eacc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> MV/m&quot;</span><span class="p">,</span>
                                        <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.plot_dispersion">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_dispersion">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot dispersion curve for the cavities</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cav</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cav</span><span class="o">.</span><span class="n">d_slans_all_results</span><span class="p">[</span><span class="s1">&#39;FREQUENCY&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">cav</span><span class="o">.</span><span class="n">n_cells</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (kcc=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1"> %)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Mode Number&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [MHz]&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># save plots</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_all_plots</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_dispersion.png&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="c1"># def ql_pin(self, labels, geometry, RF, QOI, Machine, p_data=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Calculate the value of input power as a function of loaded quality factor</span>
    <span class="c1">#</span>
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     labels: list, array like</span>
    <span class="c1">#         Descriptive labels on matplotlib plot</span>
    <span class="c1">#     geometry: list, array like</span>
    <span class="c1">#         List of grouped geometric input parameters</span>
    <span class="c1">#     RF: list, array like</span>
    <span class="c1">#         List of grouped radio-frequency (RF) properties</span>
    <span class="c1">#     QOI:</span>
    <span class="c1">#         List of quantities of interest for cavities</span>
    <span class="c1">#     Machine:</span>
    <span class="c1">#         List of grouped machine related materials</span>
    <span class="c1">#     p_data:</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # check if entries are of same length</span>
    <span class="c1">#</span>
    <span class="c1">#     it = iter(geometry)</span>
    <span class="c1">#     the_len = len(next(it))</span>
    <span class="c1">#     if not all(len(l) == the_len for l in it):</span>
    <span class="c1">#         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     it = iter(RF)</span>
    <span class="c1">#     the_len = len(next(it))</span>
    <span class="c1">#     if not all(len(l) == the_len for l in it):</span>
    <span class="c1">#         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     it = iter(QOI)</span>
    <span class="c1">#     the_len = len(next(it))</span>
    <span class="c1">#     if not all(len(l) == the_len for l in it):</span>
    <span class="c1">#         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     it = iter(Machine)</span>
    <span class="c1">#     the_len = len(next(it))</span>
    <span class="c1">#     if not all(len(l) == the_len for l in it):</span>
    <span class="c1">#         raise ValueError(&#39;not all lists have same length!&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     n_cells, l_cells, G, b = [np.array(x) for x in geometry]</span>
    <span class="c1">#     E_acc, Vrf = [np.array(x) for x in RF]</span>
    <span class="c1">#</span>
    <span class="c1">#     fig, ax = plt.subplots()</span>
    <span class="c1">#     ax.margins(x=0)</span>
    <span class="c1">#</span>
    <span class="c1">#     # QOI</span>
    <span class="c1">#     f0, R_Q = [np.array(x) for x in QOI]</span>
    <span class="c1">#</span>
    <span class="c1">#     # Machine</span>
    <span class="c1">#     I0, rho, E0 = [np.array(x) for x in Machine]</span>
    <span class="c1">#</span>
    <span class="c1">#     l_active = 2 * n_cells * l_cells</span>
    <span class="c1">#     l_cavity = l_active + 8 * l_cells</span>
    <span class="c1">#</span>
    <span class="c1">#     # CALCULATED</span>
    <span class="c1">#     v_cav = E_acc * l_active</span>
    <span class="c1">#</span>
    <span class="c1">#     U_loss = 88.46 * E0 ** 4 / rho * 1e-6  # GeV # energy lost per turn per beam</span>
    <span class="c1">#     v_loss = U_loss * 1e9  # V # v loss per beam</span>
    <span class="c1">#</span>
    <span class="c1">#     phi = np.arccos(v_loss / Vrf)</span>
    <span class="c1">#     delta_f = -R_Q * f0 * I0 * np.sin(phi) / (2 * v_cav)  # optimal df</span>
    <span class="c1">#     QL_0_x = v_cav / (R_Q * I0 * np.cos(phi))  # optimal Q loaded</span>
    <span class="c1">#</span>
    <span class="c1">#     QL_0 = np.linspace(1e4, 1e9, 1000000)</span>
    <span class="c1">#</span>
    <span class="c1">#     xy_list = [(0.15, 0.13), (0.1, 0.16), (0.1, 0.19), (0.1, 0.21)]</span>
    <span class="c1">#     for i in range(len(E_acc)):</span>
    <span class="c1">#         f1_2 = f0[i] / (2 * QL_0)  # 380.6</span>

    <span class="c1">#         pin = v_cav[i] ** 2 / (4 * R_Q[i] * QL_0) * \</span>
    <span class="c1">#               ((1 + ((R_Q[i] * QL_0 * I0[i]) / v_cav[i]) * np.cos(phi[i])) ** 2 +</span>
    <span class="c1">#                ((delta_f[i] / f1_2) + ((R_Q[i] * QL_0 * I0[i]) / v_cav[i]) * np.sin(phi[i])) ** 2)</span>
    <span class="c1">#</span>
    <span class="c1">#         # material/ wall power</span>
    <span class="c1">#         e_acc = np.linspace(0.5, 25, 1000) * 1e6  # MV/m</span>
    <span class="c1">#</span>
    <span class="c1">#         txt = labels[i]</span>
    <span class="c1">#</span>
    <span class="c1">#         if &quot;*&quot; in labels[i]:</span>
    <span class="c1">#             l = ax.plot(QL_0, pin * 1e-3, label=txt, lw=4,</span>
    <span class="c1">#                         ls=&#39;--&#39;)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             l = ax.plot(QL_0, pin * 1e-3, label=txt, lw=4)</span>
    <span class="c1">#</span>
    <span class="c1">#         # add annotations</span>
    <span class="c1">#</span>
    <span class="c1">#         # annotext = ax.annotate(txt, xy=xy_list[i], xycoords=&#39;figure fraction&#39;, size=8, rotation=0,</span>
    <span class="c1">#         #                        c=l[0].get_color())</span>
    <span class="c1">#</span>
    <span class="c1">#     if p_data:</span>
    <span class="c1">#         # plot QL with penetration</span>
    <span class="c1">#         ax_2 = ax.twinx()</span>
    <span class="c1">#         data = fr.excel_reader(p_data)</span>
    <span class="c1">#         data_ = data[list(data.keys())[0]]</span>
    <span class="c1">#         ax_2.plot(data_[&quot;QL&quot;], data_[&quot;penetration&quot;], lw=4)</span>
    <span class="c1">#</span>
    <span class="c1">#     # plot decorations</span>
    <span class="c1">#     ax.set_xlabel(r&quot;$Q_{L,0}$&quot;)</span>
    <span class="c1">#     ax.set_ylabel(r&quot;$P_\mathrm{in} ~[\mathrm{kW}]$&quot;)</span>
    <span class="c1">#     ax.set_xscale(&#39;log&#39;)</span>
    <span class="c1">#     ax.set_xlim(5e3, 1e9)</span>
    <span class="c1">#     ax.set_ylim(0, 3000)</span>
    <span class="c1">#     ax.legend(loc=&#39;upper left&#39;)  #</span>
    <span class="c1">#     ax.minorticks_on()</span>
    <span class="c1">#     # ax.grid(which=&#39;both&#39;)</span>
    <span class="c1">#     fig.show()</span>

<div class="viewcode-block" id="Cavities.run_abci">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_abci">[docs]</a>
    <span class="k">def</span> <span class="nf">run_abci</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">run_abci</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.run_multipacting">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_multipacting">[docs]</a>
    <span class="k">def</span> <span class="nf">run_multipacting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">:</span>
            <span class="n">cav</span><span class="o">.</span><span class="n">run_multipacting</span><span class="p">()</span></div>


<div class="viewcode-block" id="Cavities.define_operating_points">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.define_operating_points">[docs]</a>
    <span class="k">def</span> <span class="nf">define_operating_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="o">=</span> <span class="n">ops</span></div>


<div class="viewcode-block" id="Cavities.linspace">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.linspace">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like np.linspace but uses step instead of num</span>
<span class="sd">        This is inclusive to stop, so if start=1, stop=3, step=0.5</span>
<span class="sd">        Output is: array([1., 1.5, 2., 2.5, 3.])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ll</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">start</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ll</span></div>


<div class="viewcode-block" id="Cavities.lineTo">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.lineTo">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">lineTo</span><span class="p">(</span><span class="n">prevPt</span><span class="p">,</span> <span class="n">nextPt</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># vertical line</span>
            <span class="c1"># chwxk id nextPt is greater</span>
            <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">py</span><span class="p">))</span> <span class="o">*</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># horizontal line</span>
            <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>

            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">px</span><span class="p">))</span> <span class="o">*</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate angle to get appropriate step size for x and y</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">px</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">px</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prevPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


        <span class="c1"># plt.plot(px, py)</span>

<div class="viewcode-block" id="Cavities.arcTo2">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.arcTo2">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">arcTo2</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start_angle</span><span class="p">,</span> <span class="n">end_angle</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">x_center</span>  <span class="c1"># x-position of the center</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">y_center</span>  <span class="c1"># y-position of the center</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># radius on the x-axis</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>  <span class="c1"># radius on the y-axis</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_angle</span> <span class="o">/</span> <span class="mi">360</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># convert angle to radians</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_angle</span> <span class="o">/</span> <span class="mi">360</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># convert angle to radians</span>

        <span class="k">if</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="n">sa</span><span class="p">:</span>
            <span class="c1"># end point of curve</span>
            <span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sa</span><span class="p">),</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># t = np.linspace(ea, sa, 100)</span>
            <span class="c1"># check if end angle is included, include if not</span>
            <span class="k">if</span> <span class="n">sa</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sa</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># end point of curve</span>
            <span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># t = np.linspace(ea, sa, 100)</span>
            <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ea</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span><span class="p">]</span></div>


<div class="viewcode-block" id="Cavities.arcTo">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.arcTo">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">arcTo</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">x_center</span>  <span class="c1"># x-position of the center</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">y_center</span>  <span class="c1"># y-position of the center</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># radius on the x-axis</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>  <span class="c1"># radius on the y-axis</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="n">inidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pts</span><span class="p">,</span> <span class="n">pts</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">inidx</span><span class="p">]</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">inbox</span><span class="p">[</span><span class="n">inbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

        <span class="c1"># plt.plot(inbox[:, 0], inbox[:, 1])</span>

        <span class="k">return</span> <span class="n">inbox</span></div>


<div class="viewcode-block" id="Cavities.make_latex_summary_tables">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.make_latex_summary_tables">[docs]</a>
    <span class="k">def</span> <span class="nf">make_latex_summary_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">op_pts_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="c1"># create new sub directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Geometric parameters of &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity gemetries.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>
                <span class="n">A</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$A$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">B</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">a</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$a$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">b</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$b$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{i}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">L</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$L$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Req</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{eq}</span><span class="s2">$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ \alpha [^\circ]$&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> geometric properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_geom_latex.tex&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;fm&#39;</span><span class="p">:</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{FM QoIs of &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity gemetries.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. [MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">R_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~[\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">G</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G$ ~[$\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">GR_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~[10^4\Omega^2]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">kcc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">~[\%]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">epk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">}$ []&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">bpk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">} ~\left[\mathrm{\frac</span><span class="si">{mT}</span><span class="s2">{MV/m}}\right]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> fm properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">rf_freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">GR_Q</span><span class="p">,</span> <span class="n">kcc</span><span class="p">,</span> <span class="n">epk</span><span class="p">,</span> <span class="n">bpk</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>
                <span class="c1"># save plots</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_fm_latex.tex&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;hom&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_pts_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op_pts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{HOM QoIs of &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity geometries for the &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">op_pt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">op_pts_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; operating points.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}{c|}{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">kfm</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm</span><span class="si">{FM}</span><span class="s2">|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_fm</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_fm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_fm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kloss</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_loss</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_loss</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kkick</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_kick</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_kick</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> hom properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">kfm</span><span class="p">,</span> <span class="n">kloss</span><span class="p">,</span> <span class="n">kkick</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_hom_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;qois&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_pts_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op_pts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Geometric parameters and QoIs of cavities.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}</span><span class="si">{c}</span><span class="s1">{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. ~[MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">R_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~\mathrm{[\Omega$]} &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">G</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G$ ~[$\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">GR_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~[10^4\Omega^2]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">kcc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm</span><span class="si">{cc}</span><span class="s2">~[\%]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">epk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">}$ []&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">bpk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">} ~\left[\mathrm{\frac</span><span class="si">{mT}</span><span class="s2">{MV/m}}\right]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kfm</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_fm</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_fm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_fm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kloss</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_loss</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_loss</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kkick</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_kick</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_kick</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Ncav</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Q0</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Q_\mathrm</span><span class="si">{0}</span><span class="s2">~[]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Pin</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">\mathrm{/cav} [\mathrm</span><span class="si">{kW}</span><span class="s2">]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pin/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pstat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pstat/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pdyn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pdyn/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pwp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pwp/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">PHOM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$ ~[kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: selected shape}&quot;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">rf_freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">GR_Q</span><span class="p">,</span> <span class="n">kcc</span><span class="p">,</span> <span class="n">epk</span><span class="p">,</span> <span class="n">bpk</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">kfm</span><span class="p">,</span> <span class="n">kloss</span><span class="p">,</span> <span class="n">kkick</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span> <span class="n">Ncav</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Pstat</span><span class="p">,</span> <span class="n">Pdyn</span><span class="p">,</span> <span class="n">Pwp</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span> <span class="n">PHOM</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_qois_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_pts_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op_pts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Static, dynamic and HOM power loss and input power per cavity for &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; cavity geometries for the &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">op_pt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">op_pts_list</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; operating points.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}{c|}{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>

                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. [MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="k">if</span> <span class="s1">&#39;V [GV]&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">Vrf</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{RF}</span><span class="s2">$ [GV] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_config</span><span class="p">[</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Vrf</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{RF}</span><span class="s2">$ [GV] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Eacc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">Eacc_rf_config</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Ncav</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Q0</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Q_\mathrm</span><span class="si">{0}</span><span class="s2">$~[]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Pin</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">\mathrm{/cav} ~[\mathrm</span><span class="si">{kW}</span><span class="s2">]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pin/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pstat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pstat/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pdyn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pdyn/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pwp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pwp/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">PHOM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$ [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: &quot;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> power properties&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span> <span class="n">rf_freq</span><span class="p">,</span> <span class="n">Vrf</span><span class="p">,</span> <span class="n">Eacc</span><span class="p">,</span> <span class="n">Ncav</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Pstat</span><span class="p">,</span> <span class="n">Pdyn</span><span class="p">,</span> <span class="n">Pwp</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="c1"># PHOM,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_power_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{table}</span><span class="s2">[htb!]&quot;</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\centering&quot;</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\caption{Geometric parameters and QoIs of cavities.}&quot;</span>
                <span class="n">l4</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\resizebox{\ifdim\width&gt;\columnwidth \columnwidth \else \width \fi}{!}{\begin</span><span class="si">{tabular}</span><span class="s2">{|l|&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op_pts_list</span><span class="p">))])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;|}&quot;</span>
                <span class="n">toprule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\toprule&quot;</span>
                <span class="n">header1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;\multicolumn{&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; &amp;\multicolumn{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}</span><span class="si">{c}</span><span class="s1">{&#39;</span> <span class="o">+</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LABELS</span><span class="p">[</span><span class="n">op_pt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span>
                     <span class="n">op_pts_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">header2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline&quot;</span>
                <span class="n">hhline</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\hline \hline&quot;</span>
                <span class="n">A</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$A$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">B</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">a</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$a$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">b</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$b$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{i}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">L</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$L$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Req</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_\mathrm</span><span class="si">{eq}</span><span class="s2">$ [mm] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ \alpha [^\circ]$&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">rf_freq</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;RF Freq. ~[MHz] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Vrf</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$V_\mathrm</span><span class="si">{RF}</span><span class="s2">$ ~[GV] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;V [GV]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Eacc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{acc}</span><span class="s2">$ [MV/m] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;Eacc [MV/m]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">R_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R/Q ~[\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">G</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G$ [$\Omega$] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">GR_Q</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$G\cdot R/Q ~[10^4\Omega^2]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">epk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">}$ [] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">bpk</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$B_{\mathrm</span><span class="si">{pk}</span><span class="s2">}/E_{\mathrm</span><span class="si">{acc}</span><span class="s2">} \left[\mathrm{\frac</span><span class="si">{mT}</span><span class="s2">{MV/m}}\right]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kfm</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_fm</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_fm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_fm</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kloss</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_loss</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_loss</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">kkick</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k_kick</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k_kick</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="c1"># kloss = r&quot;$|k_\mathrm{\parallel}|$ [V/pC]&quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(k_loss, 4)) for k_loss in cav.k_loss])} &quot; for cav in</span>
                <span class="c1">#      self.cavities_list]) + r&quot; \\&quot;</span>
                <span class="c1">#</span>
                <span class="c1"># kkick = r&quot;$k_\mathrm{\perp}$ [V/pC/m]&quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(k_kick, 4)) for k_kick in cav.k_kick])} &quot; for cav in</span>
                <span class="c1">#      self.cavities_list]) + r&quot; \\&quot;</span>

                <span class="n">Ncav</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$N_\mathrm</span><span class="si">{cav}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Q0</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Q_\mathrm</span><span class="si">{0}</span><span class="s2">$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Q0 []&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">Pin</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{in}</span><span class="s2">\mathrm{/cav} [\mathrm</span><span class="si">{kW}</span><span class="s2">]$ &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pin/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pstat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{stat}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pstat/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pdyn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{dyn}</span><span class="s2">$/cav [W] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pdyn/cav [W]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Pwp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{wp}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Pwp/cav [kW]&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span>
                     <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="n">Phom</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$/cav [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="c1"># Phom = r&quot;$P_\mathrm{HOM}$/cav [kW] &quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(phom, 4)) for phom in cav.phom])} &quot; for cav in self.cavities_list]) + r&quot; \\&quot;</span>

                <span class="n">phom_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">phom</span> <span class="k">for</span> <span class="n">phom</span> <span class="ow">in</span> <span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="p">]</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span>

                <span class="c1"># if len(phom_values) % 2 == 0:</span>
                <span class="c1">#     result_array = phom_values[1::2] - phom_values[::2]</span>
                <span class="c1">#</span>
                <span class="c1">#     Phom_diff = r&quot;$\Delta P_\mathrm{HOM}$/cav [W] &amp; \multicolumn{2}{c|}{&quot; + &quot; &amp; \multicolumn{2}{c|}{&quot;.join(</span>
                <span class="c1">#         [fr&quot;{&#39;/&#39;.join([str(round(val * 1e3, 2)) for val in arr])} &quot; + &#39;}&#39; for arr in result_array]) + r&quot; \\&quot;</span>

                <span class="n">PHOM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$P_\mathrm</span><span class="si">{HOM}</span><span class="s2">$ [kW] &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">fr</span><span class="s2">&quot;&amp; </span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phom</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">rf_performance_qois</span><span class="p">[</span><span class="n">op_pt</span><span class="p">][</span><span class="s1">&#39;SR&#39;</span><span class="p">][</span><span class="s1">&#39;Ncav&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">phom</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">vv</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">op_pt</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">kk</span><span class="p">]])</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">for</span> <span class="n">op_pt</span> <span class="ow">in</span> <span class="n">op_pts_list</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>

                <span class="c1"># PHOM = r&quot;$P_\mathrm{HOM}$ [kW] &quot; + &quot;&quot;.join(</span>
                <span class="c1">#     [fr&quot;&amp; {&#39;/&#39;.join([str(round(phom * cav.n_cav_op_field, 2)) for phom in cav.phom])} &quot; for cav in</span>
                <span class="c1">#      self.cavities_list]) + r&quot; \\&quot;</span>

                <span class="n">bottomrule</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\bottomrule&quot;</span>
                <span class="n">l34</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{tabular}</span><span class="s2">}&quot;</span>
                <span class="n">l35</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\label{tab: selected shape}&quot;</span>
                <span class="n">l36</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{table}</span><span class="s2">&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">l4</span><span class="p">,</span>
                                     <span class="n">toprule</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">header1</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">header2</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">rf_freq</span><span class="p">,</span> <span class="n">Vrf</span><span class="p">,</span> <span class="n">Eacc</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">GR_Q</span><span class="p">,</span> <span class="n">epk</span><span class="p">,</span> <span class="n">bpk</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span>
                                     <span class="n">kfm</span><span class="p">,</span> <span class="n">kloss</span><span class="p">,</span> <span class="n">kkick</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span>
                                     <span class="n">hhline</span><span class="p">,</span> <span class="n">Ncav</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">Pstat</span><span class="p">,</span> <span class="n">Pdyn</span><span class="p">,</span> <span class="n">Pwp</span><span class="p">,</span> <span class="n">Phom</span><span class="p">,</span> <span class="n">PHOM</span><span class="p">,</span>
                                     <span class="n">hline</span><span class="p">,</span>
                                     <span class="n">bottomrule</span><span class="p">,</span>
                                     <span class="n">l34</span><span class="p">,</span> <span class="n">l35</span><span class="p">,</span> <span class="n">l36</span><span class="p">)</span>

                <span class="c1"># save plots</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Data\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_all_</span><span class="si">{</span><span class="n">op_pts_list</span><span class="si">}</span><span class="s2">_latex.tex&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either NGSolve or ABCI results not available. Please use &#39;&lt;cav&gt;.set_eigenmode_qois(&lt;folder&gt;)&#39; &quot;</span>
                  <span class="s2">&quot;or &#39;&lt;cav&gt;.set_wakefield_qois(&lt;folder&gt;)&#39; to fix this. Error: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.make_excel_summary">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.make_excel_summary">[docs]</a>
    <span class="k">def</span> <span class="nf">make_excel_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">project</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;CW/Pulsed&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">cw_pulsed</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Material&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">material</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;N_cells&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">n_cells</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Freq [MHz]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">op_freq</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Beta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">beta</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;T_oper [K]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">op_temp</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;I0 [mA]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">I0</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;sigma [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">sigma</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;A_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;B_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;a_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;b_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_i [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Req [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;alpha_i [deg]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;A_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;B_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;a_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;b_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_el [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="c1"># &#39;Req [mm]&#39;: [round(cav.shape_space[&#39;OC&#39;][6], 2) for cav in self.cavities_list],</span>
                    <span class="s1">&#39;alpha__el [deg]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;A_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;B_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;a_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;b_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_er [mm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="c1"># &#39;Req [mm]&#39;: [round(cav.shape_space[&#39;OC&#39;][6], 2) for cav in self.cavities_list],</span>
                    <span class="s1">&#39;alpha_er [deg]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">cav</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R_shunt [Ohm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">R_Q</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;k_cc [%]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">k_cc</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;field flatness [%]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">ff</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;L_active [m]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">l_active</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Epk/Eacc []&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">e</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Bpk/Eacc [mT/MV/m]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">b</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;G [Ohm]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">G</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;R/Q.G [Ohm^2]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">GR_Q</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">k_loss</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">k_kick</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;P_HOM/cav [kW]&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">phom</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">],</span>
                    <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">reference</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
                    <span class="p">}</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
                <span class="sa">fr</span><span class="s2">&quot;D:\Dropbox\CavityDesignHub\MuCol_Study\SimulationData\Summaries\</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">_excel_summary.xlsx&quot;</span><span class="p">,</span>
                <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Cavities&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either SLANS or ABCI results not available. Please use &#39;&lt;cav&gt;.set_slans_qois(&lt;folder&gt;)&#39; &quot;</span>
                  <span class="s2">&quot;or &#39;&lt;cav&gt;.set_wakefield_qois(&lt;folder&gt;)&#39; to fix this.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.remove_cavity">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.remove_cavity">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_cavity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cav</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes cavity from cavity list</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cav: object</span>
<span class="sd">            Cavity object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cav</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.save_all_plots">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.save_all_plots">[docs]</a>
    <span class="k">def</span> <span class="nf">save_all_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save all plots</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_name: str</span>
<span class="sd">            Name of saved plot</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">cav</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cav</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># check if folder exists</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots&quot;</span><span class="p">):</span>
                <span class="c1"># create new subdirectory</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">save_folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostprocessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">save_folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">\PostProcessingData\Plots\</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.calc_limits">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.calc_limits">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">selection</span>
            <span class="n">E0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;E [GeV]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">nu_s</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;nu_s []&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">I0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;I0 [mA]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">alpha_c</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">tau_z</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">tau_xy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">f_rev</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">beta_xy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">n_cav</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">operating_points</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s2">&quot;N_c []&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>

            <span class="n">unit</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MHz&#39;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>
                    <span class="s1">&#39;GHz&#39;</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">}</span>

            <span class="n">Z_list</span><span class="p">,</span> <span class="n">ZT_le</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;longitudinal&#39;</span><span class="p">:</span>
                <span class="n">f_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="n">Z_le</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_cav</span><span class="p">):</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">E0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">*</span> <span class="n">nu_s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                             <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">I0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">alpha_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">tau_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span>
                             <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">1e-8</span> <span class="k">else</span> <span class="mf">1e5</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">]</span>

                        <span class="n">Z_le</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">E0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">*</span> <span class="n">nu_s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">I0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">alpha_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-5</span>
                                             <span class="o">*</span> <span class="n">tau_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

                        <span class="n">Z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># convert to kOhm</span>

                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;ZeroDivisionError, check input&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">f_list</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">cols</span>

            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;transversal&#39;</span><span class="p">:</span>

                <span class="n">f_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_cav</span><span class="p">):</span>
                        <span class="n">ZT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">E0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="p">(</span>
                                <span class="n">n</span> <span class="o">*</span> <span class="n">I0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">beta_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">tau_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">f_rev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span>
                        <span class="n">ZT_le</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ZT</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

                        <span class="n">Z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZT</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># convert to kOhm/m</span>

                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;ZeroDivisionError, check input&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">f_list</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">cols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Please load a valid operating point(s) file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.plot_thresholds">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_thresholds">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncav_mod</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">labels_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">update_text_positions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Callback function to update the text positions based on current limits.&quot;&quot;&quot;</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">labels_info</span><span class="p">:</span>
                <span class="c1"># Check if the label is out of bounds</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># Reposition the label to the center of the current view</span>
                    <span class="n">axes_coord</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="c1"># Transform axes coordinate to display coordinate</span>
                    <span class="n">display_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">axes_coord</span><span class="p">)</span>
                    <span class="c1"># Transform display coordinate to data coordinate</span>
                    <span class="n">data_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">display_coord</span><span class="p">)</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">data_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span> <span class="o">-</span> <span class="n">new_x</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                    <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;text_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_texts_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s1">&#39;longitudinal&#39;</span><span class="p">:</span>
            <span class="c1"># calculate limits</span>
            <span class="n">f_list</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_limits</span><span class="p">(</span><span class="s1">&#39;longitudinal&#39;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

            <span class="c1"># plot baselines</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">aa</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f_list</span><span class="p">,</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">labels_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">aa</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">axis_data_coord6s_sys_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_list</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="c1"># x, y = axis_data_coords_sys_transform(ax, f_list[indx], z[indx], True)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">LABELS</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span>

                <span class="n">ab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">txt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">))</span>
                <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span>
                                                   <span class="s1">&#39;text_obj&#39;</span><span class="p">:</span> <span class="n">ab</span><span class="p">}</span>
                <span class="c1"># ab = add_text(ax, txt, box=&quot;Square&quot;, xy=(x, y), xycoords=&#39;axes fraction&#39;, size=12)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold_texts_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate limits</span>
            <span class="n">f_list</span><span class="p">,</span> <span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_limits</span><span class="p">(</span><span class="s1">&#39;transversal&#39;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

            <span class="c1"># plot baselines</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">labels_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">aa</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Z_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">axis_data_coords_sys_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_list</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="c1"># x, y = axis_data_coords_sys_transform(ax, f_list[indx], z, True)</span>

                <span class="n">txt</span> <span class="o">=</span> <span class="n">LABELS</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span>

                <span class="n">ab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">))</span>
                <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">f_list</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">ncav_mod</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s1">&#39;text_obj&#39;</span><span class="p">:</span> <span class="n">ab</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold_texts_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

        <span class="c1"># Attach the callback to limit changes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;xlim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;ylim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_adjust_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">separation</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">renderer</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_text_bbox</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">)</span>
            <span class="n">bbox_axes_coords</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">bbox_axes_coords</span>

        <span class="k">def</span> <span class="nf">calculate_adjustment</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">):</span>
            <span class="n">center1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bbox1</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">center2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bbox2</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">pos1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">text1</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>
            <span class="n">pos2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">text2</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">bbox2</span><span class="p">):</span>
                <span class="n">overlap_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
                <span class="n">overlap_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">y0</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">overlap_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">midpoint_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">center1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">center2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">x1</span><span class="p">:</span>
                        <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">+</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">separation</span>
                        <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">-</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">separation</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">-</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">separation</span>
                        <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_x</span> <span class="o">+</span> <span class="n">bbox2</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">separation</span>

                <span class="c1"># if overlap_y &gt; 0:</span>
                <span class="c1">#     midpoint_y = (center1[1] + center2[1]) / 2</span>
                <span class="c1">#     if bbox1.y1 &gt; bbox2.y1:</span>
                <span class="c1">#         pos1[1] = midpoint_y + bbox1.height / 2 + separation</span>
                <span class="c1">#         pos2[1] = midpoint_y - bbox2.height / 2 - separation</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         pos1[1] = midpoint_y - bbox1.height / 2 - separation</span>
                <span class="c1">#         pos2[1] = midpoint_y + bbox2.height / 2 + separation</span>

            <span class="k">return</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span>

        <span class="c1"># Run the adjustment algorithm</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
                <span class="n">bbox1</span> <span class="o">=</span> <span class="n">get_text_bbox</span><span class="p">(</span><span class="n">text1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">text2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">bbox2</span> <span class="o">=</span> <span class="n">get_text_bbox</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">bbox1</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">bbox2</span><span class="p">):</span>
                        <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span> <span class="o">=</span> <span class="n">calculate_adjustment</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">)</span>
                        <span class="n">text1</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">text2</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Ensure the texts are within the plot limits</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">text</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<div class="viewcode-block" id="Cavities.plot_cutoff">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.plot_cutoff">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ri_list</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">labels_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">update_text_positions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Callback function to update the text positions based on current limits.&quot;&quot;&quot;</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">labels_info</span><span class="p">:</span>
                <span class="c1"># Check if the label is out of bounds</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># Reposition the label to the center of the current view</span>
                    <span class="n">axes_coord</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
                    <span class="c1"># Transform axes coordinate to display coordinate</span>
                    <span class="n">display_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">axes_coord</span><span class="p">)</span>
                    <span class="c1"># Transform display coordinate to data coordinate</span>
                    <span class="n">data_coord</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">display_coord</span><span class="p">)</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="n">data_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">info_</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span> <span class="o">-</span> <span class="n">new_y</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                    <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;text_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">f_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_beampipe_cutoff</span><span class="p">(</span><span class="n">Ri_list</span><span class="p">,</span> <span class="n">which</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">Ri</span> <span class="ow">in</span> <span class="n">Ri_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mode_type</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">f_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]):</span>
                <span class="n">vl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>  <span class="c1"># label=f&quot;{sc[0]} cutoff (Ri={sc[1]})&quot;,</span>
                <span class="n">labels_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">vl</span><span class="p">})</span>

                <span class="c1"># get y text position from axis position. Position x is not used</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">axis_data_coords_sys_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">txt</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$f_\mathrm{c,&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode_type</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;} (R_\mathrm</span><span class="si">{i}</span><span class="s2"> = &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; ~\mathrm</span><span class="si">{mm}</span><span class="s2">) $&quot;</span>
                <span class="n">ab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">txt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s1">&#39;text_obj&#39;</span><span class="p">:</span> <span class="n">ab</span><span class="p">}</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># ab = add_text(ax, r&quot;$f_\mathrm{c,&quot; + f&quot;{mode_type}&quot; + r&quot;} (R_\mathrm{i} = &quot;</span>
                <span class="c1">#               + f&quot;{Ri}&quot; + r&quot; ~\mathrm{mm}) $&quot;,</span>
                <span class="c1">#               box=&quot;None&quot;, xy=(freq, pos[1]),</span>
                <span class="c1">#               xycoords=&#39;data&#39;, size=14, rotation=90)</span>

        <span class="c1"># Attach the callback to limit changes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;xlim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;ylim_changed&#39;</span><span class="p">,</span> <span class="n">update_text_positions</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.calculate_beampipe_cutoff">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.calculate_beampipe_cutoff">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_beampipe_cutoff</span><span class="p">(</span><span class="n">Ri_list</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span>
        <span class="n">mode_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">f_list</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">mode_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">mode_type</span> <span class="o">=</span> <span class="n">mode</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">mode_dict</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">mode_type</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">Ri</span> <span class="ow">in</span> <span class="n">Ri_list</span><span class="p">:</span>
            <span class="n">f_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">mode_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span>
                <span class="c1"># get jacobian</span>
                <span class="k">if</span> <span class="n">mode_dict</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;tm&#39;</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jn_zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">jnp_zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">f</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ri</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">))</span>

                <span class="c1"># append to f list</span>
                <span class="n">f_list</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Ri</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f_list</span></div>


<div class="viewcode-block" id="Cavities.run_optimisation">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.run_optimisation">[docs]</a>
    <span class="k">def</span> <span class="nf">run_optimisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimisation_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_optimisation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">optimisation_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cavities.calc_cutoff">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Cavities.calc_cutoff">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calc_cutoff</span><span class="p">(</span><span class="n">Ri</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="c1"># calculate frequency from Ri</span>
        <span class="n">p_TM01</span><span class="p">,</span> <span class="n">p_TE11</span> <span class="o">=</span> <span class="mf">2.405</span><span class="p">,</span> <span class="mf">1.841</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span>  <span class="c1"># m/s</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;TM01&#39;</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">p_TM01</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Ri</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">p_TE11</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Ri</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>

        <span class="k">return</span> <span class="n">freq</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavities_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid key. Cavities does not contain a Cavity named </span><span class="si">{key}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid argument type. Must be int or str.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Pillbox">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox">[docs]</a>
<span class="k">class</span> <span class="nc">Pillbox</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">L_bp</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="n">n_cells</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># change later to enable module run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">Req</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span> <span class="o">=</span> <span class="n">Ri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">S</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_bp</span> <span class="o">=</span> <span class="n">L_bp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span> <span class="o">=</span> <span class="n">beampipe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="mi">33</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">Ri</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">L_bp</span><span class="p">],</span>
            <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="n">beampipe</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Pillbox.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_pillbox_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_bp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beampipe</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [m]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ [m]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\parallel} ~[\mathrm{k\Omega}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\perp} ~[\mathrm{k\Omega/m}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_err&#39;</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ax</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convergence data not available.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.run_tune">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_tune">[docs]</a>
    <span class="k">def</span> <span class="nf">run_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tune_variable</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s1">&#39;Mid Cell&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;SLANS&#39;</span><span class="p">,</span> <span class="n">proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tune current cavity geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cells used for tuning.</span>
<span class="sd">        resume: bool</span>
<span class="sd">            Option to resume tuning or not. Only for shape space with multiple entries.</span>
<span class="sd">        proc: int</span>
<span class="sd">            Processor number</span>
<span class="sd">        solver: {&#39;SLANS&#39;, &#39;Native&#39;}</span>
<span class="sd">            Solver to be used. Native solver is still under development. Results are not as accurate as that of SLANS.</span>
<span class="sd">        freq: float</span>
<span class="sd">            Reference frequency in MHz</span>
<span class="sd">        cell_type: {&#39;mid cell&#39;, &#39;end-mid cell&#39;, &#39;mid-end cell&#39;, &#39;end-end cell&#39;, &#39;single cell&#39;}</span>
<span class="sd">            Type of cell to tune</span>
<span class="sd">        tune_variable: {&#39;Req&#39;, &#39;L&#39;}</span>
<span class="sd">            Tune variable. Currently supports only the tuning of the equator radius ``Req`` and half-cell length ``L``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">iter_set</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Linear Interpolation&#39;</span><span class="p">,</span> <span class="n">TUNE_ACCURACY</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># calculate freq from mid cell length</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_cell</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculated freq from mid cell half length: &quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1"># create new shape space based on cell_type</span>
        <span class="c1"># if cell_type.lower() == &#39;mid cell&#39;:</span>
        <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;BP&quot;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="n">freq</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slans_tune_res</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">run_tune</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;This cavity has already been tuned. Run tune again? (y/N)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">run_tune</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_tune_ngsolve</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                                      <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                      <span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span>
                                      <span class="n">progress_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">convergence_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence_list</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="n">n_cells</span><span class="p">)</span>

            <span class="c1"># read tune results and update geometry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ngsolve_tune_res</span><span class="p">(</span><span class="n">tune_variable</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_tune_ngsolve</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span>
                                  <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span>
                                  <span class="n">progress_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">convergence_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence_list</span><span class="p">,</span> <span class="n">n_cells</span><span class="o">=</span><span class="n">n_cells</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ngsolve_tune_res</span><span class="p">(</span><span class="n">tune_variable</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oops! Something went wrong. Could not find the tune results. Please run tune again.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.run_tune_ngsolve">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_tune_ngsolve">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">run_tune_ngsolve</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                         <span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">progress_list</span><span class="p">,</span> <span class="n">convergence_list</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
        <span class="n">tuner</span><span class="o">.</span><span class="n">tune_ngsolve</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                           <span class="n">tune_variable</span><span class="o">=</span><span class="n">tune_variable</span><span class="p">,</span> <span class="n">iter_set</span><span class="o">=</span><span class="n">iter_set</span><span class="p">,</span>
                           <span class="n">cell_type</span><span class="o">=</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;Optimisation&#39;</span><span class="p">,</span>
                           <span class="n">progress_list</span><span class="o">=</span><span class="n">progress_list</span><span class="p">,</span> <span class="n">convergence_list</span><span class="o">=</span><span class="n">convergence_list</span><span class="p">,</span>
                           <span class="n">save_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">n_cell_last_run</span><span class="o">=</span><span class="n">n_cells</span><span class="p">)</span>  <span class="c1"># last_key=last_key This would have to be tested again #val2</span></div>


<div class="viewcode-block" id="Pillbox.run_eigenmode">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_eigenmode">[docs]</a>
    <span class="k">def</span> <span class="nf">run_eigenmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">,</span> <span class="n">freq_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">boundary_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run eigenmode analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        solver: {&#39;SLANS&#39;, &#39;NGSolve&#39;}</span>
<span class="sd">            Solver to be used. Native solver is still under development. Results are not as accurate as that of SLANS.</span>
<span class="sd">        freq_shift:</span>
<span class="sd">            Frequency shift. Eigenmode solver searches for eigenfrequencies around this value</span>
<span class="sd">        boundary_cond: int</span>
<span class="sd">            Boundary condition of left and right cell/beampipe ends</span>
<span class="sd">        subdir: str</span>
<span class="sd">            Sub directory to save results to</span>
<span class="sd">        uq_config: None | dict</span>
<span class="sd">            Provides inputs required for uncertainty quantification. Default is None and disables uncertainty quantification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">boundary_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">boundary_cond</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_shift</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">,</span> <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uq_config</span><span class="o">=</span><span class="n">uq_config</span><span class="p">)</span>
        <span class="c1"># load quantities of interest</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenmode_qois</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find eigenmode results. Please rerun eigenmode analysis.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pillbox.run_wakefield">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Pillbox.run_wakefield">[docs]</a>
    <span class="k">def</span> <span class="nf">run_wakefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">wakelength</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                      <span class="n">DDR_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operating_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ABCI&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run wakefield analysis on cavity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        MROT: {0, 1}</span>
<span class="sd">            Polarisation 0 for longitudinal polarization and 1 for transversal polarization</span>
<span class="sd">        MT: int</span>
<span class="sd">            Number of time steps it takes for a beam to move from one mesh cell to the other</span>
<span class="sd">        NFS: int</span>
<span class="sd">            Number of frequency samples</span>
<span class="sd">        wakelength:</span>
<span class="sd">            Wakelength to be analysed</span>
<span class="sd">        bunch_length: float</span>
<span class="sd">            Length of the bunch</span>
<span class="sd">        DDR_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the r axis</span>
<span class="sd">        DDZ_SIG: float</span>
<span class="sd">            Mesh to bunch length ration in the z axis</span>
<span class="sd">        WG_M:</span>
<span class="sd">            For module simulation. Specifies the length of the beampipe between two cavities.</span>
<span class="sd">        marker: str</span>
<span class="sd">            Marker for the cavities. Adds this to the cavity name specified in a shape space json file</span>
<span class="sd">        wp_dict: dict</span>
<span class="sd">            Python dictionary containing relevant parameters for the wakefield analysis for a specific operating point</span>
<span class="sd">        solver: {&#39;ABCI&#39;}</span>
<span class="sd">            Only one solver is currently available</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">operating_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_abci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_space</span><span class="p">,</span>
                               <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">wakelength</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                               <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span>
                               <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="n">WG_M</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                               <span class="n">operating_points</span><span class="o">=</span><span class="n">operating_points</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R_Q</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_abci_data</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_wakefield_qois</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the abci wakefield results. Please rerun wakefield analysis.&quot;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_ngsolve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">,</span> <span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">uq_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># create folders for all keys</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">pillbox</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span>
                             <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                             <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="c1"># run UQ</span>
        <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
            <span class="n">uq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc&quot;</span><span class="p">],</span>
               <span class="n">n_cells</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="o">=</span><span class="n">n_modules</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
               <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done with Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_run_abci</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
                  <span class="n">DDR_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">operating_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R_Q</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># run abci code</span>
        <span class="k">if</span> <span class="n">WG_M</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">WG_M</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># run both polarizations if MROT == 2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">WG_M</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MROT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                     <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                     <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                     <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MROT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                     <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">MROT</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                     <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                     <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">operating_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_Q</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># save qois</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">operating_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">WP</span> <span class="o">=</span> <span class="n">key</span>
                        <span class="n">I0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;I0 [mA]&#39;</span><span class="p">])</span>
                        <span class="n">Nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;Nb [1e11]&#39;</span><span class="p">])</span>
                        <span class="n">sigma_z</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">])]</span>
                        <span class="n">bl_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SR&#39;</span><span class="p">,</span> <span class="s1">&#39;BS&#39;</span><span class="p">]</span>

                        <span class="c1"># info(&quot;Running wakefield analysis for given operating points.&quot;)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sigma_z</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">WG_M</span><span class="p">:</span>
                                <span class="n">fid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WP</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bl_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">mm</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                                         <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                                                         <span class="n">bunch_length</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                                         <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                                                         <span class="n">bunch_length</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="n">dirc</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">marker</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="c1"># try:</span>
                                <span class="n">k_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">])</span>
                                <span class="n">k_kick</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">])</span>
                                <span class="c1"># except:</span>
                                <span class="c1">#     k_loss = 0</span>
                                <span class="c1">#     k_kick = 0</span>

                                <span class="n">d</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_qois_value</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">k_loss</span><span class="p">,</span> <span class="n">k_kick</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>

                    <span class="c1"># save qoi dictionary</span>
                    <span class="n">run_save_directory</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">marker</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

                    <span class="n">done</span><span class="p">(</span><span class="s2">&quot;Done with the secondary analysis for working points&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;To run analysis for working points, eigenmode simulation has to be run first&quot;</span>
                         <span class="s2">&quot;to obtain the cavity operating frequency and R/Q&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;The working point entered is not valid. See below for the proper input structure.&#39;</span><span class="p">)</span>
                <span class="n">show_valid_operating_point_structure</span><span class="p">()</span></div>



<div class="viewcode-block" id="RFGun">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun">[docs]</a>
<span class="k">class</span> <span class="nc">RFGun</span><span class="p">(</span><span class="n">Cavity</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.shape_space = {</span>
        <span class="c1">#     &#39;IC&#39;: [L, Req, Ri, S, L_bp],</span>
        <span class="c1">#     &#39;BP&#39;: beampipe</span>
        <span class="c1"># }</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="RFGun.plot">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.RFGun.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">write_gun_geometry</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$z$ [m]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ [m]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Long&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Longitudinal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\parallel} ~[\mathrm{k\Omega}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abci_data</span><span class="p">[</span><span class="s1">&#39;Trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Transversal Impedance Magnitude&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f [MHz]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z_{\perp} ~[\mathrm{k\Omega/m}]$&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_err&#39;</span><span class="p">]],</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_plot_convergence</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ax</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Convergence data not available.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Dakota">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota">[docs]</a>
<span class="k">class</span> <span class="nc">Dakota</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scripts_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="sa">f</span><span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please ensure directory paths use forward slashes.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="k">if</span> <span class="n">scripts_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scripts_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;D:/Dropbox/CavityDesignHub/analysis_modules/uq/dakota_scripts&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scripts_folder</span> <span class="o">=</span> <span class="n">scripts_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<div class="viewcode-block" id="Dakota.write_input_file">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.write_input_file">[docs]</a>
    <span class="k">def</span> <span class="nf">write_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;variables_config&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;variables config&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;interface_config&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;interface config&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;method_config&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;method config&quot;&#39;</span><span class="p">)</span>

        <span class="n">variables_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;variables_config&#39;</span><span class="p">]</span>
        <span class="n">interface_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;interface_config&#39;</span><span class="p">]</span>
        <span class="n">method_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method_config&#39;</span><span class="p">]</span>

        <span class="c1"># check if folder exists, if not, create folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not create folder. Make sure target location exists.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.in&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">method_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">variables_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.environment">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.environment">[docs]</a>
    <span class="k">def</span> <span class="nf">environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;environment</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">tabular_data</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">tabular_data_file = &#39;sim_result_table.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">results_output</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">results_output_file = &#39;result_output_file.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.method">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.method">[docs]</a>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter &quot;method&quot; in &quot;method config&quot;.&#39;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;method</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">export_expansion_file =&#39;expansion_file.dat&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">cubature_integrand = 3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">samples_on_emulator = 10000</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">seed = 12347</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">variance_based_decomp interaction_order = 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.variables">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.variables">[docs]</a>
    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f: File</span>
<span class="sd">            File</span>
<span class="sd">        kind: {&#39;uniform_uncertain&#39;, &#39;normal_uncertain&#39;, &#39;beta_uncertain&#39;}</span>
<span class="sd">            Type of distribution of the variables</span>
<span class="sd">        descriptors: list, ndarray</span>
<span class="sd">            Uncertain variable names</span>
<span class="sd">        kwargs: kwargs</span>
<span class="sd">            Other relevant arguments eg. {means: [], &#39;std_deviations&#39;: [], &#39;lower_bounds&#39;: [], &#39;upper_bounds&#39;: []}</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;kind&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter &quot;kind&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;lower_bounds&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter keyword &quot;lower_bounds&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;upper_bounds&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter keyword &quot;upper bounds&quot;&#39;</span><span class="p">)</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">lower_bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lower_bounds&#39;</span><span class="p">]</span>
        <span class="n">upper_bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;upper_bounds&#39;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">upper_bounds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower_bounds</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Length of upper and lower bounds must be equal.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;descriptors&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">descriptors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;&quot;descriptors&quot; not entered. Using default parameter labelling.&#39;</span><span class="p">)</span>
            <span class="n">descriptors</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">upper_bounds</span><span class="p">))]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;upper_bounds&#39;</span><span class="p">])</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;variables</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">descriptors       =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">descriptor</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span> <span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;means&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">means      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="k">for</span> <span class="n">mean</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;std_deviations&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;std_deviations&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">std_deviations      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;std_deviations&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;lower_bounds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">lower_bounds      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lower_bounds&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;upper_bounds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">upper_bounds      =   &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span> <span class="k">for</span> <span class="n">ub</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;upper_bounds&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.interface">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.interface">[docs]</a>
    <span class="k">def</span> <span class="nf">interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;analysis_driver&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;please enter keyword &quot;analysis driver&quot;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;responses&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter &quot;responses&quot;&#39;</span><span class="p">)</span>

        <span class="n">analysis_driver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;analysis_driver&#39;</span><span class="p">]</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;responses&#39;</span><span class="p">]</span>

        <span class="n">nodes_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;nodes_only&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">nodes_only</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nodes_only&#39;</span><span class="p">]</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>

        <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;interface</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">common options</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">fork</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">parameters_file = &#39;params.in&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">results_file    = &#39;results.out&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">system asynchronous evaluation_concurrency = </span><span class="si">{</span><span class="n">processes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">analysis_driver = &#39;</span><span class="si">{</span><span class="n">analysis_driver</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nodes_only</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_folder</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">parameters_file = &#39;params.in&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">results_file    = &#39;results.out&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">file_tag</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">file_save</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\t</span><span class="s2">aprepro</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.responses">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.responses">[docs]</a>
    <span class="k">def</span> <span class="nf">responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;responses</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">response_functions = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">no_gradients</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">no_hessians</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.nodes_to_cst_sweep_input">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.nodes_to_cst_sweep_input">[docs]</a>
    <span class="k">def</span> <span class="nf">nodes_to_cst_sweep_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># save parts</span>
        <span class="n">row_partition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">partitions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">partitions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">partitions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">row_partition</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">row_partition</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">row_partition</span><span class="p">:]</span>

            <span class="n">df_part</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/cst_sweep_files/cst_par_in_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dakota.run_analysis">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.Dakota.run_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_cst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dakota_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.in&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">dakota_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.out&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;dakota&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dakota_in</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">dakota_out</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># read results</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/sim_result_table.dat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span>

        <span class="c1"># delete unnecessary columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;response|interface|eval_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_results</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/nodes.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write_cst</span><span class="p">:</span>
            <span class="c1"># check if folder exist and clear</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span>

            <span class="c1"># post processes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_to_cst_sweep_input</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cst_sweep_files&#39;</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="OperationPoints">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.OperationPoints">[docs]</a>
<span class="k">class</span> <span class="nc">OperationPoints</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_operating_point</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

<div class="viewcode-block" id="OperationPoints.load_operating_point">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.OperationPoints.load_operating_point">[docs]</a>
    <span class="k">def</span> <span class="nf">load_operating_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">op_points</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="n">op_points</span>
        <span class="k">return</span> <span class="n">op_points</span></div>


<div class="viewcode-block" id="OperationPoints.get_default_operating_points">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.OperationPoints.get_default_operating_points">[docs]</a>
    <span class="k">def</span> <span class="nf">get_default_operating_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;Z_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">5.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0370</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">354.91</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">709.82</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">4.32</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.76</span>
            <span class="p">},</span>
            <span class="s2">&quot;W_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">135</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">10.61</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0801</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">65.99</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">131.98</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">132</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.55</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">7.02</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.29</span>
            <span class="p">},</span>
            <span class="s2">&quot;H_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mf">53.4</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">10.61</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0328</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">39.2</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">528</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">4.45</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.51</span>
            <span class="p">},</span>
            <span class="s2">&quot;ttbar_2023&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">182.5</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">9.2</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">20.12</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0826</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">5.63</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">11.26</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">488</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">1.67</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.26</span>
            <span class="p">},</span>
            <span class="s2">&quot;Z_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">1400</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">5.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0370</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">354.91</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">709.82</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">4.32</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.76</span>
            <span class="p">},</span>
            <span class="s2">&quot;W_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">135</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">11.91</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0801</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">65.99</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">131.98</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">112</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.55</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">7.02</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.29</span>
            <span class="p">},</span>
            <span class="s2">&quot;H_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mf">53.4</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">10.61</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0328</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">39.2</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">528</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">4.45</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.51</span>
            <span class="p">},</span>
            <span class="s2">&quot;ttbar_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">182.5</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">9.2</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">20.12</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0826</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.733</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">5.63</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">11.26</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">488</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">1.67</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.26</span>
            <span class="p">},</span>
            <span class="s2">&quot;Z_booster_2022&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">6.23</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0370</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">2.85</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">354.91</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">709.82</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">4.32</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">15.2</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">0.276</span>
            <span class="p">},</span>
            <span class="s2">&quot;Z_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">45.6</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">1390</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">5.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">1.48</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">424.6</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">849.2</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">12.1</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.7</span>
            <span class="p">},</span>
            <span class="s2">&quot;W_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">147</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">11.91</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.0506</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">1.48</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">78.7</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">157.4</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.5</span>
            <span class="p">},</span>
            <span class="s2">&quot;H_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">400.79</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">11.87</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.036</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.73</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">23.4</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">46.8</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">136</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">3.15</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">5.3</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">1.8</span>
            <span class="p">},</span>
            <span class="s2">&quot;ttbar_2018&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="mf">801.58</span><span class="p">,</span>
                <span class="s2">&quot;E [GeV]&quot;</span><span class="p">:</span> <span class="mf">182.5</span><span class="p">,</span>
                <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="mf">10.8</span><span class="p">,</span>
                <span class="s2">&quot;V [GV]&quot;</span><span class="p">:</span> <span class="mf">10.93</span><span class="p">,</span>
                <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="mf">24.72</span><span class="p">,</span>
                <span class="s2">&quot;nu_s []&quot;</span><span class="p">:</span> <span class="mf">0.087</span><span class="p">,</span>
                <span class="s2">&quot;alpha_p [1e-5]&quot;</span><span class="p">:</span> <span class="mf">0.73</span><span class="p">,</span>
                <span class="s2">&quot;tau_z [ms]&quot;</span><span class="p">:</span> <span class="mf">6.8</span><span class="p">,</span>
                <span class="s2">&quot;tau_xy [ms]&quot;</span><span class="p">:</span> <span class="mf">13.6</span><span class="p">,</span>
                <span class="s2">&quot;f_rev [kHz]&quot;</span><span class="p">:</span> <span class="mf">3.07</span><span class="p">,</span>
                <span class="s2">&quot;beta_xy [m]&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;N_c []&quot;</span><span class="p">:</span> <span class="mi">584</span><span class="p">,</span>
                <span class="s2">&quot;T [K]&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">:</span> <span class="mf">1.97</span><span class="p">,</span>
                <span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
                <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="mf">2.3</span>
            <span class="p">}</span>
        <span class="p">})</span></div>
</div>



<div class="viewcode-block" id="run_tune_parallel">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.run_tune_parallel">[docs]</a>
<span class="k">def</span> <span class="nf">run_tune_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span>
                      <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">tune_config_keys</span> <span class="o">=</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">:</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">assert</span> <span class="s1">&#39;freqs&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter the target tune frequency.&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter the tune variable in tune_config_dict&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s1">&#39;cell_types&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please enter the cell_type in tune_config_dict&#39;</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">]</span>
    <span class="n">tune_parameters</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
    <span class="n">cell_types</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;cell_types&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">freqs</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape_space</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_space</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Number of target frequencies must correspond to the number of cavities&#39;</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tune_parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">],</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Please enter a valid tune parameter&#39;</span><span class="p">)</span>
        <span class="n">tune_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tune_parameters</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape_space</span><span class="p">))])</span>
        <span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cell_types</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape_space</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tune_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_space</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Number of tune parameters must correspond to the number of cavities&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_space</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Number of cell types must correspond to the number of cavities&#39;</span><span class="p">)</span>
        <span class="n">tune_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tune_parameters</span><span class="p">)</span>
        <span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span>

    <span class="c1"># split shape_space for different processes/ MPI share process by rank</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape_space</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># check if number of processors selected is greater than the number of keys in the pseudo shape space</span>
    <span class="k">if</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

    <span class="n">shape_space_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">share</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shape_space_len</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
        <span class="c1"># try:</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">processes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">]</span>
            <span class="n">proc_tune_variables</span> <span class="o">=</span> <span class="n">tune_parameters</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">]</span>
            <span class="n">proc_freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">]</span>
            <span class="n">proc_cell_types</span> <span class="o">=</span> <span class="n">cell_types</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:]</span>
            <span class="n">proc_tune_variables</span> <span class="o">=</span> <span class="n">tune_parameters</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:]</span>
            <span class="n">proc_freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:]</span>
            <span class="n">proc_cell_types</span> <span class="o">=</span> <span class="n">cell_types</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:]</span>

        <span class="n">processor_shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proc_keys_list</span><span class="p">}</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_tune_s</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">processor_shape_space</span><span class="p">,</span> <span class="n">proc_tune_variables</span><span class="p">,</span>
                                                      <span class="n">proc_freqs</span><span class="p">,</span> <span class="n">proc_cell_types</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

        <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_tune_s">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.run_tune_s">[docs]</a>
<span class="k">def</span> <span class="nf">run_tune_s</span><span class="p">(</span><span class="n">processor_shape_space</span><span class="p">,</span> <span class="n">proc_tune_variables</span><span class="p">,</span> <span class="n">proc_freqs</span><span class="p">,</span> <span class="n">proc_cell_types</span><span class="p">,</span> <span class="n">tune_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span>
               <span class="n">p</span><span class="p">):</span>
    <span class="c1"># perform necessary checks</span>
    <span class="k">if</span> <span class="n">tune_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tune_config</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tune_config_keys</span> <span class="o">=</span> <span class="n">tune_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">rerun</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_run_tune</span><span class="p">():</span>
        <span class="n">sim_folder</span> <span class="o">=</span> <span class="s1">&#39;Optimisation&#39;</span>
        <span class="n">tuned_shape_space</span><span class="p">,</span> <span class="n">d_tune_res</span><span class="p">,</span> <span class="n">conv_dict</span><span class="p">,</span> <span class="n">abs_err_dict</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">tune_ngsolve</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">shape</span><span class="p">},</span> <span class="mi">33</span><span class="p">,</span>
                                                                                    <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                                                                    <span class="n">projectDir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
                                                                                    <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span> <span class="n">proc</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                                                                                    <span class="n">tune_variable</span><span class="o">=</span>
                                                                                    <span class="n">proc_tune_variables</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                    <span class="n">cell_type</span><span class="o">=</span><span class="n">proc_cell_types</span><span class="p">[</span>
                                                                                        <span class="n">i</span><span class="p">],</span>
                                                                                    <span class="n">sim_folder</span><span class="o">=</span><span class="n">sim_folder</span><span class="p">,</span>
                                                                                    <span class="n">tune_config</span><span class="o">=</span><span class="n">tune_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">d_tune_res</span><span class="p">:</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="n">processor_shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>
            <span class="n">tuned_shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_cells</span>
            <span class="n">tuned_shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processor_shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span>
            <span class="n">tuned_shape_space_multi</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:</span> <span class="n">to_multicell</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">tuned_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">tuned_shape</span> <span class="ow">in</span>
                                       <span class="n">tuned_shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;eigenmode_config&#39;</span> <span class="ow">in</span> <span class="n">tune_config_keys</span><span class="p">:</span>
                <span class="n">eigenmode_config</span> <span class="o">=</span> <span class="n">tune_config</span><span class="p">[</span><span class="s1">&#39;eigenmode_config&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s1">&#39;tune_config not contain eigenmode_config. Default values are used for eigenmode analysis.&#39;</span><span class="p">)</span>

            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Optimisation&#39;</span>
            <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">run_eigenmode_parallel</span><span class="p">(</span><span class="n">tuned_shape_space</span><span class="p">,</span> <span class="n">tuned_shape_space_multi</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">)</span>

            <span class="c1"># save tune results</span>
            <span class="n">save_tune_result</span><span class="p">(</span><span class="n">d_tune_res</span><span class="p">,</span> <span class="s1">&#39;tune_res.json&#39;</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sim_folder</span><span class="p">)</span>

            <span class="c1"># save convergence information</span>
            <span class="n">save_tune_result</span><span class="p">(</span><span class="n">conv_dict</span><span class="p">,</span> <span class="s1">&#39;convergence.json&#39;</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sim_folder</span><span class="p">)</span>
            <span class="n">save_tune_result</span><span class="p">(</span><span class="n">abs_err_dict</span><span class="p">,</span> <span class="s1">&#39;absolute_error.json&#39;</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sim_folder</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processor_shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;FREQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc_freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;Optimisation&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
                <span class="c1"># clear previous results</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;Optimisation&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;Optimisation&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">_run_tune</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_run_tune</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_eigenmode_parallel">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.run_eigenmode_parallel">[docs]</a>
<span class="k">def</span> <span class="nf">run_eigenmode_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">,</span>
                           <span class="n">projectDir</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># split shape_space for different processes/ MPI share process by rank</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape_space</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># check if number of processors selected is greater than the number of keys in the pseudo shape space</span>
    <span class="k">if</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

    <span class="n">shape_space_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">share</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shape_space_len</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>

    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
        <span class="c1"># try:</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">processes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:]</span>

        <span class="n">processor_shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proc_keys_list</span><span class="p">}</span>
        <span class="n">processor_shape_space_multi</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proc_keys_list</span><span class="p">}</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_eigenmode_s</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">processor_shape_space</span><span class="p">,</span> <span class="n">processor_shape_space_multi</span><span class="p">,</span>
                                                           <span class="n">projectDir</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">))</span>

        <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_eigenmode_s">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.run_eigenmode_s">[docs]</a>
<span class="k">def</span> <span class="nf">run_eigenmode_s</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run eigenmode analysis</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape_space</span>
<span class="sd">    shape_space_multi</span>
<span class="sd">    projectDir</span>
<span class="sd">    eigenmode_config</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;rerun&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;rerun must be boolean.&#39;</span><span class="p">)</span>
        <span class="n">rerun</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;rerun&#39;</span><span class="p">]</span>

    <span class="c1"># perform all necessary checks</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be greater than zero.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of proceses must be integer.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processes</span>

    <span class="n">freq_shifts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="s1">&#39;f_shifts&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">freq_shifts</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;f_shifts&#39;</span><span class="p">]</span>

    <span class="n">boundary_conds</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;boundary_conditions&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BOUNDARY_CONDITIONS_DICT</span><span class="p">[</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BOUNDARY_CONDITIONS_DICT</span><span class="p">[</span><span class="n">boundary_conds</span><span class="p">]</span>

    <span class="c1"># uq_config = None</span>
    <span class="c1"># if &#39;uq_config&#39; in eigenmode_config.keys():</span>
    <span class="c1">#     uq_config = eigenmode_config[&#39;uq_config&#39;]</span>
    <span class="c1">#     if uq_config:</span>
    <span class="c1">#         assert len(uq_config[&#39;delta&#39;]) == len(uq_config[&#39;variables&#39;]), error(&quot;The number of deltas must &quot;</span>
    <span class="c1">#                                                                              &quot;be equal to the number of &quot;</span>
    <span class="c1">#                                                                              &quot;variables.&quot;)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     eigenmode_config[&#39;uq_config&#39;] = uq_config</span>

    <span class="k">def</span> <span class="nf">_run_ngsolve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">,</span> <span class="n">eigenmode_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">):</span>
        <span class="n">n_cells</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>
        <span class="n">n_modules</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># create folders for all keys</span>
        <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;OC_R&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC_R&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC&#39;</span>

        <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
            <span class="n">write_cst_paramters</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                                <span class="n">solver</span><span class="o">=</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">])</span>

            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                        <span class="n">n_modes</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span>
                                        <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span> <span class="n">sim_folder</span><span class="o">=</span><span class="n">solver_save_dir</span><span class="p">,</span>
                                        <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
            <span class="n">write_cst_paramters</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                                <span class="n">solver</span><span class="o">=</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">])</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_multicell</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape_multi</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape_multi</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                          <span class="n">n_modes</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span>
                                          <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span> <span class="n">sim_folder</span><span class="o">=</span><span class="n">solver_save_dir</span><span class="p">,</span>
                                          <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write_cst_paramters</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">],</span>
                                <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                                <span class="n">solver</span><span class="o">=</span><span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">])</span>
            <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                <span class="n">n_modes</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                <span class="n">sim_folder</span><span class="o">=</span><span class="n">solver_save_dir</span><span class="p">,</span>
                                <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># run UQ</span>
        <span class="k">if</span> <span class="s1">&#39;uq_config&#39;</span> <span class="ow">in</span> <span class="n">eigenmode_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">uq_config</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;optimisation&#39;</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">objectives</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span>
                <span class="n">solver_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ngsolvemevp&#39;</span><span class="p">:</span> <span class="n">ngsolve_mevp</span><span class="p">}</span>
                <span class="n">solver_args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span> <span class="n">eigenmode_config</span><span class="p">,</span>
                                    <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="n">n_cells</span><span class="p">,</span>
                                    <span class="s1">&#39;n_modules&#39;</span><span class="p">:</span> <span class="n">n_modules</span><span class="p">,</span>
                                    <span class="s1">&#39;parentDir&#39;</span><span class="p">:</span> <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                    <span class="s1">&#39;projectDir&#39;</span><span class="p">:</span> <span class="n">projectDir</span><span class="p">,</span>
                                    <span class="s1">&#39;analysis folder&#39;</span><span class="p">:</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;cell_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mid-cell&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;cell_parameterisation&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;optimisation&#39;</span><span class="p">:</span> <span class="n">opt</span>
                                    <span class="p">}</span>

                <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;cell_complexity&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;cell_complexity&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">uq_cell_complexity</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
                    <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape_multi</span><span class="p">}</span>
                    <span class="n">uq_parallel_multicell</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape</span><span class="p">}</span>
                    <span class="n">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done with Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">())):</span>
        <span class="c1"># if isinstance(freq_shifts, int) or isinstance(freq_shifts, float):</span>
        <span class="c1">#     freq_shift = freq_shifts</span>
        <span class="c1"># else:</span>
        <span class="c1">#     freq_shift = freq_shifts[i]</span>
        <span class="c1">#</span>
        <span class="c1"># if isinstance(boundary_conds, str) or boundary_conds is None:</span>
        <span class="c1">#     boundary_cond = boundary_conds</span>
        <span class="c1"># else:</span>
        <span class="c1">#     boundary_cond = boundary_conds[i]</span>

        <span class="n">solver_save_dir</span> <span class="o">=</span> <span class="n">eigenmode_config</span><span class="p">[</span><span class="s1">&#39;solver_save_directory&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="n">solver_save_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
                <span class="c1"># delete old results</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="n">solver_save_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">_run_ngsolve</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">eigenmode_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># check if eigenmode analysis results exist</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="n">solver_save_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;monopole&quot;</span><span class="p">,</span>
                                               <span class="s2">&quot;qois.json&quot;</span><span class="p">)):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="n">solver_save_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                    <span class="n">_run_ngsolve</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">eigenmode_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_run_ngsolve</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">eigenmode_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">)</span></div>



<div class="viewcode-block" id="run_wakefield_parallel">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.run_wakefield_parallel">[docs]</a>
<span class="k">def</span> <span class="nf">run_wakefield_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
    <span class="c1"># split shape_space for different processes/ MPI share process by rank</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape_space</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># check if number of processors selected is greater than the number of keys in the pseudo shape space</span>
    <span class="k">if</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

    <span class="n">shape_space_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">share</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shape_space_len</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
        <span class="c1"># try:</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">processes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">:]</span>

        <span class="n">processor_shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">shape_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proc_keys_list</span><span class="p">}</span>
        <span class="n">processor_shape_space_multi</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proc_keys_list</span><span class="p">}</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_wakefield_s</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">processor_shape_space</span><span class="p">,</span> <span class="n">processor_shape_space_multi</span><span class="p">,</span>
                                                           <span class="n">wakefield_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">rerun</span><span class="p">))</span>

        <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_wakefield_s">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.run_wakefield_s">[docs]</a>
<span class="k">def</span> <span class="nf">run_wakefield_s</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">rerun</span><span class="p">):</span>
    <span class="n">MROT</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span>
    <span class="n">MT</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span>
    <span class="n">NFS</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">]</span>
    <span class="n">UBT</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">]</span>
    <span class="n">bunch_length</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">]</span>
    <span class="n">DDR_SIG</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;DDR_SIG&#39;</span><span class="p">]</span>
    <span class="n">DDZ_SIG</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;DDZ_SIG&#39;</span><span class="p">]</span>

    <span class="n">operating_points</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">wakefield_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">operating_points</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span>

    <span class="n">uq_config</span> <span class="o">=</span> <span class="n">wakefield_config</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
    <span class="c1"># if uq_config:</span>
    <span class="c1">#     assert len(uq_config[&#39;delta&#39;]) == len(uq_config[&#39;variables&#39;]), error(&quot;The number of deltas must &quot;</span>
    <span class="c1">#                                                                          &quot;be equal to the number of &quot;</span>
    <span class="c1">#                                                                          &quot;variables.&quot;)</span>

    <span class="n">WG_M</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_run_abci</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_multi</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">R_Q</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># run abci code</span>
        <span class="k">if</span> <span class="n">WG_M</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">WG_M</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># run both polarizations if MROT == 2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">WG_M</span><span class="p">:</span>
            <span class="c1"># run abci code</span>
            <span class="c1"># run both polarizations if MROT == 2</span>
            <span class="k">if</span> <span class="s1">&#39;OC_R&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC_R&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC&#39;</span>

            <span class="k">if</span> <span class="n">MROT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">:</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="n">wakefield_config</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                                 <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                                 <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                                 <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                 <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="n">wakefield_config</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">:</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="n">wakefield_config</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                                 <span class="n">fid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span> <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                                 <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                                 <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                 <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">wakefield_config</span><span class="o">=</span><span class="n">wakefield_config</span><span class="p">)</span>

        <span class="n">done</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cavity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">. Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">uq_config</span><span class="p">:</span>
            <span class="n">objectives</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;objectives&#39;</span><span class="p">]</span>
            <span class="n">solver_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;abci&#39;</span><span class="p">:</span> <span class="n">abci_geom</span><span class="p">}</span>
            <span class="n">solver_args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wakefield&#39;</span><span class="p">:</span> <span class="n">wakefield_config</span><span class="p">,</span>
                                <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="n">n_cells</span><span class="p">,</span>
                                <span class="s1">&#39;n_modules&#39;</span><span class="p">:</span> <span class="n">n_modules</span><span class="p">,</span>
                                <span class="s1">&#39;parentDir&#39;</span><span class="p">:</span> <span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                <span class="s1">&#39;projectDir&#39;</span><span class="p">:</span> <span class="n">projectDir</span><span class="p">,</span>
                                <span class="s1">&#39;analysis folder&#39;</span><span class="p">:</span> <span class="s1">&#39;ABCI&#39;</span><span class="p">,</span>
                                <span class="c1"># &#39;cell_type&#39;: cell_type,</span>
                                <span class="s1">&#39;cell_parameterisation&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;CELL PARAMETERISATION&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;optimisation&#39;</span><span class="p">:</span> <span class="kc">False</span>
                                <span class="p">}</span>

            <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="s1">&#39;simplecell&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;cell_complexity&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">uq_cell_complexity</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;cell_complexity&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">uq_cell_complexity</span> <span class="o">==</span> <span class="s1">&#39;multicell&#39;</span><span class="p">:</span>
                <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape_multi</span><span class="p">}</span>
                <span class="n">uq_parallel_multicell</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape_space</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">shape</span><span class="p">}</span>
                <span class="n">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operating_points</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check folder for freq and R/Q</span>
                <span class="n">folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">/SimulationData/NGSolveMEVP/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">/monopole/qois.json&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                            <span class="n">fm_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                        <span class="n">freq</span> <span class="o">=</span> <span class="n">fm_results</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
                        <span class="n">R_Q</span> <span class="o">=</span> <span class="n">fm_results</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s2">&quot;To run analysis for working points, eigenmode simulation has to be run first&quot;</span>
                             <span class="s2">&quot;to obtain the cavity operating frequency and R/Q&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">freq</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_Q</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># save qois</span>
                    <span class="k">for</span> <span class="n">key_op</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">operating_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">WP</span> <span class="o">=</span> <span class="n">key_op</span>
                        <span class="n">I0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;I0 [mA]&#39;</span><span class="p">])</span>
                        <span class="n">Nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;Nb [1e11]&#39;</span><span class="p">])</span>
                        <span class="n">sigma_z</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">])]</span>
                        <span class="n">bl_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SR&#39;</span><span class="p">,</span> <span class="s1">&#39;BS&#39;</span><span class="p">]</span>

                        <span class="c1"># info(&quot;Running wakefield analysis for given operating points.&quot;)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sigma_z</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">WG_M</span><span class="p">:</span>
                                <span class="n">fid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WP</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bl_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">mm</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC&#39;</span>
                                <span class="k">if</span> <span class="s1">&#39;OC_R&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC_R&#39;</span>
                                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                    <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                                     <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                                                     <span class="n">bunch_length</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                     <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                                     <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                     <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="n">dirc</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">marker</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="c1"># try:</span>
                                <span class="n">k_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">])</span>
                                <span class="n">k_kick</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">])</span>
                                <span class="c1"># except:</span>
                                <span class="c1">#     k_loss = 0</span>
                                <span class="c1">#     k_kick = 0</span>

                                <span class="n">d</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_qois_value</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">k_loss</span><span class="p">,</span> <span class="n">k_kick</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>

                    <span class="c1"># save qoi dictionary</span>
                    <span class="n">run_save_directory</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">marker</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

                    <span class="n">done</span><span class="p">(</span><span class="s2">&quot;Done with the secondary analysis for working points&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;To run analysis for working points, eigenmode simulation has to be run first&quot;</span>
                         <span class="s2">&quot;to obtain the cavity operating frequency and R/Q&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;The working point entered is not valid. See below for the proper input structure.&#39;</span><span class="p">)</span>
                <span class="n">show_valid_operating_point_structure</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
                <span class="c1"># remove old simulation results</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

                <span class="n">_run_abci</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">wakefield_config</span><span class="p">,</span>
                          <span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># check if eigenmode analysis results exist</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="s2">&quot;SimulationData&quot;</span><span class="p">,</span> <span class="s2">&quot;ABCI&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;qois.json&quot;</span><span class="p">)):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_run_abci</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span>
                              <span class="n">WG_M</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_run_abci</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">shape_space_multi</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">wakefield_config</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="p">,</span>
                      <span class="n">marker</span><span class="p">)</span></div>



<div class="viewcode-block" id="uq_parallel">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.uq_parallel">[docs]</a>
<span class="k">def</span> <span class="nf">uq_parallel</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span>
                <span class="n">solver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key: str | int</span>
<span class="sd">        Cavity geomery identifier</span>
<span class="sd">    shape: dict</span>
<span class="sd">        Dictionary containing geometric dimensions of cavity geometry</span>
<span class="sd">    qois: list</span>
<span class="sd">        Quantities of interest considered in uncertainty quantification</span>
<span class="sd">    n_cells: int</span>
<span class="sd">        Number of cavity cells</span>
<span class="sd">    n_modules: int</span>
<span class="sd">        Number of modules</span>
<span class="sd">    n_modes: int</span>
<span class="sd">        Number of eigenmodes to be calculated</span>
<span class="sd">    f_shift: float</span>
<span class="sd">        Since the eigenmode solver uses the power method, a shift can be provided</span>
<span class="sd">    bc: int</span>
<span class="sd">        Boundary conditions {1:inner contour, 2:Electric wall Et = 0, 3:Magnetic Wall En = 0, 4:Axis, 5:metal}</span>
<span class="sd">        bc=33 means `Magnetic Wall En = 0` boundary condition at both ends</span>
<span class="sd">    pol: int {Monopole, Dipole}</span>
<span class="sd">        Defines whether to calculate for monopole or dipole modes</span>
<span class="sd">    parentDir: str | path</span>
<span class="sd">        Parent directory</span>
<span class="sd">    projectDir: str|path</span>
<span class="sd">        Project directory</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :param select_solver:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
        <span class="c1"># parentDir = solver_args_dict[&#39;parentDir&#39;]</span>
        <span class="n">projectDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;projectDir&#39;</span><span class="p">]</span>
        <span class="n">uq_config</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">][</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
        <span class="c1"># cell_type = uq_config[&#39;cell_type&#39;]</span>
        <span class="n">analysis_folder</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;analysis folder&#39;</span><span class="p">]</span>
        <span class="c1"># opt = solver_args_dict[&#39;optimisation&#39;]</span>
        <span class="c1"># delta = uq_config[&#39;delta&#39;]</span>

        <span class="n">method</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stroud3&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="n">uq_vars</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
        <span class="c1"># assert len(uq_vars) == len(delta), error(&#39;Ensure number of variables equal number of deltas&#39;)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># n_cells = shape[&#39;n_cells&#39;]</span>
            <span class="n">uq_path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">result_dict_eigen</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># eigen_obj_list = []</span>

            <span class="c1"># for o in objectives:</span>
            <span class="c1">#     if o in [&quot;Req&quot;, &quot;freq [MHz]&quot;, &quot;Epk/Eacc []&quot;, &quot;Bpk/Eacc [mT/MV/m]&quot;, &quot;R/Q [Ohm]&quot;,</span>
            <span class="c1">#              &quot;G [Ohm]&quot;, &quot;Q []&quot;, &#39;kcc [%]&#39;, &quot;ff [%]&quot;]:</span>
            <span class="c1">#         result_dict_eigen[o] = {&#39;expe&#39;: [], &#39;stdDev&#39;: []}</span>
            <span class="c1">#         eigen_obj_list.append(o)</span>

            <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">)</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stroud3&#39;</span><span class="p">:</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span><span class="p">,</span> <span class="n">bpoly_</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
                <span class="n">nodes_</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes_</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="c1"># nodes_, weights_ = cn_leg_03_1(rdim)  # &lt;- for some reason unknown this</span>
                <span class="c1"># gives a less accurate answer. the nodes are not the same as the custom function</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stroud5&#39;</span><span class="p">:</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">cn_leg_05_2</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cn_gauss&#39;</span><span class="p">:</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">cn_gauss</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lhc&#39;</span><span class="p">:</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">rdim</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="n">nsamp</span> <span class="o">=</span> <span class="mi">2500</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nsamp</span><span class="p">)</span>
                <span class="c1"># ic(qmc.discrepancy(sample))</span>
                <span class="n">l_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">u_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">sample_scaled</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="n">u_bounds</span><span class="p">)</span>

                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">sample_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsamp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># issue warning</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Integration method not recognised. Defaulting to Stroud3 quadrature rule!&#39;</span><span class="p">)</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span><span class="p">,</span> <span class="n">bpoly</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
                <span class="n">nodes_</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes_</span> <span class="o">-</span> <span class="mf">1.</span>

            <span class="c1"># save nodes and weights</span>
            <span class="n">data_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nodes_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">uq_vars</span><span class="p">)</span>
            <span class="n">data_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\nodes.csv&#39;</span><span class="p">,</span>
                              <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">data_table_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weights_</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
            <span class="n">data_table_w</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\weights.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">no_parm</span><span class="p">,</span> <span class="n">no_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nodes_</span><span class="p">)</span>
            <span class="c1"># if delta is None:</span>
            <span class="c1">#     delta = [0.05 for _ in range(len(uq_vars))]</span>

            <span class="n">sub_dir</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># the simulation runs at the quadrature points are saved to the key of mean value run</span>

            <span class="n">proc_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be greater than zero&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be integer&#39;</span><span class="p">)</span>
                <span class="n">proc_count</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">proc_count</span> <span class="o">&gt;</span> <span class="n">no_sims</span><span class="p">:</span>
                <span class="n">proc_count</span> <span class="o">=</span> <span class="n">no_sims</span>

            <span class="n">share</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">no_sims</span> <span class="o">/</span> <span class="n">proc_count</span><span class="p">)</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proc_count</span><span class="p">):</span>
                <span class="c1"># try:</span>
                <span class="n">end_already</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">proc_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">share</span> <span class="o">&lt;</span> <span class="n">no_sims</span><span class="p">:</span>
                        <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">no_sims</span><span class="p">)</span>
                        <span class="n">end_already</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">proc_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">end_already</span><span class="p">:</span>
                    <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">no_sims</span><span class="p">)</span>
                <span class="n">processor_nodes</span> <span class="o">=</span> <span class="n">nodes_</span><span class="p">[:,</span> <span class="n">proc_keys_list</span><span class="p">]</span>
                <span class="n">processor_weights</span> <span class="o">=</span> <span class="n">weights_</span><span class="p">[</span><span class="n">proc_keys_list</span><span class="p">]</span>
                <span class="n">service</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">,</span> <span class="n">uq_path</span><span class="p">,</span>
                                                      <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span>
                                                      <span class="n">proc_keys_list</span><span class="p">,</span> <span class="n">processor_nodes</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">solver</span><span class="p">))</span>

                <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="c1"># combine results from processes</span>
            <span class="c1"># qois_result_dict = {}</span>
            <span class="c1"># Ttab_val_f = []</span>
            <span class="c1"># keys = []</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proc_count</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)])</span>

            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;table.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;table.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">v_expe_fobj</span><span class="p">,</span> <span class="n">v_stdDev_fobj</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span><span class="n">Ttab_val_f</span><span class="p">,</span> <span class="n">weights_</span><span class="p">)</span>

            <span class="c1"># # append results to dict</span>
            <span class="c1"># for i, o in enumerate(eigen_obj_list):</span>
            <span class="c1">#     result_dict_eigen[o][&#39;expe&#39;].append(v_expe_fobj[i])</span>
            <span class="c1">#     result_dict_eigen[o][&#39;stdDev&#39;].append(v_stdDev_fobj[i])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;expe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_expe_fobj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_stdDev_fobj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;uq.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_dict_eigen</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)))</span>

    <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">:</span>
        <span class="c1"># parentDir = solver_args_dict[&#39;parentDir&#39;]</span>
        <span class="n">projectDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;projectDir&#39;</span><span class="p">]</span>
        <span class="n">solver_args</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;wakefield&#39;</span><span class="p">]</span>
        <span class="c1"># n_cells = solver_args[&#39;n_cells&#39;]</span>
        <span class="n">uq_config</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
        <span class="c1"># delta = uq_config[&#39;delta&#39;]</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;stroud3&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="n">uq_vars</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
        <span class="c1"># cell_type = uq_config[&#39;cell_type&#39;]</span>
        <span class="n">analysis_folder</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;analysis folder&#39;</span><span class="p">]</span>

        <span class="c1"># assert len(uq_vars) == len(delta), error(&#39;Ensure number of variables equal number of deltas&#39;)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># n_cells = shape[&#39;n_cells&#39;]</span>
            <span class="n">uq_path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">result_dict_wakefield</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># wakefield_obj_list = []</span>

            <span class="c1"># for o in objectives:</span>
            <span class="c1">#     if isinstance(o, list):</span>
            <span class="c1">#         if o[1].split(&#39; &#39;)[0] in [&#39;ZL&#39;, &#39;ZT&#39;]:</span>
            <span class="c1">#             result_dict_wakefield[o[1]] = {&#39;expe&#39;: [], &#39;stdDev&#39;: []}</span>
            <span class="c1">#             wakefield_obj_list.append(o[1])</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         if o in [&#39;k_FM [V/pC]&#39;, &#39;|k_loss| [V/pC]&#39;, &#39;|k_kick| [V/pC/m]&#39;, &#39;P_HOM [kW]&#39;]:</span>
            <span class="c1">#             result_dict_wakefield[o] = {&#39;expe&#39;: [], &#39;stdDev&#39;: []}</span>
            <span class="c1">#             wakefield_obj_list.append(o)</span>

            <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">)</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stroud3&#39;</span><span class="p">:</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span><span class="p">,</span> <span class="n">bpoly_</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
                <span class="n">nodes_</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes_</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="c1"># nodes_, weights_ = cn_leg_03_1(rdim)  # &lt;- for some reason unknown this</span>
                <span class="c1"># gives a less accurate answer. the nodes are not the same as the custom function</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stroud5&#39;</span><span class="p">:</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">cn_leg_05_2</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cn_gauss&#39;</span><span class="p">:</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">cn_gauss</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lhc&#39;</span><span class="p">:</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">rdim</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="n">nsamp</span> <span class="o">=</span> <span class="mi">2500</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nsamp</span><span class="p">)</span>
                <span class="c1"># ic(qmc.discrepancy(sample))</span>
                <span class="n">l_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">u_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">sample_scaled</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="n">u_bounds</span><span class="p">)</span>

                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">sample_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsamp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># issue warning</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Integration method not recognised. Defaulting to Stroud3 quadrature rule!&#39;</span><span class="p">)</span>
                <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span><span class="p">,</span> <span class="n">bpoly</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
                <span class="n">nodes_</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes_</span> <span class="o">-</span> <span class="mf">1.</span>

            <span class="c1"># save nodes</span>
            <span class="n">data_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nodes_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">uq_vars</span><span class="p">)</span>
            <span class="n">data_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\nodes.csv&#39;</span><span class="p">,</span>
                              <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">data_table_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weights_</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
            <span class="n">data_table_w</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\weights.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">no_parm</span><span class="p">,</span> <span class="n">no_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nodes_</span><span class="p">)</span>
            <span class="c1"># if delta is None:</span>
            <span class="c1">#     delta = [0.05 for _ in range(len(uq_vars))]</span>

            <span class="n">sub_dir</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># the simulation runs at the quadrature points are saved to the key of mean value run</span>

            <span class="n">proc_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be greater than zero&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be integer&#39;</span><span class="p">)</span>
                <span class="n">proc_count</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">proc_count</span> <span class="o">&gt;</span> <span class="n">no_sims</span><span class="p">:</span>
                <span class="n">proc_count</span> <span class="o">=</span> <span class="n">no_sims</span>

            <span class="n">share</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">no_sims</span> <span class="o">/</span> <span class="n">proc_count</span><span class="p">)</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proc_count</span><span class="p">):</span>
                <span class="c1"># try:</span>
                <span class="n">end_already</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">proc_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">share</span> <span class="o">&lt;</span> <span class="n">no_sims</span><span class="p">:</span>
                        <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">no_sims</span><span class="p">)</span>
                        <span class="n">end_already</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">proc_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">end_already</span><span class="p">:</span>
                    <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">no_sims</span><span class="p">)</span>

                <span class="n">processor_nodes</span> <span class="o">=</span> <span class="n">nodes_</span><span class="p">[:,</span> <span class="n">proc_keys_list</span><span class="p">]</span>
                <span class="n">processor_weights</span> <span class="o">=</span> <span class="n">weights_</span><span class="p">[</span><span class="n">proc_keys_list</span><span class="p">]</span>
                <span class="n">service</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">uq</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">,</span> <span class="n">uq_path</span><span class="p">,</span>
                                                      <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">proc_keys_list</span><span class="p">,</span> <span class="n">processor_nodes</span><span class="p">,</span>
                                                      <span class="n">p</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">solver</span><span class="p">))</span>

                <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="c1"># combine results from processes</span>
            <span class="c1"># qois_result_dict = {}</span>
            <span class="c1"># keys = []</span>
            <span class="c1"># Ttab_val_f = []</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proc_count</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)])</span>

            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;table.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;table.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">v_expe_fobj</span><span class="p">,</span> <span class="n">v_stdDev_fobj</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span><span class="n">Ttab_val_f</span><span class="p">,</span> <span class="n">weights_</span><span class="p">)</span>
            <span class="c1"># # append results to dict</span>
            <span class="c1"># for i, o in enumerate(wakefield_obj_list):</span>
            <span class="c1">#     result_dict_wakefield[o][&#39;expe&#39;].append(v_expe_fobj[i])</span>
            <span class="c1">#     result_dict_wakefield[o][&#39;stdDev&#39;].append(v_stdDev_fobj[i])</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">result_dict_wakefield</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">result_dict_wakefield</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;expe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_expe_fobj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">result_dict_wakefield</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_stdDev_fobj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;uq.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_dict_wakefield</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="uq">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.uq">[docs]</a>
<span class="k">def</span> <span class="nf">uq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">,</span> <span class="n">uq_path</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span>
       <span class="n">proc_keys_list</span><span class="p">,</span> <span class="n">processor_nodes</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape_space: dict</span>
<span class="sd">        Cavity geometry parameter space</span>
<span class="sd">    objectives: list | ndarray</span>
<span class="sd">        Array of objective functions</span>
<span class="sd">    solver_dict: dict</span>
<span class="sd">        Python dictionary of solver settings</span>
<span class="sd">    solver_args_dict: dict</span>
<span class="sd">        Python dictionary of solver arguments</span>
<span class="sd">    uq_config:</span>
<span class="sd">        Python dictionary of uncertainty quantification settings</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :param n_cells:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;eigenmode&#39;</span><span class="p">:</span>
        <span class="n">parentDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;parentDir&#39;</span><span class="p">]</span>
        <span class="n">projectDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;projectDir&#39;</span><span class="p">]</span>
        <span class="c1"># cell_type = uq_config[&#39;cell_type&#39;]</span>
        <span class="n">analysis_folder</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;analysis folder&#39;</span><span class="p">]</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;optimisation&#39;</span><span class="p">]</span>

        <span class="n">epsilon</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span>

        <span class="c1"># method = uq_config[&#39;method&#39;]</span>
        <span class="n">uq_vars</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
        <span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;cell_parameterisation&#39;</span><span class="p">]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">result_dict_eigen</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># eigen_obj_list = objectives</span>
        <span class="n">eigen_obj_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Req&quot;</span><span class="p">,</span> <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">,</span> <span class="s1">&#39;kcc [%]&#39;</span><span class="p">,</span> <span class="s2">&quot;ff [%]&quot;</span><span class="p">]:</span>
                <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">eigen_obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="c1"># if cell_type.lower() == &#39;mid cell&#39; or cell_type.lower() == &#39;mid-cell&#39; or cell_type.lower() == &#39;mid_cell&#39;:</span>
        <span class="c1">#     cell_node = shape[&#39;IC&#39;]</span>
        <span class="c1"># elif cell_type.lower() == &#39;mid-end cell&#39; or cell_type.lower() == &#39;mid-end-cell&#39; or cell_type.lower() == &#39;mid_end_cell&#39;:</span>
        <span class="c1">#     cell_node = shape[&#39;OC&#39;]</span>
        <span class="c1"># elif (cell_type.lower() == &#39;end-end cell&#39; or cell_type.lower() == &#39;end-end-cell&#39;</span>
        <span class="c1">#       or cell_type.lower() == &#39;end_end_cell&#39;) or cell_type.lower() == &#39;end end cell&#39;:</span>
        <span class="c1">#     cell_node = shape[&#39;OC&#39;]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     cell_node = shape[&#39;OC&#39;]</span>
        <span class="n">cell_node</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
        <span class="n">cell_node_left</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
        <span class="n">cell_node_right</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
        <span class="n">perturbed_cell_node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_node</span><span class="p">)</span>
        <span class="n">perturbed_cell_node_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_node_left</span><span class="p">)</span>
        <span class="n">perturbed_cell_node_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_node_right</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">proc_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">):</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">uq_var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">):</span>
                <span class="n">uq_var_indx</span> <span class="o">=</span> <span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">uq_var</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">epsilon</span><span class="p">:</span>
                    <span class="n">perturbed_cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
                    <span class="n">perturbed_cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span>
                        <span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
                    <span class="n">perturbed_cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> \
                                                             <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbed_cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>
                    <span class="n">perturbed_cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>
                    <span class="n">perturbed_cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>

            <span class="c1"># if cell_type.lower() == &#39;mid cell&#39; or cell_type.lower() == &#39;mid-cell&#39; or cell_type.lower() == &#39;mid_cell&#39;:</span>
            <span class="c1">#     # cell_node = shape[&#39;IC&#39;]</span>
            <span class="c1">#     mid = perturbed_cell_node</span>
            <span class="c1">#     left = shape[&#39;OC&#39;]</span>
            <span class="c1">#     right = shape[&#39;OC_R&#39;]</span>
            <span class="c1"># elif cell_type.lower() == &#39;mid-end cell&#39; or cell_type.lower() == &#39;mid-end-cell&#39; or cell_type.lower() == &#39;mid_end_cell&#39;:</span>
            <span class="c1">#     mid = shape[&#39;IC&#39;]</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>
            <span class="c1"># elif (cell_type.lower() == &#39;end-end cell&#39; or cell_type.lower() == &#39;end-end-cell&#39;</span>
            <span class="c1">#       or cell_type.lower() == &#39;end_end_cell&#39;) or cell_type.lower() == &#39;end end cell&#39;:</span>
            <span class="c1">#     mid = perturbed_cell_node</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>
            <span class="c1"># elif cell_type.lower() == &#39;end cell&#39; or cell_type.lower() == &#39;end-cell&#39; or cell_type.lower() == &#39;end_cell&#39;:</span>
            <span class="c1">#     mid = shape[&#39;IC&#39;]</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>
            <span class="c1"># else:</span>
            <span class="c1">#     mid = perturbed_cell_node</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>

            <span class="n">enforce_Req_continuity</span><span class="p">(</span><span class="n">perturbed_cell_node</span><span class="p">,</span> <span class="n">perturbed_cell_node_left</span><span class="p">,</span> <span class="n">perturbed_cell_node_right</span><span class="p">)</span>

            <span class="c1"># perform checks on geometry</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_Q</span><span class="si">{</span><span class="n">proc_key</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># check if folder exists and skip if it does</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">info</span><span class="p">([</span><span class="s2">&quot;Skipped: &quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
                <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="c1"># it does not seem to make sense to perform uq on a multi cell by repeating the same perturbation</span>
                <span class="c1"># to all multi cells at once. For multicells, the uq_multicell option is more suitable as it creates</span>
                <span class="c1"># independent perturbations to all cells individually</span>
                <span class="k">if</span> <span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">:</span>
                    <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">perturbed_cell_node</span><span class="p">,</span>
                                        <span class="n">perturbed_cell_node_left</span><span class="p">,</span> <span class="n">perturbed_cell_node_right</span><span class="p">,</span>
                                        <span class="n">f_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                        <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">sim_folder</span><span class="o">=</span><span class="n">analysis_folder</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                        <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                        <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                    <span class="n">ngsolve_mevp</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">perturbed_cell_node</span><span class="p">,</span>
                                                <span class="n">perturbed_cell_node_left</span><span class="p">,</span> <span class="n">perturbed_cell_node_right</span><span class="p">,</span>
                                                <span class="n">f_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span>
                                                <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                                <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">sim_folder</span><span class="o">=</span><span class="n">analysis_folder</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span>
                                                <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">uq_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/monopole/qois.json&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">qois_result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                    <span class="n">qois_result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
                <span class="n">qois_result</span> <span class="o">=</span> <span class="n">get_qoi_value</span><span class="p">(</span><span class="n">qois_result_dict</span><span class="p">,</span> <span class="n">eigen_obj_list</span><span class="p">)</span>

                <span class="n">tab_val_f</span> <span class="o">=</span> <span class="n">qois_result</span>
                <span class="n">Ttab_val_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab_val_f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">data_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Ttab_val_f</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">eigen_obj_list</span><span class="p">))</span>
        <span class="n">data_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">proc_num</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;wakefield&#39;</span><span class="p">:</span>
        <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parentDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;parentDir&#39;</span><span class="p">]</span>
        <span class="n">projectDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;projectDir&#39;</span><span class="p">]</span>
        <span class="n">solver_args</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;wakefield&#39;</span><span class="p">]</span>
        <span class="c1"># n_cells = solver_args_dict[&#39;n_cells&#39;]</span>
        <span class="c1"># n_modules = solver_args_dict[&#39;n_modules&#39;]</span>
        <span class="n">MROT</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;polarisation&#39;</span><span class="p">]</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span>
        <span class="n">NFS</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;NFS&#39;</span><span class="p">]</span>
        <span class="n">UBT</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;wakelength&#39;</span><span class="p">]</span>
        <span class="n">bunch_length</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;bunch_length&#39;</span><span class="p">]</span>
        <span class="n">DDR_SIG</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;DDR_SIG&#39;</span><span class="p">]</span>
        <span class="n">DDZ_SIG</span> <span class="o">=</span> <span class="n">solver_args</span><span class="p">[</span><span class="s1">&#39;DDZ_SIG&#39;</span><span class="p">]</span>
        <span class="c1"># WG_M = solver_args[&#39;WG_M&#39;]</span>

        <span class="n">epsilon</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span>

        <span class="c1"># method = uq_config[&#39;method&#39;]</span>
        <span class="n">cell_parameterisation</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;cell_parameterisation&#39;</span><span class="p">]</span>
        <span class="n">uq_vars</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
        <span class="c1"># cell_type = uq_config[&#39;cell_type&#39;]</span>
        <span class="n">analysis_folder</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;analysis folder&#39;</span><span class="p">]</span>
        <span class="c1"># marker = solver_args[&#39;marker&#39;]</span>

        <span class="n">result_dict_wakefield</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># wakefield_obj_list = objectives</span>
        <span class="n">wakefield_obj_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ZL&#39;</span><span class="p">,</span> <span class="s1">&#39;ZT&#39;</span><span class="p">]:</span>
                    <span class="n">result_dict_wakefield</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">wakefield_obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">,</span> <span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">]:</span>
                    <span class="n">result_dict_wakefield</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">wakefield_obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="c1"># if cell_type.lower() == &#39;mid cell&#39; or cell_type.lower() == &#39;mid-cell&#39; or cell_type.lower() == &#39;mid_cell&#39;:</span>
        <span class="c1">#     cell_node = shape[&#39;IC&#39;]</span>
        <span class="c1"># elif cell_type.lower() == &#39;mid-end cell&#39; or cell_type.lower() == &#39;mid-end-cell&#39; or cell_type.lower() == &#39;mid_end_cell&#39;:</span>
        <span class="c1">#     cell_node = shape[&#39;OC&#39;]</span>
        <span class="c1"># elif (cell_type.lower() == &#39;end-end cell&#39; or cell_type.lower() == &#39;end-end-cell&#39;</span>
        <span class="c1">#       or cell_type.lower() == &#39;end_end_cell&#39;) or cell_type.lower() == &#39;end end cell&#39;:</span>
        <span class="c1">#     cell_node = shape[&#39;OC&#39;]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     cell_node = shape[&#39;OC&#39;]</span>

        <span class="n">cell_node</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>
        <span class="n">cell_node_left</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">]</span>
        <span class="n">cell_node_right</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">]</span>
        <span class="n">perturbed_cell_node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_node</span><span class="p">)</span>
        <span class="n">perturbed_cell_node_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_node_left</span><span class="p">)</span>
        <span class="n">perturbed_cell_node_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_node_right</span><span class="p">)</span>

        <span class="n">uq_shape_space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d_uq_op</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">proc_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">):</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">uq_var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">):</span>
                <span class="n">uq_var_indx</span> <span class="o">=</span> <span class="n">VAR_TO_INDEX_DICT</span><span class="p">[</span><span class="n">uq_var</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">epsilon</span><span class="p">:</span>
                    <span class="n">perturbed_cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
                    <span class="n">perturbed_cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span>
                        <span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
                    <span class="n">perturbed_cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> \
                                                             <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbed_cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>
                    <span class="n">perturbed_cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_left</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>
                    <span class="n">perturbed_cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_node_right</span><span class="p">[</span><span class="n">uq_var_indx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>

            <span class="c1"># if cell_type.lower() == &#39;mid cell&#39; or cell_type.lower() == &#39;mid-cell&#39; or cell_type.lower() == &#39;mid_cell&#39;:</span>
            <span class="c1">#     # cell_node = shape[&#39;IC&#39;]</span>
            <span class="c1">#     mid = perturbed_cell_node</span>
            <span class="c1">#     left = shape[&#39;OC&#39;]</span>
            <span class="c1">#     right = shape[&#39;OC_R&#39;]</span>
            <span class="c1"># elif cell_type.lower() == &#39;mid-end cell&#39; or cell_type.lower() == &#39;mid-end-cell&#39; or cell_type.lower() == &#39;mid_end_cell&#39;:</span>
            <span class="c1">#     mid = shape[&#39;IC&#39;]</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>
            <span class="c1"># elif (cell_type.lower() == &#39;end-end cell&#39; or cell_type.lower() == &#39;end-end-cell&#39;</span>
            <span class="c1">#       or cell_type.lower() == &#39;end_end_cell&#39;) or cell_type.lower() == &#39;end end cell&#39;:</span>
            <span class="c1">#     mid = perturbed_cell_node</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>
            <span class="c1"># elif cell_type.lower() == &#39;end cell&#39; or cell_type.lower() == &#39;end-cell&#39; or cell_type.lower() == &#39;end_cell&#39;:</span>
            <span class="c1">#     mid = shape[&#39;IC&#39;]</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>
            <span class="c1"># else:</span>
            <span class="c1">#     mid = perturbed_cell_node</span>
            <span class="c1">#     left = perturbed_cell_node</span>
            <span class="c1">#     right = perturbed_cell_node</span>

            <span class="n">enforce_Req_continuity</span><span class="p">(</span><span class="n">perturbed_cell_node</span><span class="p">,</span> <span class="n">perturbed_cell_node_left</span><span class="p">,</span> <span class="n">perturbed_cell_node_right</span><span class="p">)</span>

            <span class="c1"># perform checks on geometry</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_Q</span><span class="si">{</span><span class="n">proc_key</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1"># check if folder exists and skip if it does</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">info</span><span class="p">([</span><span class="s2">&quot;Skipped: &quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
                <span class="n">abci_geom</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">wi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MROT</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">:</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">perturbed_cell_node</span><span class="p">,</span>
                                         <span class="n">perturbed_cell_node_left</span><span class="p">,</span> <span class="n">perturbed_cell_node_right</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">wi</span><span class="p">,</span>
                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                         <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                         <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span>
                                         <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                         <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="n">sub_dir</span>
                                         <span class="p">)</span>
                    <span class="k">if</span> <span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;flattop&#39;</span><span class="p">:</span>
                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity_flattop</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">perturbed_cell_node</span><span class="p">,</span>
                                                 <span class="n">perturbed_cell_node_left</span><span class="p">,</span> <span class="n">perturbed_cell_node_right</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">wi</span><span class="p">,</span>
                                                 <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                                 <span class="n">bunch_length</span><span class="o">=</span><span class="n">bunch_length</span><span class="p">,</span>
                                                 <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="n">UBT</span><span class="p">,</span>
                                                 <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">WG_M</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="n">sub_dir</span>
                                                 <span class="p">)</span>

            <span class="n">uq_shape</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">perturbed_cell_node</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">perturbed_cell_node_left</span><span class="p">,</span>
                        <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">perturbed_cell_node_right</span><span class="p">,</span> <span class="s1">&#39;n_cells&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]}</span>
            <span class="n">uq_shape_space</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">uq_shape</span>

            <span class="c1"># calculate uq for operating points</span>
            <span class="k">if</span> <span class="s1">&#39;operating_points&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">operating_points</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;operating_points&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># check folder for freq and R/Q</span>
                    <span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="n">folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">/SimulationData/NGSolveMEVP/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/monopole/qois.json&#39;</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                                <span class="n">fm_results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                            <span class="n">freq</span> <span class="o">=</span> <span class="n">fm_results</span><span class="p">[</span><span class="s1">&#39;freq [MHz]&#39;</span><span class="p">]</span>
                            <span class="n">R_Q</span> <span class="o">=</span> <span class="n">fm_results</span><span class="p">[</span><span class="s1">&#39;R/Q [Ohm]&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;To run analysis for working points, eigenmode simulation has to be run first&quot;</span>
                                 <span class="s2">&quot;to obtain the cavity operating frequency and R/Q&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">freq</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_Q</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="c1"># save qois</span>
                        <span class="k">for</span> <span class="n">key_op</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">operating_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">WP</span> <span class="o">=</span> <span class="n">key_op</span>
                            <span class="n">I0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;I0 [mA]&#39;</span><span class="p">])</span>
                            <span class="n">Nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;Nb [1e11]&#39;</span><span class="p">])</span>
                            <span class="n">sigma_z</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_SR [mm]&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;sigma_BS [mm]&quot;</span><span class="p">])]</span>
                            <span class="n">bl_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SR&#39;</span><span class="p">,</span> <span class="s1">&#39;BS&#39;</span><span class="p">]</span>

                            <span class="c1"># info(&quot;Running wakefield analysis for given operating points.&quot;)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sigma_z</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
                                    <span class="n">fid_op</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WP</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bl_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">mm</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC&#39;</span>
                                    <span class="k">if</span> <span class="s1">&#39;OC_R&#39;</span> <span class="ow">in</span> <span class="n">uq_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                        <span class="n">OC_R</span> <span class="o">=</span> <span class="s1">&#39;OC_R&#39;</span>
                                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                        <span class="n">abci_geom</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">uq_shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="n">uq_shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">],</span>
                                                         <span class="n">uq_shape</span><span class="p">[</span><span class="n">OC_R</span><span class="p">],</span>
                                                         <span class="n">fid</span><span class="o">=</span><span class="n">fid_op</span><span class="p">,</span> <span class="n">MROT</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">MT</span><span class="o">=</span><span class="n">MT</span><span class="p">,</span> <span class="n">NFS</span><span class="o">=</span><span class="n">NFS</span><span class="p">,</span> <span class="n">UBT</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                                                         <span class="n">bunch_length</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                         <span class="n">DDR_SIG</span><span class="o">=</span><span class="n">DDR_SIG</span><span class="p">,</span> <span class="n">DDZ_SIG</span><span class="o">=</span><span class="n">DDZ_SIG</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="n">SOFTWARE_DIRECTORY</span><span class="p">,</span>
                                                         <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span>
                                                         <span class="n">WG_M</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                    <span class="n">dirc</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span>
                                    <span class="c1"># try:</span>
                                    <span class="n">k_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid_op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">])</span>
                                    <span class="n">k_kick</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ABCIData</span><span class="p">(</span><span class="n">dirc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid_op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">])</span>
                                    <span class="c1"># except:</span>
                                    <span class="c1">#     k_loss = 0</span>
                                    <span class="c1">#     k_kick = 0</span>

                                    <span class="n">d</span><span class="p">[</span><span class="n">fid_op</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_qois_value</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">k_loss</span><span class="p">,</span> <span class="n">k_kick</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">])</span>

                        <span class="n">d_uq_op</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="c1"># save qoi dictionary</span>
                        <span class="n">run_save_directory</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

                        <span class="n">done</span><span class="p">(</span><span class="s2">&quot;Done with the secondary analysis for working points&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s2">&quot;To run analysis for working points, eigenmode simulation has to be run first&quot;</span>
                             <span class="s2">&quot;to obtain the cavity operating frequency and R/Q&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span><span class="s1">&#39;The working point entered is not valid. See below for the proper input structure.&#39;</span><span class="p">)</span>
                    <span class="n">show_valid_operating_point_structure</span><span class="p">()</span>

        <span class="n">df_uq_op</span> <span class="o">=</span> <span class="n">_data_uq_op</span><span class="p">(</span><span class="n">d_uq_op</span><span class="p">)</span>

        <span class="n">wakefield_folder</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\ABCI\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">data_table</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_wakefield_objectives_value</span><span class="p">(</span><span class="n">uq_shape_space</span><span class="p">,</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;objectives_unprocessed&#39;</span><span class="p">],</span>
                                                       <span class="n">wakefield_folder</span><span class="p">)</span>

        <span class="c1"># merge with data table</span>
        <span class="k">if</span> <span class="n">d_uq_op</span><span class="p">:</span>
            <span class="n">data_table_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_uq_op</span><span class="p">,</span> <span class="n">data_table</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_table_merged</span> <span class="o">=</span> <span class="n">data_table</span>
        <span class="n">data_table_merged</span> <span class="o">=</span> <span class="n">data_table_merged</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
        <span class="n">data_table_merged</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">proc_num</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="uq_parallel_multicell">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.uq_parallel_multicell">[docs]</a>
<span class="k">def</span> <span class="nf">uq_parallel_multicell</span><span class="p">(</span><span class="n">shape_space</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">solver_dict</span><span class="p">,</span> <span class="n">solver_args_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape_space: dict</span>
<span class="sd">        Cavity geometry parameter space</span>
<span class="sd">    objectives: list | ndarray</span>
<span class="sd">        Array of objective functions</span>
<span class="sd">    solver_dict: dict</span>
<span class="sd">        Python dictionary of solver settings</span>
<span class="sd">    solver_args_dict: dict</span>
<span class="sd">        Python dictionary of solver arguments</span>
<span class="sd">    uq_config:</span>
<span class="sd">        Python dictionary of uncertainty quantification settings</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parentDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;parentDir&#39;</span><span class="p">]</span>
    <span class="n">projectDir</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;projectDir&#39;</span><span class="p">]</span>
    <span class="n">uq_config</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">][</span><span class="s1">&#39;uq_config&#39;</span><span class="p">]</span>
    <span class="n">cell_type</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span>
    <span class="n">analysis_folder</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;analysis folder&#39;</span><span class="p">]</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;optimisation&#39;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span>

    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;stroud3&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

    <span class="n">uq_vars</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">n_cells</span> <span class="o">=</span> <span class="n">solver_args_dict</span><span class="p">[</span><span class="s1">&#39;eigenmode&#39;</span><span class="p">][</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Ensure number of variables equal number of deltas&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shape_space</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># n_cells = shape[&#39;IC&#39;].shape[1] + 1</span>
        <span class="n">uq_path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData\NGSolveMEVP\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">result_dict_eigen</span><span class="p">,</span> <span class="n">result_dict_abci</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">run_eigen</span><span class="p">,</span> <span class="n">run_abci</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">eigen_obj_list</span><span class="p">,</span> <span class="n">abci_obj_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Req&quot;</span><span class="p">,</span> <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">,</span> <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Q []&quot;</span><span class="p">,</span> <span class="s1">&#39;kcc [%]&#39;</span><span class="p">,</span> <span class="s2">&quot;ff [%]&quot;</span><span class="p">]:</span>
                <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">run_eigen</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">eigen_obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ZL&#39;</span><span class="p">,</span> <span class="s1">&#39;ZT&#39;</span><span class="p">,</span> <span class="s1">&#39;k_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;k_kick&#39;</span><span class="p">]:</span>
                <span class="n">result_dict_abci</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">run_abci</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">abci_obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="n">cav_var_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Ri&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;Req&#39;</span><span class="p">]</span>
        <span class="n">midcell_var_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cav_var_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cells</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">midcell_var_dict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cav_var_list</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i2</span><span class="si">}</span><span class="s1">_m</span><span class="si">{</span><span class="n">i3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">]</span>

        <span class="c1"># create random variables</span>
        <span class="n">multicell_mid_vars</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">n_cells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># EXAMPLE: p_true = np.array([1, 2, 3, 4, 5]).T</span>
            <span class="n">p_true</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">]]</span>
            <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">])</span>  <span class="c1"># How many variabels will be considered as random in our case 5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># EXAMPLE: p_true = np.array([1, 2, 3, 4, 5]).T</span>
            <span class="n">p_true</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">],</span> <span class="n">multicell_mid_vars</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">]]</span>
            <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">])</span> <span class="o">+</span> <span class="n">multicell_mid_vars</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;OC_R&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">])</span>  <span class="c1"># How many variabels will be considered as random in our case 5</span>
            <span class="c1"># rdim = rdim - (n_cells*2 - 1)  # &lt;- reduce dimension by making iris and equator radii to be equal</span>

        <span class="c1"># ic(rdim, multicell_mid_vars.size)</span>
        <span class="c1"># rdim = n_cells*3  # How many variables will be considered as random in our case 5</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;stroud3&#39;</span><span class="p">:</span>
            <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span><span class="p">,</span> <span class="n">bpoly_</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
            <span class="n">nodes_</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes_</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="c1"># nodes_, weights_ = cn_leg_03_1(rdim)  # &lt;- for some reason unknown this gives a less accurate answer.</span>
            <span class="c1"># the nodes are not the same as the custom function</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;stroud5&#39;</span><span class="p">:</span>
            <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">cn_leg_05_2</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;cn_gauss&#39;</span><span class="p">:</span>
            <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">cn_gauss</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;lhc&#39;</span><span class="p">:</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">rdim</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">nsamp</span> <span class="o">=</span> <span class="mi">3000</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nsamp</span><span class="p">)</span>
            <span class="c1"># ic(qmc.discrepancy(sample))</span>
            <span class="n">l_bounds</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
            <span class="n">u_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
            <span class="n">sample_scaled</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="n">u_bounds</span><span class="p">)</span>

            <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span> <span class="o">=</span> <span class="n">sample_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsamp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;load_from_file&#39;</span><span class="p">:</span>
            <span class="n">nodes_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;C:\Users\sosoho\DakotaProjects\Cavity\C3795_lhs\sim_result_table.dat&#39;</span><span class="p">,</span>
                                 <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">nodes_</span> <span class="o">=</span> <span class="n">nodes_</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">weights_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nodes_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># defaults to Stroud3</span>
            <span class="n">nodes_</span><span class="p">,</span> <span class="n">weights_</span><span class="p">,</span> <span class="n">bpoly_</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
            <span class="n">nodes_</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes_</span> <span class="o">-</span> <span class="mf">1.</span>

        <span class="c1"># save nodes</span>
        <span class="n">data_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nodes_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">data_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;nodes.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">data_table_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weights_</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
        <span class="n">data_table_w</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">projectDir</span><span class="si">}</span><span class="s1">\SimulationData\</span><span class="si">{</span><span class="n">analysis_folder</span><span class="si">}</span><span class="s1">\</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">\weights.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#  mean value of geometrical parameters</span>
        <span class="n">no_parm</span><span class="p">,</span> <span class="n">no_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nodes_</span><span class="p">)</span>

        <span class="n">sub_dir</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># the simulation runs at the quadrature points are saved to the key of mean value run</span>

        <span class="n">proc_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="n">uq_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be greater than zero&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Number of processes must be integer&#39;</span><span class="p">)</span>
            <span class="n">proc_count</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">proc_count</span> <span class="o">&gt;</span> <span class="n">no_sims</span><span class="p">:</span>
            <span class="n">proc_count</span> <span class="o">=</span> <span class="n">no_sims</span>

        <span class="n">share</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">no_sims</span> <span class="o">/</span> <span class="n">proc_count</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proc_count</span><span class="p">):</span>
            <span class="c1"># try:</span>
            <span class="n">end_already</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">proc_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">share</span> <span class="o">&lt;</span> <span class="n">no_sims</span><span class="p">:</span>
                    <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">share</span> <span class="o">+</span> <span class="n">share</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">no_sims</span><span class="p">)</span>
                    <span class="n">end_already</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">proc_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">end_already</span><span class="p">:</span>
                <span class="n">proc_keys_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">share</span><span class="p">,</span> <span class="n">no_sims</span><span class="p">)</span>

            <span class="n">processor_nodes</span> <span class="o">=</span> <span class="n">nodes_</span><span class="p">[:,</span> <span class="n">proc_keys_list</span><span class="p">]</span>
            <span class="n">processor_weights</span> <span class="o">=</span> <span class="n">weights_</span><span class="p">[</span><span class="n">proc_keys_list</span><span class="p">]</span>

            <span class="n">service</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">uq_multicell_s</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                <span class="n">n_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span>
                <span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">uq_path</span><span class="p">,</span>
                <span class="n">proc_keys_list</span><span class="p">,</span> <span class="n">processor_nodes</span><span class="p">,</span> <span class="n">processor_weights</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p_true</span><span class="p">))</span>

            <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># combine results from processes</span>
        <span class="n">qois_result_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_sims</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;table.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="s1">&#39;table.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">v_expe_fobj</span><span class="p">,</span> <span class="n">v_stdDev_fobj</span> <span class="o">=</span> <span class="n">weighted_mean_obj</span><span class="p">(</span><span class="n">Ttab_val_f</span><span class="p">,</span> <span class="n">weights_</span><span class="p">)</span>

        <span class="c1"># append results to dict</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eigen_obj_list</span><span class="p">):</span>
            <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;expe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_expe_fobj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;stdDev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_stdDev_fobj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;uq.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_dict_eigen</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)))</span></div>



<div class="viewcode-block" id="uq_multicell_s">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.uq_multicell_s">[docs]</a>
<span class="k">def</span> <span class="nf">uq_multicell_s</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">qois</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">,</span> <span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span>
                   <span class="n">key</span><span class="p">,</span> <span class="n">uq_path</span><span class="p">,</span> <span class="n">proc_keys_list</span><span class="p">,</span> <span class="n">processor_nodes</span><span class="p">,</span>
                   <span class="n">proc_num</span><span class="p">,</span> <span class="n">p_true</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">result_dict_eigen</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Ttab_val_f</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eigen_obj_list</span> <span class="o">=</span> <span class="n">qois</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qois</span><span class="p">:</span>
        <span class="n">result_dict_eigen</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expe&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;stdDev&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="n">proc_keys_list</span><span class="p">:</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">n_cells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">p_init_el</span> <span class="o">=</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">)]</span>
            <span class="n">p_init_er</span> <span class="o">=</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">]):,</span> <span class="n">i1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">)]</span>
            <span class="n">par_mid</span> <span class="o">=</span> <span class="n">p_init_el</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc_node</span> <span class="o">=</span> <span class="n">processor_nodes</span><span class="p">[:,</span> <span class="n">i1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">)]</span>
            <span class="c1"># # one dimension of nodes_ is dimension of number of variables. The variables must be expanded to the unreduced dimension</span>
            <span class="c1"># # by filling the missing slots with radius values. Insert from end of list, index(Req) + 7 and index(Ri) + 6</span>
            <span class="c1"># moved_val_indx = 7</span>
            <span class="c1"># proc_nodes_len = len(processor_nodes)</span>
            <span class="c1"># for i2 in range(2 * n_cells - 1):</span>
            <span class="c1">#     if i2 % 2 == 0:</span>
            <span class="c1">#         proc_node = np.insert(proc_node, proc_nodes_len - moved_val_indx + 7, proc_node[proc_nodes_len - moved_val_indx])</span>
            <span class="c1">#         # update index</span>
            <span class="c1">#         moved_val_indx += 7</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         proc_node = np.insert(proc_node, proc_nodes_len - moved_val_indx + 6, proc_node[proc_nodes_len - moved_val_indx])</span>
            <span class="c1">#         moved_val_indx += 5</span>

            <span class="c1"># p_init_el = processor_nodes[0:len(p_true[0]), i1 - min(proc_keys_list)]</span>
            <span class="c1"># p_init_m = processor_nodes[len(p_true[0]):len(p_true[0]) + p_true[1].size,</span>
            <span class="c1">#            i1 - min(proc_keys_list)].reshape(np.shape(p_true[1])[::-1]).T</span>
            <span class="c1"># p_init_er = processor_nodes[len(p_true[0]) + p_true[1].size:, i1 - min(proc_keys_list)]</span>

            <span class="n">p_init_el</span> <span class="o">=</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">)]</span>
            <span class="n">p_init_m</span> <span class="o">=</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">len</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                   <span class="n">i1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">p_init_er</span> <span class="o">=</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">processor_nodes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p_true</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">p_true</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:,</span> <span class="n">i1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">proc_keys_list</span><span class="p">)]</span>
            <span class="c1"># ic(proc_node, proc_node.shape)</span>

            <span class="c1"># p_init_el = p_true[0] + proc_node[0:len(p_true[0])]</span>
            <span class="c1"># p_init_m = p_true[1] + proc_node[len(p_true[0]):len(p_true[0])+p_true[1].size].reshape(np.shape(p_true[1]))</span>
            <span class="c1"># p_init_er = p_true[2] + proc_node[len(p_true[0])+p_true[1].size:]</span>

            <span class="n">par_mid</span> <span class="o">=</span> <span class="n">p_init_m</span>

        <span class="n">par_end_l</span> <span class="o">=</span> <span class="n">p_init_el</span>
        <span class="n">par_end_r</span> <span class="o">=</span> <span class="n">p_init_er</span>

        <span class="n">fid</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_Q</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># check if folder already exist (simulation already completed)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/monopole/qois.json&#39;</span><span class="p">):</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processor </span><span class="si">{</span><span class="n">proc_num</span><span class="si">}</span><span class="s1"> skipped &#39;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;Result already exists.&#39;</span><span class="p">)</span>

        <span class="c1"># skip analysis if folder already exists.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">ngsolve_mevp</span>
            <span class="c1">#  run model using SLANS or CST</span>
            <span class="c1"># # create folders for all keys</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

            <span class="n">solver</span><span class="o">.</span><span class="n">cavity_multicell</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_modules</span><span class="p">,</span> <span class="n">par_mid</span><span class="p">,</span> <span class="n">par_end_l</span><span class="p">,</span> <span class="n">par_end_r</span><span class="p">,</span>
                                    <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="n">f_shift</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
                                    <span class="n">beampipes</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">],</span>
                                    <span class="n">parentDir</span><span class="o">=</span><span class="n">parentDir</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">uq_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/monopole/qois.json&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">qois_result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">qois_result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>

            <span class="n">qois_result</span> <span class="o">=</span> <span class="n">get_qoi_value</span><span class="p">(</span><span class="n">qois_result_dict</span><span class="p">,</span> <span class="n">eigen_obj_list</span><span class="p">)</span>
            <span class="c1"># sometimes some degenerate shapes are still generated and the solver returns zero</span>
            <span class="c1"># for the objective functions, such shapes are considered invalid</span>
            <span class="c1"># for objr in qois_result:</span>
            <span class="c1">#     if objr == 0:</span>
            <span class="c1">#         # skip key</span>
            <span class="c1">#         err = True</span>
            <span class="c1">#         break</span>

            <span class="n">tab_val_f</span> <span class="o">=</span> <span class="n">qois_result</span>
            <span class="n">Ttab_val_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab_val_f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># save table</span>
    <span class="n">data_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Ttab_val_f</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">eigen_obj_list</span><span class="p">))</span>
    <span class="n">data_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">uq_path</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;table_</span><span class="si">{</span><span class="n">proc_num</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.32f</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_wakefield_objectives_value">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.get_wakefield_objectives_value">[docs]</a>
<span class="k">def</span> <span class="nf">get_wakefield_objectives_value</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">objectives_unprocessed</span><span class="p">,</span> <span class="n">abci_data_dir</span><span class="p">):</span>
    <span class="n">k_loss_array_transverse</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">k_loss_array_longitudinal</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">k_loss_M0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># create list to hold Z</span>
    <span class="n">Zmax_mon_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Zmax_dip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xmax_mon_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xmax_dip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processed_keys_mon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processed_keys_dip</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">calc_k_loss</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">abci_data_long</span> <span class="o">=</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">abci_data_trans</span> <span class="o">=</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># trans</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_trans</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Real Part of Transverse Impedance&#39;</span><span class="p">)</span>
            <span class="n">k_loss_trans</span> <span class="o">=</span> <span class="n">abci_data_trans</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">k_loss_trans</span><span class="p">):</span>
                <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered an exception: Check shape </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># long</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_long</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Real Part of Longitudinal Impedance&#39;</span><span class="p">)</span>
            <span class="n">abci_data_long</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Loss Factor Spectrum Integrated up to F&#39;</span><span class="p">)</span>

            <span class="n">k_M0</span> <span class="o">=</span> <span class="n">abci_data_long</span><span class="o">.</span><span class="n">y_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k_loss_long</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">abci_data_long</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">])</span>
            <span class="n">k_loss_HOM</span> <span class="o">=</span> <span class="n">k_loss_long</span> <span class="o">-</span> <span class="n">k_M0</span>

            <span class="c1"># append only after successful run</span>
            <span class="n">k_loss_M0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_M0</span><span class="p">)</span>
            <span class="n">k_loss_array_longitudinal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_loss_HOM</span><span class="p">)</span>
            <span class="n">k_loss_array_transverse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_loss_trans</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">k_loss_M0</span><span class="p">,</span> <span class="n">k_loss_array_longitudinal</span><span class="p">,</span> <span class="n">k_loss_array_transverse</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_Zmax_L</span><span class="p">(</span><span class="n">mon_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mon_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mon_interval</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2e10</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">abci_data_mon</span> <span class="o">=</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c1"># get longitudinal and transverse impedance plot data</span>
                <span class="n">xr_mon</span><span class="p">,</span> <span class="n">yr_mon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_mon</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Real Part of Longitudinal Impedance&#39;</span><span class="p">)</span>
                <span class="n">xi_mon</span><span class="p">,</span> <span class="n">yi_mon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_mon</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Imaginary Part of Longitudinal Impedance&#39;</span><span class="p">)</span>

                <span class="c1"># Zmax</span>
                <span class="k">if</span> <span class="n">mon_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mon_interval</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]]</span>

                <span class="c1"># calculate magnitude</span>
                <span class="n">ymag_mon</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">yr_mon</span><span class="p">,</span> <span class="n">yi_mon</span><span class="p">)]</span>

                <span class="c1"># get peaks</span>
                <span class="n">peaks_mon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ymag_mon</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">xp_mon</span><span class="p">,</span> <span class="n">yp_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xr_mon</span><span class="p">)[</span><span class="n">peaks_mon</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ymag_mon</span><span class="p">)[</span><span class="n">peaks_mon</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_bound</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mon_interval</span><span class="p">):</span>
                    <span class="c1"># get mask</span>
                    <span class="n">msk_mon</span> <span class="o">=</span> <span class="p">[(</span><span class="n">z_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xp_mon</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_mon</span><span class="p">[</span><span class="n">msk_mon</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">Zmax_mon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yp_mon</span><span class="p">[</span><span class="n">msk_mon</span><span class="p">])</span>

                        <span class="n">Zmax_mon_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zmax_mon</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_mon</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">Zmax_mon_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span><span class="p">(</span><span class="s2">&quot;skipped, yp_mon = [], raise exception&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>

                <span class="n">processed_keys_mon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipped, yp_mon = []&quot;</span><span class="p">)</span>
                <span class="c1"># for i, z_bound in enumerate(mon_interval):</span>
                <span class="c1">#     Zmax_mon_list[i].append(-1)</span>

        <span class="k">return</span> <span class="n">Zmax_mon_list</span>

    <span class="k">def</span> <span class="nf">get_Zmax_T</span><span class="p">(</span><span class="n">dip_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dip_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dip_interval</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2e10</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">abci_data_dip</span> <span class="o">=</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">xr_dip</span><span class="p">,</span> <span class="n">yr_dip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_dip</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Real Part of Transverse Impedance&#39;</span><span class="p">)</span>
                <span class="n">xi_dip</span><span class="p">,</span> <span class="n">yi_dip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_dip</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Imaginary Part of Transverse Impedance&#39;</span><span class="p">)</span>

                <span class="c1"># Zmax</span>
                <span class="k">if</span> <span class="n">dip_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dip_interval</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]]</span>

                <span class="c1"># calculate magnitude</span>
                <span class="n">ymag_dip</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">yr_dip</span><span class="p">,</span> <span class="n">yi_dip</span><span class="p">)]</span>

                <span class="c1"># get peaks</span>
                <span class="n">peaks_dip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ymag_dip</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">xp_dip</span><span class="p">,</span> <span class="n">yp_dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xr_dip</span><span class="p">)[</span><span class="n">peaks_dip</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ymag_dip</span><span class="p">)[</span><span class="n">peaks_dip</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_bound</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dip_interval</span><span class="p">):</span>
                    <span class="c1"># get mask</span>
                    <span class="n">msk_dip</span> <span class="o">=</span> <span class="p">[(</span><span class="n">z_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xp_dip</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_dip</span><span class="p">[</span><span class="n">msk_dip</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">Zmax_dip</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yp_dip</span><span class="p">[</span><span class="n">msk_dip</span><span class="p">])</span>

                        <span class="n">Zmax_dip_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zmax_dip</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_dip</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">Zmax_dip_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span><span class="p">(</span><span class="s2">&quot;skipped, yp_dip = [], raise exception&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>

                <span class="n">processed_keys_dip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;skipped, yp_dip = []&quot;</span><span class="p">)</span>
                <span class="c1"># for i, z_bound in enumerate(dip_interval):</span>
                <span class="c1">#     Zmax_dip_list[i].append(-1)</span>

        <span class="k">return</span> <span class="n">Zmax_dip_list</span>

    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="n">mon_interval</span><span class="p">,</span> <span class="n">dip_interval</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">abci_data_long</span> <span class="o">=</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">abci_data_trans</span> <span class="o">=</span> <span class="n">ABCIData</span><span class="p">(</span><span class="n">abci_data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># get longitudinal and transverse impedance plot data</span>
            <span class="n">xr_mon</span><span class="p">,</span> <span class="n">yr_mon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_long</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Real Part of Longitudinal Impedance&#39;</span><span class="p">)</span>
            <span class="n">xi_mon</span><span class="p">,</span> <span class="n">yi_mon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_long</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Imaginary Part of Longitudinal Impedance&#39;</span><span class="p">)</span>

            <span class="n">xr_dip</span><span class="p">,</span> <span class="n">yr_dip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_trans</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Real Part of Transverse Impedance&#39;</span><span class="p">)</span>
            <span class="n">xi_dip</span><span class="p">,</span> <span class="n">yi_dip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">abci_data_trans</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Imaginary Part of Transverse Impedance&#39;</span><span class="p">)</span>

            <span class="c1"># loss factors</span>
            <span class="c1"># trans</span>
            <span class="n">k_loss_trans</span> <span class="o">=</span> <span class="n">abci_data_trans</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">k_loss_trans</span><span class="p">):</span>
                <span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered an exception: Check shape </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># long</span>
            <span class="n">abci_data_long</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Loss Factor Spectrum Integrated upto F&#39;</span><span class="p">)</span>

            <span class="n">k_M0</span> <span class="o">=</span> <span class="n">abci_data_long</span><span class="o">.</span><span class="n">y_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k_loss_long</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">abci_data_long</span><span class="o">.</span><span class="n">loss_factor</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">])</span>
            <span class="n">k_loss_HOM</span> <span class="o">=</span> <span class="n">k_loss_long</span> <span class="o">-</span> <span class="n">k_M0</span>

            <span class="c1"># calculate magnitude</span>
            <span class="n">ymag_mon</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">yr_mon</span><span class="p">,</span> <span class="n">yi_mon</span><span class="p">)]</span>
            <span class="n">ymag_dip</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">yr_dip</span><span class="p">,</span> <span class="n">yi_dip</span><span class="p">)]</span>

            <span class="c1"># get peaks</span>
            <span class="n">peaks_mon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ymag_mon</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xp_mon</span><span class="p">,</span> <span class="n">yp_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xr_mon</span><span class="p">)[</span><span class="n">peaks_mon</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ymag_mon</span><span class="p">)[</span><span class="n">peaks_mon</span><span class="p">]</span>

            <span class="n">peaks_dip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ymag_dip</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xp_dip</span><span class="p">,</span> <span class="n">yp_dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xr_dip</span><span class="p">)[</span><span class="n">peaks_dip</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ymag_dip</span><span class="p">)[</span><span class="n">peaks_dip</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_bound</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mon_interval</span><span class="p">):</span>
                <span class="c1"># get mask</span>
                <span class="n">msk_mon</span> <span class="o">=</span> <span class="p">[(</span><span class="n">z_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xp_mon</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_mon</span><span class="p">[</span><span class="n">msk_mon</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Zmax_mon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yp_mon</span><span class="p">[</span><span class="n">msk_mon</span><span class="p">])</span>
                    <span class="n">xmax_mon</span> <span class="o">=</span> <span class="n">xp_mon</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yp_mon</span> <span class="o">==</span> <span class="n">Zmax_mon</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">Zmax_mon_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zmax_mon</span><span class="p">)</span>
                    <span class="n">xmax_mon_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xmax_mon</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_mon</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Zmax_mon_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">xmax_mon_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_bound</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dip_interval</span><span class="p">):</span>
                <span class="c1"># get mask</span>
                <span class="n">msk_dip</span> <span class="o">=</span> <span class="p">[(</span><span class="n">z_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xp_dip</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_dip</span><span class="p">[</span><span class="n">msk_dip</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Zmax_dip</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yp_dip</span><span class="p">[</span><span class="n">msk_dip</span><span class="p">])</span>
                    <span class="n">xmax_dip</span> <span class="o">=</span> <span class="n">xp_dip</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yp_dip</span> <span class="o">==</span> <span class="n">Zmax_dip</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">Zmax_dip_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zmax_dip</span><span class="p">)</span>
                    <span class="n">xmax_dip_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xmax_dip</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">yp_dip</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Zmax_dip_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">xmax_dip_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="c1"># append only after successful run</span>

            <span class="n">k_loss_M0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_M0</span><span class="p">)</span>
            <span class="n">k_loss_array_longitudinal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_loss_HOM</span><span class="p">)</span>
            <span class="n">k_loss_array_transverse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_loss_trans</span><span class="p">)</span>

    <span class="n">ZL</span><span class="p">,</span> <span class="n">ZT</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">df_ZL</span><span class="p">,</span> <span class="n">df_ZT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objectives_unprocessed</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;ZL&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">freq_range</span> <span class="o">=</span> <span class="n">process_interval</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freq_range</span><span class="p">)):</span>
                <span class="n">Zmax_mon_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">xmax_mon_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">df_ZL</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> [max(</span><span class="si">{</span><span class="n">freq_range</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;f&lt;</span><span class="si">{</span><span class="n">freq_range</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">ZL</span> <span class="o">=</span> <span class="n">get_Zmax_L</span><span class="p">(</span><span class="n">freq_range</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;ZT&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">freq_range</span> <span class="o">=</span> <span class="n">process_interval</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freq_range</span><span class="p">)):</span>
                <span class="n">Zmax_dip_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">xmax_dip_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="c1"># df_ZT[obj[1]] = 0</span>
                <span class="n">df_ZT</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> [max(</span><span class="si">{</span><span class="n">freq_range</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;f&lt;</span><span class="si">{</span><span class="n">freq_range</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">ZT</span> <span class="o">=</span> <span class="n">get_Zmax_T</span><span class="p">(</span><span class="n">freq_range</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;k_loss&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;k_kick&quot;</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># create dataframes from list</span>
    <span class="n">df_ZL</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZL</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">df_ZT</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZT</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">df_ZL</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_keys_mon</span>
    <span class="n">df_ZT</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_keys_dip</span>

    <span class="n">processed_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">processed_keys_mon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">processed_keys_dip</span><span class="p">))</span>

    <span class="c1"># ZL, ZT = np.array(ZL).T, np.array(ZT).T</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df_wake</span> <span class="o">=</span> <span class="n">df_ZL</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_ZT</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="c1"># obj_result = np.hstack((ZL, ZT))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df_wake</span> <span class="o">=</span> <span class="n">df_ZL</span>
        <span class="c1"># obj_result = ZL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_wake</span> <span class="o">=</span> <span class="n">df_ZT</span>
        <span class="c1"># obj_result = ZT</span>

    <span class="k">return</span> <span class="n">df_wake</span><span class="p">,</span> <span class="n">processed_keys</span></div>



<div class="viewcode-block" id="process_interval">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.process_interval">[docs]</a>
<span class="k">def</span> <span class="nf">process_interval</span><span class="p">(</span><span class="n">interval_list</span><span class="p">):</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interval_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">interval</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">interval_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">interval_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">interval</span></div>



<div class="viewcode-block" id="get_qois_value">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.get_qois_value">[docs]</a>
<span class="k">def</span> <span class="nf">get_qois_value</span><span class="p">(</span><span class="n">f_fm</span><span class="p">,</span> <span class="n">R_Q</span><span class="p">,</span> <span class="n">k_loss</span><span class="p">,</span> <span class="n">k_kick</span><span class="p">,</span> <span class="n">sigma_z</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">n_cell</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span>
    <span class="n">w_fm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">f_fm</span> <span class="o">*</span> <span class="mf">1e6</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">1.602e-19</span>

    <span class="n">k_fm</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_fm</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_Q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">w_fm</span> <span class="o">*</span> <span class="n">sigma_z</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">/</span> <span class="n">c</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-12</span>
    <span class="n">k_hom</span> <span class="o">=</span> <span class="n">k_loss</span> <span class="o">-</span> <span class="n">k_fm</span>
    <span class="n">p_hom</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_hom</span> <span class="o">*</span> <span class="mf">1e12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">I0</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">*</span> <span class="mf">1e11</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n cell&quot;</span><span class="p">:</span> <span class="n">n_cell</span><span class="p">,</span>
        <span class="c1"># &quot;freq [MHz]&quot;: f_fm,</span>
        <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">:</span> <span class="n">R_Q</span><span class="p">,</span>
        <span class="s2">&quot;k_FM [V/pC]&quot;</span><span class="p">:</span> <span class="n">k_fm</span><span class="p">,</span>
        <span class="s2">&quot;I0 [mA]&quot;</span><span class="p">:</span> <span class="n">I0</span><span class="p">,</span>
        <span class="s2">&quot;sigma_z [mm]&quot;</span><span class="p">:</span> <span class="n">sigma_z</span><span class="p">,</span>
        <span class="s2">&quot;Nb [1e11]&quot;</span><span class="p">:</span> <span class="n">Nb</span><span class="p">,</span>
        <span class="s2">&quot;|k_loss| [V/pC]&quot;</span><span class="p">:</span> <span class="n">k_loss</span><span class="p">,</span>
        <span class="s2">&quot;|k_kick| [V/pC/m]&quot;</span><span class="p">:</span> <span class="n">k_kick</span><span class="p">,</span>
        <span class="s2">&quot;P_HOM [kW]&quot;</span><span class="p">:</span> <span class="n">p_hom</span> <span class="o">*</span> <span class="mf">1e-3</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="process_objectives">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.process_objectives">[docs]</a>
<span class="k">def</span> <span class="nf">process_objectives</span><span class="p">(</span><span class="n">objectives</span><span class="p">):</span>
    <span class="n">processed_objectives</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objectives</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ZL&quot;</span> <span class="ow">or</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ZT&quot;</span><span class="p">:</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">freq_ranges</span> <span class="o">=</span> <span class="n">process_interval</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freq_ranges</span><span class="p">:</span>
                <span class="n">processed_objectives</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">goal</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> [max(</span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;f&lt;</span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)]&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
                <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">goal</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span>
                <span class="n">processed_objectives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processed_objectives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">processed_objectives</span><span class="p">,</span> <span class="n">weights</span></div>



<div class="viewcode-block" id="show_valid_operating_point_structure">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.show_valid_operating_point_structure">[docs]</a>
<span class="k">def</span> <span class="nf">show_valid_operating_point_structure</span><span class="p">():</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;&lt;wp1&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;I0 [mA]&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;value&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nb [1e11]&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;value&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma_z (SR/BS) [mm]&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;value&gt;&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;&lt;wp2&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;I0 [mA]&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;value&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nb [1e11]&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;value&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma_z (SR/BS) [mm]&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;value&gt;&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">info</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_surface_resistance">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.get_surface_resistance">[docs]</a>
<span class="k">def</span> <span class="nf">get_surface_resistance</span><span class="p">(</span><span class="n">Eacc</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">Rs_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Rs_NbCu_2K_400.79Mhz&quot;</span><span class="p">:</span> <span class="mf">0.57</span> <span class="o">*</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mf">28.4</span><span class="p">,</span>  <span class="c1"># nOhm</span>
        <span class="s2">&quot;Rs_NbCu_4.5K_400.79Mhz&quot;</span><span class="p">:</span> <span class="mf">39.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.014</span> <span class="o">*</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span> <span class="o">+</span> <span class="mi">27</span><span class="p">,</span>  <span class="c1"># nOhm</span>
        <span class="s2">&quot;Rs_bulkNb_2K_400.79Mhz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">2.33</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">26.24</span><span class="p">,</span>  <span class="c1"># nOhm</span>
        <span class="s2">&quot;Rs_bulkNb_4.5K_400.79Mhz&quot;</span><span class="p">:</span> <span class="mf">0.0123</span> <span class="o">*</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">62.53</span><span class="p">,</span>  <span class="c1"># nOhm</span>

        <span class="s2">&quot;Rs_NbCu_2K_801.58Mhz&quot;</span><span class="p">:</span> <span class="mf">1.45</span> <span class="o">*</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">92</span><span class="p">,</span>  <span class="c1"># nOhm</span>
        <span class="s2">&quot;Rs_NbCu_4.5K_801.58Mhz&quot;</span><span class="p">:</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.033</span> <span class="o">*</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span> <span class="o">+</span> <span class="mi">154</span><span class="p">,</span>  <span class="c1"># nOhm</span>
        <span class="s2">&quot;Rs_bulkNb_2K_801.58Mhz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">16.4</span> <span class="o">+</span> <span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="mf">0.092</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">800</span> <span class="o">/</span> <span class="mi">704</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># nOhm</span>
        <span class="s2">&quot;Rs_bulkNb_4.5K_801.58Mhz&quot;</span><span class="p">:</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mf">62.7</span> <span class="o">+</span> <span class="p">(</span><span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.012</span><span class="p">)</span>  <span class="c1"># nOhm</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="mf">400.79</span>

    <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="mf">801.58</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">Rs_dict</span><span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;Rs_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">T</span><span class="si">}</span><span class="s2">K_</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s2">Mhz&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rs</span></div>



<div class="viewcode-block" id="axis_data_coords_sys_transform">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.axis_data_coords_sys_transform">[docs]</a>
<span class="k">def</span> <span class="nf">axis_data_coords_sys_transform</span><span class="p">(</span><span class="n">axis_obj_in</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; inverse = False : Axis =&gt; Data</span>
<span class="sd">                    = True  : Data =&gt; Axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis_obj_in</span><span class="o">.</span><span class="n">get_yscale</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">axis_obj_in</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">axis_obj_in</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="n">x_delta</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">x_out</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xin</span> <span class="o">*</span> <span class="n">x_delta</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">yin</span><span class="p">)</span> <span class="o">*</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="n">yin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_delta2</span> <span class="o">=</span> <span class="n">xin</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_out</span> <span class="o">=</span> <span class="n">x_delta2</span> <span class="o">/</span> <span class="n">x_delta</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yin</span> <span class="o">/</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">axis_obj_in</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">axis_obj_in</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="n">x_delta</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_delta</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">x_out</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xin</span> <span class="o">*</span> <span class="n">x_delta</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">yin</span> <span class="o">*</span> <span class="n">y_delta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_delta2</span> <span class="o">=</span> <span class="n">xin</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_delta2</span> <span class="o">=</span> <span class="n">yin</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_out</span> <span class="o">=</span> <span class="n">x_delta2</span> <span class="o">/</span> <span class="n">x_delta</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">y_delta2</span> <span class="o">/</span> <span class="n">y_delta</span>

    <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span></div>



<span class="k">def</span> <span class="nf">_get_nodes_and_weights</span><span class="p">(</span><span class="n">uq_config</span><span class="p">,</span> <span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">):</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
    <span class="n">uq_vars</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stroud3&#39;</span><span class="p">:</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">bpoly</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes</span> <span class="o">-</span> <span class="mf">1.</span>
        <span class="c1"># nodes, weights = cn_leg_03_1(rdim)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stroud5&#39;</span><span class="p">:</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">cn_leg_05_2</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">cn_gauss</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lhs&#39;</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">rdim</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">nsamp</span> <span class="o">=</span> <span class="n">uq_config</span><span class="p">[</span><span class="s1">&#39;integration&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nsamp</span><span class="p">)</span>

        <span class="n">l_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">))]</span>
        <span class="n">u_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uq_vars</span><span class="p">))]</span>
        <span class="n">sample_scaled</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="n">u_bounds</span><span class="p">)</span>

        <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">sample_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsamp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;from file&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># issue warning</span>
        <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Integration method not recognised. Defaulting to Stroud3 quadrature rule!&#39;</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">bpoly</span> <span class="o">=</span> <span class="n">quad_stroud3</span><span class="p">(</span><span class="n">rdim</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">nodes</span> <span class="o">-</span> <span class="mf">1.</span>

    <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span>


<div class="viewcode-block" id="add_text">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.add_text">[docs]</a>
<span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
             <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    text: str</span>
<span class="sd">        Matplotlib annotation text</span>
<span class="sd">    box</span>
<span class="sd">    xy: tuple</span>
<span class="sd">        Coordinates of annotation text</span>
<span class="sd">    xycoords: str {data, axis}</span>
<span class="sd">        Coordinate system reference</span>
<span class="sd">    xytext</span>
<span class="sd">    textcoords</span>
<span class="sd">    size</span>
<span class="sd">    rotation: float</span>
<span class="sd">        Annotation text rotation</span>
<span class="sd">    arrowprops</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># add text</span>
    <span class="k">if</span> <span class="n">xytext</span><span class="p">:</span>
        <span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">box</span><span class="p">),</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">annotext</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="n">xycoords</span><span class="p">,</span>
                               <span class="n">xytext</span><span class="o">=</span><span class="n">xytext</span><span class="p">,</span> <span class="n">textcoords</span><span class="o">=</span><span class="n">textcoords</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                               <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrowprops</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">box</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">annotext</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="n">xycoords</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                                   <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrowprops</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">box</span><span class="p">),</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">annotext</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="n">xycoords</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                                   <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrowprops</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">annotext</span></div>



<span class="k">def</span> <span class="nf">_data_uq_op</span><span class="p">(</span><span class="n">d_uq_op</span><span class="p">):</span>
    <span class="c1"># Initialize an empty list to store the rows</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate over the dictionary</span>
    <span class="k">for</span> <span class="n">main_key</span><span class="p">,</span> <span class="n">sub_dict</span> <span class="ow">in</span> <span class="n">d_uq_op</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">main_key</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">sub_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if the metric is one of the desired ones</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k_FM [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_loss| [V/pC]&#39;</span><span class="p">,</span> <span class="s1">&#39;|k_kick| [V/pC/m]&#39;</span><span class="p">,</span> <span class="s1">&#39;P_HOM [kW]&#39;</span><span class="p">]:</span>
                    <span class="c1"># Create a new key combining the metric and the sub_key</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sub_key</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="c1"># Add the value to the row</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Add the row to the list</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># Convert the list of rows into a DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>


<div class="viewcode-block" id="show_welcome">
<a class="viewcode-back" href="../../cavsim2d.html#cavsim2d.cavity.show_welcome">[docs]</a>
<span class="k">def</span> <span class="nf">show_welcome</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;docs/images/cavsim2d_logo_1x.png&#39;</span><span class="p">)</span>

    <span class="c1"># Convert the image to base64</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">img_file</span><span class="p">:</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="c1"># HTML and CSS to display image and colourful text on the same line</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;div style=&quot;display: flex; align-items: center;&quot;&gt;</span>
<span class="s2">        &lt;img src=&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">encoded_image</span><span class="si">}</span><span class="s2">&quot; style=&quot;height: 32px;&quot;&gt;</span>
<span class="s2">        &lt;p style=&quot;margin: 0; font-size: 16px; </span>
<span class="s2">                  background: -webkit-linear-gradient(left, #EFC3CA, #5DE2E7, #FE9900, #E7DDFF, #FFDE59);</span>
<span class="s2">                  -webkit-background-clip: text; </span>
<span class="s2">                  -webkit-text-fill-color: transparent;&quot;&gt;</span>
<span class="s2">            &lt;b&gt;CAV-SIM-2D&lt;/b&gt; loaded successfully!</span>
<span class="s2">        &lt;/p&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Display the HTML</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Sosoho-Abasi Udongwo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>