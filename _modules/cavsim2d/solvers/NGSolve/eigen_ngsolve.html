<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cavsim2d.solvers.NGSolve.eigen_ngsolve &mdash; cavsim2d 13.08.2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css?v=7f9a90b1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=f5513fb5"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            cavsim2d
              <img src="../../../../_static/cavsim2d_logo_2x.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html#understanding-the-geometry-types">Understanding the geometry types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html#advanced">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html#parallelisation">Parallelisation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">cavsim2d</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">cavsim2d</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cavsim2d.solvers.NGSolve.eigen_ngsolve</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cavsim2d.solvers.NGSolve.eigen_ngsolve</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">tri</span>
<span class="kn">from</span> <span class="nn">cavsim2d.utils.shared_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">ngsolve</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ngsolve.webgui</span> <span class="kn">import</span> <span class="n">Draw</span>
<span class="kn">from</span> <span class="nn">netgen.occ</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">cavsim2d.utils.printing</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">mu0</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="mf">1e-7</span>
<span class="n">eps0</span> <span class="o">=</span> <span class="mf">8.85418782e-12</span>
<span class="n">c0</span> <span class="o">=</span> <span class="mi">299792458</span>


<div class="viewcode-block" id="NGSolveMEVP">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP">[docs]</a>
<span class="k">class</span> <span class="nc">NGSolveMEVP</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MEVP for accelerating cavities with NGSolve</span>

<span class="sd">        ..math:</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="NGSolveMEVP.ell_ips_grads">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.ell_ips_grads">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ell_ips_grads</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">x_center</span>  <span class="c1"># x-position of the center</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">y_center</span>  <span class="c1"># y-position of the center</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># radius on the x-axis</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>  <span class="c1"># radius on the y-axis</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">h</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="n">inidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pts</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">inidx</span><span class="p">]</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">inbox</span><span class="p">[</span><span class="n">inbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

        <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">Nps</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{},</span> <span class="mi">5</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nps</span><span class="p">):</span>
            <span class="c1"># get inbox midpoint</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">inbox</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inbox</span><span class="p">)</span> <span class="o">/</span> <span class="n">Nps</span><span class="p">)]</span>  <span class="c1"># &lt;- spline interpolation point</span>
            <span class="n">gipt</span> <span class="o">=</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span>  <span class="c1"># &lt;- gradient at interpolation point</span>

            <span class="n">ips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
            <span class="n">gipts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">gipt</span><span class="p">])</span>

            <span class="c1"># x = np.array([ip[0] * 0.98, ip[0] * 1.02])</span>
            <span class="c1"># y = gipt * x + ip[1] - gipt * ip[0]</span>
        <span class="c1">#         plt.plot(x, y)</span>
        <span class="c1">#         plt.scatter(ip[0], ip[1], s=10, c=&#39;r&#39;)</span>

        <span class="c1">#     # get inbox midpoint</span>
        <span class="c1">#     midpoint = inbox[int(len(inbox)/2)]</span>
        <span class="c1">#     grad_midpoint = b**2/(2*(midpoint[1]-k)) - (b**2/a**2)*((midpoint[0]-h)/(midpoint[1]-k))</span>

        <span class="c1">#     # get midpoint neighbour 1</span>
        <span class="c1">#     n1 = inbox[int(len(inbox)/4)]</span>
        <span class="c1">#     grad_n1 = b**2/(2*(n1[1]-k)) - (b**2/a**2)*((n1[0]-h)/(n1[1]-k))</span>

        <span class="c1">#     # get midpoint</span>
        <span class="c1">#     n2 = inbox[int(3*len(inbox)/4)]</span>
        <span class="c1">#     grad_n2 = b**2/(2*(n2[1]-k)) - (b**2/a**2)*((n2[0]-h)/(n2[1]-k))</span>

        <span class="c1">#     x = np.array([midpoint[0]*0.98, midpoint[0]*1.02])</span>
        <span class="c1">#     y = grad_midpoint*x + midpoint[1] - grad_midpoint*midpoint[0]</span>

        <span class="c1">#     x1 = np.array([n1[0]*0.98, n1[0]*1.02])</span>
        <span class="c1">#     y1 = grad_n1*x1 + n1[1] - grad_n1*n1[0]</span>

        <span class="c1">#     x2 = np.array([n2[0]*0.98, n2[0]*1.02])</span>
        <span class="c1">#     y2 = grad_n2*x2 + n2[1] - grad_n2*n2[0]</span>

        <span class="c1">#     plt.plot(inbox[:, 0], inbox[:, 1])</span>
        <span class="c1">#     plt.plot(x, y)</span>
        <span class="c1">#     plt.plot(x1, y1)</span>
        <span class="c1">#     plt.plot(x2, y2)</span>

        <span class="c1">#     # plot box</span>
        <span class="c1">#     xs, ys = start</span>
        <span class="c1">#     xe, ye = end</span>
        <span class="c1">#     plt.plot([xs, xe], [ys, ys], &#39;b&#39;)</span>
        <span class="c1">#     plt.plot([xs, xs], [ys, ye], &#39;b&#39;)</span>
        <span class="c1">#     plt.plot([xs, xe], [ye, ye], &#39;b&#39;)</span>
        <span class="c1">#     plt.plot([xe, xe], [ys, ye], &#39;b&#39;)</span>

        <span class="n">nlast</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span></div>


<div class="viewcode-block" id="NGSolveMEVP.write_geometry">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.write_geometry">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;simplecell&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        mid_cell: array like</span>
<span class="sd">            Mid cell cell geometric parameters</span>
<span class="sd">        end_cell_left: array like</span>
<span class="sd">            Left end cell cell geometric parameters</span>
<span class="sd">        end_cell_right: array like</span>
<span class="sd">            Right end cell cell geometric parameters</span>
<span class="sd">        beampipe: {&quot;none&quot;, &quot;both&quot;, &quot;left&quot;, &quot;right&quot;}</span>
<span class="sd">            Which sides to include beampipes</span>
<span class="sd">        plot: bool</span>
<span class="sd">            Show geometry after definition or not</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">mid_cell</span>

        <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">end_cell_left</span>

        <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_left</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_right</span>

        <span class="c1"># check if folder exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;There was a problem creating the directory for the simulation files. Please check folder.&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">\geodata.n&quot;</span>
        <span class="k">if</span> <span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;simplecell&#39;</span><span class="p">:</span>
            <span class="c1"># writeCavityForMultipac(file_path, n_cells, mid_cell, end_cell_left, end_cell_right, beampipe, plot=plot)</span>
            <span class="n">write_cavity_geometry_cli</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># writeCavityForMultipac_flat_top(file_path, n_cells, mid_cell, end_cell_left, end_cell_right, beampipe,</span>
            <span class="c1">#                                 plot=plot)</span>
            <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span>
                                              <span class="n">write</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.write_geometry_multicell">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.write_geometry_multicell">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geometry_multicell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder</span>
<span class="sd">        n_cells: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        mid_cell: array like</span>
<span class="sd">            Mid cell cell geometric parameters</span>
<span class="sd">        end_cell_left: array like</span>
<span class="sd">            Left end cell cell geometric parameters</span>
<span class="sd">        end_cell_right: array like</span>
<span class="sd">            Right end cell cell geometric parameters</span>
<span class="sd">        beampipe: {&quot;none&quot;, &quot;both&quot;, &quot;left&quot;, &quot;right&quot;}</span>
<span class="sd">            Which sides to include beampipes</span>
<span class="sd">        plot: bool</span>
<span class="sd">            Show geometry after definition or not</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_cells</span> <span class="o">=</span> <span class="n">n_cells</span>
        <span class="n">mid_cell</span> <span class="o">=</span> <span class="n">mid_cell</span>

        <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">end_cell_left</span>

        <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_left</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_right</span>

        <span class="n">beampipe</span> <span class="o">=</span> <span class="n">beampipe</span>

        <span class="c1"># check if folder exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;There was a problem creating the directory for the simulation files. Please check folder.&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">\geodata.n&quot;</span>
        <span class="k">if</span> <span class="n">cell_parameterisation</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
            <span class="n">writeCavityForMultipac_multicell</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span> <span class="n">beampipe</span><span class="p">,</span>
                                             <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write_cavity_geometry_cli_flattop</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">n_cell</span><span class="o">=</span><span class="n">n_cells</span><span class="p">,</span>
                                              <span class="n">write</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.cavgeom_ngsolve">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.cavgeom_ngsolve">[docs]</a>
    <span class="k">def</span> <span class="nf">cavgeom_ngsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cell</span><span class="p">,</span> <span class="n">mid_cell</span><span class="p">,</span> <span class="n">end_cell_left</span><span class="p">,</span> <span class="n">end_cell_right</span><span class="p">,</span> <span class="n">beampipe</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write cavity geometry to be used by Multipac for multipacting analysis</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_cell: int</span>
<span class="sd">            Number of cavity cells</span>
<span class="sd">        mid_cell: list, ndarray</span>
<span class="sd">            Array of cavity middle cells&#39; geometric parameters</span>
<span class="sd">        end_cell_left: list, ndarray</span>
<span class="sd">            Array of cavity left end cell&#39;s geometric parameters</span>
<span class="sd">        end_cell_right: list, ndarray</span>
<span class="sd">            Array of cavity left end cell&#39;s geometric parameters</span>
<span class="sd">        beampipe: str {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        draw: bool</span>
<span class="sd">            If True, the cavity geometry is plotted for viewing</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_cell_left</span> <span class="o">=</span> <span class="n">mid_cell</span>

        <span class="k">if</span> <span class="n">end_cell_right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end_cell_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">mid_cell</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_cell_right</span> <span class="o">=</span> <span class="n">end_cell_left</span>

        <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cell</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="n">L_el</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_left</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="n">L_er</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_cell_right</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># step in boundary points in mm</span>

        <span class="k">if</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L_m</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L_m</span>
        <span class="k">elif</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>  <span class="c1"># 4 * L_m  #</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>  <span class="c1"># 4 * L_m  #</span>
        <span class="k">elif</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L_m</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>
        <span class="k">elif</span> <span class="n">beampipe</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L_m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_bp_l</span> <span class="o">=</span> <span class="mf">0.000</span>  <span class="c1"># 4 * L_m  #</span>
            <span class="n">L_bp_r</span> <span class="o">=</span> <span class="mf">0.000</span>  <span class="c1"># 4 * L_m  #</span>

        <span class="c1"># calculate shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cell</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># calculate angles outside loop</span>
        <span class="c1"># CALCULATE x1_el, y1_el, x2_el, y2_el</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">,</span> <span class="n">L_el</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">)</span>
        <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">,</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># CALCULATE x1, y1, x2, y2</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L_m</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_l</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># CALCULATE x1_er, y1_er, x2_er, y2_er</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">tangent_coords</span><span class="p">(</span><span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">,</span> <span class="n">L_er</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L_bp_r</span><span class="p">)</span>
        <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span><span class="p">,</span> <span class="n">x2er</span><span class="p">,</span> <span class="n">y2er</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># start workplane</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>

        <span class="c1"># SHIFT POINT TO START POINT</span>
        <span class="n">start_point</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">])</span>  <span class="c1"># &lt;-</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">])</span>  <span class="c1"># &lt;- add left beampipe</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_el</span> <span class="o">+</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">a_el</span><span class="p">,</span> <span class="n">b_el</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y1el</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2el</span> <span class="o">-</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y2el</span> <span class="o">-</span> <span class="n">y1el</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw iris arc</span>

                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2el</span><span class="p">,</span> <span class="n">y2el</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">A_el</span><span class="p">,</span> <span class="n">B_el</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2el</span> <span class="o">-</span> <span class="n">x1el</span><span class="p">,</span> <span class="n">y2el</span> <span class="o">-</span> <span class="n">y1el</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">n_cell</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                           <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">],</span>
                                                           <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                    <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">)],</span>
                              <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2er</span> <span class="o">-</span> <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span> <span class="o">-</span> <span class="n">y2er</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>

                    <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>
                    <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                           <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ri_er</span><span class="p">],</span>
                                                           <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">])</span>
                    <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">)],</span>
                              <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2er</span> <span class="o">-</span> <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span> <span class="o">-</span> <span class="n">y2er</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>

                    <span class="c1"># calculate new shift</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                           <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">],</span>
                                                           <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                    <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">)],</span>
                              <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>

                    <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                    <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                           <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ri_m</span><span class="p">],</span>
                                                           <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                    <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">)],</span>
                              <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>

                    <span class="c1"># calculate new shift</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="p">(</span><span class="n">L_el</span> <span class="o">+</span> <span class="n">L_m</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">n_cell</span><span class="p">:</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw iris arc</span>

                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>

                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ri_m</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">]</span>

                <span class="c1"># calculate new shift</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_m</span> <span class="o">+</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw iris arc</span>

                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">shift</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">A_er</span><span class="p">,</span> <span class="n">B_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Req</span> <span class="o">-</span> <span class="n">B_er</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Req</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x2er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y2er</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="n">x2er</span> <span class="o">-</span> <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span> <span class="o">-</span> <span class="n">y2er</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>

                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">])</span>  <span class="c1"># &lt;- draw tangent line</span>

                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">x1er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">]</span>
                <span class="n">ips</span><span class="p">,</span> <span class="n">gipts</span><span class="p">,</span> <span class="n">nlast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_ips_grads</span><span class="p">(</span><span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span> <span class="o">+</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">a_er</span><span class="p">,</span> <span class="n">b_er</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ri_er</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y1er</span><span class="p">])</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">Spline</span><span class="p">([</span><span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="p">(</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">)],</span>
                          <span class="n">tangents</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">x2er</span> <span class="o">-</span> <span class="n">x1er</span><span class="p">,</span> <span class="n">y1er</span> <span class="o">-</span> <span class="n">y2er</span><span class="p">),</span> <span class="n">nlast</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">gipts</span><span class="p">})</span>  <span class="c1"># &lt;- draw left eq. arc</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">]</span>

        <span class="c1"># BEAM PIPE</span>
        <span class="c1"># reset shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_bp_r</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cell</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cell</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">Ri_er</span><span class="p">])</span>  <span class="c1"># &lt;- right beampipe</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cell</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L_m</span> <span class="o">+</span> <span class="n">L_el</span> <span class="o">+</span> <span class="n">L_er</span> <span class="o">+</span> <span class="n">L_bp_l</span> <span class="o">+</span> <span class="n">L_bp_r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
        <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>
        <span class="c1"># name the boundaries</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Draw(face)</span>

        <span class="k">return</span> <span class="n">face</span></div>


<div class="viewcode-block" id="NGSolveMEVP.cavity">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.cavity">[docs]</a>
    <span class="k">def</span> <span class="nf">cavity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_of_modules</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mid_cells_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_end_cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_end_cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
               <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="n">expansion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expansion_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deformation_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write geometry file and run eigenmode analysis with NGSolveMEVP</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pol</span>
<span class="sd">        expansion</span>
<span class="sd">        no_of_cells: int</span>
<span class="sd">            Number of cells</span>
<span class="sd">        no_of_modules: int</span>
<span class="sd">            Number of modules</span>
<span class="sd">        mid_cells_par: list, array like</span>
<span class="sd">            Mid cell geometric parameters -&gt; [A, B, a, b, Ri, L, Req, alpha]</span>
<span class="sd">        l_end_cell_par: list, array like</span>
<span class="sd">            Left end cell geometric parameters -&gt; [A_el, B_el, a_el, b_el, Ri_el, L_el, Req, alpha_el]</span>
<span class="sd">        r_end_cell_par: list, array like</span>
<span class="sd">            Right end cell geometric parameters -&gt; [A_er, B_er, a_er, b_er, Ri_er, L_er, Req, alpha_er]</span>
<span class="sd">        fid: int, str</span>
<span class="sd">            File id</span>
<span class="sd">        bc: int</span>
<span class="sd">            Boundary condition -&gt; 1:inner contour, 2:Electric wall Et = 0, 3:Magnetic Wall En = 0, 4:Axis, 5:metal</span>
<span class="sd">        f_shift: float</span>
<span class="sd">            Eigenvalue frequency shift</span>
<span class="sd">        beta: int, float</span>
<span class="sd">            Velocity ratio :math: `\\beta = \frac{v}{c}`</span>
<span class="sd">        n_modes: int</span>
<span class="sd">            Number of modes</span>
<span class="sd">        beampipes: {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        parentDir: str</span>
<span class="sd">            Parent directory</span>
<span class="sd">        projectDir: str</span>
<span class="sd">            Project directory</span>
<span class="sd">        subdir: str</span>
<span class="sd">            Sub directory to save simulation results to</span>
<span class="sd">        mesh: list [Jxy, Jxy_bp, Jxy_bp_y]</span>
<span class="sd">            Mesh definition for logical mesh:</span>
<span class="sd">            Jxy -&gt; Number of elements of logical mesh along JX and JY</span>
<span class="sd">            Jxy_bp -&gt; Number of elements of logical mesh along JX in beampipe</span>
<span class="sd">            Jxy_bp_y -&gt; Number of elements of logical mesh along JY in beampipe</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;monopole&#39;</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;dipole&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;monopole&#39;</span>

        <span class="c1"># change save directory</span>
        <span class="k">if</span> <span class="n">mesh_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mesh_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>
            <span class="c1"># consider making better. This was just an adhoc fix</span>
            <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/Optimisation/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change save directory</span>
            <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">mid_cells_par</span><span class="p">,</span> <span class="n">l_end_cell_par</span><span class="p">,</span> <span class="n">r_end_cell_par</span><span class="p">,</span> <span class="n">beampipes</span><span class="p">,</span>
                            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span><span class="p">):</span>
            <span class="c1"># read geometry</span>
            <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span><span class="p">,</span>
                                   <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">deformation_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cav_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_deform</span><span class="p">(</span><span class="n">no_of_cells</span><span class="p">,</span> <span class="n">cav_geom</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                                <span class="n">deformation_params</span><span class="p">)</span>
                <span class="c1"># save deformed cavity profile</span>
                <span class="n">cav_geom</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata_deformed.n&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># plt.plot(cav_geom[1], cav_geom[0], ls=&#39;--&#39;, lw=4)</span>
            <span class="c1"># plt.show()</span>

            <span class="n">pnts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cav_geom</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">*</span><span class="n">pnts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
            <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>

            <span class="c1"># # get face from ngsolve geom &lt;- coming later</span>
            <span class="c1"># face = self.cavgeom_ngsolve(no_of_cells, mid_cells_par, l_end_cell_par, r_end_cell_par, beampipes)</span>

            <span class="c1"># name the boundaries</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">geo</span> <span class="o">=</span> <span class="n">OCCGeometry</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># mesh</span>
            <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cells_par</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">maxh</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">mesh_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>

            <span class="c1"># try to generate mesh</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ngmesh</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">GenerateMesh</span><span class="p">(</span><span class="n">maxh</span><span class="o">=</span><span class="n">maxh</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to generate mesh:: &#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">ngmesh</span><span class="p">)</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># save mesh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_mesh</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>

            <span class="c1"># define finite element space</span>
            <span class="n">fes</span> <span class="o">=</span> <span class="n">HCurl</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dirichlet</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">TnT</span><span class="p">()</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>

            <span class="n">apre</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="n">Preconditioner</span><span class="p">(</span><span class="n">apre</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">TaskManager</span><span class="p">():</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="n">m</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="n">apre</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="c1"># freedof_matrix = a.mat.CreateSmoother(fes.FreeDofs())</span>

                <span class="c1"># build gradient matrix as sparse matrix (and corresponding scalar FESpace)</span>
                <span class="n">gradmat</span><span class="p">,</span> <span class="n">fesh1</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">CreateGradient</span><span class="p">()</span>

                <span class="n">gradmattrans</span> <span class="o">=</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">CreateTranspose</span><span class="p">()</span>  <span class="c1"># transpose sparse matrix</span>
                <span class="n">math1</span> <span class="o">=</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span> <span class="o">@</span> <span class="n">gradmat</span>  <span class="c1"># multiply matrices</span>
                <span class="n">math1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># fix the 1-dim kernel</span>
                <span class="n">invh1</span> <span class="o">=</span> <span class="n">math1</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">,</span> <span class="n">freedofs</span><span class="o">=</span><span class="n">fesh1</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

                <span class="c1"># build the Poisson projector with operator Algebra:</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">()</span> <span class="o">-</span> <span class="n">gradmat</span> <span class="o">@</span> <span class="n">invh1</span> <span class="o">@</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span>

                <span class="n">projpre</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">pre</span><span class="o">.</span><span class="n">mat</span>
                <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">PINVIT</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">projpre</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">no_of_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="n">mesh_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="n">printrates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">freq_fes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># &lt;- replace nan with zero</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evals</span><span class="p">):</span>
                <span class="n">freq_fes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

            <span class="c1"># plot results</span>
            <span class="n">gfu_E</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">gfu_H</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">)):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="n">gfu</span> <span class="o">=</span> <span class="n">GridFunction</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>
                <span class="n">gfu</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">gfu_E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gfu</span><span class="p">)</span>
                <span class="n">gfu_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">gfu</span><span class="p">))</span>

            <span class="c1"># save fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_fields</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">)</span>

            <span class="c1"># # alternative eigenvalue solver, but careful, mode numbering may change</span>
            <span class="c1"># u = GridFunction(fes, multidim=30, name=&#39;resonances&#39;)</span>
            <span class="c1"># lamarnoldi = ArnoldiSolver(a.mat, m.mat, fes.FreeDofs(),</span>
            <span class="c1">#                         list(u.vecs), shift=300)</span>

            <span class="c1"># save json file</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">mid_cells_par</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                     <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">l_end_cell_par</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                     <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">r_end_cell_par</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s2">/geometric_parameters.json&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

            <span class="c1"># qois = self.evaluate_qois(face, no_of_cells, Req, L, gfu_E, gfu_H, mesh, freq_fes)</span>
            <span class="n">qois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qois</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">freq_fes</span><span class="p">)</span>
            <span class="c1"># error(qois)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">qois</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not run eigenmode analysis due to error in geometry.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="NGSolveMEVP.cavity_multicell">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.cavity_multicell">[docs]</a>
    <span class="k">def</span> <span class="nf">cavity_multicell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_of_modules</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mid_cells_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_end_cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">r_end_cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                         <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">expansion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expansion_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">deformation_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write geometry file and run eigenmode analysis with NGSolveMEVP</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pol</span>
<span class="sd">        expansion</span>
<span class="sd">        no_of_cells: int</span>
<span class="sd">            Number of cells</span>
<span class="sd">        no_of_modules: int</span>
<span class="sd">            Number of modules</span>
<span class="sd">        mid_cells_par: list, ndarray</span>
<span class="sd">            Mid cell geometric parameters -&gt; [A, B, a, b, Ri, L, Req, alpha]</span>
<span class="sd">        l_end_cell_par: list, ndarray</span>
<span class="sd">            Left end cell geometric parameters -&gt; [A_el, B_el, a_el, b_el, Ri_el, L_el, Req, alpha_el]</span>
<span class="sd">        r_end_cell_par: list, ndarray</span>
<span class="sd">            Right end cell geometric parameters -&gt; [A_er, B_er, a_er, b_er, Ri_er, L_er, Req, alpha_er]</span>
<span class="sd">        fid: int, str</span>
<span class="sd">            File id</span>
<span class="sd">        bc: int</span>
<span class="sd">            Boundary condition -&gt; 1:inner contour, 2:Electric wall Et = 0, 3:Magnetic Wall En = 0, 4:Axis, 5:metal</span>
<span class="sd">        f_shift: float</span>
<span class="sd">            Eigenvalue frequency shift</span>
<span class="sd">        beta: int, float</span>
<span class="sd">            Velocity ratio :math: `\\beta = \frac{v}{c}`</span>
<span class="sd">        n_modes: int</span>
<span class="sd">            Number of modes</span>
<span class="sd">        beampipes: {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        parentDir: str</span>
<span class="sd">            Parent directory</span>
<span class="sd">        projectDir: str</span>
<span class="sd">            Project directory</span>
<span class="sd">        subdir: str</span>
<span class="sd">            Sub directory to save simulation results to</span>
<span class="sd">        mesh: list [Jxy, Jxy_bp, Jxy_bp_y]</span>
<span class="sd">            Mesh definition for logical mesh:</span>
<span class="sd">            Jxy -&gt; Number of elements of logical mesh along JX and JY</span>
<span class="sd">            Jxy_bp -&gt; Number of elements of logical mesh along JX in beampipe</span>
<span class="sd">            Jxy_bp_y -&gt; Number of elements of logical mesh along JY in beampipe</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;monopole&#39;</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;dipole&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;monopole&#39;</span>

        <span class="c1"># change save directory</span>
        <span class="k">if</span> <span class="n">mesh_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mesh_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>  <span class="c1"># consider making better. This was just an adhoc fix</span>
            <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/Optimisation/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change save directory</span>
            <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># write</span>
        <span class="c1"># st1 = time.time()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry_multicell</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">mid_cells_par</span><span class="p">,</span> <span class="n">l_end_cell_par</span><span class="p">,</span> <span class="n">r_end_cell_par</span><span class="p">,</span>
                                      <span class="n">beampipes</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># error(&#39;Time to write geom: &#39;, time.time()-st1)</span>

        <span class="c1"># read geometry</span>
        <span class="c1"># error(run_save_directory)</span>
        <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span><span class="p">,</span>
                               <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">skipfooter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">deformation_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cav_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_deform</span><span class="p">(</span><span class="n">no_of_cells</span><span class="p">,</span> <span class="n">cav_geom</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                            <span class="n">deformation_params</span><span class="p">)</span>
            <span class="c1"># save deformed cavity profile</span>
            <span class="n">cav_geom</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata_deformed.n&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># plt.plot(cav_geom[0], cav_geom[1])</span>
        <span class="c1"># plt.show()</span>

        <span class="n">pnts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cav_geom</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">*</span><span class="n">pnts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
        <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>

        <span class="c1"># # get face from ngsolve geom &lt;- coming later</span>
        <span class="c1"># face = self.cavgeom_ngsolve(no_of_cells, mid_cells_par, l_end_cell_par, r_end_cell_par, beampipes)</span>

        <span class="c1"># name the boundaries</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="n">OCCGeometry</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># mesh</span>
        <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_end_cell_par</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">maxh</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">mesh_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="c1"># error(maxh)</span>
        <span class="c1"># st1 = time.time()</span>
        <span class="n">ngmesh</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">GenerateMesh</span><span class="p">(</span><span class="n">maxh</span><span class="o">=</span><span class="n">maxh</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">ngmesh</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># save mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_mesh</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="c1"># error(&#39;Time to write geom: &#39;, time.time()-st1)</span>

        <span class="c1"># define finite element space</span>
        <span class="n">fes</span> <span class="o">=</span> <span class="n">HCurl</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dirichlet</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">TnT</span><span class="p">()</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>  <span class="c1">#.Assemble()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>  <span class="c1">#.Assemble()</span>

        <span class="n">apre</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="n">Preconditioner</span><span class="p">(</span><span class="n">apre</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">TaskManager</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">apre</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="c1"># freedof_matrix = a.mat.CreateSmoother(fes.FreeDofs())</span>

            <span class="c1"># build gradient matrix as sparse matrix (and corresponding scalar FESpace)</span>
            <span class="n">gradmat</span><span class="p">,</span> <span class="n">fesh1</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">CreateGradient</span><span class="p">()</span>

            <span class="n">gradmattrans</span> <span class="o">=</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">CreateTranspose</span><span class="p">()</span>  <span class="c1"># transpose sparse matrix</span>
            <span class="n">math1</span> <span class="o">=</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span> <span class="o">@</span> <span class="n">gradmat</span>  <span class="c1"># multiply matrices</span>
            <span class="n">math1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># fix the 1-dim kernel</span>
            <span class="n">invh1</span> <span class="o">=</span> <span class="n">math1</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">,</span> <span class="n">freedofs</span><span class="o">=</span><span class="n">fesh1</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

            <span class="c1"># build the Poisson projector with operator Algebra:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">()</span> <span class="o">-</span> <span class="n">gradmat</span> <span class="o">@</span> <span class="n">invh1</span> <span class="o">@</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span>

            <span class="n">projpre</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">pre</span><span class="o">.</span><span class="n">mat</span>
            <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">PINVIT</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">projpre</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">no_of_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="n">mesh_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">printrates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># error(&#39;Time to complete sim: &#39;, time.time()-start)</span>
        <span class="c1"># freq_fes = []</span>
        <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># &lt;- replace nan with zero</span>
        <span class="c1"># for i, lam in enumerate(evals):</span>
        <span class="n">freq_fes</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>

        <span class="c1"># plot results</span>
        <span class="n">gfu_E</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gfu_H</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">)):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">gfu</span> <span class="o">=</span> <span class="n">GridFunction</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>
            <span class="n">gfu</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">gfu_E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gfu</span><span class="p">)</span>
            <span class="n">gfu_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">gfu</span><span class="p">))</span>

        <span class="c1"># save fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_fields</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">)</span>

        <span class="c1"># # alternative eigenvalue solver, but careful, mode numbering may change</span>
        <span class="c1"># u = GridFunction(fes, multidim=30, name=&#39;resonances&#39;)</span>
        <span class="c1"># lamarnoldi = ArnoldiSolver(a.mat, m.mat, fes.FreeDofs(),</span>
        <span class="c1">#                         list(u.vecs), shift=300)</span>

        <span class="c1"># save json file</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">mid_cells_par</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">l_end_cell_par</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">r_end_cell_par</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s2">/geometric_parameters.json&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

        <span class="c1"># qois = self.evaluate_qois(face, no_of_cells, Req, L, gfu_E, gfu_H, mesh, freq_fes)</span>
        <span class="n">qois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qois</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">freq_fes</span><span class="p">)</span>
        <span class="c1"># error(qois)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">qois</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="NGSolveMEVP.cavity_flattop">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.cavity_flattop">[docs]</a>
    <span class="k">def</span> <span class="nf">cavity_flattop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_of_modules</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">mid_cells_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_end_cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_end_cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                       <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                       <span class="n">expansion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expansion_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">deformation_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write geometry file and run eigenmode analysis with NGSolveMEVP</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pol</span>
<span class="sd">        expansion</span>
<span class="sd">        no_of_cells: int</span>
<span class="sd">            Number of cells</span>
<span class="sd">        no_of_modules: int</span>
<span class="sd">            Number of modules</span>
<span class="sd">        mid_cells_par: list, array like</span>
<span class="sd">            Mid cell geometric parameters -&gt; [A, B, a, b, Ri, L, Req, alpha]</span>
<span class="sd">        l_end_cell_par: list, array like</span>
<span class="sd">            Left end cell geometric parameters -&gt; [A_el, B_el, a_el, b_el, Ri_el, L_el, Req, alpha_el]</span>
<span class="sd">        r_end_cell_par: list, array like</span>
<span class="sd">            Right end cell geometric parameters -&gt; [A_er, B_er, a_er, b_er, Ri_er, L_er, Req, alpha_er]</span>
<span class="sd">        fid: int, str</span>
<span class="sd">            File id</span>
<span class="sd">        bc: int</span>
<span class="sd">            Boundary condition -&gt; 1:inner contour, 2:Electric wall Et = 0, 3:Magnetic Wall En = 0, 4:Axis, 5:metal</span>
<span class="sd">        f_shift: float</span>
<span class="sd">            Eigenvalue frequency shift</span>
<span class="sd">        beta: int, float</span>
<span class="sd">            Velocity ratio :math: `\\beta = \frac{v}{c}`</span>
<span class="sd">        n_modes: int</span>
<span class="sd">            Number of modes</span>
<span class="sd">        beampipes: {&quot;left&quot;, &quot;right&quot;, &quot;both&quot;, &quot;none&quot;}</span>
<span class="sd">            Specify if beam pipe is on one or both ends or at no end at all</span>
<span class="sd">        parentDir: str</span>
<span class="sd">            Parent directory</span>
<span class="sd">        projectDir: str</span>
<span class="sd">            Project directory</span>
<span class="sd">        subdir: str</span>
<span class="sd">            Sub directory to save simulation results to</span>
<span class="sd">        mesh: list [Jxy, Jxy_bp, Jxy_bp_y]</span>
<span class="sd">            Mesh definition for logical mesh:</span>
<span class="sd">            Jxy -&gt; Number of elements of logical mesh along JX and JY</span>
<span class="sd">            Jxy_bp -&gt; Number of elements of logical mesh along JX in beampipe</span>
<span class="sd">            Jxy_bp_y -&gt; Number of elements of logical mesh along JY in beampipe</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;monopole&#39;</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;dipole&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;monopole&#39;</span>

        <span class="c1"># change save directory</span>
        <span class="k">if</span> <span class="n">mesh_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mesh_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>  <span class="c1"># consider making better. This was just an adhoc fix</span>
            <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/Optimisation/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change save directory</span>
            <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="c1"># write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_geometry</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">mid_cells_par</span><span class="p">,</span> <span class="n">l_end_cell_par</span><span class="p">,</span> <span class="n">r_end_cell_par</span><span class="p">,</span> <span class="n">beampipes</span><span class="p">,</span>
                            <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;flattop&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># read geometry</span>
        <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span><span class="p">,</span>
                               <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deformation_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cav_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_deform</span><span class="p">(</span><span class="n">no_of_cells</span><span class="p">,</span> <span class="n">cav_geom</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                            <span class="n">deformation_params</span><span class="p">)</span>
            <span class="c1"># save deformed cavity profile</span>
            <span class="n">cav_geom</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata_deformed.n&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># plt.plot(cav_geom[0], cav_geom[1])</span>
        <span class="c1"># plt.show()</span>

        <span class="n">pnts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cav_geom</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">*</span><span class="n">pnts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
        <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>

        <span class="c1"># # get face from ngsolve geom &lt;- coming later</span>
        <span class="c1"># face = self.cavgeom_ngsolve(no_of_cells, mid_cells_par, l_end_cell_par, r_end_cell_par, beampipes)</span>

        <span class="c1"># name the boundaries</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">geo</span> <span class="o">=</span> <span class="n">OCCGeometry</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># mesh</span>
        <span class="n">A_m</span><span class="p">,</span> <span class="n">B_m</span><span class="p">,</span> <span class="n">a_m</span><span class="p">,</span> <span class="n">b_m</span><span class="p">,</span> <span class="n">Ri_m</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mid_cells_par</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">maxh</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">mesh_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="n">ngmesh</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">GenerateMesh</span><span class="p">(</span><span class="n">maxh</span><span class="o">=</span><span class="n">maxh</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">ngmesh</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># save mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_mesh</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>

        <span class="c1"># define finite element space</span>
        <span class="n">fes</span> <span class="o">=</span> <span class="n">HCurl</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dirichlet</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">TnT</span><span class="p">()</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>

        <span class="n">apre</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="n">Preconditioner</span><span class="p">(</span><span class="n">apre</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">TaskManager</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">apre</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="c1"># freedof_matrix = a.mat.CreateSmoother(fes.FreeDofs())</span>

            <span class="c1"># build gradient matrix as sparse matrix (and corresponding scalar FESpace)</span>
            <span class="n">gradmat</span><span class="p">,</span> <span class="n">fesh1</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">CreateGradient</span><span class="p">()</span>

            <span class="n">gradmattrans</span> <span class="o">=</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">CreateTranspose</span><span class="p">()</span>  <span class="c1"># transpose sparse matrix</span>
            <span class="n">math1</span> <span class="o">=</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span> <span class="o">@</span> <span class="n">gradmat</span>  <span class="c1"># multiply matrices</span>
            <span class="n">math1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># fix the 1-dim kernel</span>
            <span class="n">invh1</span> <span class="o">=</span> <span class="n">math1</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">,</span> <span class="n">freedofs</span><span class="o">=</span><span class="n">fesh1</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

            <span class="c1"># build the Poisson projector with operator Algebra:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">()</span> <span class="o">-</span> <span class="n">gradmat</span> <span class="o">@</span> <span class="n">invh1</span> <span class="o">@</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span>

            <span class="n">projpre</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">pre</span><span class="o">.</span><span class="n">mat</span>
            <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">PINVIT</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">projpre</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">no_of_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="n">mesh_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">printrates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">freq_fes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># &lt;- replace nan with zero</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evals</span><span class="p">):</span>
            <span class="n">freq_fes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="c1"># plot results</span>
        <span class="n">gfu_E</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gfu_H</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">)):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">gfu</span> <span class="o">=</span> <span class="n">GridFunction</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>
            <span class="n">gfu</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">gfu_E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gfu</span><span class="p">)</span>
            <span class="n">gfu_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">gfu</span><span class="p">))</span>

        <span class="c1"># save fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_fields</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">)</span>

        <span class="c1"># save json file</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">mid_cells_par</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;flattop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="s1">&#39;OC&#39;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">l_end_cell_par</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;flattop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="s1">&#39;OC_R&#39;</span><span class="p">:</span> <span class="n">update_alpha</span><span class="p">(</span><span class="n">r_end_cell_par</span><span class="p">,</span> <span class="n">cell_parameterisation</span><span class="o">=</span><span class="s1">&#39;flattop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s2">/geometric_parameters.json&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

        <span class="n">qois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qois</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">freq_fes</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">qois</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="NGSolveMEVP.geometry_from_file">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.geometry_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">geometry_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="NGSolveMEVP.geometry_from_array">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.geometry_from_array">[docs]</a>
    <span class="k">def</span> <span class="nf">geometry_from_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="NGSolveMEVP.pillbox">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.pillbox">[docs]</a>
    <span class="k">def</span> <span class="nf">pillbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_of_modules</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cell_par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Monopole&#39;</span><span class="p">,</span> <span class="n">f_shift</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beampipes</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">expansion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expansion_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deformation_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;Monopole&#39;</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;dipole&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;monopole&#39;</span>

        <span class="c1"># change save directory</span>
        <span class="k">if</span> <span class="n">mesh_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mesh_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>
            <span class="c1"># consider making better. This was just an adhoc fix</span>
            <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/Optimisation/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change save directory</span>
            <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># write geometry</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span>
        <span class="n">write_pillbox_geometry</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">cell_par</span><span class="p">,</span> <span class="n">beampipes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="c1"># read geometry</span>
            <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span><span class="p">,</span>
                                   <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">deformation_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cav_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_deform</span><span class="p">(</span><span class="n">no_of_cells</span><span class="p">,</span> <span class="n">cav_geom</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                                <span class="n">deformation_params</span><span class="p">)</span>
                <span class="c1"># save deformed cavity profile</span>
                <span class="n">cav_geom</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata_deformed.n&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># plt.plot(cav_geom[1], cav_geom[0], ls=&#39;--&#39;, lw=4)</span>
            <span class="c1"># plt.show()</span>

            <span class="n">pnts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cav_geom</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">*</span><span class="n">pnts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
            <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>

            <span class="c1"># name the boundaries</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">geo</span> <span class="o">=</span> <span class="n">OCCGeometry</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># mesh</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">Req</span> <span class="o">=</span> <span class="n">cell_par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">maxh</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">mesh_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;mesh maxh&#39;</span><span class="p">,</span> <span class="n">maxh</span><span class="p">)</span>

            <span class="c1"># try to generate mesh</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ngmesh</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">GenerateMesh</span><span class="p">(</span><span class="n">maxh</span><span class="o">=</span><span class="n">maxh</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to generate mesh:: &#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">ngmesh</span><span class="p">)</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># save mesh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_mesh</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>

            <span class="c1"># define finite element space</span>
            <span class="n">fes</span> <span class="o">=</span> <span class="n">HCurl</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dirichlet</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">TnT</span><span class="p">()</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>

            <span class="n">apre</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="n">Preconditioner</span><span class="p">(</span><span class="n">apre</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">TaskManager</span><span class="p">():</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="n">m</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="n">apre</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>

                <span class="c1"># build gradient matrix as sparse matrix (and corresponding scalar FESpace)</span>
                <span class="n">gradmat</span><span class="p">,</span> <span class="n">fesh1</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">CreateGradient</span><span class="p">()</span>

                <span class="n">gradmattrans</span> <span class="o">=</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">CreateTranspose</span><span class="p">()</span>  <span class="c1"># transpose sparse matrix</span>
                <span class="n">math1</span> <span class="o">=</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span> <span class="o">@</span> <span class="n">gradmat</span>  <span class="c1"># multiply matrices</span>
                <span class="n">math1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># fix the 1-dim kernel</span>
                <span class="n">invh1</span> <span class="o">=</span> <span class="n">math1</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">,</span> <span class="n">freedofs</span><span class="o">=</span><span class="n">fesh1</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

                <span class="c1"># build the Poisson projector with operator Algebra:</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">()</span> <span class="o">-</span> <span class="n">gradmat</span> <span class="o">@</span> <span class="n">invh1</span> <span class="o">@</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span>

                <span class="n">projpre</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">pre</span><span class="o">.</span><span class="n">mat</span>
                <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">PINVIT</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">projpre</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">no_of_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="n">mesh_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="n">printrates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">freq_fes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># &lt;- replace nan with zero</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evals</span><span class="p">):</span>
                <span class="n">freq_fes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

            <span class="c1"># plot results</span>
            <span class="n">gfu_E</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">gfu_H</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">)):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="n">gfu</span> <span class="o">=</span> <span class="n">GridFunction</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>
                <span class="n">gfu</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">gfu_E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gfu</span><span class="p">)</span>
                <span class="n">gfu_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">gfu</span><span class="p">))</span>

            <span class="c1"># save fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_fields</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">)</span>

            <span class="c1"># # alternative eigenvalue solver, but careful, mode numbering may change</span>
            <span class="c1"># u = GridFunction(fes, multidim=30, name=&#39;resonances&#39;)</span>
            <span class="c1"># lamarnoldi = ArnoldiSolver(a.mat, m.mat, fes.FreeDofs(),</span>
            <span class="c1">#                         list(u.vecs), shift=300)</span>

            <span class="c1"># save json file</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IC&#39;</span><span class="p">:</span> <span class="n">cell_par</span><span class="p">}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s2">/geometric_parameters.json&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>

            <span class="n">qois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qois</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">,</span> <span class="n">no_of_cells</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">freq_fes</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\qois.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">qois</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not run eigenmode analysis due to error in geometry.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="NGSolveMEVP.vhf_gun">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.vhf_gun">[docs]</a>
    <span class="k">def</span> <span class="nf">vhf_gun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;monopole&#39;</span><span class="p">,</span> <span class="n">sim_folder</span><span class="o">=</span><span class="s1">&#39;NGSolveMEVP&#39;</span><span class="p">,</span> <span class="n">parentDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projectDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">mesh_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># variables</span>
        <span class="c1"># y1, T2, R2, L3, R4, L5, R6, R8, T9, R9, T10, R10, L11, R12, L13, R14, G, L_bp</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;monopole&#39;</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;dipole&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;monopole&#39;</span>

        <span class="c1"># change save directory</span>
        <span class="k">if</span> <span class="n">mesh_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mesh_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>
            <span class="c1"># consider making better. This was just an adhoc fix</span>
            <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectDir</span><span class="p">,</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/Optimisation/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change save directory</span>
            <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_save_directory</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">sim_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># write geometry</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span>
        <span class="n">write_gun_geometry</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="c1"># read geometry</span>
            <span class="n">cav_geom_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_save_directory</span><span class="si">}</span><span class="s1">\geodata.n&#39;</span><span class="p">,</span>
                                    <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

            <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">cav_geom_</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># plt.plot(cav_geom[1], cav_geom[0], ls=&#39;--&#39;, lw=4)</span>
            <span class="c1"># plt.show()</span>

            <span class="n">pnts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cav_geom</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;len of pts:: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnts</span><span class="p">))</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">*</span><span class="n">pnts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
            <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>

            <span class="c1"># print(&#39;edges_lehgth:: &#39;, len(face.edges), len(face.vertices))</span>
            <span class="n">save_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
                <span class="n">edge</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cav_geom_</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ii</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="c1"># print(edge.start)</span>
                <span class="n">save_points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">edge</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

            <span class="c1"># print([edge.name for edge in face.edges])</span>
            <span class="c1"># name the boundaries</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># face.edges.Min(X).name = &quot;l&quot;</span>
            <span class="c1"># face.edges.Min(X).col = (1, 0, 0)</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>
            <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;3.0&quot;</span><span class="p">:</span>
                    <span class="n">edge</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># print([edge.name for edge in face.edges])</span>
            <span class="n">Draw</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
            <span class="n">geo</span> <span class="o">=</span> <span class="n">OCCGeometry</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># try to generate mesh</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ngmesh</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">GenerateMesh</span><span class="p">(</span><span class="n">maxh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to generate mesh:: &#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">exit</span><span class="p">()</span>

            <span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">ngmesh</span><span class="p">)</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># save mesh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_mesh</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>

            <span class="c1"># define finite element space</span>
            <span class="n">fes</span> <span class="o">=</span> <span class="n">HCurl</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dirichlet</span><span class="o">=</span><span class="s1">&#39;2.0&#39;</span><span class="p">)</span>

            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">TnT</span><span class="p">()</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>

            <span class="n">apre</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="n">Preconditioner</span><span class="p">(</span><span class="n">apre</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">TaskManager</span><span class="p">():</span>
                <span class="n">a</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="n">m</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
                <span class="n">apre</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>

                <span class="c1"># build gradient matrix as sparse matrix (and corresponding scalar FESpace)</span>
                <span class="n">gradmat</span><span class="p">,</span> <span class="n">fesh1</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">CreateGradient</span><span class="p">()</span>

                <span class="n">gradmattrans</span> <span class="o">=</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">CreateTranspose</span><span class="p">()</span>  <span class="c1"># transpose sparse matrix</span>
                <span class="n">math1</span> <span class="o">=</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span> <span class="o">@</span> <span class="n">gradmat</span>  <span class="c1"># multiply matrices</span>
                <span class="n">math1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># fix the 1-dim kernel</span>
                <span class="n">invh1</span> <span class="o">=</span> <span class="n">math1</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">,</span> <span class="n">freedofs</span><span class="o">=</span><span class="n">fesh1</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

                <span class="c1"># build the Poisson projector with operator Algebra:</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">()</span> <span class="o">-</span> <span class="n">gradmat</span> <span class="o">@</span> <span class="n">invh1</span> <span class="o">@</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span>

                <span class="n">projpre</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">pre</span><span class="o">.</span><span class="n">mat</span>
                <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">PINVIT</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">projpre</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="n">mesh_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="n">printrates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">freq_fes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># &lt;- replace nan with zero</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evals</span><span class="p">):</span>
                <span class="n">freq_fes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="s1">&#39;freq: &#39;</span><span class="p">,</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s2">&quot;MHz&quot;</span><span class="p">)</span>

            <span class="c1"># plot results</span>
            <span class="n">gfu_E</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">gfu_H</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">)):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                <span class="n">gfu</span> <span class="o">=</span> <span class="n">GridFunction</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>
                <span class="n">gfu</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">gfu_E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gfu</span><span class="p">)</span>
                <span class="n">gfu_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">gfu</span><span class="p">))</span>

            <span class="c1"># save fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_fields</span><span class="p">(</span><span class="n">run_save_directory</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">)</span>

            <span class="c1"># # alternative eigenvalue solver, but careful, mode numbering may change</span>
            <span class="c1"># u = GridFunction(fes, multidim=30, name=&#39;resonances&#39;)</span>
            <span class="c1"># lamarnoldi = ArnoldiSolver(a.mat, m.mat, fes.FreeDofs(),</span>
            <span class="c1">#                         list(u.vecs), shift=300)</span>
            <span class="c1"># print(np.sort(c0*np.sqrt(lamarnoldi)/(2*np.pi) * 1e-6))</span>

            <span class="c1"># save json file</span>
            <span class="c1"># shape = {&#39;IC&#39;: cell_par}</span>
            <span class="c1"># # print(run_save_directory)</span>
            <span class="c1"># with open(Path(fr&quot;{run_save_directory}/geometric_parameters.json&quot;), &#39;w&#39;) as f:</span>
            <span class="c1">#     json.dump(shape, f, indent=4, separators=(&#39;,&#39;, &#39;: &#39;))</span>
            <span class="c1">#</span>
            <span class="c1"># qois = self.evaluate_qois(cav_geom, no_of_cells, Req, L, gfu_E, gfu_H, mesh, freq_fes)</span>
            <span class="c1">#</span>
            <span class="c1"># with open(fr&#39;{run_save_directory}\qois.json&#39;, &quot;w&quot;) as f:</span>
            <span class="c1">#     json.dump(qois, f, indent=4, separators=(&#39;,&#39;, &#39;: &#39;))</span>
            <span class="c1"># return True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not run eigenmode analysis due to error in geometry.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="NGSolveMEVP.eigen3d">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.eigen3d">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eigen3d</span><span class="p">(</span><span class="n">geometry_dir</span><span class="p">):</span>
        <span class="c1"># define geometry</span>
        <span class="n">cav_geom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;D:\Dropbox\multipacting\MPGUI21\geodata.n&#39;</span><span class="p">,</span>
                               <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">skipfooter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="n">pnts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cav_geom</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">WorkPlane</span><span class="p">()</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">MoveTo</span><span class="p">(</span><span class="o">*</span><span class="n">pnts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">LineTo</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="o">.</span><span class="n">Reverse</span><span class="p">()</span>
        <span class="n">face</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">Face</span><span class="p">()</span>

        <span class="c1"># name the boundaries</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
        <span class="n">face</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">Revolve</span><span class="p">(</span><span class="n">Axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">X</span><span class="p">),</span> <span class="mi">360</span><span class="p">)</span>
        <span class="n">Draw</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="n">OCCGeometry</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># mesh</span>
        <span class="n">ngmesh</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">GenerateMesh</span><span class="p">(</span><span class="n">maxh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">ngmesh</span><span class="p">)</span>

        <span class="c1"># define finite element space</span>
        <span class="n">fes</span> <span class="o">=</span> <span class="n">HCurl</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dirichlet</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">TnT</span><span class="p">()</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>

        <span class="n">apre</span> <span class="o">=</span> <span class="n">BilinearForm</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="n">Preconditioner</span><span class="p">(</span><span class="n">apre</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">TaskManager</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">apre</span><span class="o">.</span><span class="n">Assemble</span><span class="p">()</span>
            <span class="n">freedof_matrix</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">CreateSmoother</span><span class="p">(</span><span class="n">fes</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

            <span class="c1"># build gradient matrix as sparse matrix (and corresponding scalar FESpace)</span>
            <span class="n">gradmat</span><span class="p">,</span> <span class="n">fesh1</span> <span class="o">=</span> <span class="n">fes</span><span class="o">.</span><span class="n">CreateGradient</span><span class="p">()</span>

            <span class="n">gradmattrans</span> <span class="o">=</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">CreateTranspose</span><span class="p">()</span>  <span class="c1"># transpose sparse matrix</span>
            <span class="n">math1</span> <span class="o">=</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span> <span class="o">@</span> <span class="n">gradmat</span>  <span class="c1"># multiply matrices</span>
            <span class="n">math1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># fix the 1-dim kernel</span>
            <span class="n">invh1</span> <span class="o">=</span> <span class="n">math1</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;sparsecholesky&quot;</span><span class="p">,</span> <span class="n">freedofs</span><span class="o">=</span><span class="n">fesh1</span><span class="o">.</span><span class="n">FreeDofs</span><span class="p">())</span>

            <span class="c1"># build the Poisson projector with operator Algebra:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">()</span> <span class="o">-</span> <span class="n">gradmat</span> <span class="o">@</span> <span class="n">invh1</span> <span class="o">@</span> <span class="n">gradmattrans</span> <span class="o">@</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span>

            <span class="n">projpre</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">@</span> <span class="n">pre</span><span class="o">.</span><span class="n">mat</span>
            <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">PINVIT</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">projpre</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">printrates</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

        <span class="n">freq_fes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evals</span><span class="p">):</span>
            <span class="n">freq_fes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="c1"># plot results</span>
        <span class="n">gfu</span> <span class="o">=</span> <span class="n">GridFunction</span><span class="p">(</span><span class="n">fes</span><span class="p">,</span> <span class="n">multidim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evecs</span><span class="p">)):</span>
            <span class="n">gfu</span><span class="o">.</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>


        <span class="c1"># # alternative eigenvalue solver</span>
        <span class="c1"># u = GridFunction(fes, multidim=30, name=&#39;resonances&#39;)</span>
        <span class="c1"># lamarnoldi = ArnoldiSolver(a.mat, m.mat, fes.FreeDofs(),</span>
        <span class="c1">#                         list(u.vecs), shift=300)</span>

<div class="viewcode-block" id="NGSolveMEVP.evaluate_qois">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.evaluate_qois">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evaluate_qois</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">Req</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">freq_fes</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>

        <span class="c1"># calculate Vacc and Eacc</span>
        <span class="n">Vacc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Integrate</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">c0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">definedon</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">Boundaries</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)))</span>
        <span class="n">Eacc</span> <span class="o">=</span> <span class="n">Vacc</span> <span class="o">/</span> <span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>

        <span class="c1"># calculate U and R/Q</span>
        <span class="n">U</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">eps0</span> <span class="o">*</span> <span class="n">Integrate</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">InnerProduct</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">gfu_E</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="c1"># Uh = 2 * pi * 0.5 * mu0 * Integrate(y * InnerProduct(gfu_H[n], gfu_H[n]), mesh)</span>
        <span class="n">RoQ</span> <span class="o">=</span> <span class="n">Vacc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">U</span><span class="p">)</span>

        <span class="c1"># OLD GEOMETRY INPUT TYPE</span>
        <span class="c1"># calculate peak surface fields</span>
        <span class="n">xpnts_surf</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
        <span class="n">Esurf</span> <span class="o">=</span> <span class="p">[</span><span class="n">Norm</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">n</span><span class="p">])(</span><span class="n">mesh</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">))</span> <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="n">xpnts_surf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="n">Epk</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Esurf</span><span class="p">))</span>

        <span class="c1"># calculate peak surface fields</span>
        <span class="n">xpnts</span> <span class="o">=</span> <span class="n">cav_geom</span><span class="p">[(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
        <span class="n">Hsurf</span> <span class="o">=</span> <span class="p">[</span><span class="n">Norm</span><span class="p">(</span><span class="n">gfu_H</span><span class="p">[</span><span class="n">n</span><span class="p">])(</span><span class="n">mesh</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">))</span> <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="n">xpnts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="n">Hpk</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Hsurf</span><span class="p">))</span>

        <span class="c1"># # calculate peak surface fields</span>
        <span class="c1"># pec_boundary = mesh.Boundaries(&quot;default&quot;)</span>
        <span class="c1"># bel = [xx.vertices for xx in pec_boundary.Elements()]</span>
        <span class="c1"># bel_unique = list(set(itertools.chain(*bel)))</span>
        <span class="c1"># xpnts_surf = sorted([mesh.vertices[xy.nr].point for xy in bel_unique])</span>
        <span class="c1"># Esurf = [Norm(gfu_E[n])(mesh(xi, yi)) for xi, yi in xpnts_surf]</span>
        <span class="c1"># Epk = (max(Esurf))</span>
        <span class="c1">#</span>
        <span class="c1"># Hsurf = [Norm(gfu_H[n])(mesh(xi, yi)) for xi, yi in xpnts_surf]</span>
        <span class="c1"># Hpk = (max(Hsurf))</span>

        <span class="c1"># calculate surface power loss</span>
        <span class="n">sigma_cond</span> <span class="o">=</span> <span class="mf">5.96e7</span>  <span class="c1"># &lt;- conduction of copper</span>
        <span class="n">Rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_cond</span><span class="p">))</span>  <span class="c1"># Surface resistance</span>
        <span class="n">Ploss</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Rs</span> <span class="o">*</span> <span class="n">Integrate</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">InnerProduct</span><span class="p">(</span><span class="n">CF</span><span class="p">(</span><span class="n">Hsurf</span><span class="p">),</span> <span class="n">CF</span><span class="p">(</span><span class="n">Hsurf</span><span class="p">)),</span> <span class="n">mesh</span><span class="p">,</span>
                                              <span class="n">definedon</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">Boundaries</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span>

        <span class="c1"># calculate cell to cell coupling factor</span>
        <span class="n">f_diff</span> <span class="o">=</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq_fes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_add</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_fes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">freq_fes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">kcc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f_diff</span> <span class="o">/</span> <span class="n">f_add</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># calculate Q</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">U</span> <span class="o">/</span> <span class="n">Ploss</span>

        <span class="c1"># OLD</span>
        <span class="c1"># Get axis field</span>
        <span class="n">xpnts_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">cav_geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">Eax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Norm</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">n</span><span class="p">])(</span><span class="n">mesh</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">xpnts_ax</span><span class="p">])</span>

        <span class="c1"># # Get axis field</span>
        <span class="c1"># xmin = face.vertices.Min(X)</span>
        <span class="c1"># xmax = face.vertices.Max(X)</span>
        <span class="c1"># xpnts_ax = np.linspace(xmin.p[0], xmax.p[0], 100)</span>
        <span class="c1"># Eax = np.array([Norm(gfu_E[n])(mesh(xi, 0.0)) for xi in xpnts_ax])</span>

        <span class="c1"># calculate field flatness</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">Eax</span><span class="p">)</span>
        <span class="n">E_abs_peaks</span> <span class="o">=</span> <span class="n">Eax</span><span class="p">[</span><span class="n">peaks</span><span class="p">]</span>
        <span class="c1"># ff = min(E_abs_peaks)/max(E_abs_peaks) * 100</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">E_abs_peaks</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">E_abs_peaks</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">E_abs_peaks</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># calculate G</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">Rs</span>

        <span class="n">qois</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Req [mm]&quot;</span><span class="p">:</span> <span class="n">Req</span><span class="p">,</span>
            <span class="s2">&quot;Normalization Length [mm]&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span>
            <span class="s2">&quot;N Cells&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
            <span class="s2">&quot;freq [MHz]&quot;</span><span class="p">:</span> <span class="n">freq_fes</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
            <span class="s2">&quot;Q []&quot;</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span>
            <span class="s2">&quot;Vacc [MV]&quot;</span><span class="p">:</span> <span class="n">Vacc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="s2">&quot;Eacc [MV/m]&quot;</span><span class="p">:</span> <span class="n">Eacc</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="s2">&quot;Epk [MV/m]&quot;</span><span class="p">:</span> <span class="n">Epk</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="s2">&quot;Hpk [A/m]&quot;</span><span class="p">:</span> <span class="n">Hpk</span><span class="p">,</span>
            <span class="s2">&quot;Bpk [mT]&quot;</span><span class="p">:</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">Hpk</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span>
            <span class="s2">&quot;kcc [%]&quot;</span><span class="p">:</span> <span class="n">kcc</span><span class="p">,</span>
            <span class="s2">&quot;ff [%]&quot;</span><span class="p">:</span> <span class="n">ff</span><span class="p">,</span>
            <span class="s2">&quot;Rsh [MOhm]&quot;</span><span class="p">:</span> <span class="n">RoQ</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="s2">&quot;R/Q [Ohm]&quot;</span><span class="p">:</span> <span class="n">RoQ</span><span class="p">,</span>
            <span class="s2">&quot;Epk/Eacc []&quot;</span><span class="p">:</span> <span class="n">Epk</span> <span class="o">/</span> <span class="n">Eacc</span><span class="p">,</span>
            <span class="s2">&quot;Bpk/Eacc [mT/MV/m]&quot;</span><span class="p">:</span> <span class="n">mu0</span> <span class="o">*</span> <span class="n">Hpk</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">Eacc</span><span class="p">,</span>
            <span class="s2">&quot;G [Ohm]&quot;</span><span class="p">:</span> <span class="n">G</span><span class="p">,</span>
            <span class="s2">&quot;GR/Q [Ohm^2]&quot;</span><span class="p">:</span> <span class="n">G</span> <span class="o">*</span> <span class="n">RoQ</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">qois</span></div>


<div class="viewcode-block" id="NGSolveMEVP.save_fields">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.save_fields">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_fields</span><span class="p">(</span><span class="n">project_folder</span><span class="p">,</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">):</span>
        <span class="c1"># save mode fields</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_folder</span><span class="si">}</span><span class="s2">/gfu_EH.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.save_mesh">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.save_mesh">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_mesh</span><span class="p">(</span><span class="n">project_folder</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
        <span class="c1"># save mesh</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/mesh.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.load_fields">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.load_fields">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_fields</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/gfu_EH.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="p">[</span><span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span></div>


<div class="viewcode-block" id="NGSolveMEVP.load_mesh">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.load_mesh">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_mesh</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="c1"># pickle mesh and fields</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/mesh.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mesh</span></div>


<div class="viewcode-block" id="NGSolveMEVP.plot_fields">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.plot_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">):</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_mesh</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">gfu_E</span><span class="p">,</span> <span class="n">gfu_H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_fields</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotter</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>
            <span class="n">mesh_points</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span>
            <span class="n">E_values_mesh</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mesh_points_grid</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">mesh_points</span><span class="p">:</span>
                <span class="n">mesh_points_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>
                <span class="n">E_values_mesh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Norm</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">mode</span><span class="p">])(</span><span class="n">mesh</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="o">.</span><span class="n">point</span><span class="p">)))</span>

            <span class="n">mesh_points_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_points_grid</span><span class="p">)</span>
            <span class="n">xxt</span><span class="p">,</span> <span class="n">yyt</span> <span class="o">=</span> <span class="n">mesh_points_grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mesh_points_grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">triang</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">Triangulation</span><span class="p">(</span><span class="n">xxt</span><span class="p">,</span> <span class="n">yyt</span><span class="p">)</span>

            <span class="c1"># plot only triangles with sidelength smaller some max_radius</span>
            <span class="n">max_radius</span> <span class="o">=</span> <span class="mf">0.02</span>
            <span class="n">triangles</span> <span class="o">=</span> <span class="n">triang</span><span class="o">.</span><span class="n">triangles</span>
            <span class="c1"># Mask unwanted triangles.</span>
            <span class="n">xtri</span> <span class="o">=</span> <span class="n">xxt</span><span class="p">[</span><span class="n">triangles</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">xxt</span><span class="p">[</span><span class="n">triangles</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ytri</span> <span class="o">=</span> <span class="n">yyt</span><span class="p">[</span><span class="n">triangles</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">yyt</span><span class="p">[</span><span class="n">triangles</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xtri</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ytri</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">triang</span><span class="o">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xtri</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_radius</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">triang</span><span class="p">,</span> <span class="n">E_values_mesh</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
                <span class="n">Draw</span><span class="p">(</span><span class="n">Norm</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">mode</span><span class="p">]),</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Draw</span><span class="p">(</span><span class="n">Norm</span><span class="p">(</span><span class="n">gfu_E</span><span class="p">[</span><span class="n">mode</span><span class="p">]),</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.plot_mesh">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.plot_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="s1">&#39;ngsolve&#39;</span><span class="p">):</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_mesh</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotter</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>

            <span class="n">mesh_points</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span>
            <span class="n">mesh_points_grid</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">mesh_points</span><span class="p">:</span>
                <span class="n">mesh_points_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>

            <span class="n">mesh_points_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_points_grid</span><span class="p">)</span>
            <span class="n">xxt</span><span class="p">,</span> <span class="n">yyt</span> <span class="o">=</span> <span class="n">mesh_points_grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mesh_points_grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">triang</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">Triangulation</span><span class="p">(</span><span class="n">xxt</span><span class="p">,</span> <span class="n">yyt</span><span class="p">)</span>

            <span class="c1"># plot only triangles with sidelength smaller some max_radius</span>
            <span class="n">max_radius</span> <span class="o">=</span> <span class="mf">0.02</span>
            <span class="n">triangles</span> <span class="o">=</span> <span class="n">triang</span><span class="o">.</span><span class="n">triangles</span>
            <span class="c1"># Mask unwanted triangles.</span>
            <span class="n">xtri</span> <span class="o">=</span> <span class="n">xxt</span><span class="p">[</span><span class="n">triangles</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">xxt</span><span class="p">[</span><span class="n">triangles</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ytri</span> <span class="o">=</span> <span class="n">yyt</span><span class="p">[</span><span class="n">triangles</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">yyt</span><span class="p">[</span><span class="n">triangles</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xtri</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ytri</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">triang</span><span class="o">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">maxi</span> <span class="o">&gt;</span> <span class="n">max_radius</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">triang</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mesh_points_grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mesh_points_grid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Draw</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.createFolder">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.createFolder">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">createFolder</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">projectDir</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;monopole&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>
            <span class="n">ngsolvemevp_folder</span> <span class="o">=</span> <span class="s1">&#39;Optimisation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ngsolvemevp_folder</span> <span class="o">=</span> <span class="s1">&#39;NGSolveMEVP&#39;</span>
        <span class="c1"># change save directory</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;monopole&#39;</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;monopole&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_subdir</span> <span class="o">=</span> <span class="s1">&#39;dipole&#39;</span>

        <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">new_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">new_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">projectDir</span> <span class="o">/</span> <span class="sa">fr</span><span class="s1">&#39;SimulationData/</span><span class="si">{</span><span class="n">ngsolvemevp_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pol_subdir</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.gauss">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.gauss">[docs]</a>
    <span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">g</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">g</span><span class="p">)</span></div>


<div class="viewcode-block" id="NGSolveMEVP.gaussian_deform">
<a class="viewcode-back" href="../../../../cavsim2d.solvers.NGSolve.html#cavsim2d.solvers.NGSolve.eigen_ngsolve.NGSolveMEVP.gaussian_deform">[docs]</a>
    <span class="k">def</span> <span class="nf">gaussian_deform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">deformation_params</span><span class="p">):</span>

        <span class="c1"># plt.plot(surface[:, 0], surface[:, 1], label=&#39;undeformed&#39;)#, marker=&#39;o&#39;, mfc=&#39;none&#39;</span>

        <span class="n">deform_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">))</span>
        <span class="n">deform_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n_cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cells</span><span class="p">):</span>
            <span class="c1"># get index of ncell surface nodes</span>
            <span class="n">n_cell_surf_indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">surface</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_cell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">mn</span><span class="p">,</span> <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">n_cell_surf_indx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n_cell_surf_indx</span><span class="p">)</span>

            <span class="c1"># disp = deformation_params[n_cell*3] * 0.02</span>
            <span class="n">disp</span> <span class="o">=</span> <span class="n">deformation_params</span><span class="p">[</span><span class="n">n_cell</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
            <span class="c1"># scale sigma to between 10 and 20% of length of cavity cell</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">deformation_params</span><span class="p">[</span><span class="n">n_cell</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_cell_surf_indx</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">deformation_params</span><span class="p">[</span><span class="n">n_cell</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mn</span> <span class="o">+</span> <span class="n">mx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="c1"># n_cell_deform_matrix = np.identity(len(surface)) + disp * np.diag(self.gauss(len(surface), sigma, shift=shift))</span>
            <span class="c1"># n_cell_deform_surface = n_cell_deform_matrix @ surface</span>
            <span class="c1"># plt.plot(n_cell_deform_surface[:, 0], n_cell_deform_surface[:, 1], label=n_cell)#, marker=&#39;o&#39;, mfc=&#39;none&#39;</span>
            <span class="c1"># n_cell_deform_vector = np.atleast_2d(disp*1e-3*self.gauss(len(surface), sigma, shift=shift)).T</span>
            <span class="c1"># n_cell_deform_surface = n_cell_deform_vector + surface</span>
            <span class="c1"># plt.plot(n_cell_deform_surface[:, 0], n_cell_deform_surface[:, 1], label=n_cell)#, marker=&#39;o&#39;, mfc=&#39;none&#39;</span>

            <span class="c1"># deform_matrix += disp * np.diag(self.gauss(len(surface), sigma, shift=shift))</span>
            <span class="n">deform_vector</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">disp</span> <span class="o">*</span> <span class="mf">2e-3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># deform surface</span>
        <span class="c1"># surface_def = deform_matrix @ surface</span>
        <span class="n">surface_def</span> <span class="o">=</span> <span class="n">deform_vector</span> <span class="o">+</span> <span class="n">surface</span>
        <span class="n">surface_def</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># enforce end plane to be equal by checking that the first two and last two points are on same plane</span>
        <span class="n">surface_def</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_def</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">surface_def</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_def</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">surface_def</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">surface_def</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># plt.plot(surface_def[:, 0], surface_def[:, 1], label=f&#39;gaussian: {disp:.4f}, {sigma:.4f}, {shift:.4f}&#39;)  # , marker=&#39;o&#39;, mfc=&#39;none&#39;</span>

        <span class="c1"># plt.legend()</span>
        <span class="c1"># # plt.gca().set_aspect(&#39;equal&#39;)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">surface_def</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">eig</span> <span class="o">=</span> <span class="n">NGSolveMEVP</span><span class="p">()</span>

    <span class="n">mid_cell</span> <span class="o">=</span> <span class="p">[</span><span class="mf">73.52</span><span class="p">,</span> <span class="mf">131.75</span><span class="p">,</span> <span class="mf">106.25</span><span class="p">,</span> <span class="mf">118.7</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mf">369.6321578127116</span><span class="p">]</span>
    <span class="n">l_end_cell</span> <span class="o">=</span> <span class="p">[</span><span class="mf">73.52</span><span class="p">,</span> <span class="mf">131.75</span><span class="p">,</span> <span class="mf">106.25</span><span class="p">,</span> <span class="mf">118.7</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mf">369.6321578127116</span><span class="p">]</span>
    <span class="n">r_end_cell</span> <span class="o">=</span> <span class="p">[</span><span class="mf">73.52</span><span class="p">,</span> <span class="mf">131.75</span><span class="p">,</span> <span class="mf">106.25</span><span class="p">,</span> <span class="mf">118.7</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mf">369.6321578127116</span><span class="p">]</span>
    <span class="n">eig</span><span class="o">.</span><span class="n">cavity</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mid_cell</span><span class="p">,</span> <span class="n">l_end_cell</span><span class="p">,</span> <span class="n">r_end_cell</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Sosoho-Abasi Udongwo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>